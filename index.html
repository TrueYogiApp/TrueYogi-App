
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#1e293b">
  <title>TrueYogi</title>
  <meta name="description" content="True Yogi (YOGI) draws from Bhagavad Gita wisdom: 'A Yogi excels the monk, scholar, and ritualist. Strive to be a Yogi.' Anchoring a cosmic grid of awakened souls devoted to meditation and truth. Earn YOGI tokens through stillness practice and wisdom engagement.">
  <link rel="icon" type="image/png" href="/assets/favicon.ico" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TrueYogi">
  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link rel="android-chrome-192x192" href="/assets/android-chrome-192x192.png"/>
  <link rel="android-chrome-512x512" href="/assets/android-chrome-512x512.png"/>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="/output.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Dancing+Script:700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Lexend', sans-serif;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      min-height: 100vh;
    }
    .mode-btn {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .mode-btn.active {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
    }
    #progress-ring {
      transition: stroke-dashoffset 1s linear;
    }
    .avatar-container {
      position: relative;
      width: 180px;
      height: 180px;
      margin: 0 auto 24px;
      margin-top: 2.5rem;
    }
    .pulse {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(234, 179, 8, 0.3);
      animation: pulse 2s infinite;
    }
    .pulse-2 {
      animation-delay: 0.5s;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .mode-selected {
      position: relative;
      animation: gentlePulse 2s infinite;
      transform: scale(1.02);
      transition: all 0.3s ease;
    }
    @keyframes gentlePulse {
      0% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
      100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
    }
    .flow-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.7) !important; }
    .yogi-glow { box-shadow: 0 0 15px rgba(234, 179, 8, 0.7) !important; }
    .mode-selected i {
      animation: gentleBounce 1.5s infinite;
    }
    @keyframes gentleBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    .glow {
      box-shadow: 0 0 20px rgba(234, 179, 8, 0.5);
    }
    .session-time-badge {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
    }
    .session-time-badge.active {
      background: rgba(234, 179, 8, 0.3);
      border: 1px solid rgba(234, 179, 8, 0.8);
    }
    .session-time-badge.completed {
      background: rgba(34, 197, 94, 0.3);
      border: 1px solid rgba(34, 197, 94, 0.8);
    }
    .session-time-badge.missed {
      background: rgba(239, 68, 68, 0.3);
      border: 1px solid rgba(239, 68, 68, 0.8);
      color: #fecaca;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #session-info-badge {
      background: rgba(74, 85, 104, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #a0aec0;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    #session-info-badge.flow-mode {
      background: rgba(59, 130, 246, 0.15);
      border-color: rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }
    #session-info-badge.yogi-mode {
      background: rgba(234, 179, 8, 0.15);
      border-color: rgba(234, 179, 8, 0.3);
      color: #fde68a;
    }
    @keyframes subtleFade {
      0%, 100% { opacity: 0.9; }
      50% { opacity: 1; }
    }
    #session-info-badge {
      animation: subtleFade 6s infinite;
    }
    .welcome-message {
      animation: gentleFadeIn 1.5s ease-out;
      background: rgba(74, 85, 104, 0.7);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }
    @keyframes gentleFadeIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .config-modal, .confirmation-modal {
      background: rgba(74, 85, 104, 0.9);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(234, 179, 8, 0.3);
      animation: gentleFadeIn 0.5s ease-out;
      max-height: 80vh;
      overflow-y: auto;
    }
    @keyframes moonGlow {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 6px rgba(255, 255, 150, 0.6);
      }
      50% {
        transform: scale(1.1);
        box-shadow: 0 0 12px rgba(255, 255, 150, 1);
      }
    }
    .moon-icon {
      animation: moonGlow 3s infinite ease-in-out;
      display: inline-block;
      border-radius: 50%;
    }
    @keyframes sunPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 6px rgba(255, 204, 0, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 12px rgba(255, 204, 0, 0.8);
      }
    }
    .sun-icon {
      animation: sunPulse 4s infinite ease-in-out;
      display: inline-block;
      border-radius: 50%;
    }
	.glow {
  box-shadow: 0 0 20px rgba(234, 179, 8, 0.5);
  animation: gentlePulse 9s infinite;
}
.calm-heading {
  font-family: 'Playfair Display', serif;
  font-style: italic;
  font-size: 2rem; /* Matches text-2xl, scales to 3xl on md */
  color: #eab308; /* Yellow-200 */
  text-align: center;
  margin-bottom: 0.5rem; /* Reduced from caption's 1.5rem for heading */
  line-height: 1.4;
  text-shadow: 0 0 8px rgba(234, 179, 8, 0.6), 0 0 16px rgba(234, 179, 8, 0.3);
  letter-spacing: 0.5px; /* Elegant spacing */
  font-weight: 500; /* Light bold for emphasis */
  position: relative;
}

.calm-heading:hover::after {
  width: 40%; /* Expands on hover */
}

.text-shadow {
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}



@media (max-width: 640px) {
  .calm-heading {
    font-size: 1.5rem; /* Adjusts for mobile, matches earlier caption */
  }
}

.text-gray-300 {
  color: #d1d5db; /* Lighter gray for subtlety */
}
.subdued-path-text {
  font-size: 1.1rem; /* Reduced font size for less emphasis */
  color: #9ca3af; /* Softer gray tone for subtlety */
  text-align: center;
  padding: 0.25rem 0.5rem;
  transition: color 0.3s ease;
}

.subdued-path-text:hover {
  color: #d1d5db; /* Slight color shift on hover for minimal interaction */
}

.auth-section-container {
  max-width: 320px;
  margin: 1.5rem auto;
}

.auth-card {
  background: linear-gradient(145deg, #1e1e2f, #2a2a3a);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.auth-title {
  color: #8b5cf6; /* Slightly deeper purple for better contrast */
  font-size: clamp(1.1rem, 1.25vw + 0.5rem, 1.3rem); /* Responsive scaling */
  font-weight: 600; /* Semi-bold for better presence */
  margin-bottom: 1.5rem;
  text-align: center;
  letter-spacing: 0.03em; /* More natural spacing */
  font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif; /* Modern sans-serif */
  text-transform: uppercase; /* Clean, structured look */
  position: relative;
  display: inline-block; /* For pseudo-element styling */
  padding-bottom: 0.5rem; /* Space for underline effect */
}
/* Optional: Subtle underline effect */
.auth-title::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40%;
  height: 2px;
  background: linear-gradient(90deg, #8b5cf6, #c4b5fd, #8b5cf6);
  border-radius: 2px;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .auth-title {
    font-size: 1.15rem;
    letter-spacing: 0.02em;
    margin-bottom: 1.25rem;
  }
  .auth-title::after {
    width: 60%; /* Longer underline on mobile */
  }
}


.wallet-connect-btn, .wallet-auth-btn {
  position: relative;
  width: 100%;
  padding: 0.85rem;
  border-radius: 12px;
  border: none;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  cursor: pointer;
  overflow: hidden;
  transition: all 0.3s ease;
}

.wallet-connect-btn {
  background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
  color: white;
}

.wallet-auth-btn {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  margin-top: 0.75rem;
}

.btn-icon {
  font-size: 1.1rem;
}

.btn-text {
  font-size: 0.95rem;
}

.btn-glow {
  position: absolute;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, rgba(255,255,255,0.3) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.wallet-connect-btn:hover, .wallet-auth-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.wallet-connect-btn:hover .btn-glow, .wallet-auth-btn:hover .btn-glow {
  opacity: 1;
}

.wallet-status-message {
  margin-top: 1rem;
  font-size: 0.8rem;
  text-align: center;
  color: #fef08a;
  min-height: 1.2rem;
  line-height: 1.4;
  padding: 0.5rem;
  border-radius: 6px;
  background: rgba(254, 240, 138, 0.1);
}

.hidden {
  display: none;
}

/* Add this to your existing style section */
  .end-date-display {
    position: fixed;
    bottom: 10px;
    right: 10px;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    background: transparent;
    padding: 4px 8px;
    border-radius: 12px;
    z-index: 100;
    transition: all 0.3s ease;
  }
  .end-date-display:hover {
    color: rgba(255, 255, 255, 0.8);
    background: transparent;
  }
  
  #start-date-display {
  left: 10px;
  bottom: 10px; /* Positions it above the end date */
}

#now-date-display {
  background: transparent;
  left: 50%;
  right: auto;
  transform: translateX(-50%);
  bottom: 10px;
  /* Same as .end-date-display otherwise */
}

/* Auto-hide loader after 6 seconds */
#app-loader {
  animation: hideLoader 6s forwards;
}

@keyframes hideLoader {
  0%, 70% {
    opacity: 1;
    visibility: visible;
  }
  100% {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }
}

/* Loader spinner for app loader only */
#app-loader .loader-spinner {
  background: conic-gradient(from 0deg, transparent, #eab308, transparent);
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1.2s linear infinite;
  position: relative;
  border: 6px solid #eab308;
  border-top: 6px solid #fff;
  box-shadow: 0 0 24px #eab30888;
}

#app-loader .loader-spinner::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #eab308;
  border-radius: 50%;
  animation: pulse1 2.4s ease-in-out infinite;
}

#claim-loader .loader-spinner {
  background: conic-gradient(from 0deg, transparent, #3b82f6, transparent);
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1.2s linear infinite;
  position: relative;
  border: 6px solid #3b82f6;
  border-top: 6px solid #60a5fa;
  box-shadow: 0 0 24px #3b82f688;
}

#claim-loader .loader-spinner::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #3b82f6; /* Blue */
  border-radius: 50%;
  animation: pulse1 2.4s ease-in-out infinite;
}

/* General spin animation */
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

/* Pulse animation for dot */
@keyframes pulse1 {
  0% { width: 0px; height: 0px; opacity: 1; }
  50% { width: 20px; height: 20px; opacity: 0.8; }
  100% { width: 0px; height: 0px; opacity: 1; }
}
.loader-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 2;
}

.cosmic-bg {
  position: absolute;
  opacity: 0;
  width: 100%; /* Change from 100vw to 100% */
  height: 100%; /* Change from 100vh to 100% */
  object-fit: cover;
  pointer-events: none;
  transition: opacity 1s ease-in-out;
}

.cosmic-bg.active {
  opacity: 0.33;
}

.cosmic-quote {
  font-family: 'Playfair Display', serif;
  color: #fde68a;
  font-size: 1.3em;
  text-align: center;
  margin-top: 4em;
  text-shadow: 0 0 18px #fde68a88;
  z-index: 3;
}

/* FAQ Tab Styles */
#faq-tab {
  position: fixed;
  bottom: 10px;
  left: 100%;
  transform: translateX(-50%);
  background-color: rgba(30, 41, 59, 0.8);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  cursor: pointer;
  z-index: 40;
  backdrop-filter: blur(5px);
  border: 1px solid rgba(234, 179, 8, 0.3);
  transition: all 0.3s ease;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  /* Hide by default */
  display: none;
}

#faq-tab {
  background-color: #1e293b !important;
  color: #fde68a !important;
  border: 1.5px solid #eab308;
  font-weight: 600;
  font-size: 1.1rem;
  border-top-left-radius: 1.2em;
  border-top-right-radius: 1.2em;
  box-shadow: 0 2px 14px #eab30822;
}
#faq-tab:hover {
  background-color: #fde68a !important;
  color: #1e293b !important;
}

.web3-status-wrapper {
  background: radial-gradient(circle at 50% 40%, #101a32 60%, #232746 100%);
  border-radius: 18px;
  box-shadow: 0 0 28px 4px #683dd5, 0 0 14px 2px #eabfff90, 0 2px 12px #0005;
  padding: 16px 0;
  margin: 0 5px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 65px;
  position: relative;
  transition: box-shadow 0.35s;
  overflow: hidden;
}

.web3-status-wrapper::before {
  content: "";
  position: absolute;
  inset: 0;
  z-index: 0;
  background: radial-gradient(circle at 50% 30%, #ad7efb33 0%, #232746 90%);
  animation: portalGlowMove 5s infinite linear;
  opacity: 0.8;
}

.web3-status-icon {
  font-size: 1.8em;
  color: #a78bfa;
  margin-bottom: 0.15em;
  text-shadow: 0 0 8px #a78bfa88;
}

.web3-status-title {
  font-weight: 700;
  color: #a78bfa;
  letter-spacing: 1px;
  font-size: 1.1em;
  margin-bottom: 0.1em;
}

.web3-status-desc {
  color: #fffad6; /* lighter yellow */
  font-weight: 700;
  font-style: italic;
  font-size: 1.25em;
  text-align: center;
  letter-spacing: 0.4px;
  font-family: 'Dancing Script', cursive, system-ui, -apple-system, sans-serif;
  text-shadow:
    0 0 6px #ffe06677, /* soft gold glow */
    0 0 18px #f7ffd0aa, /* outer brighter glow */
    0 1px 1px #fff8;
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  10%, 30% { transform: scale(1.1); }
  20%, 40% { transform: scale(0.95); }
}
#jwt-timer {
  display: inline-block;
  animation: heartbeat 1s infinite;
}

/* Tooltip Styles */
.status-tooltip {
  position: relative;
  cursor: default;
}
.status-tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 100;
  margin-bottom: 5px;
  border: 1px solid rgba(255,255,255,0.1);
  font-family: 'Lexend', sans-serif;
}

/* Status-specific colors */
.completed-tip:hover::after { background: #10b981; }
.missed-tip:hover::after { background: #ef4444; }
.active-tip:hover::after { background: #eab308; }
.upcoming-tip:hover::after { background: #3b82f6; }
.Journey-begins-tip:hover::after { background: #3b82f6; }

@keyframes resetPulse {
  0%, 100% { box-shadow: 0 0 18px #fff, 0 0 1px #e5e7eb; opacity: 0.8; }
  50% { box-shadow: 0 0 32px #fff, 0 0 1px #e5e7eb; opacity: 1; }
}

#meditation-guide button {
  transition: all 0.2s ease;
}
#meditation-guide button:hover {
  transform: translateY(-1px);
}

/* Add to your style section */
#yogi-sun-icon {
  transition: transform 0.3s ease;
}

  /* TrueYogi Configuration Modal */
.config-modal {
  width: 95%;
  max-width: 420px;
  max-height: 85vh;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #eab308 #1e293b;
  padding: 1.5rem;
  margin: 1rem;
}

.config-modal::-webkit-scrollbar {
  width: 6px;
}

.config-modal::-webkit-scrollbar-track {
  background: #1e293b;
  border-radius: 3px;
}

.config-modal::-webkit-scrollbar-thumb {
  background-color: #eab308;
  border-radius: 3px;
}

/* Session Times Inputs Container */
#session-times-inputs {
  max-height: 40vh;
  overflow-y: auto;
  padding-right: 8px;
  margin-bottom: 1rem;
}

/* Input Row Styling */
#session-times-inputs > div {
  margin-bottom: 1rem;
  gap: 0.75rem;
  display: flex;
  flex-direction: column;
}

/* Universal Input Styling */
#session-times-inputs input[type="time"],
#start-date,
#session-times-inputs select {
  width: 100%;
  background-color: #1e293b;
  color: white;
  border: 1px solid #334155;
  border-radius: 0.5rem;
  padding: 0.75rem;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s;
}

/* Hover States */
#session-times-inputs input[type="time"]:hover,
#start-date:hover,
#session-times-inputs select:hover {
  border-color: #eab308;
}

/* Focus States */
#session-times-inputs input[type="time"]:focus,
#start-date:focus,
#session-times-inputs select:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(234, 179, 8, 0.5);
}

/* Date Input Styling */
#start-date {
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 14px;
  padding-right: 2.5rem;
}

/* Time Input Styling */
#session-times-inputs input[type="time"] {
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 14px;
  padding-right: 2.5rem;
}

/* Duration Select Styling */
#session-times-inputs select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23eab308' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 12px;
  padding-right: 2.5rem;
  appearance: none;
}

/* Submit Button Styling */
.config-modal button[onclick="saveYogiConfig()"] {
  margin-top: 1rem;
  width: 100%;
  background-color: #eab308;
  color: #1e293b;
  font-weight: 600;
  padding: 0.75rem;
  border-radius: 0.5rem;
  transition: all 0.2s;
}

.config-modal button[onclick="saveYogiConfig()"]:hover {
  background-color: #f59e0b;
}

/* Responsive Adjustments */
@media (max-height: 600px) {
  .config-modal {
    max-height: 75vh;
  }
  #session-times-inputs {
    max-height: 30vh;
  }
}

.mode-btn.disabled, .mode-btn[disabled] {
  pointer-events: none !important;
  opacity: 0.6 !important;
  filter: grayscale(40%) blur(0.5px);
  cursor: not-allowed !important;
  box-shadow: none !important;
}

/* Transaction link styling */
.tx-link {
  display: block;
  margin: 18px auto 0 auto;
  width: fit-content;
  color: #7c8afc;
  font-weight: 600;
  font-size: 1.09em;
  text-decoration: underline;
  letter-spacing: 0.04em;
  transition: color 0.22s, box-shadow 0.22s, text-shadow 0.22s;
  text-align: center;
  box-shadow: 0 1px 6px #7c8afc15;
  border-radius: 8px;
  padding: 0.4em 1.4em;
  background: rgba(124, 138, 252, 0.08);
  text-shadow: 0 2px 8px #7c8afc33;
}
.tx-link:hover, .tx-link:focus {
  color: #4f55c2;
  background: rgba(124, 138, 252, 0.15);
  box-shadow: 0 2px 14px #7c8afc44;
  outline: none;
  text-decoration: none;
}

.token-preview {
  position: static;
  margin: 0.7em 0 0.7em 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(purple);
  border: 1px solid rgba(purple);
  color: #FFD700;
  text-shadow: 0 0 1px #fffbe6, 0 0 12px #FFD700;
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 0.98rem;
  font-weight: 600;
  gap: 8px;
}

.token-preview i {
  font-size: 1.1em;
}

.meditation-steps {
  font-size: 1rem;
  line-height: 1.7;
  font-family: 'Lexend', 'Segoe UI', Arial, sans-serif;
  color: white;
  font-weight: 500;
  margin-bottom: 1em;
  letter-spacing: 0.02em;
}

.meditation-steps li {
  margin-bottom: 0.45em;
  background: rgba(251, 191, 36, 0.07);
  border-radius: 8px;
  padding: 0.33em 0.7em;
  /* Optional: add a gentle box-shadow for more depth */
  /* box-shadow: 0 1px 8px rgba(251,191,36,0.05); */
}

#lang-switch-container {
  position: fixed;
  left: 18px;
  bottom: 18px;
  z-index: 100;
  display: flex;
  align-items: center;
  padding: 0.15em 0.7em 0.15em 0.4em;
  background: rgba(30,41,59,0.92);
  border: 1.3px solid #eab308;
  border-radius: 1.3em;
  box-shadow: 0 2px 12px #eab30822;
  min-width: 0;
  transition: box-shadow 0.18s;
  height: 35px;
}

#lang-switch-container i.fas.fa-globe-asia {
  color: #fde68a;
  font-size: 1em;
  margin-right: 0.45em;
  vertical-align: middle;
  cursor: pointer;
}

#lang-switch option {
  color: #963;
  background: #fde68a;
  font-weight: 600;
  font-size: 1em;
}

#lang-switch {
  cursor: pointer;
}

@media (max-width: 640px) {
  #lang-switch-container {
    left: 12px;   /* Use right, not left, for bottom right position */
    right: auto;    /* Override any previous left */
    bottom: 18px;
    padding: 0.09em 0.4em 0.09em 0.25em;
    height: 28px;
    width: auto;      /* Prevents stretching */
    min-width: 0;     /* Ensures no minimum width */
    max-width: none;  /* No max width restriction */
    display: flex;
    align-items: center;
  }
  #lang-switch {
    font-size: 0.92em;
    min-width: 28px;
    background-size: 0.7em;
  }
  #lang-switch-container i.fas.fa-globe-asia {
    font-size: 0.92em;
    margin-right: 0.33em;
  }
}

#meditation-canvas {
  position: fixed;
  top: 0;
  left: 0;
  z-index: -1;
  background: radial-gradient(ellipse at center, #0d1b2a 0%, #000 100%);
}
.hidden {
  display: none;
}

.tab-button:not(.active):hover {
  color: #fde68a; /* yellow-200 */
  background: rgba(234,179,8,0.07);
  box-shadow: 0 2px 10px 0 rgba(234, 179, 8, 0.07);
  z-index: 2;
}

/* Active tab styling */
.tab-button.active {
  color: #fde68a; /* yellow-200 */
  border-bottom: 2.5px solid #fbbf24; /* yellow-400 */
  background: rgba(234,179,8,0.10);
  box-shadow: 0 0 0 2px #fde68a33;
  z-index: 3;
}

/* "About" symbol tab special style */
#about-faq-tab.tab-button {
  font-size: 1.3em;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
}

/* Divider between tabs (optional, for subtle shadow/gap) */
.tab-button:not(:last-child) {
  box-shadow: 1px 0 0 0 rgba(55,65,81,0.08);
}

.tab-button:focus {
  outline: 2px solid #fbbf24;
  outline-offset: -2px;
}

#reset-faq-content .faq-item {
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 0.5rem;
  padding: 1rem;
  background: rgba(239, 68, 68, 0.05);
}

#reset-faq-content button {
  transition: all 0.2s;
}

#reset-faq-tab.tab-button:hover {
  background-color: #ef4444 !important; /* Tailwind red-500 */
  color: #fff !important;
  box-shadow: 0 0 12px #ef4444cc;
  border-bottom: 2.5px solid #ef4444 !important;
  z-index: 3;
}

 /* Add to Homescreen Prompt Styles */
    #add-to-homescreen {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 400px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: none;
      animation: slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp {
      from { transform: translate(-50%, 100px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    #add-to-homescreen h3 {
      color: #fde68a;
      margin-top: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #add-to-homescreen p {
      color: #d1d5db;
      margin: 12px 0;
      line-height: 1.5;
    }
    
    #add-to-homescreen .steps {
      background: rgba(234, 179, 8, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    
    #add-to-homescreen .steps div {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    
    #add-to-homescreen .steps div:last-child {
      margin-bottom: 0;
    }
    
    #add-to-homescreen .steps .number {
      background: #eab308;
      color: #1e293b;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    #add-to-homescreen .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    #add-to-homescreen button {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    #add-to-homescreen .btn-primary {
      background: #eab308;
      color: #1e293b;
    }
    
    #add-to-homescreen .btn-primary:hover {
      background: #f59e0b;
    }
    
    #add-to-homescreen .btn-secondary {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #4b5563;
    }
    
    #add-to-homescreen .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    #add-to-homescreen .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 1.2rem;
      cursor: pointer;
    }
	
#yogi-mint {
  background: linear-gradient(90deg, #ffd700, #fff, #ffd700);
  background-size: 200% auto;
  color: #222;
  padding: 2px 6px;
  border-radius: 6px;
  font-weight: bold;
  animation: shine 3s linear infinite;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
#yogi-mint:hover {
  cursor: pointer;
  transform: scale(1.05);
  box-shadow: 0 0 10px #ffd700;
}
@keyframes shine {
  0% { background-position: 0% center; }
  100% { background-position: 200% center; }
}

#wisdom-section {
  position: relative;
  overflow: hidden;
}
#wisdom-section::before {
  content: '';
  position: absolute;
  top: 5%;
  left: 50%;
  transform: translateX(-50%);
  width: 85%;
  height: 90%;
  background: radial-gradient(circle, #fde68a33 0%, transparent 70%);
  z-index: 0;
  pointer-events: none;
  animation: wisdomGlow 4s infinite alternate;
}
@keyframes wisdomGlow {
  0% { opacity: 0.45; }
  100% { opacity: 0.75; }
}
#wisdom-text {
  position: relative;
  z-index: 2;
}

/* Add this for a subtle moving shine across the progress bar */
#progress-bar-bg {
  position: relative;
  overflow: hidden;
}

#progress-bar-bg::after {
  content: "";
  position: absolute;
  top: 0;
  left: -30%;
  width: 60%;
  height: 100%;
  background: linear-gradient(120deg, 
    transparent 0%, 
    rgba(255, 0, 0, 0.15) 10%,      /* Red */
    rgba(255, 127, 0, 0.15) 20%,    /* Orange */
    rgba(255, 255, 0, 0.15) 30%,    /* Yellow */
    rgba(0, 255, 0, 0.15) 40%,      /* Green */
    rgba(0, 0, 255, 0.15) 50%,      /* Blue */
    rgba(75, 0, 130, 0.15) 60%,     /* Indigo */
    rgba(148, 0, 211, 0.15) 70%,    /* Violet */
    transparent 100%);
  pointer-events: none;
  animation: shine-move 3s infinite linear;
}

@keyframes shine-move {
  0% { left: -30%; }
  100% { left: 100%; }
}

/* Optional: Glow effect at edges */
#progress-bar-bg div {
  box-shadow: 0 0 8px 2px rgba(234,179,8,0.25),
              0 0 13px 2px rgba(139,92,246,0.22);
  transition: box-shadow 0.3s;
}
/* Subtle background pattern */
#progress-bar-bg {
  background: linear-gradient(45deg, 
    rgba(139,92,246,0.05) 25%, 
    transparent 25%, 
    transparent 50%, 
    rgba(139,92,246,0.05) 50%, 
    rgba(139,92,246,0.05) 75%, 
    transparent 75%);
  background-size: 8px 8px;
}

@keyframes smooth-rotate {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

@keyframes clock-rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.rainbow-text, #rainbow-icon, .rainbow-underline-container {
  animation: color-cycle 14s infinite;
}

.rainbow-underline-container {
  position: relative;
  display: inline-block;
  padding-bottom: 2px;
}

.rainbow-underline-container::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 1px;
  bottom: 0;
  left: 0;
  background-color: currentColor; /* <- key change */
}

@keyframes color-cycle {
  0%, 100% { color: #FF0000; } /* Bright Red */
  12.5% { color: #FF5F00; }   /* Bright Orange-Red */
  25% { color: #FFBF00; }     /* Bright Amber */
  37.5% { color: #FFFF00; }   /* Bright Yellow */
  50% { color: #80FF00; }     /* Chartreuse */
  62.5% { color: #00FF00; }   /* Bright Green */
  75% { color: #00FFFF; }     /* Cyan */
  87.5% { color: #0080FF; }   /* Bright Blue */
}

@keyframes underline-color-cycle {
  0%, 100% { background-color: #FF0000; } /* Bright Red */
  12.5% { background-color: #FF5F00; }   /* Bright Orange-Red */
  25% { background-color: #FFBF00; }     /* Bright Amber */
  37.5% { background-color: #FFFF00; }   /* Bright Yellow */
  50% { background-color: #80FF00; }     /* Chartreuse */
  62.5% { background-color: #00FF00; }   /* Bright Green */
  75% { background-color: #00FFFF; }     /* Cyan */
  87.5% { background-color: #0080FF; }   /* Bright Blue */
}

@keyframes smooth-rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#rainbow-icon {
  animation: color-cycle 14s infinite, smooth-rotate 6s linear infinite;
}

#info-toggle-btn.info-glow {
  box-shadow: 0 0 12px #fde68a99, 0 2px 6px #fde68a22;
  background: rgba(234,179,8,0.06);
  color: #fde68a;
  transition: box-shadow 0.2s, background 0.2s, color 0.2s, transform 0.15s;
}
#info-toggle-btn:hover, #info-toggle-btn:focus {
  background: #fde68a;
  color: #1e293b;
  box-shadow: 0 0 18px #fde68a99, 0 4px 12px #fde68a44;
  transform: scale(1.07);
}
#info-toggle-btn:active {
  transform: scale(0.96);
  box-shadow: 0 0 18px #fde68a99;
}
#info-toggle-btn i { color: #eab308 !important; }

#hide-ui-btn {
  display: none; 
  position: fixed;
  top: 22px;
  right: 22px;
  z-index: 9999;
  font-size: 1em; /* Larger for touch and visibility */
  background: linear-gradient(135deg, #68592c 60%, #68592c 100%);
  color: #1e293b;
  border-radius: 50%;
  border: none;
  padding: 0.37em 0.6em;
  cursor: pointer;
  box-shadow: 0 2px 18px #eab30844, 0 0 0 2px #fde68a55;
  opacity: 0.95;
  transition: box-shadow 0.25s, transform 0.2s, background 0.3s;
  outline: none;
  animation: gentleMeditationPulse 5s infinite;
}
#hide-ui-btn:hover, #hide-ui-btn:focus {
  box-shadow: 0 0 32px #fde68a, 0 0 0 4px #fbbf24;
  transform: scale(1.08);
  background: linear-gradient(135deg, #fbbf24 80%, #fde68a 100%);
  opacity: 1;
}
@keyframes gentleMeditationPulse {
  0%, 100% { box-shadow: 0 2px 18px #eab30844; }
  50%      { box-shadow: 0 0 38px #fde68a88; }
}

/* Add these styles to your existing CSS */
.fa-feather-pointed {
    position: relative;
    transition: all 0.3s ease;
    color: #6B4625; /* Natural feather color */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    transform: rotate(-5deg);
}

#start-button:hover .fa-feather-pointed {
    transform: rotate(0deg) translateY(-2px);
    color: #8B4513; /* Slightly darker on hover */
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
}

/* Optional: Add subtle animation for breathing effect */
@keyframes featherFloat {
    0%, 100% { transform: rotate(-5deg) translateY(0); }
    50% { transform: rotate(-3deg) translateY(-1px); }
}

.fa-feather-pointed {
    animation: featherFloat 4s ease-in-out infinite;
}

#start-button:hover .fa-feather-pointed {
    animation: none; /* Stop the float animation on hover */
}

/* Add these styles to your existing CSS */
.fa-dove {
    position: relative;
    transition: all 0.4s ease;
    color: #36454F; /* Soft blue-gray reminiscent of dove feathers */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    transform: translateY(0);
}

#continue-path1:hover .fa-dove {
    transform: translateY(-2px) translateX(1px);
    color: #3B3C36; /* Slightly darker blue-gray on hover */
    text-shadow: 2px 3px 4px rgba(0,0,0,0.15);
    filter: drop-shadow(0 2px 4px rgba(100, 100, 150, 0.3));
}

/* Gentle wing flap animation */
@keyframes doveFlap {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-1px) rotate(-2deg); }
    75% { transform: translateY(-1px) rotate(2deg); }
}

.fa-dove {
    animation: doveFlap 5s ease-in-out infinite;
}

#continue-path1:hover .fa-dove {
    animation: doveFlap 1.5s ease-in-out infinite; /* Faster animation on hover */
}

@media print {
  body > *:not(#certificate-page) { display: none !important; }
  #certificate-page, #certificate {
    display: block !important;
    margin: 0 auto !important;
    width: 700px !important;
    height: 900px !important;
    max-height: 900px !important;
    min-height: 900px !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
    page-break-inside: avoid !important;
    page-break-after: avoid !important;
    page-break-before: avoid !important;
    background: linear-gradient(135deg,#232946,#3e497a 80%) !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    border: 6px solid gold !important;
    box-shadow: 0 2px 18px #eab30866 !important;
  }
  .print-only-hide { display: none !important; }
}

@keyframes colorShift {
  0% { color: #FFD700; }
  33% { color: #FFA500; }
  66% { color: #FFDF00; }
  100% { color: #FFEC8B; }
}

@keyframes shimmer {
  0%, 100% { text-shadow: 0 0 10px currentColor; }
  50% { text-shadow: 0 0 25px currentColor, 0 0 15px white; }
}

.bg-orange-400 {
  background-color: #fb923c !important;
}
.bg-orange-500 {
  background-color: #f97316 !important;
}
.bg-orange-400:hover, .bg-orange-500:hover {
  filter: brightness(1.08);
}

/* Add to existing CSS */
.wisdom-glow {
  box-shadow: 0 0 8px 1px #fde68a66, 0 0 0 1px #eab30822;
  animation: wisdomPulse 2.5s infinite;
}

@keyframes wisdomPulse {
  0%, 100% { box-shadow: 0 0 8px 1px #fde68a66, 0 0 0 1px #eab30822; }
  50% { box-shadow: 0 0 16px 3px #fde68a88, 0 0 0 2px #eab30844; }
}

.lamp-glow {
  font-size: 1.3em;
  text-shadow: 0 0 18px #fde68a, 0 0 35px #fbbf24, 0 0 8px #fffbe6;
  animation: lampPulse 2.3s infinite;
  transition: transform 0.3s;
  display: inline-block;
}
.lamp-glow:hover {
  transform: scale(1.12) rotate(-8deg);
  text-shadow: 0 0 36px #fde68a, 0 0 70px #fbbf24, 0 0 12px #fffbe6;
}
@keyframes lampPulse {
  0%, 100% { opacity: 0.87; text-shadow: 0 0 18px #fde68a, 0 0 35px #fbbf24; }
  50% { opacity: 1; text-shadow: 0 0 36px #fde68a, 0 0 70px #fbbf24; }
}

@keyframes lotusEyeFireGlow {
  0% {
    opacity: 1;
    box-shadow:
      0 0 8px 4px #fbb6ce,
      0 0 15px 7px #f472b6,
      0 0 21px 11px #ec489988;
  }
  25% {
    opacity: 0.7;
    box-shadow:
      0 0 5px 2px #fbb6ce,
      0 0 10px 5px #f472b6,
      0 0 12px 8px #ec489988;
  }
  50% {
    opacity: 0.3;
    box-shadow:
      0 0 0px 0px #fbb6ce,
      0 0 0px 0px #f472b6,
      0 0 0px 0px #ec489988;
  }
  75% {
    opacity: 0.7;
    box-shadow:
      0 0 5px 2px #fbb6ce,
      0 0 10px 5px #f472b6,
      0 0 12px 8px #ec489988;
  }
  100% {
    opacity: 1;
    box-shadow:
      0 0 8px 4px #fbb6ce,
      0 0 15px 7px #f472b6,
      0 0 21px 11px #ec489988;
  }
}

#pull-refresh-spinner {
  position: absolute;
  top: 26px;
  left: 50%;
  transform: translateX(-50%) scale(1) rotate(0deg);
  width: 48px;
  height: 48px;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  pointer-events: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

#pull-refresh-spinner.show {
  opacity: 1;
}

#pull-refresh-spinner.refreshing svg {
  animation: spinlotus 1s linear infinite;
}

@keyframes spinlotus {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

@keyframes inhaleExhale {
  0%   { transform: scale(1);}
  35%  { transform: scale(1.06);}
  55%  { transform: scale(1.10);}
  70%  { transform: scale(1.06);}
  100% { transform: scale(1);}
}

/* Rainbow color classes using your exact colors */
.lungs-red { filter: invert(42%) sepia(65%) saturate(1352%) hue-rotate(325deg) brightness(99%) contrast(96%); } /* #ef4444 */
.lungs-orange { filter: invert(81%) sepia(94%) saturate(726%) hue-rotate(-17deg) brightness(111%) contrast(104%); }
.lungs-yellow { filter: invert(92%) sepia(90%) saturate(720%) hue-rotate(1deg) brightness(115%) contrast(105%); }
.lungs-green { filter: invert(61%) sepia(65%) saturate(450%) hue-rotate(90deg) brightness(95%) contrast(90%); } /* #22c55e */
.lungs-lightblue { filter: invert(43%) sepia(97%) saturate(1800%) hue-rotate(195deg) brightness(110%) contrast(104%); } /* #7dd3fc */
.lungs-indigo { filter: invert(30%) sepia(98%) saturate(1500%) hue-rotate(228deg) brightness(110%) contrast(102%); } /* #6366f1 */
.lungs-violet { filter: invert(46%) sepia(85%) saturate(1400%) hue-rotate(275deg) brightness(112%) contrast(105%); } /* #8b5cf6 */

  /* Enhanced Zoom Styles */
.zoomable-content {
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  transform-origin: center center;
}

.zoomed {
  transform: scale(1.15); /* Increased zoom level */
}

/* Prevent zoom on images/text from being blurry */
.zoomed img {
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.zoomed {
  text-rendering: optimizeLegibility;
}

.card-aura {
  border-radius: 24px;
  transition: box-shadow 3s;
}

/* 1. Red: true, powerful red */
.card-aura.red {
  box-shadow: 0 0 27px 0 #FF1A1A99, 0 0 8px 2px #FF1A1A44;
}
/* 2. Orange: vivid, sunrise orange */
.card-aura.orange {
  box-shadow: 0 0 27px 0 #FF880099, 0 0 8px 2px #FF880044;
}
/* 3. Yellow: pure solar yellow */
.card-aura.yellow {
  box-shadow: 0 0 27px 0 #FFD60099, 0 0 8px 2px #FFD60044;
}
/* 4. Green: energetic spring green */
.card-aura.green {
  box-shadow: 0 0 27px 0 #29D88499, 0 0 8px 2px #29D88444;
}

/* 5. Vibrant Azure */
.card-aura.blue {
  box-shadow: 0 0 30px 0 #3B82F6EE, 0 0 8px 2px #60A5FA99;
}

/* 6. Vibrant Royal Indigo */
.card-aura.indigo {
  box-shadow: 0 0 30px 0 #4338CAEE, 0 0 8px 2px #5B54FA99;
}

/* 7. Bright Magenta-Violet */
.card-aura.violet {
  box-shadow: 0 0 30px 0 #C026D3EE, 0 0 8px 2px #E879F999;
}
/* 8. Gold: strong, royal metallic gold */
.card-aura.gold {
  box-shadow: 0 0 23px 0 #FFD700DD, 0 0 8px 2px #FFD70088;
}
/* 9. Silver: bright, clear silver */
.card-aura.silver {
  box-shadow: 0 0 27px 0 #BFC9CA99, 0 0 8px 2px #BFC9CA44;
}
/* 10. Royal Sapphire - richer, more regal */
.card-aura.sapphire {
  box-shadow: 0 0 35px 0 #1a4fccee, 0 0 10px 3px #1a4fccaa;
}
/* 11. Iron Shadow - platinum dark silver */
.card-aura.dark-silver {
  box-shadow: 0 0 28px 0 #606060EE, 0 0 10px 3px #606060EE;
}
/* 12. White: pure, radiant white */
.card-aura.white {
  box-shadow: 0 0 30px 0 #FFFFFFCC, 0 0 8px 2px #FFFFFF66;
}

.auth-card {
  box-shadow: 
    inset 0 0 25px rgba(122, 65, 233, 0.5),
    inset 0 0 35px rgba(168, 85, 247, 0.3),
    inset 0 0 45px rgba(192, 132, 252, 0.2);
  border: 1px solid rgba(122, 65, 233, 0.4);
  animation: 
    gentleFloat 6s ease-in-out infinite,
    breathGlow 12s ease-in-out infinite;
}

@keyframes gentleFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-3px); }
}

@keyframes breathGlow {
  0%, 100% { 
    box-shadow: 
      inset 0 0 25px rgba(122, 65, 233, 0.5),
      inset 0 0 35px rgba(168, 85, 247, 0.3),
      inset 0 0 45px rgba(192, 132, 252, 0.2);
  }
  50% { 
    box-shadow: 
      inset 0 0 30px rgba(122, 65, 233, 0.6),
      inset 0 0 40px rgba(168, 85, 247, 0.4),
      inset 0 0 50px rgba(192, 132, 252, 0.3);
  }
}


.thruster-flame {
  width: 2px;
  height: 9px;
  background: radial-gradient(circle at 50% 70%, #fff 70%, #fff 100%);
  border-radius: 50% 50% 70% 70%;
  position: absolute;
  top: 11px;
  opacity: 0.8;
  z-index: 1;
  animation: thrusterPulse 1.5s infinite;
}
.thruster-flame.left  { left: 4.2px; }
.thruster-flame.right { left: 10.2px; }
@keyframes thrusterPulse {
  0%, 100% { opacity: 0.3; transform: scaleY(1); }
  50% { opacity: 0.9; transform: scaleY(1.12); }
}

.om-counter {
  display: block;
  margin: 18px auto 0 auto;
  text-align: center;
  color: #fde68a;
  font-family: 'Playfair Display', serif;
  font-size: 2.4em;
  font-weight: 600;
  letter-spacing: 0.03em;
  text-shadow: 0 2px 12px #fde68a77, 0 0 1px #fff;
  opacity: 1;
  transition: opacity .4s, color .3s;
  background: none;
  padding: 0.1em 0.5em;
  border-radius: 1em;
  min-width: 1.5em;
  min-height: 1.2em;
  /* box-shadow: 0 0 16px #fde68a22; */
  /* Optional: subtle glowing animation */
  animation: omSimpleGlow 3s infinite alternate;
}

.om-counter.hidden {
  display: none !important;
}

.om-counter.red         { color: #FF1A1A; text-shadow: 0 0 16px #FF1A1A99; }
.om-counter.orange      { color: #FF8800; text-shadow: 0 0 16px #FF880099; }
.om-counter.yellow      { color: #FFD600; text-shadow: 0 0 16px #FFD60099; }
.om-counter.green       { color: #29D884; text-shadow: 0 0 16px #29D88499; }
.om-counter.blue        { color: #3B82F6; text-shadow: 0 0 16px #3B82F6EE; }
.om-counter.indigo      { color: #4338CA; text-shadow: 0 0 16px #4338CAEE; }
.om-counter.violet      { color: #C026D3; text-shadow: 0 0 16px #C026D3EE; }
.om-counter.gold        { color: #FFD700; text-shadow: 0 0 16px #FFD700DD; }
.om-counter.silver      { color: #BFC9CA; text-shadow: 0 0 16px #BFC9CA99; }
.om-counter.sapphire    { color: #1a4fcc; text-shadow: 0 0 16px #1a4fccee; }
.om-counter.dark-silver { color: #606060EE; text-shadow: 0 0 16px #606060EE; }
.om-counter.white       { color: #FFFFFF; text-shadow: 0 0 16px #FFFFFFCC; }

.om-counter-pulse {
  animation: omCounterPulse 0.7s;
  will-change: transform;
}

@keyframes omCounterPulse {
  0%   { transform: scale(1); text-shadow: none; }
  40%  { transform: scale(1.25); text-shadow: 0 0 12px #fde68a; }
  60%  { transform: scale(0.92); text-shadow: 0 0 12px #fde68a; }
  80%  { transform: scale(1.12); text-shadow: none; }
  100% { transform: scale(1); text-shadow: none; }
}

.om-counter.active {
  text-shadow: 0 0 10px #fde68a99, 0 0 2px #fffbe6;
  animation: omActiveGlowText 3.3s infinite alternate;
}

@keyframes omActiveGlowText {
  0%   { text-shadow: 0 0 7px #fde68a77, 0 0 2px #fffbe6; }
  100% { text-shadow: 0 0 15px #fde68aee, 0 0 4px #fffbe6; }
}

.session-time-block {
  background: rgba(30,41,59,0.92);         /* Slightly lighter than modal */
  border: 1.5px solid #eab30833;           /* Subtle gold border */
  border-radius: 10px;
  box-shadow: 0 2px 10px #eab30811;        /* Gentle shadow */
  padding: 0.75em 0.8em;
  margin-bottom: 1em;                      /* Spacing between blocks */
  transition: box-shadow 0.18s, border 0.18s;
}

.session-time-block:hover, .session-time-block:focus-within {
  box-shadow: 0 4px 16px #eab30822;
  border-color: #eab30899;
}


/* Container for swipe effects */
/* General container for effects */
#swipe-effects {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  overflow: hidden;
}

/* Base element style */
.element-swipe {
  position: absolute;
  border-radius: 50%;
  opacity: 0.85;
  transform: translate(-50%, -50%) scale(0.8);
  animation: fadeOut 2s ease-out forwards;
  mix-blend-mode: screen;
}

/* Trail elements fade quicker */
.swipe-trail {
  opacity: 0.6;
  animation: fadeOutTrail 1.5s ease-out forwards;
}

/* ===== ELEMENT THEMES ===== */

/* üåä Water ‚Äî flowing blue waves */
.swipe-water {
  background: radial-gradient(circle, rgba(0,170,255,0.9), rgba(0,90,255,0.2));
  box-shadow: 0 0 20px rgba(0,160,255,0.8), 0 0 60px rgba(0,200,255,0.4);
  animation: ripple 2s ease-out forwards;
}

/* üî• Fire ‚Äî fiery pulse */
.swipe-fire {
  background: radial-gradient(circle, rgba(255,100,0,0.9), rgba(255,0,0,0.3));
  box-shadow: 0 0 20px rgba(255,80,0,0.9), 0 0 60px rgba(255,200,0,0.6);
  animation: flame 2s ease-out forwards;
}

/* üí® Air ‚Äî light white swirl */
.swipe-air {
  background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(200,255,255,0.3));
  box-shadow: 0 0 25px rgba(255,255,255,0.8), 0 0 60px rgba(180,255,255,0.4);
  animation: swirl 2s ease-out forwards;
}

/* üåç Earth ‚Äî grounding dust */
.swipe-earth {
  background: radial-gradient(circle, rgba(120, 72, 32, 0.95), rgba(80, 45, 20, 0.4));
  box-shadow:
    0 0 15px rgba(120, 72, 32, 0.8),
    0 0 45px rgba(139, 69, 19, 0.5),
    inset 0 0 8px rgba(255, 235, 200, 0.15);
  animation: ripple 2s ease-out forwards;
}

/* ‚ö° Lightning ‚Äî energetic spark */
.swipe-lightning {
  background: radial-gradient(circle, rgba(255,255,0,0.95), rgba(255,255,255,0.3));
  box-shadow: 0 0 25px rgba(255,255,0,0.9), 0 0 80px rgba(255,255,150,0.6);
  animation: spark 1.8s ease-out forwards;
}

/* ===== ANIMATIONS ===== */

/* Soft disappearance */
@keyframes fadeOut {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; }
}

@keyframes fadeOutTrail {
  0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.7; }
  100% { transform: translate(-50%, -50%) scale(1.4); opacity: 0; }
}

/* Element-specific magic */
@keyframes ripple {
  0% { transform: translate(-50%, -50%) scale(0.8); }
  50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
}

@keyframes flame {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  25% { transform: translate(-50%, -50%) scale(1.2) rotate(10deg); }
  50% { transform: translate(-50%, -50%) scale(0.9) rotate(-10deg); }
  75% { transform: translate(-50%, -50%) scale(1.3) rotate(6deg); }
}

@keyframes swirl {
  0% { transform: translate(-50%, -50%) scale(0.6) rotate(0deg); }
  100% { transform: translate(-50%, -50%) scale(1.6) rotate(180deg); opacity: 0; }
}

/* patchiness */
@keyframes crumble {
  0% {
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 1;
    filter: blur(0);
  }
  50% {
    transform: translate(-50%, -50%) scale(1.05);
    opacity: 0.9;
    filter: blur(0.5px);
  }
  100% {
    transform: translate(-50%, -50%) scale(1.25);
    opacity: 0;
    filter: blur(1.5px);
  }
}

@keyframes spark {
  0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
  50% { transform: translate(-50%, -50%) scale(1.4); opacity: 0.9; }
  100% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; }
}
.element-swipe:not(.swipe-trail) {
  width: 60px;
  height: 60px;
}

.atoms-signature {
  text-align: center;
  color: #fde68a;
  font-size: 0.9em;
  letter-spacing: 0.5px;
  
  opacity: 0.8;
  font-style: italic;
  animation: fadeInCosmic 3s ease-in-out 1;
}

@keyframes fadeInCosmic {
  0% { opacity: 0; transform: translateY(10px); }
  100% { opacity: 0.8; transform: translateY(0); }
}

/* Only apply animation when user is active in their country! */
#omusers-svg.rainbow {
  animation: hue-rotate-rainbow 2.8s linear infinite;
  filter:
    hue-rotate(0deg)
    saturate(2.5)
    brightness(1.4)
    drop-shadow(0 0 6px #fff2);
}

@keyframes hue-rotate-rainbow {
  0%   { filter: hue-rotate(0deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  14%  { filter: hue-rotate(52deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  28%  { filter: hue-rotate(104deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  42%  { filter: hue-rotate(156deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  57%  { filter: hue-rotate(208deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  71%  { filter: hue-rotate(260deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  85%  { filter: hue-rotate(312deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
  100% { filter: hue-rotate(360deg) saturate(2.5) brightness(1.4) drop-shadow(0 0 6px #fff2);}
}

.chakra-rotate {
  animation: chakraSpin 6.2s linear infinite;
  /* You can adjust duration for faster/slower spin */
}

@keyframes chakraSpin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

/* Resonance message aura classes */
#resonanceMsg.red         { color: #FF1A1A; text-shadow: 0 0 16px #FF1A1A99; }
#resonanceMsg.orange      { color: #FF8800; text-shadow: 0 0 16px #FF880099; }
#resonanceMsg.yellow      { color: #FFD600; text-shadow: 0 0 16px #FFD60099; }
#resonanceMsg.green       { color: #29D884; text-shadow: 0 0 16px #29D88499; }
#resonanceMsg.blue        { color: #3B82F6; text-shadow: 0 0 16px #3B82F6EE; }
#resonanceMsg.indigo      { color: #4338CA; text-shadow: 0 0 16px #4338CAEE; }
#resonanceMsg.violet      { color: #C026D3; text-shadow: 0 0 16px #C026D3EE; }
#resonanceMsg.gold        { color: #FFD700; text-shadow: 0 0 16px #FFD700DD; }
#resonanceMsg.silver      { color: #BFC9CA; text-shadow: 0 0 16px #BFC9CA99; }
#resonanceMsg.sapphire    { color: #1a4fcc; text-shadow: 0 0 16px #1a4fccee; }
#resonanceMsg.dark-silver { color: #606060EE; text-shadow: 0 0 16px #606060EE; }
#resonanceMsg.white       { color: #FFFFFF; text-shadow: 0 0 16px #FFFFFFCC; }

.om-flame-fire {
  color: #ffd700;
  font-weight: 900;
  font-size: 1.45rem;
  text-shadow:
    0 0 12px #ff8800cc,
    0 0 3px #ffd700cc,
    0 0 20px #ff440066;
  animation: flameFlicker 0.8s infinite alternate ease-in-out;
  -webkit-font-smoothing: antialiased;
  font-smooth: always;
  display: inline-block;
  transform-origin: center bottom;
  position: relative;
}

/* Smoke effect */
.om-flame-fire::after {
  content: 'üî•   üî•   üî•';
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 255, 255, 0.3);
  font-size: 0.8rem;
  letter-spacing: 2px;
  animation: smokeRise 3s infinite ease-out;
  opacity: 0;
  text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
}

@keyframes flameFlicker {
  0% {
    text-shadow:
      0 0 14px #ff8800bb,
      0 0 5px #ffd700bb,
      0 0 25px #ff440077;
    color: #ffd700;
    transform: scale(1) translateY(0);
  }
  25% {
    text-shadow:
      0 0 16px #ffaa00cc,
      0 0 7px #ffff00aa,
      0 0 28px #ff660088;
    color: #ffff00;
  }
  50% {
    text-shadow:
      0 0 18px #ff8800dd,
      0 0 9px #ffd700cc,
      0 0 32px #ff220099;
    color: #ffae42;
    transform: scale(1.05) translateY(-1px);
  }
  75% {
    text-shadow:
      0 0 14px #ff6600bb,
      0 0 6px #ff9900aa,
      0 0 26px #ff000066;
    color: #ff9500;
  }
  100% {
    text-shadow:
      0 0 24px #ffd70099,
      0 0 11px #ff8800aa,
      0 0 35px #ff4400aa;
    color: #ffae42;
    transform: scale(1.02) translateY(-0.5px);
  }
}

@keyframes smokeRise {
  0% {
    opacity: 0;
    transform: translateX(-50%) translateY(0) scale(0.8);
    filter: blur(0px);
  }
  20% {
    opacity: 0.4;
    transform: translateX(-50%) translateY(-10px) scale(1);
    filter: blur(1px);
  }
  40% {
    opacity: 0.3;
    transform: translateX(-50%) translateY(-20px) scale(1.1);
    filter: blur(2px);
  }
  60% {
    opacity: 0.2;
    transform: translateX(-50%) translateY(-30px) scale(1.2);
    filter: blur(3px);
  }
  80% {
    opacity: 0.1;
    transform: translateX(-50%) translateY(-40px) scale(1.3);
    filter: blur(4px);
  }
  100% {
    opacity: 0;
    transform: translateX(-50%) translateY(-50px) scale(1.4);
    filter: blur(5px);
  }
}
	
/* Grid ID aura classes */
#userIdDisplay.red      { color: #FF1A1A; text-shadow: 0 0 7px #FF1A1A99; border-color: #FF1A1A44; background: linear-gradient(90deg,#232526 0%, #FF1A1A22 100%); }
#userIdDisplay.orange   { color: #FF8800; text-shadow: 0 0 7px #FF880099; border-color: #FF880044; background: linear-gradient(90deg,#232526 0%, #FF880022 100%); }
#userIdDisplay.yellow   { color: #FFD600; text-shadow: 0 0 7px #FFD60099; border-color: #FFD60044; background: linear-gradient(90deg,#232526 0%, #FFD60022 100%); }
#userIdDisplay.green    { color: #29D884; text-shadow: 0 0 7px #29D88499; border-color: #29D88444; background: linear-gradient(90deg,#232526 0%, #29D88422 100%); }
#userIdDisplay.blue     { color: #3B82F6; text-shadow: 0 0 7px #3B82F6EE; border-color: #3B82F644; background: linear-gradient(90deg,#232526 0%, #3B82F622 100%); }
#userIdDisplay.indigo   { color: #4338CA; text-shadow: 0 0 7px #4338CAEE; border-color: #4338CA44; background: linear-gradient(90deg,#232526 0%, #4338CA22 100%); }
#userIdDisplay.violet   { color: #C026D3; text-shadow: 0 0 7px #C026D3EE; border-color: #C026D344; background: linear-gradient(90deg,#232526 0%, #C026D322 100%); }
#userIdDisplay.gold     { color: #FFD700; text-shadow: 0 0 7px #FFD700DD; border-color: #FFD70044; background: linear-gradient(90deg,#232526 0%, #FFD70022 100%); }
#userIdDisplay.silver   { color: #BFC9CA; text-shadow: 0 0 7px #BFC9CA99; border-color: #BFC9CA44; background: linear-gradient(90deg,#232526 0%, #BFC9CA22 100%); }
#userIdDisplay.sapphire { color: #1a4fcc; text-shadow: 0 0 7px #1a4fccee; border-color: #1a4fcc44; background: linear-gradient(90deg,#232526 0%, #1a4fcc22 100%); }
#userIdDisplay.dark-silver { color: #606060EE; text-shadow: 0 0 7px #606060EE; border-color: #60606044; background: linear-gradient(90deg,#232526 0%, #60606033 100%); }
#userIdDisplay.white    { color: #FFFFFF; text-shadow: 0 0 7px #FFFFFFCC; border-color: #FFF4; background: linear-gradient(90deg,#232526 0%, #fff2 100%); }

.chakra-glow {
  animation: chakraRainbow 2.4s linear infinite;
  font-weight: 600;
  transition: color 0.25s;
  /* For glow effect: */
  text-shadow: 0 0 8px #fff5, 0 0 2px #fff;
}

@keyframes chakraRainbow {
  0% { color: #FF1A1A; }    /* Red */
  17% { color: #FF8800; }   /* Orange */
  34% { color: #FFD600; }   /* Yellow */
  50% { color: #29D884; }   /* Green */
  66% { color: #3B82F6; }   /* Blue */
  83% { color: #C026D3; }   /* Violet */
  100% { color: #FF1A1A; }  /* Loop back to red */
}
	
.om-flame-heading-gradient {
  font-size: 1.21em;
  font-weight: 900;
  letter-spacing: 2px;
  background: linear-gradient(90deg, #FFD700 25%, #FF8800 75%, #fff 100%);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 12px #FFD70065, 0 0 2px #fff;
  animation: goldGlow 1.8s infinite alternate;
  display: inline-block;
  vertical-align: middle;
}

@keyframes goldGlow {
  from { text-shadow: 0 0 14px #FFD70088, 0 0 1px #fff; }
  to   { text-shadow: 0 0 30px #FFD700dd, 0 0 7px #fff; }
}

@keyframes pulse-flash {
  0% { color: #ffd700; background: none; }
  30% { color: #fff; background: #29D88455; }
  70% { color: #29D884; background: #ffd70066; }
  100% { color: #ffd700; background: none; }
}

body.lock-scroll {
  overflow: hidden !important;
  touch-action: none !important; /* more robust for some mobile browsers */
}


.modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(30,41,59,0.65);
  z-index: 99999;
  display: flex; align-items: center; justify-content: center;
}
.modal-content {
  background: #232626;
  padding: 1.5em 2em;
  border-radius: 16px;
  box-shadow: 0 4px 20px #444;
  color: #fde68a;
  min-width: 320px;
  text-align: center;
  border: 2px solid #eab308;
}
.modal-title {
  font-size: 1.2em;
  font-weight: bold;
  margin-bottom: .7em;
}
.modal-message {
  margin-bottom: 1.1em;
}
.modal-actions button {
  background: #fde68a;
  color: #232626;
  font-weight: bold;
  border: none;
  padding: 0.6em 1.4em;
  margin: 0 .7em;
  border-radius: 7px;
  font-size: 1em;
  cursor: pointer;
  box-shadow: 0 2px 7px #eab30833;
}
.modal-actions button:hover {
  background: #eab308;
  color: #232626;
}
.hidden {
  display: none !important;
}

.looping {
  background: radial-gradient(circle at center, #ffd70044 0%, #fffbe6 100%);
  box-shadow: 0 0 12px #ffd70099;
  animation: loopingBgPulse 0.79s both;
}
@keyframes loopingBgPulse {
  0%, 100% { background-size: 100% 100%; }
  50% { background-size: 120% 120%; }
}

</style>
  
<!-- 1. Load bs58 via Skypack and attach to window -->
  <script type="module">
    import bs58 from 'https://cdn.skypack.dev/bs58';
    window.bs58 = bs58;
    window.bs58Ready = true;
    window.dispatchEvent(new Event('bs58-ready'));
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="text-white flex items-center justify-center min-h-screen px-4 py-8">
<canvas id="particles-canvas" class="hidden fixed top-0 left-0 w-full h-full z-0 pointer-events-none opacity-10"></canvas>
<canvas id="meditation-canvas" class="hidden"></canvas>

<!-- Persistent Sync Auth Banner -->
<div id="sync-auth-banner" style="display:none; background:#fde68a; color:#1e293b; font-weight:bold; text-align:center; padding:0.75em; z-index:1001; position:fixed; top:0; left:0; width:100%;">
  <span>Your session(s) need Verification. </span>
  <button onclick="promptVerifyAndSync()" style="background:#eab308; color:#222; margin-left:1em; font-weight:bold; border-radius:6px; padding:0.4em 1.2em; cursor:pointer;">Verify Now</button>
</div>

  <div id="app-loader" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-80 z-50"> <!-- 24 -->
    <div class="loader-spinner"></div>
	     <div class="loader-overlay">
    <!-- Video backgrounds -->
    <video src="/assets/cosmos.mp4" class="cosmic-bg active" autoplay loop muted playsinline preload="none"></video>
    <video src="/assets/merkaba.mp4" class="cosmic-bg" autoplay loop muted playsinline preload="none"></video>	
    <video src="/assets/sriyantra.mp4" class="cosmic-bg" autoplay loop muted playsinline preload="none"></video>
	
   <!-- <video src="/assets/mandala.mp4" class="cosmic-bg" autoplay loop muted playsinline preload="none"></video>
    <video src="/assets/floweroflife.mp4" class="cosmic-bg" autoplay loop muted playsinline preload="none"></video> -->
	
    </div>
</div>	
<!-- Service Worker Status Indicator -->
<div id="sw-status" style="display: none;"></div>

  <!-- Welcome Message Modal -->
  <div id="welcome-message" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="welcome-heading">
  <div class="welcome-message max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-lotus"></i>
    </div>
    <h2 id="welcome-heading" class="text-xl font-semibold text-yellow-300 mb-2"></h2>
    <p class="text-gray-200 mb-4" id="welcome-text"></p>
    <button id="welcome-button" onclick="closeWelcomeMessage()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      Continue Journey
    </button>
  </div>
</div>

<!-- Start Meditation Confirmation Modal -->
<div id="start-meditation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-spa"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Enter Sacred Stillness</h2>
    <p class="text-gray-200 mb-4" id="meditation-confirmation-text">
      The Universe bows to your Silence. This flow session will last 30 minutes. Read the guidance, find quiet place, sit with grace, and gently return to the Breath within.
    </p>

    <!-- Collapsible Info Section -->
    <button id="info-toggle-btn"  
            class="info-glow bg-gray-700/30 text-yellow-300 rounded-full px-3 py-1 mb-2 text-sm font-medium flex items-center gap-2 mx-auto"
            style="border:none;outline:none;cursor:pointer;">
      <i class="fas fa-info-circle fa-shake"></i>
      <span id="info-toggle-btn-text" How does this work?></span>
    </button>
    <div id="info-section" class="bg-gray-700/30 rounded-lg p-3 mb-3 text-left text-sm text-gray-200" style="display:none;">
      <b id="info-section-title"> How it works:</b><br>
      <span id="info-section-line1"> Once you start meditation, the timer runs until the selected duration ends.</span><br>
      <span id="info-section-line2"> You may keep the app open, close it, or move about‚Äîyour session continues.</span><br>
      <span id="info-section-line3"> Ending early will mark the session as incomplete.</span><br>
      <span class="text-yellow-300" id="info-section-line4">During the session, remember: meditation continues even if life interrupts. As long as you gently return to your breath and awareness, your presence is the practice.</span>
    </div>
    <div class="flex justify-center gap-4">
      <button onclick="confirmStartMeditation()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
        Begin Stillness
      </button>
      <button onclick="cancelStartMeditation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Not Yet
      </button>
    </div>
  </div>
</div>

  <!-- End Meditation Confirmation Modal -->
  <div id="end-meditation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
      <div class="text-red-400 text-5xl mb-4">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <h2 class="text-xl font-semibold text-red-300 mb-2">End Meditation?</h2>
      <p id="end-meditation-description" class="text-gray-200 mb-4">Are you sure you wish to end this session early? This time of Stillness won‚Äôt be recorded in your TrueYogi journey.</p>
      <div class="flex justify-center gap-4">
        <button onclick="confirmEndMeditation()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
          End Session
        </button>
        <button onclick="cancelEndMeditation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
          Continue Meditation
        </button>
      </div>
    </div>
  </div>

  <!-- Completed Sessions Alert Modal -->
  <div id="completed-sessions-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
      <div class="text-green-400 text-5xl mb-4">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2 class="text-xl font-semibold text-green-300 mb-2">Daily Sessions Complete</h2>
      <p class="text-gray-200 mb-4" id="completed-sessions-text"></p>
      <button id="completed-sessions-modal-btn" onclick="closeCompletedSessionsModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Continue Journey
      </button>
    </div>
  </div>

  <!-- Session Time Alert Modal -->
  <div id="session-time-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
      <div class="text-yellow-400 text-5xl mb-4">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h2 class="text-xl font-semibold text-yellow-300 mb-2">Session Time Restriction</h2>
      <p id="session-time-modal-description" class="text-gray-200 mb-4">You can only start a session within 10 minutes before or after your set time. Check your next session to align.</p>
      <button onclick="closeSessionTimeModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
        OK
      </button>
    </div>
  </div>

  <!-- Next Session Info Modal -->
  <div id="next-session-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
      <div class="text-blue-400 text-5xl mb-4">
        <i class="fas fa-bell"></i>
      </div>
      <h2 id="next-session-modal-heading" class="text-xl font-semibold text-blue-300 mb-2">Next Session</h2>
      <p class="text-gray-200 mb-4" id="next-session-text"></p>
      <button id="next-session-modal-btn" onclick="closeNextSessionModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        OK
      </button>
    </div>
  </div>

  <!-- Missed Session Modal -->
 <div id="missed-session-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2" id="missed-session-modal-title"></h2>
    <p class="text-gray-200 mb-4" id="missed-session-modal-text"></p>
    <div class="flex justify-center gap-4">
      <button onclick="reconfigureChallenge()" id="missed-session-modal-reconfigure" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer"></button>
      <button onclick="switchToFlowMode()" id="missed-session-modal-flowmode" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer"></button>
    </div>
  </div>
</div>

  <!-- Reset Confirmation Modal -->
<div id="reset-confirmation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="config-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-red-400 text-5xl mb-4">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 class="text-xl font-semibold text-red-300 mb-2">Reset TrueYogi Stillness?</h2>
    <p id="reset-description" class="text-gray-200 mb-4">The circle Resets. Are you sure you wish to Reset your 41-day Sacred Sits? All progress will be cleared, and a new Vibration must be chosen.</p>
    <div class="flex justify-center gap-4">
      <button onclick="confirmResetChallenge()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Confirm Reset
      </button>
      <button onclick="closeResetConfirmation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</div>

  <!-- TrueYogi Configuration Modal -->
  <div id="yogi-config-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
    <div class="config-modal max-w-md mx-4 p-6 rounded-xl text-center max-h-[80vh] overflow-y-auto relative">
	
      <button onclick="returnToModeSelection()" class="absolute top-2 right-2 text-gray-400 hover:text-white text-lg font-bold cursor-pointer">
        <i class="fa-solid fa-circle-xmark fa-1xs" style="color: #FFD43B;"></i>
      </button>
      <div class="mb-4">
      <div class="text-yellow-400 text-4xl mb-2">
        <i class="fas fa-yin-yang mr-2" style="animation: smooth-rotate 6s linear infinite;"></i>
      </div>
      <h2 class="text-xl font-semibold text-yellow-300 mb-1">Configure Your TrueYogi Journey</h2>
      <p id="yogi-config-modal-41" class="text-gray-300 text-sm">41 Days ‚Ä¢ 41 Sacred Sits</p>
    </div>

    <!-- Quick Steps (icon + short text) -->
    <div class="bg-gray-700/50 rounded-lg p-3 mb-4 text-left">
      <div class="flex items-start mb-2">
        <div class="text-yellow-400 mr-2 mt-0.5"><i class="fas fa-calendar-day text-sm"></i></div>
        <div id="yogi-config-modalstart" class="text-gray-300 text-sm">Select your start date</div>
      </div>
      <div class="flex items-start mb-2">
        <div class="text-yellow-400 mr-2 mt-0.5"><i class="fas fa-clock text-sm"></i></div>
        <div id="yogi-config-modalTimes" class="text-gray-300 text-sm">Choose 1-3 daily Session Times (3h gap)</div>
      </div>
      <div class="flex items-start mb-2">
        <div class="text-yellow-400 mr-2 mt-0.5"><i class="fas fa-hourglass-half text-sm"></i></div>
        <div id="yogi-config-modalduration" class="text-gray-300 text-sm">Set duration (fixed for all days)</div>
      </div>
      <div class="flex items-start">
        <div class="text-yellow-400 mr-2 mt-0.5"><i class="fas fa-bell text-sm"></i></div>
        <div id="yogi-config-modalwindow" class="text-gray-300 text-sm">¬±10 minute window to start sessions</div>
      </div>
	  <div class="flex items-start">
		<div class="text-yellow-400 mr-2 mt-0.5"><i class="fas fa-fire text-sm"></i></div>
		<div id="yogi-config-modalstreak" class="text-gray-300 text-sm">Complete all daily sessions to maintain streak</div>
	  </div>
    </div>

<div id="token-preview" class="token-preview hidden">
  <i class="fas fa-coins"></i>
  <span id="token-amount">0</span>
</div>

    <!-- Configuration Form -->
    <div class="text-left mb-4">
      <label id="yogi-config-selectstart" for="start-date" class="block text-sm text-gray-400 mb-1">Start Date:</label>
      <input type="date" id="start-date" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg mb-4" required>
      
      <div class="flex justify-between items-center mb-2">
        <label id="yogi-config-selecttimes" class="block text-sm text-gray-400">Session Times:</label>
        <button id="yogi-config-addsessions" onclick="addSessionTimeInput()" class="text-blue-400 hover:text-blue-300 text-xs cursor-pointer">
          <i class="fas fa-plus mr-1"></i>Add Sessions
        </button>
      </div>
      
      <div id="session-times-inputs" class="mb-2">
	    <label id="session-times-label" class="block text-sm text-gray-400 mb-2"></label>
        <div id="session-time-1" class="session-time-block flex flex-col sm:flex-row gap-2 mb-3">
          <input type="time" class="flex-1 bg-gray-800 text-white px-4 py-2 rounded-lg" required>
          <select id="duration-1" class="flex-1 bg-gray-800 text-white px-4 py-2 rounded-lg">
            <option value="60">1 min</option>
            <option value="180">3 min</option>
            <option value="780">13 min</option>
            <option value="1800" selected>30 min</option>
            <option value="3600">60 min</option>
          </select>
        </div>
      </div>
    </div>
	  
      <p id="config-error" class="text-red-400 text-sm mb-3 hidden"></p>
	  
      <button id="begin-journey" onclick="saveYogiConfig()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-3 rounded-lg font-medium cursor-pointer transition">
      <i class="fas fa-check-circle mr-2"></i> Begin Journey
    </button>
    </div>
  </div>

  <div class="w-full max-w-md">
  
  <!-- Claim Tokens Required Modal -->
<div id="claim-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-coins"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Claim Required</h2>
    <p class="text-gray-200 mb-4">Please claim your YOGI tokens before starting a new journey.<br></p>
    <button onclick="handleClaimRequiredOk()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK
    </button>
  </div>
</div>

<!-- Authentication Required Modal -->
<div id="auth-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-key"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Verification Needed</h2>
    <p class="text-gray-200 mb-4">
      <span id="auth-required-modal-line1">To access your meditation journey securely,</span><br>
      <span id="auth-required-modal-line2">Smoothly. please verify your wallet.</span><br>
      <span id="auth-required-modal-verify" class="block mt-2 text-yellow-400">Click "Verify Identity".</span>
    </p>
    <button onclick="closeAuthRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK, I Understand
    </button>
  </div>
</div>

<!-- Sync Auth Required Modal -->
<div id="sync-auth-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-key"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Verification Required</h2>
    <p class="text-gray-200 mb-4">
      To record your meditation in the space,<br>
      please verify your wallet.<br>
      <span class="block mt-2 text-yellow-400">Click "Verify Identity" to secure your journey.</span>
    </p>
    <button onclick="closeSyncAuthRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK, I Understand
    </button>
  </div>
</div>

<!-- Wallet Required Modal (Day 21+) -->
<div id="wallet-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-wallet"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Connect Your Wallet</h2>
    <p class="text-gray-200 mb-4">
      To continue your sacred journey beyond 21 days, please connect and verify your wallet.<br>
      This ensures your progress and rewards are secure.
    </p>
    <div class="flex flex-col gap-3">
      <button onclick="connectWalletForDay21()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-3 rounded-lg font-semibold cursor-pointer">
        <i class="fas fa-wallet mr-2"></i> Connect Wallet
      </button>
      <button onclick="resetChallengeForDay21()" class="w-full bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-semibold cursor-pointer">
        <i class="fas fa-redo mr-2"></i> Reset Challenge
      </button>
    </div>
  </div>
</div>

<!-- Mobile Device Required Modal (Day 21+) -->
<div id="mobile-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-mobile-alt"></i>
    </div>
    <h2 id="mobile-required-heading" class="text-xl font-semibold text-yellow-300 mb-2">Continue on Mobile</h2>
    <p id="mobile-required-paragraph" class="text-gray-200 mb-4">
      To continue your 41-day journey beyond day 21,<br>
      please use your mobile device.<br>
      and carry your meditation with you, wherever you are.
    </p>
    <button id="mobile-required-button" onclick="closeMobileRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK, I Understand
    </button>
  </div>
</div>

<!-- Mobile Device Required Modal 2 (Day 21+) -->
<div id="desktop-yogi-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="bg-gray-800 rounded-xl shadow-lg max-w-md w-full p-6 text-center">
    <div class="text-yellow-400 text-4xl mb-2">
      <i class="fas fa-desktop"></i>
    </div>
    <h2 id="desktop-yogi-modal-heading" class="text-lg font-semibold text-yellow-300 mb-2">Unlock WEB3 Rewards</h2>
    <p id="desktop-yogi-modal-paragraph" class="text-gray-200 mb-4"></p>
    <button id="desktop-yogi-modal-button" onclick="closeDesktopYogiModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">OK</button>
  </div>
</div>

<!-- Mobile Device Required Modal (for mobile browsers excluding Phantom) -->
<div id="mobile-yogi-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="bg-gray-800 rounded-xl shadow-lg max-w-md w-full p-6 text-center">
    <div class="text-yellow-400 text-4xl mb-2">
      <i class="fas fa-mobile-alt"></i>
    </div>
    <h2 id="mobile-yogi-modal-heading" class="text-lg font-semibold text-yellow-300 mb-2">Unlock WEB3 Rewards</h2>
    <p id="mobile-yogi-modal-paragraph" class="text-gray-200 mb-4">      
    </p>
    <button id="mobile-yogi-modal-button" onclick="closeMobileYogiModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">OK</button>
  </div>
</div>

<!-- Mode Selection Screen -->
<div id="mode-selection" class="bg-gray-800 rounded-2xl shadow-xl p-6 mb-6 fade-in card-aura">
  <div class="text-center">
    <div class="flex justify-center mb-4">
		    <!-- Lungs (place here, below logo, above title) -->
    <div id="pull-refresh-spinner">
      <img src="/assets/lungs.svg" alt="Lungs Icon" width="40" height="40" class="breathing-lungs">
    </div>
<div class="w-32 h-32 rounded-full overflow-hidden shadow-md glow" style="position:relative;">
<div id="om-mute-toggle" style="
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  width: 13px;
  height: 13px;
  border-radius: 50%;
  background: transparent;
  z-index: 10;
"></div>
  <img id="logo-sacred" src="/assets/icrown3.png" alt="Sacred Symbol" class="w-full h-full object-cover" draggable="false" onmousedown="return false;" style="user-select:none;-webkit-user-drag:none;">
<div id="lotus-eye-flare"
     style="
       position:absolute;
       left:50%; top:74%;
       transform:translate(-50%,-50%);
       width:3px; height:3px;
       pointer-events:none;
       border-radius:50%;
       background: radial-gradient(circle at 50% 48%, #ffe4ef 0%, #fbb6ce 45%, #f472b6 80%, #0000 100%);
       box-shadow:
         0 0 8px 4px #fbb6ce,
         0 0 15px 7px #f472b6,
         0 0 21px 11px #f472b688;
       opacity: 1;
       z-index: 2;
       transition: opacity 0.4s;
       animation: lotusEyeFireGlow 21s infinite alternate;
     "></div>
</div>
    </div>

	
    <h2 class="calm-heading text-yellow-200 text-2xl md:text-3xl font-playfair italic leading-relaxed text-shadow mt-4">
      Awaken within
    </h2>
    <!-- Shining Silver-Gray Text -->
    <p class="text-gray-300 text-sm mt-2 italic font-playfair opacity-90 text-shadow-md subdued-path-text">
      Choose Your Meditation Path
    </p>

    <div class="space-y-4 mt-6">
      <button id="flow-mode-btn-select" onclick="selectMode('flow')" class="mode-btn relative w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-xl font-semibold text-lg transition flex items-center justify-start gap-4 cursor-pointer">
        <i class="fa-solid fa-water fa-fade"></i>
        <div class="flex flex-col items-center text-center">
          <span class="text-base leading-tight">Flow</span>
          <span class="text-sm font-normal text-blue-200">Meditate Anytime Freely</span>
        </div>
      </button>
      <button id="yogi-mode-btn-select" onclick="selectMode('yogi')" class="mode-btn relative w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-4 rounded-xl font-semibold text-lg transition flex items-center justify-start gap-4 cursor-pointer">
  <i id="yogi-sun-icon" class="fa-solid fa-sun"></i> <!-- Removed fa-spin here -->
  <div class="flex flex-col items-center text-center">
    <span class="text-base leading-tight">TrueYogi</span>
    <span class="text-sm font-normal text-yellow-900">41 Days, 41 Sacred Sits</span>
  </div>
</button>
    </div>
	
<div id="om-counter" class="om-counter"></div>

<!-- Desktop-only Mobile Reminder Card -->
<div id="mobile-reminder-card" class="auth-card hidden" style="margin: 1.5em auto 0 auto; max-width: 330px; text-align: center;">
  <div class="text-yellow-400 text-3xl mb-2">
    <i class="fas fa-mobile-alt"></i>
  </div>
<h3 class="text-lg font-semibold text-yellow-300 mb-1" id="mobile-reminder-heading"></h3>
<p class="text-gray-300 mb-3" id="mobile-reminder-paragraph"></p>
<div class="bg-yellow-900/20 p-2 rounded-lg text-yellow-100 text-sm mb-1">
  <span class="italic" id="mobile-reminder-peaceflow"></span>
</div>
</div>


    <!-- Auth Sections - Side by Side -->
    <div class="auth-section-container">
     <div class="auth-card">
     <h3 class="auth-title">WEB3 SPACE</h3>
    
    <div class="auth-content">
      <!-- Wallet Connection -->
      <button id="wallet-action-btn" class="wallet-connect-btn">
        <span class="btn-icon"><i class="fas fa-wallet"></i></span>
        <span id="wallet-btn-text" class="btn-text">Connect Wallet</span>
        <span class="btn-glow"></span>
      </button>
      
      <!-- Authentication (hidden by default) -->
      <button id="auth-wallet-btn" class="wallet-auth-btn hidden">
        <span class="btn-icon"><i class="fas fa-key"></i></span>
        <span id="verify-identity-btn" class="btn-text">Verify Identity</span>
        <span class="btn-glow"></span>
      </button>
      
      <!-- Status Message -->
      <div id="wallet-status" class="wallet-status-message" aria-live="polite"></div>
      </div>
    </div>
  </div>
  
  </div>
</div>

 <!-- FAQ Tab -->
<div id="faq-tab" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-yellow-300 px-4 py-2 rounded-t-lg cursor-pointer z-40 border border-yellow-400 font-semibold flex items-center gap-2" style="font-size: 1.15rem;">
  <span style="font-size: 1.5em;"></span>
  <span>üßò</span>
</div>

<!-- FAQ Modal -->
<div id="faq-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 rounded-xl max-w-md w-full max-h-[80vh] overflow-y-auto p-6" style="min-height:480px;  border: 2px solid #eab308; box-shadow: 0 0 25px rgba(234, 179, 8, 0.3); scrollbar-width: thin; scrollbar-color: #fde68a #000000;">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-yellow-300" id="faq-heading"></h2>
	  <button onclick="closeFAQModal()" class="text-yellow-400 hover:text-white text-2xl cursor-pointer">&times;</button>
    </div>
    
<!-- Inside the FAQ Modal -->
<div class="border-b border-gray-700 mb-4">
  <button id="meditation-faq-tab" class="tab-button active px-4 py-2 text-yellow-300 font-medium border-b-2 border-yellow-400 cursor-pointer">
    Meditation
  </button>
  <button id="app-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
    App
  </button>
  <button id="dapp-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
    Web3
  </button>
  <!-- Add this new rewards tab -->
  <button id="rewards-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
    Rewards
  </button> 
    <button id="unseen-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
  üîÆ
</button>
    <button id="certificate-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
  <i class="fa-solid fa-award mr-2" style="color: #D4AF37;"></i>
</button>
    <button id="reset-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
    ‚ôªÔ∏è
  </button>
      <button id="about-faq-tab" class="tab-button px-4 py-2 text-gray-400 font-medium border-b-2 border-transparent cursor-pointer">
  üìú
</button>
</div>

    <!-- Meditation FAQ Content -->
    <div id="meditation-faq-content" class="space-y-4">
      <div class="faq-item">
        <h3 id="faq-q1" class="text-yellow-200 font-medium"> </h3>
        <p id="faq-a1" class="text-gray-300 mt-1"></p>
      </div>
	 
      <div class="faq-item">
        <h3 id="faq-q2" class="text-yellow-200 font-medium"> </h3>
        <p id="faq-a2" class="text-gray-300 mt-1"> </p>
      </div>
	  
      <div class="faq-item">
        <h3 id="faq-q3" class="text-yellow-200 font-medium"> </h3>
        <p id="faq-a3" class="text-gray-300 mt-1"> </p>
      </div>
      
      <div class="faq-item">
        <h3 id="faq-q4" class="text-yellow-200 font-medium"> </h3>
        <p id="faq-a4" class="text-gray-300 mt-1"> </p>
      </div>
                  
      <div class="faq-item">
        <h3 id="faq-q5" class="text-yellow-200 font-medium"> </h3>
        <p id="faq-a5" class="text-gray-300 mt-1"> </p>
      </div>
    </div>
  
	<!-- App FAQ Content -->
<div id="app-faq-content" class="space-y-4 hidden">
  <div class="faq-item">
    <h3 id="app-faq-q1" class="text-yellow-200 font-medium"> </h3>
    <p id="app-faq-a1" class="text-gray-300 mt-1"> </p>
  </div>
  
  <div class="faq-item">
    <h3 id="app-faq-q2" class="text-yellow-200 font-medium"> </h3>
    <p id="app-faq-a2" class="text-gray-300 mt-1"> </p>
  </div>
    
  <div class="faq-item">
    <h3 id="app-faq-q3" class="text-yellow-200 font-medium"> </h3>
    <p id="app-faq-a3" class="text-gray-300 mt-1"> </p>
  </div>
    
  <div class="faq-item">
    <h3 id="app-faq-q4" class="text-yellow-200 font-medium"> </h3>
    <p id="app-faq-a4" class="text-gray-300 mt-1"></p>
  </div>
  
  <div class="faq-item">
    <h3 id="app-faq-q5" class="text-yellow-200 font-medium"> </h3>
    <p id="app-faq-a5" class="text-gray-300 mt-1"> </p>
  </div>
  
<div class="faq-item">
  <h3 id="faq-wallet-question" class="text-yellow-200 font-medium flex items-start">
    <span class="mr-2 text-yellow-400">üïäÔ∏è</span>
    <!-- Will be filled by JS -->
  </h3>
  <div class="pl-6 mt-3 space-y-3">
    <div class="relative">
      <p class="text-gray-300">
        <span class="text-yellow-300" id="faq-wallet-21days-label"></span>
        <span id="faq-wallet-21days-text"></span>
      </p>
    </div>
    <div class="relative">
      <p class="text-gray-300">
        <span class="text-yellow-300" id="faq-wallet-beyond-label"></span>
        <span id="faq-wallet-beyond-text"></span>
      </p>
    </div>
    <div class="ml-4 pl-4 border-l-2 border-yellow-400/20 space-y-3">
      <div class="flex items-start">
        <span class="mr-2 mt-1 text-yellow-400 text-sm">‚§∑</span>
        <div>
          <p class="text-gray-300 font-medium" id="faq-wallet-anew-title"></p>
          <p class="text-gray-400 text-sm" id="faq-wallet-anew-desc"></p>
          <p class="text-yellow-300/90 text-xs mt-1 italic" id="faq-wallet-anew-note"></p>
        </div>
      </div>
    </div>
    <div class="bg-yellow-900/20 p-3 rounded-lg mt-3">
      <p class="text-yellow-300 text-sm italic" id="faq-wallet-ending-quote"></p>
    </div>
  </div>
</div>
</div>
  
    <!-- DApp FAQ Content -->
    <div id="dapp-faq-content" class="space-y-4 hidden">
      <div class="faq-item">
        <h3 id="dapp-faq-q1" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a1" class="text-gray-300 mt-1"> </p>
      </div>

      <div class="faq-item">
        <h3 id="dapp-faq-q2" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a2" class="text-gray-300 mt-1"> </p>
      </div>
      
      <div class="faq-item">
        <h3 id="dapp-faq-q3" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a3" class="text-gray-300 mt-1"> </p>
      </div>
      
      <div class="faq-item">
        <h3 id="dapp-faq-q4" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a4" class="text-gray-300 mt-1"> </p>
      </div>
      
      <div class="faq-item">
        <h3 id="dapp-faq-q5" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a5" class="text-gray-300 mt-1"> </p>
      </div>
	 
      <div class="faq-item">
        <h3 id="dapp-faq-q6" class="text-yellow-200 font-medium"> </h3>
        <p id="dapp-faq-a6" class="text-gray-300 mt-1"> </p>
      </div>
	  
	  <div class="faq-item" id="faq-token-address">
  <h3 class="text-yellow-200 font-medium" id="faq-token-address-question"></h3>
  <p class="text-gray-300 mt-1">
    <span id="faq-token-address-answer"></span><br>
    <strong id="faq-token-mint-label"></strong><br>
    <div style="position:relative; display:inline-block;">
      <code id="yogi-mint" style="cursor:pointer;"></code>
      <span id="faq-token-copy-tip" style="opacity:0; margin-left:8px; color:#4CAF50; font-size:0.9em; transition:opacity 0.3s;"></span>
    </div>
    <br>
    üîó <a id="faq-token-explorer-link" href="#" target="_blank" style="color:#fde68a; text-decoration:underline;"></a>
  </p>
</div>

    </div>
	
	<!-- Rewards FAQ Content -->
<div id="rewards-faq-content" class="space-y-4 hidden">
  <div class="faq-item">
    <div id="rewards-faq-heading" class="font-semibold text-yellow-200 mb-1"> </div>
    <div id="rewards-faq-intro" class="text-gray-300 mb-2"> </div>
    
    <div class="mt-4 overflow-x-auto">
      <table class="w-full text-sm text-center border-collapse">
        <thead>
          <tr class="bg-yellow-900/30 text-yellow-200">
            <th id="rewards-faq-table-session" class="p-2 border border-yellow-800"> </th>
            <th id="rewards-faq-table-tokens" class="p-2 border border-yellow-800"> </th>
            <th id="rewards-faq-table-41max" class="p-2 border border-yellow-800"> </th>
            <th id="rewards-faq-table-yearly" class="p-2 border border-yellow-800"> </th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">1 min</td>
            <td class="p-2 border border-yellow-800">YÃê10</td>
            <td class="p-2 border border-yellow-800">YÃê30</td>
            <td class="p-2 border border-yellow-800">~YÃê270</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">3 min</td>
            <td class="p-2 border border-yellow-800">YÃê30</td>
            <td class="p-2 border border-yellow-800">YÃê90</td>
            <td class="p-2 border border-yellow-800">~YÃê810</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">13 min</td>
            <td class="p-2 border border-yellow-800">YÃê130</td>
            <td class="p-2 border border-yellow-800">YÃê390</td>
            <td class="p-2 border border-yellow-800">~YÃê3,510</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">30 min</td>
            <td class="p-2 border border-yellow-800">YÃê300</td>
            <td class="p-2 border border-yellow-800">YÃê900</td>
            <td class="p-2 border border-yellow-800">~YÃê8,100</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">60 min</td>
            <td class="p-2 border border-yellow-800">YÃê600</td>
            <td class="p-2 border border-yellow-800">YÃê1,800</td>
            <td class="p-2 border border-yellow-800">~YÃê16,200</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">90 min</td>
            <td class="p-2 border border-yellow-800">YÃê900</td>
            <td class="p-2 border border-yellow-800">YÃê2,700</td>
            <td class="p-2 border border-yellow-800">~YÃê24,300</td>
          </tr>
          <tr class="border-b border-yellow-800/50 hover:bg-yellow-900/10">
            <td class="p-2 border border-yellow-800">180 min</td>
            <td class="p-2 border border-yellow-800">YÃê1,800</td>
            <td class="p-2 border border-yellow-800">YÃê5,400</td>
            <td class="p-2 border border-yellow-800">~YÃê48,600</td>
          </tr>
         
        </tbody>
      </table>
    </div>
    
    <div class="mt-4 bg-yellow-900/20 p-3 rounded-lg">
    <ul class="list-disc list-inside space-y-1 text-gray-300">
      <li id="rewards-faq-note1"></li>
      <li id="rewards-faq-note2"></li>
      <li id="rewards-faq-note3"></li>
    </ul>
  </div>
  
  <div id="rewards-faq-cta" class="mt-6 text-center text-yellow-200 text-base font-semibold italic">
       
    </div>
  </div>
</div>
    
	<!-- About FAQ Content -->
	<div id="about-faq-content" class="space-y-4 hidden">
  <div class="faq-item">
    <h3 class="text-white-200 font-medium">Whitepaper</h3>
    <p class="text-gray-300 mt-1">
      <a href="/whitepaper.html" target="_blank" style="color:#ffffff; text-decoration:underline;">Read our Whitepaper</a>
    </p>
  </div>	
  <div class="faq-item">
    <h3 class="text-yellow-200 font-medium">Terms & Conditions</h3>
    <p class="text-gray-300 mt-1">
      <a href="/terms.html" target="_blank" style="color:#fde68a; text-decoration:underline;">Read our Terms & Conditions</a>
    </p>
  </div>
  <div class="faq-item">
    <h3 class="text-yellow-200 font-medium">Privacy Policy</h3>
    <p class="text-gray-300 mt-1">
      <a href="/privacy.html" target="_blank" style="color:#fde68a; text-decoration:underline;">Read our Privacy Policy</a>
    </p>
  </div>
  <div class="faq-item">
  <h3 class="text-yellow-200 font-medium">Contact</h3>
  <p class="text-gray-300 mt-1">
    <i class="fas fa-envelope text-yellow-200"></i>
    <a href="mailto:light@trueyogi.app" 
       style="color:#fde68a; text-decoration:underline;">
       light@trueyogi.app
    </a>
  </p>
  <p class="text-gray-400 text-sm italic">
    Our silence is intentional ‚Äî trust the App to guide your journey.
  </p>
</div>

 <div style="display: flex; justify-content: center; margin-top: 6em; margin-bottom: 7em;">
  <i class="fas fa-praying-hands" style="font-size: 2.3em; color: #fde68a;"></i>
</div>
  
      <!-- Cosmic Signature -->
<div class="atoms-signature">
  Built by atoms, awakening atoms, for atoms to remember their Source.
</div>

</div>

<!-- Reset  Content -->
<div id="reset-faq-content" class="space-y-4 hidden">
<div class="faq-item" id="faq-reset-yogi-config">
  <h3 class="text-yellow-200 font-medium">{{t('resetYogiConfigHeading')}}</h3>
  <p class="text-gray-300 mt-1">{{t('resetYogiConfigDescription')}}</p>
  <div class="mt-4">
    <button onclick="showResetConfirmation()" class="w-full bg-orange-400 hover:bg-orange-500 text-white py-2 rounded-lg font-medium cursor-pointer">
      <i class="fas fa-redo mr-2"></i> {{t('resetYogiConfigButton')}}
    </button>
  </div>
</div>

  <div class="faq-item">
    <h3 id="reset-faq-heading" class="text-yellow-200 font-medium">Reset All App Data</h3>
    <p id="reset-faq-description" class="text-gray-300 mt-1">This will completely reset the app, removing all your meditation history, wallet connections, and settings. Use this if you want to start fresh.</p>
    <div class="mt-4">
      <button onclick="showFullResetConfirmation()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-medium cursor-pointer">
        <i class="fas fa-trash-alt mr-2"></i> <span id="reset-faq-button"></span>
      </button>
    </div>
  </div>
  
     <div class="faq-item">
  <h3 id="faq-clear-cache-heading" class="text-yellow-200 font-medium">Clear App Cache</h3>
  <p id="faq-clear-cache-description" class="text-gray-300 mt-1">
    Clear downloaded app data and reload fresh content. Useful if app has issues.
  </p>
  <div class="mt-4">
    <button id="faq-clear-cache-btn" onclick="showClearCacheModal()" class="w-full bg-blue-400 hover:bg-blue-500 text-white py-2 rounded-lg font-medium cursor-pointer">
      <i class="fas fa-broom mr-2"></i> Clear Cache & Reload
    </button>
  </div>
</div>
</div>

<div id="unseen-faq-content" class="space-y-4 hidden">
  <div class="faq-item">
    <h3 id="unseen-faq-q1" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a1" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q2" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a2" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q3" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a3" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q4" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a4" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q5" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a5" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q6" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a6" class="text-gray-300 mt-1"></p>
  </div>
  <div class="faq-item">
    <h3 id="unseen-faq-q7" class="text-yellow-200 font-medium"></h3>
    <p id="unseen-faq-a7" class="text-gray-300 mt-1"></p>
  </div>
</div>

<!-- Certificate  Content -->
<div id="certificate-faq-content" class="space-y-4 hidden"></div>

    <button onclick="closeFAQModal()" class="mt-6 w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 py-2 rounded-lg cursor-pointer">
      Close
    </button>
  </div>
</div>

  <!-- Mobile-wallet-modal -->
<div id="mobile-wallet-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-60">
  <div class="bg-gray-800 rounded-xl shadow-lg max-w-sm w-full p-6 text-center">
    <div class="text-yellow-400 text-4xl mb-2">
      <i class="fas fa-mobile-alt"></i>
    </div>
    <h2 id="phantom-wallet-heading" class="text-lg font-semibold text-yellow-300 mb-2">Open Phantom Wallet?</h2>
    <p class="text-gray-200 mb-4">
      <span id="phantom-wallet-redirect"></span><br>
      <span id="phantom-wallet-confirm"></span>
    </p>
    <div class="flex justify-center gap-4 mt-2">
      <button id="mobile-wallet-continue" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-4 py-2 rounded-lg font-medium">Continue</button>
      <button id="mobile-wallet-cancel" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium">Cancel</button>
    </div>
  </div>
</div>

<!-- Disconnect Wallet Confirmation Modal -->
<div id="disconnect-wallet-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-70">
  <div class="bg-gray-800 rounded-xl shadow-lg max-w-sm w-auto p-6 text-center">
    <div class="text-yellow-400 text-4xl mb-2">
      <i class="fas fa-unlink"></i>
    </div>
    <h2 id="disconnect-wallet-title" class="text-lg font-semibold text-yellow-300 mb-2">Disconnect Wallet?</h2>
    <p class="text-gray-300 mb-4" id="disconnect-wallet-lines">
	  <span id="disconnect-wallet-line1"> ‚Ä¢ Your Meditation stats will no longer sync to space.</span><br>
      <span id="disconnect-wallet-line2"> ‚Ä¢ Rewards and progress will pause.</span><br>
      <span id="disconnect-wallet-line3"> ‚Ä¢ You can always reconnect your wallet with ease.</span>
    </p>
    <!-- New message below -->
    <p id="disconnect-wallet-message" style="color:#38ef7d; font-size:0.98em; font-style:italic; margin-bottom:0.75em; word-break:break-word;">
  Stay Connected and Verified for a better experience.
</p>
    <div class="flex justify-center gap-4 mt-2">
      <button id="confirm-disconnect-wallet" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">Yes, Disconnect</button>
      <button id="cancel-disconnect-wallet" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">Cancel</button>
    </div>
  </div>
</div>

<!-- Wallet Switch Block Modal -->
<div id="wallet-switch-block-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Wallet Switch Detected</h2>
    <p class="text-gray-200 mb-4">
      You started your journey with wallet <span id="modal-old-wallet" class="font-bold text-yellow-400"></span>.<br>
      Please reset your journey before using new wallet <span id="modal-new-wallet" class="font-bold text-blue-400"></span>.<br>
      <span class="block mt-2 text-yellow-400">Resetting will clear all progress. You can continue with new wallet.</span>
    </p>
    <div class="flex justify-center gap-4">
      <button onclick="resetJourneyForNewWallet()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
        Reset Old Wallet & Switch
      </button>
      <button onclick="closeWalletSwitchBlockModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Go Back
      </button>
    </div>
  </div>
</div>

<!-- Wallet Reset Confirm Modal -->
<div id="wallet-reset-confirm-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-red-400 text-5xl mb-4">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <h2 class="text-xl font-semibold text-red-300 mb-2">Confirm Wallet Reset</h2>
    <p class="text-gray-200 mb-4">
      You are about to reset all meditation progress for:<br>
      <span id="confirm-reset-old-wallet" class="font-bold text-yellow-400"></span>
      <br><br>
      This action <span class="text-red-400 font-bold">cannot be undone</span>.<br>
      Are you sure you want to continue?
    </p>
    <div class="flex justify-center gap-4 mt-4">
      <button onclick="doWalletResetNow()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Yes, Reset Wallet
      </button>
      <button onclick="closeWalletResetConfirmModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Wallet Required Modal -->
<div id="connect-wallet-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-wallet"></i>
    </div>
    <h2 id="connect-wallet-modal" class="text-xl font-semibold text-yellow-300 mb-2">Connect Wallet</h2>
    <p class="text-gray-200 mb-4">
       <span id="connect-wallet-line1"> Please connect your wallet to continue your meditation journey.</span><br>
       <span id="connect-wallet-line2"> All sessions will be recorded with your journey wallet for consistency and rewards.</span><br>
    </p>
    <button onclick="closeConnectWalletRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK
    </button>
  </div>
</div>

<!-- Wisdom Like Wallet Modal -->
<div id="wisdom-wallet-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-wallet"></i>
    </div>
    <h2 id="wisdom-wallet-modal" class="text-xl font-semibold text-yellow-300 mb-2">Wallet Needed</h2>
    <p class="text-gray-200 mb-4">
      <span id="wisdom-wallet-line1">Please connect your wallet to engage with wisdom.</span><br>
      <span id="wisdom-wallet-line2">Every ‚Äòlove‚Äô you send honors wisdom and records your presence with your wallet.</span>
    </p>
    <button onclick="closeWisdomWalletRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK
    </button>
  </div>
</div>

<!-- Connect Journey Wallet for Verification Modal -->
<div id="connect-journey-wallet-required-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Connect Your Journey Wallet</h2>
    <p class="text-gray-200 mb-4">
      Please connect your journey wallet <span id="required-journey-wallet" class="font-bold text-yellow-400"></span> to verify your identity.<br>
      This ensures all sessions and rewards are protected.
    </p>
    <button onclick="closeConnectJourneyWalletRequiredModal()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
      OK
    </button>
  </div>
</div>

<!-- start-onchain-journey Modal -->
<div id="start-onchain-journey-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-yellow-400 text-5xl mb-4"><i class="fas fa-seedling"></i></div>
    <h2 class="text-xl font-semibold text-yellow-300 mb-2">Start Your On-Chain Journey?</h2>
    <p class="text-gray-200 mb-4">
      You began your journey offline.<br>
      Now, your meditation path will be linked to your wallet.<br>
      <span class="text-yellow-400 font-bold">All previous progress will clear.</span><br>
      Configure your journey afresh to receive rewards.
    </p>
    <div class="flex justify-center gap-4">
      <button onclick="confirmStartOnChainJourney()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-lg font-medium cursor-pointer">
        Start Fresh
      </button>
      <button onclick="cancelStartOnChainJourney()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- full-reset-confirmation-modal   -->
<div id="full-reset-confirmation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-red-400 text-5xl mb-4">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <h2 id="reset-confirm-title" class="text-xl font-semibold text-red-300 mb-2">Reset Everything?</h2>
    <p id="reset-confirm-description" class="text-gray-200 mb-4"></p>
       
      <ul class="text-left text-gray-300 text-sm my-3 space-y-1">
        <li><i class="fas fa-check-circle mr-2 text-red-400"></i> <span id="reset-confirm-list1"></span></li>
        <li><i class="fas fa-check-circle mr-2 text-red-400"></i> <span id="reset-confirm-list2"></span></li>
        <li><i class="fas fa-check-circle mr-2 text-red-400"></i> <span id="reset-confirm-list3"></span></li>
        <li><i class="fas fa-check-circle mr-2 text-red-400"></i> <span id="reset-confirm-list4"></span></li>
      </ul>
      <p id="reset-confirm-warning" class="text-gray-200 mb-4"></p>
     
    <div class="flex justify-center gap-4 mt-4">
      <button id="reset-confirm-button" onclick="confirmFullReset()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        <i class="fas fa-trash-alt mr-1"></i> Reset Everything
      </button>
      <button id="reset-confirm-cancel" onclick="closeFullResetConfirmation()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Clear Cache Confirm Modal -->
<div id="clearCacheModal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="confirmation-modal max-w-md mx-4 p-6 rounded-xl text-center">
    <div class="text-blue-400 text-5xl mb-4">
      <i class="fas fa-broom"></i>
    </div>
    <h2 id="clear-cache-heading" class="text-xl font-semibold text-blue-300 mb-2">Confirm Cache Clear</h2>
    <p id="clear-cache-description" class="text-gray-200 mb-4">
      This will remove downloaded app data and reload the latest content.<br>
      <span class="text-yellow-400 font-bold">Your Meditation Stats are not affected.</span>
      <br><br>
      Are you sure you want to continue?
    </p>
    <div class="flex justify-center gap-4 mt-4">
      <button id="clear-cache-confirm-btn" onclick="clearAppCache()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        <i class="fas fa-broom mr-1"></i> Yes, Clear & Reload
      </button>
      <button id="clear-cache-cancel-btn" onclick="hideClearCacheModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-medium cursor-pointer">
        Cancel
      </button>
    </div>
  </div>
</div>

    <!-- Main App Interface -->
    <div id="app-interface" class="hidden">
      <!-- Back Button -->
      <div id="back-to-mode-container" class="flex justify-start mb-4">
        <button id="back-to-mode" onclick="returnToModeSelection()" class="text-gray-400 hover:text-white flex items-center cursor-pointer">
          <i class="fas fa-arrow-left mr-2"></i> Back
        </button>
      </div>

      <!-- Mode Selector -->
      <div class="flex justify-center space-x-4 mb-6">
        <button id="flow-mode-btn-app" class="mode-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full" 
                onclick="setMode('flow')">
          Flow
        </button>
        <button id="yogi-mode-btn-app" class="mode-btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-4 py-2 rounded-full" 
                onclick="setMode('yogi')">
          TrueYogi
        </button>
      </div>

      <!-- Heading and Random Quote -->
      <div class="text-center mb-4">
        <h1 id="proof-of-stillness-heading" class="text-2xl md:text-3xl font-semibold mb-2 text-yellow-300">Proof of Stillness</h1>
        <p id="proof-of-stillness-subtitle" class="text-sm text-gray-300 mb-2">Silence is the currency. Stillness is the path</p>
        <p id="yogi-quote" class="text-sm md:text-base text-blue-300 italic p-3 bg-gray-800 rounded-lg inline-block"></p>
      </div>

      <!-- Avatar -->
      <div class="avatar-container mt-9">
        <div class="pulse"></div>
        <div class="pulse pulse-2"></div>
        <img src="https://trueyogi.app/assets/yogi-avatar.gif" alt="Meditating Avatar" class="w-44 h-44 mx-auto rounded-full mb-6 shadow-lg object-scale-down object-center"
			onerror="if(this.src.indexOf('yogi-avatar-fallback.gif')==-1){this.src='https://assets.trueyogi.app/assets/yogi-avatar.gif';}else{this.style.display='none'; this.parentNode.style.background='#fde047';}"
		>
      </div>

      <!-- Yogi Mode Progress -->
      <div id="yogi-progress" class="hidden bg-gray-800 p-4 rounded-lg mb-4">
        <div class="flex justify-between items-center mb-2">
          <p id="sacred" class="text-yellow-300">Sacred 41</p>
          <span class="text-xs bg-yellow-900 text-yellow-200 px-2 py-1 rounded"><span id="day-label">Day</span> <span id="current-day-display">1</span>/41</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2" id="progress-bar-bg"></div>
            
        <div class="flex justify-between text-xs text-gray-400">
          <span>
		   <i id="sessions-completed-check" class="fas fa-check-circle mr-1"></i>
		   <span id="sessions-completed">0</span>/<span id="required-sessions">1</span>
		   <span id="today">today</span>
		  </span>
          <span><i class="fas fa-fire fa-fade mr-1" style="color: #e67e22"></i> <span id="streak-days">0</span> <span id="day-streak">day streak</span></span>
        </div>
        <div class="mt-2 text-center">
          <button id="reset-challenge-btn" onclick="showResetConfirmation()" class="text-xs text-gray-400 hover:text-yellow-600 underline cursor-pointer">
            <i class="fas fa-redo mr-1"></i> Reset Stillness
          </button>
        </div>
      </div>

      <!-- Session Times Display -->
      <div id="session-timing-display" class="hidden bg-gray-800 p-4 rounded-lg mb-4">
        <div class="flex justify-between items-center mb-2">
          <p class="text-yellow-300"><i class="far fa-clock mr-2" style="animation: clock-rotate 50s infinite linear;"></i>Your Session Times</p>
          <button id="next-session" onclick="showNextSessionTime()" class="text-blue-400 hover:text-blue-300 text-xs flex items-center cursor-pointer">
            <i class="fas fa-bell mr-1"></i> Next session
          </button>
        </div>
        <div id="session-times-list" class="flex flex-wrap gap-2 mt-3 justify-center"></div>
      </div>

      <!-- Duration Selector -->
      <div id="start-section">
        <div id="duration-selector" class="mb-4">
          <label id="duration-label" for="duration" class="block text-sm text-gray-400 mb-2"><i class="far fa-hourglass mr-2"></i></label>
          <div class="relative">
            <select id="duration" class="w-full bg-gray-800 text-white px-4 py-3 rounded-xl appearance-none cursor-pointer">
              <option value="60">1 minute</option>
              <option value="180">3 minutes</option>
              <option value="780">13 minutes</option>
              <option value="1800" selected>30 minutes</option>
              <option value="3600">60 minutes</option>
              <option value="5400">90 minutes</option>
              <option value="10800">180 minutes</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
        </div>
		
		<div class="mb-4">
  <label id="choose-background-music-label" for="music-choice" class="block text-sm text-gray-400 mb-2">
  <i class="fas fa-music mr-2"></i>
  <span id="choose-background-music-text"></span>
  </label>
  <div class="relative">
  <select id="music-choice" class="w-full bg-gray-800 text-white px-4 py-3 rounded-xl appearance-none cursor-pointer">
    <option value="music1.m4a">Miracle-cell-regeneration</option>
    <option value="music2.m4a">Soul-of-the-earth</option>
    <option value="music3.m4a">Krishna-flute</option>
    <option value="music4.m4a">Meditation-relaxing</option> 
    <option value="music5.m4a">Tibetian-bowls</option>
    <option value="music6.m4a">Ambient-yoga</option>
    <option value="music7.m4a">Gayatri-mantra</option>
  </select>
  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
      <i class="fas fa-chevron-down"></i>
    </div>
  </div>
</div>

        <div class="flex items-center justify-center mb-6">
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="music-toggle" class="sr-only peer" checked>
            <div class="relative w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-400"></div>
            <span id="background-music" class="ml-3 text-sm font-medium text-gray-300"><i class="fas fa-music mr-2"></i>Music</span>
          </label>
        </div>

        <button id="start-button" onclick="startMeditation()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold text-lg transition flex items-center justify-center gap-2 cursor-pointer">
          <i class="fa-solid fa-feather-pointed" style="margin-right: 8px;"></i>
		  <span id="start-button-label"></span>
        </button>

        <p class="text-center mt-4 text-sm cursor-pointer" onclick="toggleMeditationGuide()">
  <span class="rainbow-underline-container rainbow-text">
    <i class="fas fa-yin-yang mr-2" id="rainbow-icon"></i>
    <span id="how-to-meditate-link">How to Meditate?</span>
  </span>
</p>
      </div>

      <!-- Meditation Guide -->
<div id="meditation-guide" class="hidden text-left bg-gray-800 text-gray-200 p-4 rounded-lg mb-4 text-sm relative">
  <button onclick="toggleMeditationGuide()" class="absolute top-2 right-2 text-gray-400 hover:text-white text-lg font-bold cursor-pointer"></button>
  
  <h2 class="text-yellow-300 font-semibold mb-2"><i class="fas fa-book-open mr-2"></i>How to Meditate:</h2>
  <ol id="meditation-steps-list" class="list-decimal list-inside space-y-1 pl-2 mb-4 meditation-steps">
  <li> Take any comfortable sitting position on chair or mat.</li>
  <li> Close your eyes, join your hands and cross your legs. Observe your natural in/out Breath.</li>
  <li> If any thoughts arise bring your awareness back to your Breath.</li>
  <li> After finishing, gently place your hands over your eyes. Open your eyes slowly with a smile and feel gratitude.</li>
</ol>
<div id="meditation-guide-image" style="display: flex; justify-content: center; margin-bottom: 1.3em;">
  <!-- Image will be injected by JS -->
</div>
  <button onclick="toggleMeditationGuide()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 py-2 rounded-lg font-medium cursor-pointer">
    <i class="fas fa-check mr-2"></i> Got It
  </button>
</div>

<!-- Session Stats -->
<div id="session-stats" class="mt-6 bg-gray-800 rounded-lg p-4">

  <!-- TrueYogi Stats -->
<div id="yogi-stats" class="grid grid-cols-2 gap-4 text-center">
  <div>
    <p class="text-xl font-bold text-yellow-400" id="yogi-total-sessions">0</p>
    <p class="text-xs text-gray-400">Yogi Sessions</p>
  </div>
  <div>
    <p class="text-xl font-bold text-green-400" id="yogi-total-minutes">0</p>
    <p class="text-xs text-gray-400">Yogi Minutes</p>
  </div>
  <div>
    <p class="text-xl font-bold text-yellow-400" id="yogi-day-streak">0</p>
    <p class="text-xs text-gray-400">Yogi Streak</p>
  </div>
  <div>
    <p class="text-xl font-bold text-purple-400" id="yogi-reset-count">0</p>
    <p class="text-xs text-gray-400">Resets</p>
  </div>
</div>

  <!-- Flow Stats -->
  <div id="flow-stats" class="grid grid-cols-2 gap-4 text-center mb-4">
    <div>
      <p class="text-xl font-bold text-blue-400" id="flow-total-sessions">0</p>
      <p class="text-xs text-gray-400">Flow Sessions</p>
    </div>
    <div>
      <p class="text-xl font-bold text-green-400" id="flow-total-minutes">0</p>
      <p class="text-xs text-gray-400">Flow Minutes</p>
    </div>
  </div>
    <!-- Only show in Flow -->
  <div id="shared-stats" class="grid grid-cols-2 gap-4 text-center mt-4">
    <div>
      <p class="text-xl font-bold text-blue-400" id="current-streak">0</p>
      <p class="text-xs text-gray-400">Flow Streak</p>
    </div>
    <div>
      <p class="text-xl font-bold text-red-400" id="cancelled-sessions">0</p>
      <p class="text-xs text-gray-400">Cancelled</p>
    </div>
  </div>
</div>

      <!-- Timer Section -->
      <div id="timer-section" class="hidden flex flex-col items-center mt-6">
        <div class="text-center mb-4">
          <p id="meditating" class="text-xl font-semibold text-yellow-300 mb-1"><i class="fas fa-spa mr-2"></i>Meditating</p>
          <div id="session-info-badge" class="inline-block px-3 py-1 rounded-full text-xs font-medium">
            <span id="current-session-info"></span>
          </div>
        </div>
        <div class="relative w-44 h-44 mb-6">
          <svg class="absolute top-0 left-0 w-full h-full" viewBox="0 0 100 100">
            <circle class="text-orange-200" stroke="currentColor" stroke-width="10" fill="transparent" r="45" cx="50" cy="50" />
            <circle id="progress-ring" class="text-orange-600" stroke="currentColor" stroke-width="10" fill="transparent" r="45" cx="50" cy="50" stroke-dasharray="282.6" stroke-dashoffset="282.6" stroke-linecap="round" transform="rotate(-90 50 50)" />
          </svg>
          <p id="timer" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold text-orange-600">00:00</p>
        </div>
						<!-- Add inside #timer-section, maybe below the timer or above the End Meditation button -->
<button id="mute-audio-btn" 
  class="bg-gray-800 hover:bg-gray-700 text-yellow-400 px-3 py-2 rounded-full font-medium flex items-center gap-2"
  style="margin-bottom: 1em;"
  title="Mute/Unmute Meditation Audio">
  <i id="mute-audio-icon" class="fas fa-volume-up"></i>
</button>
        <button onclick="showEndMeditationModal()" class="w-full max-w-xs bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-medium flex items-center justify-center gap-2 cursor-pointer">
         <i class="fas fa-stop"></i> <span id="end-meditation-btn-label">End Meditation</span>
        </button>
      </div>

      <!-- Complete Section -->
      <div id="complete-section" class="hidden mt-6 text-center">
        <div class="text-green-400 text-5xl mb-4">
          <i class="fas fa-check-circle"></i>
        </div>
        <p id="completion-message" class="text-green-300 text-xl font-semibold mb-2">‚ú® Session Complete</p>
        <p id="duration-message" class="text-gray-300 mb-6">
          You've Nourished your Soul for <span id="actual-minutes">0</span> <span id="minute-text">minutes</span> of Stillness
        </p>
        <button onclick="confirmCompletion()" class="w-full max-w-xs bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-medium cursor-pointer">
          Carry the Stillness Forward
        </button>
      </div>

      <!-- Final Section -->
      <div id="final-section" class="hidden mt-6 text-center p-6 bg-gray-800 rounded-xl">
        <div class="text-yellow-400 text-5xl mb-4">
          <div class="moon-icon text-3xl mb-2">üåô</div>
        </div>
        <p id="final-message" class="text-yellow-300 text-xl mb-2">Your Stillness is recorded</p>
        <p id="youaresecret" class="text-gray-300 mb-6 text-2xl font-playfair tracking-wider" style="font-family: 'Playfair Display', serif; letter-spacing: 0.2em; text-transform: uppercase; text-shadow: 0 0 10px rgba(234, 179, 8, 0.5);">'YOU ARE YOUR SECRET'</p>
		
        <!-- Enhanced Wisdom Section -->
<div id="wisdom-section" class="relative mt-6 p-6 rounded-lg ...">
  <div class="flex items-center mb-4">
    <div class="text-yellow-300 text-xl mr-2">
      <i class="fas fa-quote-left"></i>
    </div>
    <p class="text-yellow-300 text-lg font-medium" id="wisdom-section-heading"></p>
  </div>
<div class="mt-2 flex flex-col items-center">
  <p id="wisdom-text" class="text-gray-100 text-base leading-relaxed pl-6 border-l-2 border-yellow-700 transition-opacity duration-700 mb-2 text-center"></p>
  <div id="wisdom-like-container" style="display:none; margin-top: 8px;">
    <button id="wisdom-like-btn"
            type="button"
            class="flex items-center gap-1 px-3 py-1 bg-gray-900/80 rounded-full shadow hover:bg-yellow-900/40 transition cursor-pointer"
            style="z-index: 10;"
            aria-label="Like this wisdom"
            onclick="toggleWisdomLike()">
     <i id="wisdom-like-icon" class="fa-regular fa-heart text-yellow-200 text-lg transition"></i>
     <span id="wisdom-like-count" class="text-yellow-200 font-semibold text-sm ml-2">0</span>
    </button>
  </div>
</div>
</div>

<!-- Enhanced Wisdom Button -->
<button id="show-wisdom" 
        class="mt-4 w-full bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-yellow-300 px-6 py-3 rounded-lg font-medium cursor-pointer transition-all duration-300 ease-in-out shadow-md hover:shadow-lg border border-yellow-800 hover:border-yellow-600 flex items-center justify-center group wisdom-glow">
  <span id="show-wisdom-label"></span>
  <span class="ml-2 group-hover:animate-pulse">üìö</span>
</button>
		<button id="continue-path1" onclick="returnToModeSelection()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold cursor-pointer">
          <i class="fas fa-dove mr-2"></i>Continue the Path
        </button>
      </div>

      <!-- Journey Complete Section -->
      <div id="journey-complete-section" class="hidden mt-6 text-center p-6 bg-gray-800 rounded-xl">
        <div class="text-yellow-400 text-5xl mb-4">
          <i class="fas fa-star" style="
			animation: colorShift 5s infinite alternate, shimmer 2s infinite ease-in-out;
			"></i>
        </div>
        <p class="text-yellow-300 text-xl mb-2">Congratulations, TrueYogi!</p>
        <p class="text-gray-300 mb-6">You have completed your 41-day journey of Stillness.</p>
        <button onclick="resetYogiJourney()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold cursor-pointer">
          <i class="fas fa-om mr-2"></i>Start a New Journey
        </button>
		<button id="claim-tokens-btn" onclick="showClaimTokens()" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold mb-3 cursor-pointer">
		<i class="fas fa-coins mr-2"></i>Claim YOGI Tokens
		</button>
		
		<button id="view-certificate-btn" onclick="showCertificatePage()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold mb-3 cursor-pointer">
		<i class="fas fa-certificate mr-2"></i>View Certificate
		</button>
      </div>

 <!-- Claim-tokens-section -->
<div id="claim-tokens-section" class="hidden mt-6 text-center p-6 bg-gray-800 rounded-xl">
  <div class="text-green-400 text-5xl mb-4">
    <i class="fas fa-coins"></i>
  </div>
  <p class="text-green-300 text-xl mb-2">Claim Your YOGI Tokens</p>
  <p class="text-gray-300 mb-6">Presence honored. You‚Äôve completed the Sacred 41-day path. Breathe, Connect and Authenticate your wallet to receive your YOGI tokens.</p>
  <button id="start-claim-btn" onclick="startClaimProcess()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold mb-3 cursor-pointer">
    <i class="fas fa-wallet mr-2"></i>Claim Now
  </button>
  <div id="claim-status" class="mt-4 text-sm text-gray-300" aria-live="polite"></div>
  <button onclick="closeClaimTokens()" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-semibold">
    Close
  </button>
  <div id="claim-loader" style="display:none; margin:0 auto 1em auto; text-align:center;">
  <div class="loader-spinner" style="margin:0 auto;"></div>
  <div style="color:#7c8afc;font-weight:bold;margin-top:8px;">Processing...</div>
</div>
</div>

      <!-- Incomplete Section -->
      <div id="incomplete-section" class="hidden mt-6 text-center p-6 bg-gray-800 rounded-xl">
        <div class="text-red-400 text-5xl mb-4">
          <i class="fas fa-times-circle"></i>
        </div>
        <p class="text-red-300 text-xl font-semibold mb-2">‚ú® Session Incomplete</p>
        <p class="text-gray-300 mb-6">The path to Stillness is Always Open</p>
        <button id="continue-path2" onclick="returnToModeSelection()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold cursor-pointer">
          <i class="fas fa-om mr-2"></i>Continue the Path
        </button>
      </div>
    </div>
  </div>
  
<div id="lang-switch-container">
  <i class="fas fa-globe-asia"></i>
  <select id="lang-switch" onchange="setLanguage(this.value)" aria-label="Select language">
    <option value="en" data-fullname="English">EN</option>
    <option value="te" data-fullname="Telugu">TE</option>
    <option value="hi" data-fullname="Hindi">HI</option>
    <option value="es" data-fullname="Spanish">ES</option>
    <option value="fr" data-fullname="French">FR</option>
    <option value="de" data-fullname="German">DE</option>
    <option value="zh" data-fullname="Chinese">ZH</option>
    <option value="ru" data-fullname="Russian">RU</option>
    <option value="it" data-fullname="Italian">IT</option>		
  </select>
</div>

 <!-- Add to Homescreen Prompt -->
<div id="add-to-homescreen" style="display: none;">
  <button class="close-btn" onclick="dismissHomescreenPrompt()">√ó</button>
  <h3>üì± Install TrueYogi App</h3>
  <p>Add TrueYogi to your home screen for a better experience and quick access!</p>
  
  <div class="steps">
    <!-- iOS Instructions -->
    <div id="ios-steps" style="display: none;">
      <div>
        <span class="number">1</span>
        <span>Tap the <strong>Share</strong> button <i class="fa-solid fa-arrow-up-from-bracket"></i></span>
      </div>
      <div>
        <span class="number">2</span>
        <span>Scroll down and select <strong>Add to Home Screen</strong> <i class="fa-regular fa-square-plus"></i></span>
      </div>
      <div>
        <span class="number">3</span>
        <span>Tap <strong>Add</strong> in the top right corner</span>
      </div>
    </div>
    
    <!-- Android Chrome Instructions -->
    <div id="android-chrome-steps" style="display: none;">
      <div>
        <span class="number">1</span>
        <span>Tap the <strong>three dots</strong> menu <i class="fa-solid fa-ellipsis-vertical"></i></span>
      </div>
      <div>
        <span class="number">2</span>
        <span>Select <strong>Add to Home screen</strong> <i class="fa-regular fa-square-plus"></i></span>
      </div>
      <div>
        <span class="number">3</span>
        <span>Tap <strong>Install</strong> to confirm</span>
      </div>
    </div>
    
    <!-- Samsung Browser Instructions -->
    <div id="samsung-steps" style="display: none;">
      <div>
        <span class="number">1</span>
        <span>Tap the <strong>menu button</strong> <i class="fa-solid fa-bars"></i></span>
      </div>
      <div>
        <span class="number">2</span>
        <span>Select <strong>Add page to</strong> ‚Üí <strong>Home screen</strong></span>
      </div>
      <div>
        <span class="number">3</span>
        <span>Tap <strong>Add</strong> to confirm</span>
      </div>
    </div>
  </div>
  
  <div class="buttons">
    <button class="btn-secondary" onclick="dismissHomescreenPrompt()">Maybe Later</button>
    <button class="btn-primary" onclick="dismissHomescreenPrompt(true)">Got It!</button>
  </div>
</div>
  
<button id="hide-ui-btn"
  
  title="">
  üåû
</button>

  <!-- Sound elements -->
  <audio id="bell" src="https://trueyogi.app/assets/meditation-end.mp3" preload="auto" muted></audio>
  <audio id="om-sound" src="https://assets.trueyogi.app/assets/aum.m4a" preload="auto"></audio>
  <audio id="moon-sound" src="https://assets.trueyogi.app/assets/healing.m4a" preload="auto"></audio>
  <audio id="meditate-music-audio"></audio>
  <audio id="awareness-sound" src="https://assets.trueyogi.app/assets/music/music-flame.mp3"></audio>
  <audio id="bg-music-player" preload="auto" loop></audio>
  <audio id="sound-bell" src="https://assets.trueyogi.app/assets/bell.m4a" preload="auto"></audio>
  <audio id="avatar-sound" src="https://assets.trueyogi.app/assets/meditation-eternal.m4a" preload="auto"></audio>

  <!-- Add these 3 new sounds -->
<audio id="sound-chimes" src="https://assets.trueyogi.app/assets/tamtam-gong.m4a" preload="auto"></audio>
<audio id="sound-gong" src="https://assets.trueyogi.app/assets/tao-chi-gong.m4a" preload="auto"></audio>
<audio id="sound-bowl" src="https://assets.trueyogi.app/assets/harmony-bell.m4a" preload="auto"></audio>

 <!-- Certificate Page HTML  --> 
<div id="certificate-page" class="hidden">	
  <div id="certificate" style="
    max-width: 98vw;
    width: 100%;
    min-width: 0;
    margin: 0 auto;
    padding: 4vw 3vw 7vw 3vw;
    border: 1.5vw solid #eab308;
    border-radius: 6vw;
    background: linear-gradient(135deg, #232946 80%, #eab30822 100%);
    color: #fff;
    text-align: center;
    box-shadow: 0 4px 22px #eab30844;
    font-family: 'Lexend','Playfair Display',serif,Arial;
    position: relative;
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    box-sizing: border-box;
  ">
    <img src="/assets/icrown3.png" alt="Cosmic Lotus" style="height:68px; width:auto; margin:0 auto 12px auto; border-radius:16px; box-shadow:0 2px 12px #eab30844;">
    <h1 style="
      font-family:'Playfair Display',serif;
      font-size:1.36em;
      color:#eab308;
      margin-bottom:0.45em;
      letter-spacing:0.7px;
      line-height:1.21;
      text-shadow:0 0 8px #eab30888;
      max-width:97vw;
      white-space:normal;
      overflow:auto;
    ">
      TrueYogi Certificate of Stillness
    </h1>
    <p style="font-size:1.09em;color:#fde68a;font-weight:500;margin-bottom:1.1em;line-height:1.4;">
      In honor of completing the 41-day Sacred Stillness Challenge
    </p>
    <div style="margin-bottom:1em;">
      <span style="font-size:1.09em;color:#fde68a;font-weight:bold;" id="cert-wallet"></span>
    </div>
    <div style="width:100%;margin-bottom:1em;">
      <table style="
        margin:0 auto 1.0em auto;
        background:rgba(234,179,8,0.09);
        border-radius:10px;
        box-shadow:0 1px 8px #fde68a11;
        font-size:1em;
        border-collapse:separate;
        border-spacing:0;
        width: 100%;
        max-width:400px;
        overflow-x:auto;
      ">
        <tr>
          <td style="padding:8px 4vw; color:#fde68a; text-align:left;">Start Date:</td>
          <td style="padding:8px 4vw; color:#fff; text-align:right;" id="cert-startDate"></td>
        </tr>
        <tr>
          <td style="padding:8px 4vw; color:#fde68a; text-align:left;">Completion Date:</td>
          <td style="padding:8px 4vw; color:#fff; text-align:right;" id="cert-endDate"></td>
        </tr>
        <tr>
          <td style="padding:8px 4vw; color:#fde68a; text-align:left;">Total Sessions:</td>
          <td style="padding:8px 4vw; color:#fff; text-align:right;" id="cert-totalSessions"></td>
        </tr>
        <tr>
          <td style="padding:8px 4vw; color:#fde68a; text-align:left;">Total Minutes of Stillness:</td>
          <td style="padding:8px 4vw; color:#fff; text-align:right;" id="cert-totalMinutes"></td>
        </tr>
        <tr>
          <td style="padding:8px 4vw; color:#fde68a; text-align:left;">YOGI Tokens Earned:</td>
          <td style="padding:8px 4vw; color:#fff; text-align:right;" id="cert-totalTokens"></td>
        </tr>
      </table>
    </div>
    <blockquote style="margin:18px 0 15px 0;color:#a0aec0;font-style:italic;font-size:1em;border-left:3px solid #fde68a;padding-left:1em;text-shadow:0 0 8px #fde68a22;">
      ‚ÄúIn honoring this journey, the universe bows to your presence.‚Äù
    </blockquote>
    <div style="margin:0.4em 0 0.1em 0;color:#fde68a;font-size:0.97em;">Issued on: <span id="cert-issuedOn"></span></div>
    <div style="font-size:0.92em;color:#eab308;word-break:break-all;">Certificate ID: <span id="cert-certId"></span></div>
    <div style="margin-top:1.2em; display:flex; gap:10px; justify-content:center;flex-wrap:wrap;" class="print-only-hide">
      <button onclick="closeCertificatePage()" class="print-only-hide" style="background: #eab308; color: #1e293b; border: 1.5px solid #fde68a; border-radius: 7px; font-weight: 600; padding: 7px 18px; font-size: 1em; margin-left: 4px; box-shadow: 0 2px 10px #eab30811; cursor: pointer;">
        <i class="fas fa-times" style="margin-right:7px;"></i>Close
      </button>
    </div>
  </div>
</div>
	
	
<div id="swipe-effects"></div>
	
	<div id="call-confirm-modal" class="modal-bg hidden">
  <div class="modal-content">
    <div class="modal-title">Confirm?</div>
    <div class="modal-message"></div>
    <div class="modal-actions">
      <button id="call-confirm-ok">Yes, call</button>
      <button id="call-confirm-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="challenge-completed-modal" class="hidden"></div>

  <script>
    // State Management
    let endTime = 0;
    let startTime = 0;
    let sessionActive = false;
    let targetDuration = 0;
    let notificationPermission = false;
    let backgroundAudio = null;
    let currentMode = null;
    let userSessionTimes = [];
    let yogiQuotes = [];
    let notificationWindow = 10;
    let currentSessionTime = null;
    let audioContext = null;
    let sessionCompletedWhileModalOpen = false;
	let completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
    let LANGUAGES = {}; // Will hold current language map
	let timerRunning = false;
    let selectedMusicFile = localStorage.getItem('selectedMusicFile') || 'music4.m4a';
	let wakeLock = null;
    let isWakeLockSupported = 'wakeLock' in navigator;	
	let omUserId = localStorage.getItem('omUserId');

	
    // Challenge Data
    let challengeData = {
      startDate: null,
      endDate: null,
      currentDay: 1,
      sessionsCompleted: [],
      requiredSessions: 1,
      lastSessionDate: null,
      streakDays: 0,
      totalSessions: 0,
      totalMinutes: 0,
	  resetCount: 0, // Add this line
      challengeStreak: 0 // Add this line
    };

function showChallengeCompletedModal() {
  const modal = document.getElementById('challenge-completed-modal');
  
  // Format the description with actual dates
  const description = t('challengeCompleteDescription')
    .replace('${startDate}', challengeData.startDate)
    .replace('${endDate}', challengeData.endDate);
  
modal.innerHTML = `
  <div id="challenge-complete-section" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-yellow-500/30 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fas fa-trophy text-yellow-400 text-2xl"></i>
        </div>
        <h3 id="challenge-complete-heading" class="text-xl font-bold text-white mb-3">${t('challengeCompleteHeading')}</h3>
        <p id="challenge-complete-description" class="text-gray-300 text-sm mb-6">
          ${description}
        </p>
      </div>
      
      <div class="space-y-4">
        <button id="challenge-complete-new-journey-btn" onclick="resetYogiJourney()" 
          class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 px-6 py-3 rounded-xl font-semibold cursor-pointer transition-all duration-200 hover:scale-[1.02]">
          <i class="fas fa-om mr-2"></i>${t('challengeCompleteButtonNewJourney')}
        </button>
        
        <div class="h-2"></div> <!-- Simple spacing div -->
        
        <button id="challenge-complete-close-btn" onclick="closeChallengeCompletedModal()" 
          class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 px-6 py-3 rounded-xl font-semibold cursor-pointer transition-all duration-200 border border-gray-700">
          <i class="fas fa-times mr-2"></i>${t('close')}
        </button>
      </div>
    </div>
  </div>
`;
  modal.classList.remove('hidden');
  
  // If your updateUILanguage function updates elements by these IDs, they'll exist now
}

function closeChallengeCompletedModal() {
  const modal = document.getElementById('challenge-completed-modal');
  modal.classList.add('hidden');
}

function showClearCacheModal() {
  document.getElementById('clearCacheModal').classList.remove('hidden');
}
function hideClearCacheModal() {
  document.getElementById('clearCacheModal').classList.add('hidden');
}

function clearAppCache() {
  hideClearCacheModal();
  // Send a message to the SW to clear caches
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_APP_CACHE' });
  }
  // Optionally, also unregister the SW for a total reset
  navigator.serviceWorker.getRegistration().then(function(reg) {
    if (reg) {
      reg.unregister().then(function() {
        window.location.reload(true); // Force reload, bypass cache
      });
    } else {
      window.location.reload(true);
    }
  });
}

function enableMobileAudioResume() {
  const htmlEl = document.documentElement;
  const elements = [
    document.getElementById('timer-section'),
    document.getElementById('meditating'),
    document.getElementById('timer'),
    document.getElementById('session-info-badge'),
    document.getElementById('meditation-canvas'),
    document.body,
    htmlEl,
    window,
    document
  ];

  ['touchstart', 'pointerdown', 'click'].forEach(evt => {
    elements.forEach(el => {
      if (!el) return;
      el.addEventListener(evt, tryResumeAudio, { passive: false, capture: true });
    });
  });
}

function tryResumeAudio(e) {
  // Try to resume context first
  if (window.audioContext && window.audioContext.state === 'suspended') {
    window.audioContext.resume().then(() => {
      // Resume all audio elements if paused and not at beginning
      document.querySelectorAll('audio').forEach(audio => {
        if (audio.paused && audio.currentTime > 0) {
          audio.play().catch(() => {});
        }
      });
    });
  }
}

function disableMobileAudioResume() {
  const htmlEl = document.documentElement;
  const elements = [
    document.getElementById('timer-section'),
    document.getElementById('meditating'),
    document.getElementById('timer'),
    document.getElementById('session-info-badge'),
    document.getElementById('meditation-canvas'),
    document.body,
    htmlEl,
    window,
    document
  ];

  ['touchstart', 'pointerdown', 'click'].forEach(evt => {
    elements.forEach(el => {
      if (!el) return;
      el.removeEventListener(evt, tryResumeAudio, { passive: false, capture: true });
    });
  });
}

// Function to request screen wake lock
async function requestWakeLock() {
  try {
    if (isWakeLockSupported && document.visibilityState === 'visible') {
      wakeLock = await navigator.wakeLock.request('screen');
      //console.log('Screen Wake Lock is active');
      wakeLock.addEventListener('release', () => {
       // console.log('Screen Wake Lock was released');
        // Try to reacquire if we're still in a session and tab is visible
        if (sessionActive && document.visibilityState === 'visible') {
          setTimeout(requestWakeLock, 1000);
        }
      });
    }
  } catch (err) {
    // Only log unexpected errors
    if (!(err && err.message && err.message.includes('not visible'))) {
      console.error(`Error acquiring wake lock: ${err.message}`);
    }
    // Don't retry if the page is not visible
    if (sessionActive && document.visibilityState === 'visible') {
      setTimeout(requestWakeLock, 2000);
    }
  }
}

// Function to release screen wake lock
function releaseWakeLock() {
  if (wakeLock !== null) {
    wakeLock.release();
    wakeLock = null;
    console.log('Screen Wake Lock released');
  }
}

// Load the language JSON file dynamically
async function loadLanguage(lang) {
  // Try to fetch requested language
  try {
    const response = await fetch(`/locales/${lang}.json`);
    if (!response.ok) throw new Error('Lang file not found');
    LANGUAGES = await response.json();
    localStorage.setItem(`langCache_${lang}`, JSON.stringify(LANGUAGES));
    return;
  } catch (e) {
    // If not English, try to fetch English from server
    if (lang !== 'en') {
      try {
        const enResponse = await fetch(`/locales/en.json`);
        if (!enResponse.ok) throw new Error('English file not found');
        LANGUAGES = await enResponse.json();
        localStorage.setItem(`langCache_en`, JSON.stringify(LANGUAGES));
        return;
      } catch (e2) {
        // Fallback to cached English
        const enCached = localStorage.getItem(`langCache_en`);
        LANGUAGES = enCached ? JSON.parse(enCached) : {};
        return;
      }
    } else {
      // Fallback to cached English
      const enCached = localStorage.getItem(`langCache_en`);
      LANGUAGES = enCached ? JSON.parse(enCached) : {};
      return;
    }
  }
}

function getDeviceType() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? "mobile" : "desktop";
}

function isMobileSafariOrChromeNotPhantom() {
  const ua = navigator.userAgent;
  // Mobile browser detection
  const isMobile = /iPhone|iPad|iPod|Android|Mobile/i.test(ua);
  // Exclude Phantom (has window.solana.isPhantom)
  const isPhantom = window.solana && window.solana.isPhantom;
  return isMobile && !isPhantom;
}

function showMobileYogiModal() {
  document.getElementById('mobile-yogi-modal').classList.remove('hidden');
}
function closeMobileYogiModal() {
  document.getElementById('mobile-yogi-modal').classList.add('hidden');
}

function getLocalDateString(date = new Date()) {
  return date.getFullYear() + '-' +
    String(date.getMonth() + 1).padStart(2, '0') + '-' +
    String(date.getDate()).padStart(2, '0');
}

function getLocalMidnight(dateOrStr) {
  let d = typeof dateOrStr === "string" 
    ? new Date(dateOrStr + "T00:00:00") // This creates local midnight
    : new Date(dateOrStr);
  d.setHours(0,0,0,0); 
  return d;
}

function hasMissedSession() {
  if (sessionActive) return false;
  if (currentMode !== 'yogi' || !challengeData.startDate) return false;
  
  const now = new Date();
  const today = getLocalDateString(now);
  const startDate = new Date(challengeData.startDate + "T00:00:00"); // Treat start date as local
  
  // Journey hasn't started yet
  if (now < startDate) return false;
  
  const currentMinutes = now.getHours() * 60 + now.getMinutes();

  // 1. Check all previous days (before today)
  const startDateLocal = new Date(challengeData.startDate + "T00:00:00");
  const daysSinceStart = Math.floor((now - startDateLocal) / (1000 * 60 * 60 * 24));
  
  for (let d = 0; d < daysSinceStart; d++) {
    const date = new Date(startDateLocal);
    date.setDate(date.getDate() + d);
    const dateStr = getLocalDateString(date);
    
    const completedCount = challengeData.sessionsCompleted.filter(s => s.date === dateStr).length;
    if (completedCount < challengeData.requiredSessions) {
      return true; // Missed a previous day's session
    }
  }

  // 2. Check today
  const todayCompleted = challengeData.sessionsCompleted.filter(s => s.date === today).length;
  if (todayCompleted >= challengeData.requiredSessions) {
    return false;
  }

  // 3. If ANY session for today is still upcoming (window not open yet), DO NOT show missed
  for (const session of userSessionTimes) {
    const [hours, minutes] = session.time.split(':').map(Number);
    const sessionTime = hours * 60 + minutes;
    const isCompleted = challengeData.sessionsCompleted.some(
      s => s.date === today && s.time === session.time
    );
    
    // If session is not completed and the window has not even started (-10 min), it's not missed
    if (!isCompleted && currentMinutes < sessionTime - 10) {
      return false;
    }
    // If session is not completed and the window is open, it's not missed yet
    if (!isCompleted && Math.abs(currentMinutes - sessionTime) <= 10) {
      return false;
    }
  }

  // 4. If you get here, some sessions for today are not completed and ALL their windows are over
  return true;
}

// FAQ Modal Functions
function openFAQModal() {
  document.getElementById('faq-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden'; // Prevent scrolling
  document.body.classList.add('lock-scroll');
}

function closeFAQModal() {
  document.getElementById('faq-modal').classList.add('hidden');
  document.body.style.overflow = ''; // Re-enable scrolling
  document.body.classList.remove('lock-scroll');
}

function showMobileRequiredModal() {
  document.getElementById('mobile-required-modal').classList.remove('hidden');
}
function closeMobileRequiredModal() {
  document.getElementById('mobile-required-modal').classList.add('hidden');
}

function showDesktopYogiModal() {
  document.getElementById('desktop-yogi-modal').classList.remove('hidden');
}
function closeDesktopYogiModal() {
  document.getElementById('desktop-yogi-modal').classList.add('hidden');
}

function updateFAQVisibility() {
  const faqTab = document.getElementById('faq-tab');
  const modeSelection = document.getElementById('mode-selection');
  
  if (modeSelection && !modeSelection.classList.contains('hidden')) {
    faqTab.style.display = 'block'; // Show only on mode selection
  } else {
    faqTab.style.display = 'none';  // Hide everywhere else
  }
}

function cleanUpLocalSessions() {
  const walletKey = window.walletPublicKey || "unknown";
  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  Object.keys(sessions).forEach(date => {
    // Assign session_id to any session missing one
    sessions[date].forEach((session, idx) => {
      if (!session.session_id) {
        session.session_id = `${walletKey}_${date}_${session.mode}_${idx}`;
      }
    });
    // Deduplicate by session_id (keep last, or first)
    const seen = new Set();
    sessions[date] = sessions[date].filter(s => {
      if (seen.has(s.session_id)) return false;
      seen.add(s.session_id);
      return true;
    });
  });
  localStorage.setItem('meditationSessions', JSON.stringify(sessions));
}

function fixUnknownSessionIds() {
  const walletKey = window.walletPublicKey || "unknown";
  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  Object.keys(sessions).forEach(date => {
    sessions[date].forEach((session, idx) => {
      // Fix only the unknown sessions
      if (session.session_id && session.session_id.startsWith("unknown_")) {
        session.session_id = `${walletKey}_${date}_${session.mode}_${idx}`;
      }
      // If missing session_id entirely, assign one
      if (!session.session_id) {
        session.session_id = `${walletKey}_${date}_${session.mode}_${idx}`;
      }
    });
    // Deduplicate by session_id
    const seen = new Set();
    sessions[date] = sessions[date].filter(s => {
      if (seen.has(s.session_id)) return false;
      seen.add(s.session_id);
      return true;
    });
  });
  localStorage.setItem('meditationSessions', JSON.stringify(sessions));
}

function setupFAQTabs() {
  const meditationTab = document.getElementById('meditation-faq-tab');
  const dappTab = document.getElementById('dapp-faq-tab');
  const appTab = document.getElementById('app-faq-tab');
  const aboutTab = document.getElementById('about-faq-tab');
  const rewardsTab = document.getElementById('rewards-faq-tab'); 
  const resetTab = document.getElementById('reset-faq-tab'); 
  const certificateTab = document.getElementById('certificate-faq-tab');
  const unseenTab = document.getElementById('unseen-faq-tab');
  
  const meditationContent = document.getElementById('meditation-faq-content');
  const dappContent = document.getElementById('dapp-faq-content');
  const appContent = document.getElementById('app-faq-content');
  const rewardsContent = document.getElementById('rewards-faq-content');
  const aboutContent = document.getElementById('about-faq-content');
  const resetContent = document.getElementById('reset-faq-content');
  const certificateContent = document.getElementById('certificate-faq-content');
  const unseenContent = document.getElementById('unseen-faq-content');

certificateTab.addEventListener('click', () => {
  resetTabs(); // Hide other tabs/contents
  certificateTab.classList.add('active', 'text-yellow-300');
  certificateTab.classList.remove('text-gray-400');
  certificateContent.classList.remove('hidden');
  showCertificateInFaq();
});

async function showCertificateInFaq() {
  const container = document.getElementById('certificate-faq-content');
  if (!container) return;
  
  // 1. FIRST show loading or local data
  let certificates = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  let claimedChallengeIds = []; // Store claimed IDs
  
  // 2. TRY to fetch from backend (for cross-device support)
  try {
    const jwtToken = localStorage.getItem('jwtToken');
    if (jwtToken && window.walletPublicKey) {
      // Fetch certificates
      const response = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_certificates', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + jwtToken,
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.certificates && data.certificates.length > 0) {
          // Convert backend format to match local format
          certificates = data.certificates.map(cert => ({
            challengeId: cert.challenge_id,
            startDate: cert.start_date,
            completionDate: cert.completion_date || cert.end_date,
            totalTokens: cert.total_tokens,
            totalMinutes: cert.total_minutes,
            totalSessions: cert.total_sessions || 41,
            claimed: cert.claimed || false, // This might be false for all
            certId: cert.cert_id || cert.challenge_id,
            wallet: cert.user_id
          }));
        }
      }
      
      // üÜï FETCH CLAIMS FROM NEW ENDPOINT
      try {
        const claimsResponse = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_claims', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + jwtToken,
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });
        
        if (claimsResponse.ok) {
          const claimsData = await claimsResponse.json();
          if (claimsData.success && claimsData.claims) {
            // Extract all claimed challenge IDs
            claimedChallengeIds = claimsData.claims.map(claim => claim.challenge_id);
            console.log('Claimed challenge IDs:', claimedChallengeIds);
          }
        }
      } catch (claimsError) {
        console.log('Could not fetch claims:', claimsError);
      }
    }
  } catch (error) {
    console.log('Could not fetch from backend, using local data:', error);
  }
  
  // 3. Display certificates
  if (!Array.isArray(certificates) || certificates.length === 0) {
    container.innerHTML = `
      <div class="text-yellow-300 text-lg text-center p-4 rounded-lg bg-gradient-to-br from-indigo-900/30 to-purple-900/30 border border-amber-500/30 shadow-lg">
        <i class="fas fa-seedling mr-2"></i>
        ${t('noCertificatesMessage')}
      </div>
    `;
    return;
  }

  // 4. Generate HTML with CORRECT claimed status
  container.innerHTML = `
    <div class="certificate-list" style="display:flex; flex-wrap:wrap; gap:18px; justify-content:center;">
      ${certificates.map((cert, idx) => {
        // üîç CHECK IF THIS CERTIFICATE IS CLAIMED
        const isClaimed = claimedChallengeIds.includes(cert.challengeId) || cert.claimed === true;
        
        return `
        <div class="certificate-summary" style="
          margin-bottom: 18px; 
          border-radius: 12px; 
          background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(125, 88, 234, 0.08));
          padding: 16px 20px;
          border: 1px solid rgba(234, 179, 8, 0.2);
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
          position: relative;
          overflow: hidden;
        ">
          <!-- Decorative corner elements -->
          <div style="position: absolute; top: 0; left: 0; width: 12px; height: 12px; border-top: 2px solid #eab308; border-left: 2px solid #eab308;"></div>
          <div style="position: absolute; top: 0; right: 0; width: 12px; height: 12px; border-top: 2px solid #eab308; border-right: 2px solid #eab308;"></div>
          <div style="position: absolute; bottom: 0; left: 0; width: 12px; height: 12px; border-bottom: 2px solid #eab308; border-left: 2px solid #eab308;"></div>
          <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-bottom: 2px solid #eab308; border-right: 2px solid #eab308;"></div>
          
          <div style="font-weight:600; color:#fde68a; font-size:1em; display:flex; align-items:center; gap:7px;">
            <span class="lamp-glow" style="font-size:1.3em;">ü™î</span>
            ${t('challengeLabel')} #${idx + 1} ‚Ä¢ <span style="opacity:0.7;">${cert.completionDate}</span>
          </div>
          <div style="font-size:1em; color:#eab308; margin:5px 0 3px 0;">
            <i class="fas fa-coins" style="margin-right:7px;"></i>${t('tokensLabel')}: <b>YÃê${cert.totalTokens}</b>
          </div>
          <div style="font-size:0.92em; color:#c4b5fd; margin-bottom:2px;">
            <i class="fas fa-fingerprint" style="margin-right:6px;"></i>ID: <span style="font-family:monospace;">${cert.certId || 'TR_' + (cert.challengeId || 'N/A')}</span>
          </div>
          <button 
            onclick="viewCertificateModal(${idx})"
            style="
              margin-top:10px;
              background:linear-gradient(90deg,#eab308 0%,#fde68a 100%);
              color:#222;
              border-radius:8px;
              padding:7px 20px;
              font-weight:600;
              font-size:1em;
              cursor:pointer;
              box-shadow:0 2px 8px #eab30822;
              transition:background 0.2s,box-shadow 0.2s;
              border:none;
            "
            onmouseover="this.style.background='#fde68a';"
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(234, 179, 8, 0.3)';">
            <i class="fas fa-scroll"></i> ${t('viewCertificateButton')}
          </button>
          
          ${isClaimed ? `
            <div style="font-size:0.92em; color:#10b981; margin-top:8px;">
              <i class="fas fa-check-circle" style="margin-right:5px;"></i>${t('TokensClaimed')}
            </div>
          ` : `
            <div style="font-size:0.92em; color:#ef4444; margin-top:8px;">
              <i class="fas fa-times-circle" style="margin-right:5px;"></i>${t('TokensUnclaimed')}
            </div>
          `}
          
          ${idx >= 3 ? `
            <button
              onclick="openWherebyForCertificate('${cert.challengeId || cert.certId || ''}')"
              ...style...>
              <i class="fas fa-users"></i> Join Conscious Session
            </button>
          ` : ''}
        </div>
        `;
      }).join('')}
    </div>
    <div id="certificate-modal-container"></div>
  `;
  
  // 5. Store the fetched certificates with UPDATED claimed status
  window.fetchedCertificates = certificates.map(cert => ({
    ...cert,
    claimed: claimedChallengeIds.includes(cert.challengeId) || cert.claimed === true
  }));
}

// Update the modal function to use fetched certificates
window.viewCertificateModal = function(idx) {
  // Use the certificates we stored globally
  const certificates = window.fetchedCertificates || JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  const cert = certificates[idx];
  const modalContainer = document.getElementById('certificate-modal-container');
  if (!cert) return;

  // Add html2canvas script if not present (for JPEG save)
  if (!window.html2canvas) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
    script.onload = () => {}; // Loaded!
    document.body.appendChild(script);
  }

   modalContainer.innerHTML = `
    <div id="certificate-modal-overlay" style="
      position:fixed; inset:0; background:rgba(30,41,59,0.95); z-index:9999; overflow:auto; display:flex; align-items:center; justify-content:center;
      padding:0.5em;
    ">
      <div id="certificate-modal-card" style="
        width:100%; max-width:420px; margin:2em auto; padding:18px 9px;
        border:7px solid gold; border-radius:22px;
        background:linear-gradient(135deg,#232946,#3e497a 80%);
        color:#fff; text-align:center; font-family:'Lexend','Playfair Display',serif,Arial;
        box-shadow:0 4px 32px #eab30866;
        position:relative;
      ">
	  <!-- Decorative corner elements -->
        <div style="position:absolute; top:15px; left:15px; width:30px; height:30px; border-top:2px solid #eab308; border-left:2px solid #eab308;"></div>
        <div style="position:absolute; top:15px; right:15px; width:30px; height:30px; border-top:2px solid #eab308; border-right:2px solid #eab308;"></div>
        <div style="position:absolute; bottom:15px; left:15px; width:30px; height:30px; border-bottom:2px solid #eab308; border-left:2px solid #eab308;"></div>
        <div style="position:absolute; bottom:15px; right:15px; width:30px; height:30px; border-bottom:2px solid #eab308; border-right:2px solid #eab308;"></div>
		
        <img src="assets/icrown3.png" alt="Cosmic Lotus" style="height:143px; display:block; margin:0 auto 10px auto;">
        <h1 style="font-family:'Playfair Display',serif;font-size:1.3em;color:#eab308;margin-bottom:0.15em;letter-spacing:1.2px;text-shadow:0 0 8px #eab30888;">TrueYogi Certificate of Stillness</h1>
        <p style="font-size:1.03em;color:#fde68a;font-weight:500;margin-bottom:1.1em;">
          In honor of completing the 41-day Sacred Stillness Challenge
        </p>
        <div style="margin-bottom:0.6em;">
          <span style="font-size:1.05em;color:#fde68a;font-weight:bold;">Wallet: </span>
          <span style="font-size:1.02em; color:#fff; font-weight:500;">
            ${cert.wallet ? cert.wallet.slice(0,6) + '...' + cert.wallet.slice(-4) : 'N/A'}
          </span>
        </div>
         <table style="margin:0 auto 1.5em auto;background:rgba(234,179,8,0.1);border-radius:12px;box-shadow:0 4px 15px rgba(253,230,138,0.1);font-size:1em;border-collapse:separate;border-spacing:0; width:95%; border:1px solid rgba(234,179,8,0.15); overflow:hidden;">
          <tr><td style="padding:8px 15px;color:#fde68a;font-weight:600;border-bottom:1px solid rgba(253,230,138,0.2);">Start Date:</td><td style="padding:8px 15px;color:#fff;border-bottom:1px solid rgba(253,230,138,0.2);font-weight:500;">${cert.startDate}</td></tr>
          <tr><td style="padding:8px 15px;color:#fde68a;font-weight:600;border-bottom:1px solid rgba(253,230,138,0.2);">Completion Date:</td><td style="padding:8px 15px;color:#fff;border-bottom:1px solid rgba(253,230,138,0.2);font-weight:500;">${cert.completionDate}</td></tr>
          <tr><td style="padding:8px 15px;color:#fde68a;font-weight:600;border-bottom:1px solid rgba(253,230,138,0.2);">Sessions:</td><td style="padding:8px 15px;color:#fff;border-bottom:1px solid rgba(253,230,138,0.2);font-weight:500;">${cert.totalSessions || ''}</td></tr>
          <tr><td style="padding:8px 15px;color:#fde68a;font-weight:600;border-bottom:1px solid rgba(253,230,138,0.2);">Minutes of Stillness:</td><td style="padding:8px 15px;color:#fff;border-bottom:1px solid rgba(253,230,138,0.2);font-weight:500;">${cert.totalMinutes || ''}</td></tr>
          <tr style="background:rgba(234,179,8,0.15);"><td style="padding:8px 15px;color:#fde68a;font-weight:600;">YOGI Tokens:</td><td style="padding:8px 15px;color:#fff;font-weight:600;">YÃê${cert.totalTokens}</td></tr>
        </table>
        <blockquote style="margin:16px 0 12px 0;color:#a0aec0;font-style:italic;font-size:0.98em;border-left:3px solid #fde68a;padding-left:0.6em;text-shadow:0 0 8px #fde68a33;">
          ‚ÄúIn honoring this journey, the universe bows to your presence.‚Äù
        </blockquote>
        <div style="margin:0.4em 0 0.12em 0;color:#fde68a;font-size:0.93em;">
          Issued on: ${cert.completionDate}
        </div>
        <div style="font-size:0.91em;color:#eab308;">
          Certificate ID: ${cert.certId ? 'TR_' + cert.certId : cert.challengeId ? 'TR_' + cert.challengeId : ''}
        </div>
        <div style="margin-top:1.2em; display:flex; gap:10px; justify-content:center;" class="print-only-hide">
          <button onclick="saveCertificateAsJPEG()" class="print-only-hide" style="
            background: #eab308;
            color: #232946;
            border: 1.5px solid #fde68a;
            border-radius: 7px;
            font-weight: 500;
            padding: 7px 18px;
            font-size: 1em;
            margin-left: 3px;
            box-shadow: 0 2px 10px #eab30811;
            cursor: pointer;
          "><i class="fas fa-image" style="margin-right:7px;"></i>Save as Image</button>
          <button onclick="closeCertificateModal()" class="print-only-hide" style="
            background: #232946;
            color: #fde68a;
            border: 1.3px solid #fde68a;
            border-radius: 7px;
            font-weight: 500;
            padding: 7px 18px;
            font-size: 1em;
            margin-left: 3px;
            box-shadow: 0 2px 10px #eab30811;
            cursor: pointer;
          "><i class="fas fa-times" style="margin-right:7px;"></i>Close</button>
        </div>
      </div>
    </div>
  `;

  // JPEG handler
window.saveCertificateAsJPEG = function() {
  if (!window.html2canvas) {
    alert('Please wait while image library loads...');
    return;
  }
  const card = document.getElementById('certificate-modal-card');

  // --- FIX: Temporarily expand card ---
  const oldMaxHeight = card.style.maxHeight;
  const oldOverflow = card.style.overflow;
  const oldHeight = card.style.height;
  card.style.maxHeight = 'none';
  card.style.overflow = 'visible';
  card.style.height = 'auto';
  card.scrollTop = 0;

  // Hide buttons
  document.querySelectorAll('.print-only-hide').forEach(e => e.style.display = 'none');
  window.html2canvas(card, { backgroundColor: "#232946", scale: 2 }).then(canvas => {
    // Restore card styles
    card.style.maxHeight = oldMaxHeight;
    card.style.overflow = oldOverflow;
    card.style.height = oldHeight;

    const dataUrl = canvas.toDataURL("image/jpeg");
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if (isMobile) {
      let prev = document.getElementById('jpeg-preview-img');
      if (prev) prev.remove();
      const img = document.createElement('img');
      img.src = dataUrl;
      img.id = 'jpeg-preview-img';
      img.style = "width:100%;margin:12px 0;border-radius:12px;box-shadow:0 0 16px #eab30844;";
      const instr = document.createElement('div');
      instr.innerHTML = `
<div style="
  background: rgba(234, 179, 8, 0.1);
  border: 1px solid rgba(234, 179, 8, 0.3);
  border-radius: 8px;
  padding: 12px;
  margin: 15px 0;
  text-align: center;
  font-size: 0.95em;
  color: #fde68a;
">
  <i class="fas fa-download" style="margin-right: 8px;"></i>
  Long-press the certificate image and choose "Save to Photos" or "Download"
</div>
`;
      instr.style = "color:#fde68a;font-size:1.01em;margin-bottom:9px;";
      card.appendChild(img);
      card.appendChild(instr);
    } else {
      const link = document.createElement('a');
      link.download = `TrueYogiCertificate.jpg`;
      link.href = dataUrl;
      link.click();
    }
    setTimeout(() => document.querySelectorAll('.print-only-hide').forEach(e => e.style.display = ''), 500);
  });
};

  window.closeCertificateModal = function() {
    modalContainer.innerHTML = '';
  };
};

  function resetTabs() {
  [meditationTab, dappTab, appTab, rewardsTab, aboutTab, resetTab, unseenTab, certificateTab].forEach(tab => {
    tab.classList.remove('active', 'text-yellow-300');
    tab.classList.add('text-gray-400');
    tab.style.borderBottomColor = 'transparent';
  });
  [meditationContent, dappContent, appContent, rewardsContent, aboutContent, resetContent, unseenContent, certificateContent].forEach(content => {
    content.classList.add('hidden');
  });
}

  function activateTab(tab, content) {
    resetTabs();
    tab.classList.add('active', 'text-yellow-300');
    tab.classList.remove('text-gray-400');
    tab.style.borderBottomColor = '#fbbf24';
    content.classList.remove('hidden');
  }

  meditationTab.addEventListener('click', () => activateTab(meditationTab, meditationContent));
  dappTab.addEventListener('click', () => activateTab(dappTab, dappContent));
  appTab.addEventListener('click', () => activateTab(appTab, appContent));
  rewardsTab.addEventListener('click', () => activateTab(rewardsTab, rewardsContent)); // New handler
  aboutTab.addEventListener('click', () => activateTab(aboutTab, aboutContent));
  resetTab.addEventListener('click', () => activateTab(resetTab, resetContent));
  certificateTab.addEventListener('click', () => activateTab(certificateTab, certificateContent));
  unseenTab.addEventListener('click', () => activateTab(unseenTab, unseenContent));

}

function getJwtExpiry(token) {
  if (!token) return 0;
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.exp * 1000; // exp is in seconds, JS wants ms
  } catch (e) {
    return 0;
  }
}

const jwt = localStorage.getItem('jwtToken');
function isJwtValid() {
  const jwt = localStorage.getItem('jwtToken');
  if (!jwt) return false;
  try {
    const payload = JSON.parse(atob(jwt.split('.')[1]));
    return payload.exp * 1000 > Date.now();
  } catch {
    return false;
  }
}

function shouldShowVerifyButton() {
  const token = localStorage.getItem('jwtToken');
  if (!token) return true;
  const expiry = getJwtExpiry(token);
  const now = Date.now();
  // Show button if JWT is missing, expired, or expires in less than 3 hour
  return !expiry || expiry - now < 10800 * 1000;
}

function updateJwtTimer() {
  const token = localStorage.getItem('jwtToken');
  const timerSpan = document.getElementById('jwt-timer');
  if (!token || !timerSpan) return;

  const expiry = getJwtExpiry(token);
  const now = Date.now();
  let remaining = Math.max(0, expiry - now);

  if (remaining === 0) {
    timerSpan.textContent = '';
    return;
  }


  // Format as hh:mm:ss
  const hours = Math.floor(remaining / (1000 * 60 * 60));
  const minutes = Math.floor((remaining / (1000 * 60)) % 60);
  const seconds = Math.floor((remaining / 1000) % 60);
  timerSpan.textContent = `‚è≥ ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function updateYogiIcon() {
  const sunIcon = document.getElementById('yogi-sun-icon');
  if (!sunIcon) return;

  const todayStr = getLocalDateString(new Date());
  const startDateStr = challengeData.startDate;
  const endDateStr = challengeData.endDate;

  // How many completed sessions for today?
  const todaySessionsCompleted = challengeData.sessionsCompleted.filter(s => s.date === todayStr).length;
  const allTodaySessionsDone = todaySessionsCompleted >= challengeData.requiredSessions;

  if (!startDateStr || !endDateStr) {
    sunIcon.classList.remove('fa-spin');
    sunIcon.style.color = '#000000';
    return;
  }

  // 1. Before end date
  if (todayStr < endDateStr) {
    sunIcon.classList.add('fa-spin');
    sunIcon.style.color = '#000000'; // black
    return;
  }

  // 2. On end date
  if (todayStr === endDateStr) {
    if (!allTodaySessionsDone) {
      sunIcon.classList.add('fa-spin');
      sunIcon.style.color = '#000000'; // black
    } else {
      sunIcon.classList.add('fa-spin');
      sunIcon.style.color = '#f59e0b'; // gold
    }
    return;
  }

  // 3. After end date (challenge finished)
  sunIcon.classList.add('fa-spin');
  sunIcon.style.color = '#f59e0b'; // gold
}

function showStartOnChainJourneyModal(walletPublicKey) {
  window.pendingJourneyWallet = walletPublicKey;
  // Persist modal state
  localStorage.setItem('pendingOnChainJourney', 'true');
  document.getElementById('start-onchain-journey-modal').classList.remove('hidden');
}

function confirmStartOnChainJourney() {
  // Clear all config and progress
  localStorage.removeItem('yogiConfig');
  localStorage.removeItem('yogiChallenge');
  clearYogiSessions();
  localStorage.setItem('currentJourneyWallet', window.pendingJourneyWallet);
  document.getElementById('start-onchain-journey-modal').classList.add('hidden');
  showYogiConfig(); // Prompt user to set up
  updateStats();
}

function cancelStartOnChainJourney() {
  document.getElementById('start-onchain-journey-modal').classList.add('hidden');
  if (window.solana && window.solana.isPhantom) {
    window.solana.disconnect();
    localStorage.setItem('walletManuallyDisconnected', 'true'); // <--- Prevent auto-reconnect!
  }
  // Only clear journey wallet if user hasn't onboarded yet
  if (localStorage.getItem('currentJourneyWallet') && !localStorage.getItem('yogiConfig')) {
    localStorage.removeItem('currentJourneyWallet');
  }
  // updateWalletUI();
}

function showSyncAuthBanner() {
  document.getElementById('sync-auth-banner').style.display = 'block';
}
function hideSyncAuthBanner() {
  document.getElementById('sync-auth-banner').style.display = 'none';
}

async function promptVerifyAndSync() {
console.log('promptVerifyAndSync CALLED');
  // Show your auth modal or directly call authenticateWithWallet
  if (typeof authenticateWithWallet === "function") {
    await authenticateWithWallet();
    hideSyncAuthBanner();
    if (typeof window.syncSessionsToSupabase === "function") window.syncSessionsToSupabase();
    // Add other syncs as needed
  }
}

const TOKEN_TABLE = {
  1: 10,
  3: 30,
  13: 130,
  30: 300,
  60: 600,
  90: 900,
  180: 1800
};

function calculateTokenReward() {
  const durations = Array.from(document.querySelectorAll('#session-times-inputs select'))
    .map(sel => parseInt(sel.value, 10) / 60);
  let total = 0;
  durations.forEach(mins => {
    const reward = TOKEN_TABLE[mins];
    if (reward) total += reward;
  });
  return total;
}

function updateTokenPreview() {
  const tokenPreview = document.getElementById('token-preview');
  const tokenAmount = document.getElementById('token-amount');
  // Always calculate live from visible selects
  const tokens = calculateTokenReward();
  tokenAmount.textContent = `YÃê${tokens}`;
  tokenPreview.classList.remove('hidden');
}

function attachTokenPreviewListeners() {
  // Listen for change on all selects and times in the config modal
  document.querySelectorAll('#session-times-inputs select, #session-times-inputs input[type="time"]').forEach(el => {
    el.onchange = updateTokenPreview;
  });
}

function updateLangSwitcherVisibility() {
  const langSwitch = document.getElementById('lang-switch-container');
  const modeSelection = document.getElementById('mode-selection');
  if (modeSelection && !modeSelection.classList.contains('hidden')) {
    langSwitch.style.display = 'flex'; // Show only on mode selection
  } else {
    langSwitch.style.display = 'none'; // Hide everywhere else
  }
}

// Place this function in your script
function updateDurationMessage(actualMinutes) {
  const minuteText = actualMinutes === 1 ? t('minute') : t('minutes');
  let message = t('durationMessage', { minutes: actualMinutes, minuteText });
  // Fallback to English if translation missing
  if (!message || message === 'durationMessage') {
    message = `You've Nourished your Soul for ${actualMinutes} ${minuteText} of Stillness`;
  }
  document.getElementById('duration-message').innerHTML = message;
}

function showFullResetConfirmation() {
const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;

  // If journey wallet is set, but wallet is not connected
  if (journeyWallet && !walletIsConnected) {
    showConnectWalletRequiredModal();
    return;
  }
  // If wallet is connected but is NOT journey wallet
  if (journeyWallet && walletIsConnected && window.walletPublicKey !== journeyWallet) {
    showWalletSwitchBlockModal(journeyWallet, window.walletPublicKey);
    return;
  }
  // 2.5. Block and trigger verification if not verified (no valid JWT)
  const jwtToken = localStorage.getItem('jwtToken');
  const tokenValid = jwtToken && getJwtExpiry(jwtToken) > Date.now();

  if (journeyWallet && walletIsConnected && !tokenValid) {
    showAuthRequiredModal();
    return;
  }
  document.getElementById('full-reset-confirmation-modal').classList.remove('hidden');
}

function closeFullResetConfirmation() {
  document.getElementById('full-reset-confirmation-modal').classList.add('hidden');
}

async function confirmFullReset() {
  try {
    // Call backend to delete all DB data for wallet
    const jwtToken = localStorage.getItem('jwtToken');
    const walletKey = window.walletPublicKey;
    if (walletKey && jwtToken) {
      try {
        await fetch('https://trueyogi-backend-knkq.onrender.com/api/wallet-reset', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + jwtToken
          }
        });
      } catch (err) {
        console.warn('Could not clear remote wallet data during full reset:', err.message);
      }
    }

    // --- Disconnect wallet 
    if (window.solana && window.solana.isPhantom && window.walletPublicKey) {
      await window.solana.disconnect();
    }

    // --- Clear ALL app data ---
    localStorage.clear();
	      // Set a flag to block auto-reconnect on reload
	localStorage.setItem('walletManuallyDisconnected', 'true');
	 // localStorage.removeItem('completedChallenges');


    // Hide modals
    document.getElementById('full-reset-confirmation-modal').classList.add('hidden');
    document.getElementById('faq-modal').classList.add('hidden');

    // Show welcome message (handled by reload logic on fresh user)
    // Force a full page reload
    window.location.reload(true);
  } catch (e) {
    console.error("Error during full reset:", e);
    alert("Reset failed. Please try again.");
  }
}

    // Initialize the app
      document.addEventListener('DOMContentLoaded', async () => {
	  cleanUpLocalSessions();
	  setupFAQTabs();
      document.addEventListener('click', initAudioContext, { once: true });
      document.addEventListener('touchstart', initAudioContext, { once: true });

	const syncDot = document.getElementById('sync-dot');
	const syncTooltip = document.getElementById('sync-tooltip');

    if (!omUserId) {
	omUserId = crypto.randomUUID();   // or use any UUID generator
	localStorage.setItem('omUserId', omUserId);
	}
	
	if (!isMobile()) {
	document.querySelector('.auth-section-container').style.display = 'none';
	document.getElementById('mobile-reminder-card').classList.remove('hidden');
	} 

	if (syncDot && syncTooltip) {
	syncDot.addEventListener('mouseenter', () => {
		syncTooltip.style.display = 'block';
		setTimeout(() => { syncTooltip.style.opacity = 1; }, 10);
	});
	syncDot.addEventListener('mouseleave', () => {
		syncTooltip.style.opacity = 0;
		setTimeout(() => { syncTooltip.style.display = 'none'; }, 200);
	});
	}
	
	const fetchDot = document.getElementById('fetch-dot');
	const fetchTooltip = document.getElementById('fetch-tooltip');

	if (fetchDot && fetchTooltip) {
    fetchDot.addEventListener('mouseenter', () => {
        fetchTooltip.style.display = 'block';
        setTimeout(() => { fetchTooltip.style.opacity = 1; }, 10);
    });
    fetchDot.addEventListener('mouseleave', () => {
        fetchTooltip.style.opacity = 0;
        setTimeout(() => { fetchTooltip.style.display = 'none'; }, 200);
    });
  }

      const faqTab = document.getElementById('faq-tab');
  if (faqTab) {
    faqTab.addEventListener('click', openFAQModal);
  }
      const musicToggleState = localStorage.getItem('musicToggle');
      if (musicToggleState !== null) {
        document.getElementById('music-toggle').checked = musicToggleState === 'true';
      }

const musicChoiceEl = document.getElementById('music-choice');
if (musicChoiceEl) {
  // Restore previous choice
  musicChoiceEl.value = selectedMusicFile;
  musicChoiceEl.addEventListener('change', function() {
    selectedMusicFile = this.value;
    localStorage.setItem('selectedMusicFile', selectedMusicFile);
  });
}

      const savedChallenge = localStorage.getItem('yogiChallenge');
      if (savedChallenge) {
  try {
    challengeData = JSON.parse(savedChallenge);
	updateYogiIcon();
    if (!Array.isArray(challengeData.sessionsCompleted)) {
      challengeData.sessionsCompleted = [];
    }
    // Ensure reset count is initialized
    if (typeof challengeData.resetCount === 'undefined') {
      challengeData.resetCount = 0;
    }
    if (typeof challengeData.challengeStreak === 'undefined') {
      challengeData.challengeStreak = 0;
    }
  } catch (e) {
    console.error("Error parsing challenge data:", e);
  }
}

      // Set the language dropdown to the saved value
     const lang = localStorage.getItem('lang') || 'en';
     const langSwitch = document.getElementById('lang-switch');
	 langSwitch.value = lang;
	 await loadLanguage(lang);
	 updateUILanguage();
	 updateWalletUI();
  
      const activeSession = localStorage.getItem('activeSession');
      if (activeSession) {
        try {
          const sessionData = JSON.parse(activeSession);
          const { startTime: savedStart, endTime: savedEnd, mode, targetDuration: savedDuration, sessionActive: savedActive, sessionTime } = sessionData;

          startTime = savedStart;
          endTime = savedEnd;
          currentMode = mode;
          targetDuration = savedDuration;
          currentSessionTime = sessionTime;

          if (savedActive && savedEnd > Date.now()) {
            sessionActive = true;
            restoreActiveSessionUI();
          } else {
            localStorage.removeItem('activeSession');
            const actualMinutes = Math.round(targetDuration / 60);
            document.getElementById('actual-minutes').textContent = actualMinutes;
            document.getElementById('minute-text').textContent = actualMinutes === 1 ? 'minute' : 'minutes';
			updateDurationMessage(actualMinutes);
            saveSession(actualMinutes, currentSessionTime);
			localStorage.setItem('lastCompletedMode', currentMode);

            if (currentMode === 'yogi') {
              const sessionDate = new Date(startTime).toDateString();
              const sessionTimeStr = currentSessionTime || new Date(startTime).toTimeString().split(' ')[0].slice(0, 5);
              challengeData.sessionsCompleted.push({ time: sessionTimeStr, duration: targetDuration, date: getLocalDateString(new Date(startTime)) });
              challengeData.totalSessions++;
              challengeData.totalMinutes += actualMinutes;
              challengeData.lastSessionDate = sessionDate;
              saveChallengeData();
            }

            document.getElementById('mode-selection').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            document.getElementById('timer-section').classList.add('hidden');
            document.getElementById('complete-section').classList.remove('hidden');
            document.getElementById('start-section').classList.add('hidden');
            document.getElementById('session-stats').classList.remove('hidden');
            document.getElementById('yogi-progress').classList.add('hidden');
            document.getElementById('session-timing-display').classList.add('hidden');
            document.querySelector('#app-interface #flow-mode-btn-app').classList.add('hidden');
            document.querySelector('#app-interface #yogi-mode-btn-app').classList.add('hidden');
            updateBackButtonVisibility();
			showCompletionStats();
            const bell = document.getElementById('bell');
            if (bell) {
              bell.muted = false;
              bell.play().catch(e => console.log("Bell sound error:", e));
            }
          }
        } catch (e) {
          console.error("Error parsing session data:", e);
          localStorage.removeItem('activeSession');
        }
      } else {
        document.getElementById('mode-selection').classList.remove('hidden');
        document.getElementById('app-interface').classList.add('hidden');
      }

      checkDayReset();
      await loadQuotes();
	  updateStats();
      try {
        const savedSessions = localStorage.getItem('meditationSessions') || '{}';
        const sessions = JSON.parse(savedSessions);
      } catch (e) {
        console.error("Error parsing session stats:", e);
      }

      updateStats();
      showRandomQuote();

      if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          notificationPermission = permission === 'granted';
        });
      }

      document.getElementById('start-button').addEventListener('click', () => {
        document.querySelectorAll('audio').forEach(audio => {
          audio.volume = 0.5;
          audio.muted = !document.getElementById('music-toggle').checked;
        });
      });

      document.getElementById('flow-mode-btn-select').addEventListener('click', () => selectMode('flow'));
      document.getElementById('yogi-mode-btn-select').addEventListener('click', () => selectMode('yogi'));

      showWelcomeMessage();
	  updateEndDateDisplay();
	  updateNowDisplay();
	  updateStartDateDisplay();
	  updateFAQVisibility();
	  updateYogiIcon();
	  updateLangSwitcherVisibility();
	  await validateOmPresence();
	  updateCount();
    // Hide loader when app is ready
    document.getElementById('app-loader').classList.add('hidden');
    });

function showAuthRequiredModal() {
  document.getElementById('auth-required-modal').classList.remove('hidden');
}
function closeAuthRequiredModal() {
  document.getElementById('auth-required-modal').classList.add('hidden');
}

function showSyncAuthRequiredModal() {
  document.getElementById('sync-auth-required-modal').classList.remove('hidden');
}
function closeSyncAuthRequiredModal() {
  document.getElementById('sync-auth-required-modal').classList.add('hidden');
}

function closeWalletRequiredModal() {
  document.getElementById('wallet-required-modal').classList.add('hidden');
}

function showConnectWalletRequiredModal() {
  document.getElementById('connect-wallet-required-modal').classList.remove('hidden');
}
function closeConnectWalletRequiredModal() {
  document.getElementById('connect-wallet-required-modal').classList.add('hidden');
}

function showWisdomWalletRequiredModal() {
  document.getElementById('wisdom-wallet-required-modal').classList.remove('hidden');
}
function closeWisdomWalletRequiredModal() {
  document.getElementById('wisdom-wallet-required-modal').classList.add('hidden');
}

function showConnectJourneyWalletRequiredModal(wallet) {
  const el = document.getElementById('required-journey-wallet');
  if (el) el.textContent = `${wallet.slice(0,4)}...${wallet.slice(-4)}`;
  document.getElementById('connect-journey-wallet-required-modal').classList.remove('hidden');
}
function closeConnectJourneyWalletRequiredModal() {
  document.getElementById('connect-journey-wallet-required-modal').classList.add('hidden');
}

async function loadWelcomeMessages() {
  const lang = localStorage.getItem('lang') || 'en';
  try {
    // Try to load the correct file for the selected language
    const response = await fetch(`/assets/welcomeMessages.${lang}.json`);
    if (response.ok) return await response.json();
    // If not found, fallback to English
    if (lang !== 'en') {
      const fallback = await fetch('/assets/welcomeMessages.en.json');
      if (fallback.ok) return await fallback.json();
    }
    throw new Error('No welcome messages found');
  } catch (e) {
    console.error('Error loading welcome messages:', e);
    // Fallback messages if JSON fails to load
    return {
      firstVisit: ["The path of stillness begins with your first step"],
      returnVisit: [
        "The universe whispers your name in stillness.",
        "Each return is a rebirth on your spiritual path.",
        "The sacred space within remembers your presence.",
        "Like the lotus, you return to bloom again.",
        "Your journey inward continues where you left off."
      ]
    };
  }
}

    async function showWelcomeMessage() {
  const now = new Date();
  const lastVisitTime = localStorage.getItem('lastVisitTime');
  const hasSeenFirstWelcome = localStorage.getItem('hasSeenFirstWelcome');
  const welcomeHeading = document.getElementById('welcome-heading');
  const welcomeText = document.getElementById('welcome-text');
  const welcomeButton = document.getElementById('welcome-button');
  
  // Load welcome messages from JSON
  const welcomeMessages = await loadWelcomeMessages();

  // First-time visitor experience
  if (!hasSeenFirstWelcome) {
    welcomeHeading.textContent =  t('welcomeHeadingFirst');  
    welcomeText.textContent = welcomeMessages.firstVisit[
      Math.floor(Math.random() * welcomeMessages.firstVisit.length)
    ];
    welcomeButton.textContent = t('welcomeButtonFirst'); // Changed for first-time
    localStorage.setItem('hasSeenFirstWelcome', 'true');
    localStorage.setItem('lastVisitTime', now.getTime());
    showWelcomeModal();
    return;
  }
  
  // Returning visitor logic (only show if >15 minutes since last visit)
  if (lastVisitTime) {
    const minutesSinceLastVisit = (now.getTime() - parseInt(lastVisitTime)) / (1000 * 60);
    if (minutesSinceLastVisit > 15) {
      welcomeHeading.textContent = t('welcomeHeadingReturn');
      welcomeText.textContent = welcomeMessages.returnVisit[
        Math.floor(Math.random() * welcomeMessages.returnVisit.length)
      ];
      welcomeButton.textContent = t('welcomeButtonReturn'); // Kept for returning
      showWelcomeModal();
    }
  }
  
  // Always update last visit time
  localStorage.setItem('lastVisitTime', now.getTime());
}

function showWelcomeModal() {
  document.getElementById('welcome-message').classList.remove('hidden');
  
  // Auto-close after 5 minutes (300,000 milliseconds)
  setTimeout(() => {
    closeWelcomeMessage();
  }, 300000); // Changed from 5000 to 300000
}


    function closeWelcomeMessage() {
      document.getElementById('welcome-message').classList.add('hidden');
    }

    function showCompletedSessionsModal(requiredSessions) {
      const modal = document.getElementById('completed-sessions-modal');
      const textElement = document.getElementById('completed-sessions-text');
      textElement.textContent = t('completedSessionsText', { count: requiredSessions });
      modal.classList.remove('hidden');
	  const firstButton = modal.querySelector('button, [tabindex="0"]');
	  if (firstButton) firstButton.focus();
    }

    function closeCompletedSessionsModal() {
      document.getElementById('completed-sessions-modal').classList.add('hidden');
    }

    function showSessionTimeModal() {
      document.getElementById('session-time-modal').classList.remove('hidden');
    }

    function closeSessionTimeModal() {
      document.getElementById('session-time-modal').classList.add('hidden');
    }

    function showNextSessionModal(time, duration, dateOrDay) {
	  // Check if challenge has ended
  if (challengeData.endDate) {
    const now = new Date();
    const endDate = new Date(challengeData.endDate + "T00:00:00");
    if (now > endDate) {
      // Challenge has ended, don't show next session info
      // Instead, you could show a different message or do nothing
      console.log("Challenge has ended, not showing next session modal");
      return;
    }
  }

  const modal = document.getElementById('next-session-modal');
  if (!modal) return;
  const textElement = document.getElementById('next-session-text');

  // Translate "today" and "tomorrow"
  if (dateOrDay === "today" || dateOrDay === "tomorrow") {
    dateOrDay = t(dateOrDay);
  }
  textElement.textContent = t('nextSessionText', { time, duration, dateOrDay });
  modal.classList.remove('hidden');
  const firstButton = modal.querySelector('button, [tabindex="0"]');
  if (firstButton) firstButton.focus();
}

    function closeNextSessionModal() {
      document.getElementById('next-session-modal').classList.add('hidden');
    }

    function showMissedSessionModal() {
      document.getElementById('missed-session-modal').classList.remove('hidden');
    }

    function closeMissedSessionModal() {
      document.getElementById('missed-session-modal').classList.add('hidden');
    }

function showWalletSwitchBlockModal(oldWallet, newWallet) {
  document.getElementById('modal-old-wallet').textContent = `${oldWallet.slice(0,4)}...${oldWallet.slice(-4)}`;
  document.getElementById('modal-new-wallet').textContent = `${newWallet.slice(0,4)}...${newWallet.slice(-4)}`;
  document.getElementById('wallet-switch-block-modal').classList.remove('hidden');
}

function closeWalletSwitchBlockModal() {
  document.getElementById('wallet-switch-block-modal').classList.add('hidden');
}

function resetJourneyForNewWallet() {
  const oldWallet = localStorage.getItem('currentJourneyWallet');
  // Set wallet id in modal text
  document.getElementById('confirm-reset-old-wallet').textContent = `${oldWallet.slice(0,4)}...${oldWallet.slice(-4)}`;
  // Hide the first modal, show the second
  closeWalletSwitchBlockModal();
  document.getElementById('wallet-reset-confirm-modal').classList.remove('hidden');
}

function closeWalletResetConfirmModal() {
  document.getElementById('wallet-reset-confirm-modal').classList.add('hidden');
}

// This is the actual reset logic (copy your previous logic here)
async function doWalletResetNow() {
  const oldWallet = localStorage.getItem('currentJourneyWallet');
  const jwtToken = localStorage.getItem('jwtToken');
  const newWallet = window.walletPublicKey;

  // 1. Call backend to clear ALL DB data for old wallet (using JWT)
  try {
    if (oldWallet && jwtToken) {
      await fetch('https://trueyogi-backend-knkq.onrender.com/api/wallet-reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwtToken
        }
      });
    }
  } catch (err) {
    console.warn('Could not clear remote wallet data:', err.message);
  }

  // 2. Clear ALL local data (including JWT)
  localStorage.removeItem('meditationSessions');
  localStorage.removeItem('yogiChallenge');
  localStorage.removeItem('yogiConfig');
  localStorage.removeItem('jwtToken');

  // 3. Set new wallet as journey wallet
  localStorage.setItem('currentJourneyWallet', newWallet);

  // 4. Close modal and reload app
  closeWalletResetConfirmModal();
  location.reload();
}

function showYellowIndicator(duration = 1500) {
  const indicator = document.getElementById('yellow-indicator');
  if (!indicator) return;
  indicator.style.display = 'block';
  setTimeout(() => {
    indicator.style.display = 'none';
  }, duration);
}

 async function reconfigureChallenge() {
  // --- Start: Also clear from Supabase if wallet is connected ---
  const walletKey = window.walletPublicKey;
  const jwtToken = localStorage.getItem('jwtToken');
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;
  const jwtValid = isJwtValid();
  
  // 1. If journeyWallet exists and wallet is NOT connected, block
  if (journeyWallet && !walletIsConnected) {
    showConnectWalletRequiredModal();
    return;
  }
  // 2. If wallet is connected but is NOT journey wallet
  if (journeyWallet && walletIsConnected && window.walletPublicKey !== journeyWallet) {
    showWalletSwitchBlockModal(journeyWallet, window.walletPublicKey);
    return;
  }
  // 3. If not verified (missing or expired JWT), block
  if (journeyWallet && !jwtValid) {
  showAuthRequiredModal();
  return;
}
  // --- Start: Also clear from Supabase if wallet is connected ---
  if (walletKey && jwtToken) {
    try {
      await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi-reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwtToken
        }
      });
      // No alert needed, silent like a reset
    } catch (err) {
      // Optionally log error for dev
      console.warn('Could not clear remote yogi data during reconfigure:', err.message);
    }
  }
  // --- End: DB clear logic ---
  // Reset all Yogi stats to 0 except resetCount
  const currentResetCount = challengeData.resetCount || 0; // Preserve reset count
  
  challengeData = {
    startDate: null,
    endDate: null,
    currentDay: 1,
    sessionsCompleted: [],
    requiredSessions: 1,
    lastSessionDate: null,
    streakDays: 0,
    totalSessions: 0,
    totalMinutes: 0,
    resetCount: currentResetCount, // Keep the existing reset count
    challengeStreak: 0
  };
  
  // Clear Yogi sessions from session history
  clearYogiSessions();
  
  // Save the reset data
  saveChallengeData();
  
  // Close the missed session modal
  closeMissedSessionModal();
  showYellowIndicator();
  // Show configuration modal
  showYogiConfig();
  
  // Update the UI
  updateStats();
}

    function switchToFlowMode() {
      closeMissedSessionModal();
      selectMode('flow');
    }

    function showResetConfirmation() {
  
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;

  // If journey wallet is set, but wallet is not connected
  if (journeyWallet && !walletIsConnected) {
    showConnectWalletRequiredModal();
    return;
  }
  // If wallet is connected but is NOT journey wallet
  if (journeyWallet && walletIsConnected && window.walletPublicKey !== journeyWallet) {
    showWalletSwitchBlockModal(journeyWallet, window.walletPublicKey);
    return;
  }
  // 2.5. Block and trigger verification if not verified (no valid JWT)
  const jwtToken = localStorage.getItem('jwtToken');
  const tokenValid = jwtToken && getJwtExpiry(jwtToken) > Date.now();

  if (
    currentMode === 'yogi' &&
    journeyWallet &&
    walletIsConnected &&
    !tokenValid
  ) {
    // Show verify identity modal and after user verifies, start meditation seamlessly
    window.afterIdentityVerified = function() {
      showStartMeditationModal();
      window.afterIdentityVerified = null;
    };
    showAuthRequiredModal();
    return;
  }
  closeFAQModal();
  // Otherwise show the normal reset confirmation modal
  document.getElementById('reset-confirmation-modal').classList.remove('hidden');
}

    function closeResetConfirmation() {
      document.getElementById('reset-confirmation-modal').classList.add('hidden');
    }

   async function confirmResetChallenge() {
    
  let oldChallenge = {};
  try {
    oldChallenge = JSON.parse(localStorage.getItem('yogiChallenge')) || {};
  } catch (e) {}
  const previousCount = typeof oldChallenge.resetCount === 'number' ? oldChallenge.resetCount : 0;
  const newResetCount = previousCount + 1;

  const walletKey = window.walletPublicKey;
  const jwtToken = localStorage.getItem('jwtToken');
  let resetSuccess = false;

  if (walletKey && jwtToken) {
    try {
      const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi-reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwtToken
        }
      });
      const result = await resp.json();
      if (resp.ok && result.success) {
        resetSuccess = true;
      } else {
        console.warn('Could not clear remote yogi data:', result.error || resp.statusText);
      }
    } catch (err) {
      console.warn('Network error clearing remote yogi challenge:', err.message);
    }
  } else {
    // No wallet or JWT, treat as local-only, so consider it "success" for local reset
    resetSuccess = true;
  }

  // Only show reset indicator if remote reset succeeded (or local-only)
  if (resetSuccess) {
    document.getElementById('reset-indicator').style.display = 'block';
    setTimeout(() => {
      document.getElementById('reset-indicator').style.display = 'none';
    }, 1500);
  }

  // Proceed with local reset regardless (or, if you want, only if resetSuccess)
  localStorage.removeItem('yogiConfig');
  localStorage.removeItem('yogiChallenge');
  clearYogiSessions();

  challengeData = {
    startDate: null,
    endDate: null,
    currentDay: 1,
    sessionsCompleted: [],
    requiredSessions: 1,
    lastSessionDate: null,
    streakDays: 0,
    totalSessions: 0,
    totalMinutes: 0,
    resetCount: newResetCount,
    challengeStreak: 0
  };

  saveChallengeData();

  userSessionTimes = [];
  document.getElementById('reset-confirmation-modal').classList.add('hidden');
  document.getElementById('yogi-progress').classList.add('hidden');
  document.getElementById('session-timing-display').classList.add('hidden');
  document.getElementById('yogi-total-sessions').textContent = '0';
  document.getElementById('yogi-total-minutes').textContent = '0';
  if (currentMode === 'yogi') {
    document.getElementById('current-streak').textContent = '0';
  }
  updateBackButtonVisibility();
  showYogiConfig();
  updateStats();
}

    function restoreActiveSessionUI() {
	  startMeditationBackground();
      document.getElementById('mode-selection').classList.add('hidden');
      document.getElementById('app-interface').classList.remove('hidden');
      document.getElementById('start-section').classList.add('hidden');
      document.getElementById('session-stats').classList.add('hidden');
      document.getElementById('timer-section').classList.remove('hidden');
      document.getElementById('yogi-progress').classList.add('hidden');
      document.getElementById('session-timing-display').classList.add('hidden');
      updateBackButtonVisibility();
	  updateHideUiBtnVisibility();
	  requestWakeLock();
      enableMobileAudioResume();


      const appFlowBtn = document.getElementById('flow-mode-btn-app')
      const appYogiBtn = document.getElementById('yogi-mode-btn-app');
      appFlowBtn.classList.toggle('hidden', currentMode === 'yogi');
      appYogiBtn.classList.toggle('hidden', currentMode === 'flow');

      const sessionInfoEl = document.getElementById('current-session-info');
      const badgeEl = document.getElementById('session-info-badge');
      const durationText = formatDuration(targetDuration);
      sessionInfoEl.textContent = `${durationText} `;
      badgeEl.classList.remove('flow-mode', 'yogi-mode');
      badgeEl.classList.add(currentMode === 'flow' ? 'flow-mode' : 'yogi-mode');

      document.getElementById('duration-selector').classList.toggle('hidden', currentMode === 'yogi');

      if (document.getElementById('music-toggle').checked) {
        const bgMusicPlayer = document.getElementById('bg-music-player');
		bgMusicPlayer.src = 'https://assets.trueyogi.app/assets/' + selectedMusicFile;
		bgMusicPlayer.currentTime = 0;
		bgMusicPlayer.loop = true;
		bgMusicPlayer.volume = 0.5;
		backgroundAudio = bgMusicPlayer;
        if (backgroundAudio) {
          const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
          backgroundAudio.currentTime = Math.min(elapsedTime, backgroundAudio.duration || Infinity);
          
      const playAudio = async () => {
        try {
          // Only resume if audioContext exists and has resume function
          if (audioContext && typeof audioContext.resume === 'function') {
            await audioContext.resume();
          }
          // Only play if backgroundAudio exists and has play function
          if (backgroundAudio && typeof backgroundAudio.play === 'function') {
            await backgroundAudio.play();
          }
        } catch (e) {
          // Silently ignore errors about null resume/play
          // Optionally log only unexpected errors:
          if (!(e && e.message && e.message.includes('resume'))) {
            console.log("Restore play error:", e);
          }
          // Optionally, do not retry if audioContext is missing
          // Or: setTimeout(playAudio, 200);
        }
      };
          playAudio();
        }
      }

      requestAnimationFrame(updateTimer);
      document.addEventListener('visibilitychange', handleVisibilityChange);
    }

    function updateBackButtonVisibility() {
      const backButtonContainer = document.getElementById('back-to-mode-container');
      const completeSection = document.getElementById('complete-section');
      const finalSection = document.getElementById('final-section');
      const isCompleteOrFinalVisible = !completeSection.classList.contains('hidden') || !finalSection.classList.contains('hidden');
      backButtonContainer.classList.toggle('hidden', sessionActive || isCompleteOrFinalVisible);
    }

function enforceClaimBeforeProceeding() {
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch {}
  const hasUnclaimed = completedChallenges.some(c => !c.claimed && c.completionDate);

  // Get both mode toggle buttons at the top of the interface
  const flowBtn = document.getElementById('flow-mode-btn-app');
  const yogiBtn = document.getElementById('yogi-mode-btn-app');

  if (hasUnclaimed) {
    document.getElementById('session-timing-display').classList.add('hidden');
    document.getElementById('yogi-progress').classList.add('hidden');
    document.getElementById('start-button').classList.add('hidden');
    document.getElementById('duration-selector').classList.add('hidden');
    showClaimRequiredModal();

    // Disable the mode buttons
    if (flowBtn) {
      flowBtn.classList.add('disabled');
      flowBtn.setAttribute('disabled', 'disabled');
    }
    if (yogiBtn) {
      yogiBtn.classList.add('disabled');
      yogiBtn.setAttribute('disabled', 'disabled');
    }
    return true;
  } else {
    document.getElementById('session-timing-display').classList.remove('hidden');
    document.getElementById('yogi-progress').classList.remove('hidden');
    document.getElementById('start-button').classList.remove('hidden');
    document.getElementById('duration-selector').classList.remove('hidden');

    // Enable the mode buttons if previously disabled
    if (flowBtn) {
      flowBtn.classList.remove('disabled');
      flowBtn.removeAttribute('disabled');
    }
    if (yogiBtn) {
      yogiBtn.classList.remove('disabled');
      yogiBtn.removeAttribute('disabled');
    }
    return false;
  }
}

    function selectMode(mode) {
  currentMode = mode;
  document.getElementById('mode-selection').classList.add('hidden');
  document.getElementById('app-interface').classList.remove('hidden');
  updateBackButtonVisibility();
  updateLangSwitcherVisibility();

// Hide FAQ tab when entering either Flow or TrueYogi mode
  document.getElementById('faq-tab').style.display = 'none'; // Add this line
  
  // Use getElementById directly since you use these IDs
  const appFlowBtn = document.getElementById('flow-mode-btn');
  const appYogiBtn = document.getElementById('yogi-mode-btn');
  if (appFlowBtn) appFlowBtn.classList.toggle('hidden', mode === 'yogi');
  if (appYogiBtn) appYogiBtn.classList.toggle('hidden', mode === 'flow');

  if (mode === 'flow') {
    document.getElementById('yogi-progress').classList.add('hidden');
    document.getElementById('session-timing-display').classList.add('hidden');
    setMode('flow');
    return;
  }

  if (mode === 'yogi') {
  if (enforceClaimBeforeProceeding()) return;
    // Challenge complete logic
    const today = new Date().toISOString().split('T')[0];
    const challengeComplete = (
      challengeData.endDate &&
      today >= challengeData.endDate &&
      challengeData.currentDay >= 41 &&
      challengeData.streakDays >= 41
    );
    if (challengeComplete) {
      document.getElementById('app-interface').classList.add('hidden');
      document.getElementById('journey-complete-section').classList.remove('hidden');
      // Show only claim if not claimed, only new journey if claimed
      if (typeof updateJourneyCompleteButtons === 'function') updateJourneyCompleteButtons();
      return;
    }

    try {
      loadYogiConfig();
      setMode('yogi');
      checkSessionNotifications();
    } catch (e) {
      console.error('Error loading Yogi config:', e);
      showYogiConfig();
	  updateEndDateDisplay();
	  updateStartDateDisplay();
	  updateNowDisplay();
    }
  }
}

    function returnToModeSelection() {
  const today = new Date();
  const todayStr = getLocalDateString(new Date());
  const endDate = challengeData.endDate;	

  // Check if challenge is complete BEFORE hiding everything
  if (
    currentMode === 'yogi' &&
    todayStr >= endDate &&
    challengeData.currentDay >= 41 &&
    challengeData.streakDays >= 41
  ) {
    const finalSection = document.getElementById('final-section');
    const journeyCompleteSection = document.getElementById('journey-complete-section');
    if (finalSection) finalSection.classList.add('hidden');
    if (journeyCompleteSection) journeyCompleteSection.classList.remove('hidden');
    updateBackButtonVisibility();
    return;
  }

  // Otherwise, go home as before
  document.getElementById('app-interface').classList.add('hidden');
  document.getElementById('timer-section').classList.add('hidden');
  document.getElementById('complete-section').classList.add('hidden');
  document.getElementById('final-section').classList.add('hidden');
  document.getElementById('incomplete-section').classList.add('hidden');
  document.getElementById('yogi-config-modal').classList.add('hidden');
  document.getElementById('end-meditation-modal').classList.add('hidden');
  document.getElementById('start-section').classList.remove('hidden');
  document.getElementById('session-stats').classList.remove('hidden');
  document.getElementById('yogi-progress').classList.toggle('hidden', currentMode !== 'yogi');
  document.getElementById('session-timing-display').classList.toggle('hidden', currentMode !== 'yogi');
  document.getElementById('faq-tab').style.display = 'block';
  
  // Reset stats visibility based on current mode
  document.getElementById('flow-stats').classList.toggle('hidden', currentMode === 'yogi');
  document.getElementById('yogi-stats').classList.toggle('hidden', currentMode === 'flow');
  document.getElementById('shared-stats').classList.toggle('hidden', currentMode === 'yogi');

  const appFlowBtn = document.getElementById('flow-mode-btn-app')
  const appYogiBtn = document.getElementById('yogi-mode-btn-app');
  if (appFlowBtn) appFlowBtn.classList.remove('hidden');
  if (appYogiBtn) appYogiBtn.classList.remove('hidden');

  document.getElementById('duration-selector').classList.remove('hidden');
  document.getElementById('mode-selection').classList.remove('hidden');

const bgMusicPlayer = document.getElementById('bg-music-player');
if (bgMusicPlayer) {
  bgMusicPlayer.pause();
  bgMusicPlayer.currentTime = 0;
  backgroundAudio = null;
}
  localStorage.removeItem('finalSectionActive');
  localStorage.removeItem('wisdomShownCount');
  localStorage.removeItem('quoteOrder');
  localStorage.removeItem('lastVisit');
  currentMode = null;
  currentSessionTime = null;
  updateEndDateDisplay();
  updateStartDateDisplay();
  updateNowDisplay();
  updateFAQVisibility();
  updateYogiIcon();
  updateLangSwitcherVisibility();
  updateHideUiBtnVisibility();
}

  function setMode(mode) {
  // Prevent mode switching during an active session in TrueYogi mode
  if (sessionActive && currentMode === 'yogi') {
    return;
  }

  currentMode = mode;

  const appFlowBtn = document.querySelector('#app-interface #flow-mode-btn-app');
  const appYogiBtn = document.querySelector('#app-interface #yogi-mode-btn-app');
  appFlowBtn.classList.toggle('active', mode === 'flow');
  appYogiBtn.classList.toggle('active', mode === 'yogi');

  appFlowBtn.classList.toggle('hidden', mode === 'yogi');
  appYogiBtn.classList.toggle('hidden', mode !== 'yogi');

  document.getElementById('duration-selector').classList.toggle('hidden', mode === 'yogi');
  document.getElementById('yogi-progress').classList.toggle('hidden', mode !== 'yogi');
  document.getElementById('session-timing-display').classList.toggle('hidden', mode !== 'yogi');
  
  // Show/hide appropriate stats sections
  document.getElementById('flow-stats').classList.toggle('hidden', mode === 'yogi');
  document.getElementById('yogi-stats').classList.toggle('hidden', mode === 'flow');
  document.getElementById('shared-stats').classList.toggle('hidden', mode === 'yogi');

  updateBackButtonVisibility();

  if (mode === 'yogi') {
    updateProgressDisplay();
	updateEndDateDisplay();
	updateStartDateDisplay();
	updateNowDisplay();
	updateFAQVisibility();
  }
  updateStats();
}

    function loadYogiConfig() {
      const savedConfig = localStorage.getItem('yogiConfig');
      try {
        if (savedConfig) {
          const config = JSON.parse(savedConfig);
          userSessionTimes = config.sessionTimes || [];
          if (userSessionTimes.length > 0 && typeof userSessionTimes[0] === 'string') {
            userSessionTimes = userSessionTimes.map(time => ({ time, duration: 1800 }));
          } else if (!Array.isArray(userSessionTimes)) {
            userSessionTimes = [];
          }
          notificationWindow = config.notificationWindow || 10;
          if (config.startDate) {
            challengeData.startDate = config.startDate;
            challengeData.endDate = config.endDate;
            challengeData.requiredSessions = config.requiredSessions || 1;
          }
          updateSessionTimesDisplay();
          //  checkJourneyCompletion();
          return;
        }
      } catch (e) {
        console.error('Error parsing yogiConfig:', e);
      }
      showYogiConfig();
    }

    function showYogiConfig() {	
	  if (!isMobile()) {
    showDesktopYogiModal();
  }
  if (isMobileSafariOrChromeNotPhantom()) {
  showMobileYogiModal();
}

  document.getElementById('app-interface').classList.add('hidden');
  document.getElementById('yogi-config-modal').classList.remove('hidden');
  const today = getLocalDateString();
  const maxDate = new Date();
  maxDate.setDate(maxDate.getDate() + 30); // Allow up to 30 days in the future
  const maxDateStr = maxDate.toISOString().split('T')[0];
  document.getElementById('start-date').value = today; // Default to today
  document.getElementById('start-date').min = today; // Prevent past dates
  document.getElementById('start-date').max = maxDateStr; // Limit to 30 days ahead
  document.getElementById('session-times-inputs').innerHTML = `
    <label id="session-times-label" class="block text-sm text-gray-400 mb-2"></label>
    <div id="session-time-1" class="mb-2 flex items-center gap-2 flex-col sm:flex-row">
      <input type="time" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg" required>
      <select id="duration-1" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg">
        <option value="60">1 minute</option>
        <option value="180">3 minutes</option>
        <option value="780">13 minutes</option>
        <option value="1800" selected>30 minutes</option>
        <option value="3600">60 minutes</option>
        <option value="5400">90 minutes</option>
        <option value="10800">180 minutes</option>
      </select>
    </div>
  `;
  // --- Add this block to RESET preview ---
  const tokenPreview = document.getElementById('token-preview');
  const tokenAmount = document.getElementById('token-amount');
  if (tokenPreview && tokenAmount) {
    tokenAmount.textContent = '0';
    tokenPreview.classList.remove('hidden');
  }
  // --- END reset block ---
  setTimeout(attachTokenPreviewListeners, 0);
  
  // Set the label's content using translation (if available)
  if (typeof t === 'function') {
    document.getElementById('session-times-label').textContent = t('sessionTimesLabel');
  } else {
    document.getElementById('session-times-label').textContent = 'Session Times and Durations (1‚Äì3):';
  }
  
}

function showClaimTokens() {
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch {}
  let unclaimed = completedChallenges.find(c => !c.claimed && c.completionDate);
  if (!unclaimed) {
    alert('No unclaimed challenge to claim tokens for!');
    return;
  }
  document.getElementById('journey-complete-section').classList.add('hidden');
  document.getElementById('claim-tokens-section').classList.remove('hidden');
}

function closeClaimTokens() {
  document.getElementById('claim-tokens-section').classList.add('hidden');
  document.getElementById('journey-complete-section').classList.remove('hidden');
  updateJourneyCompleteButtons();
}

function showCertificatePage() {
  // Hide app, show certificate
  document.getElementById('journey-complete-section').classList.add('hidden');
  document.getElementById('certificate-page').classList.remove('hidden');
  // Get latest completed challenge
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch {}
  let lastChallenge = completedChallenges[completedChallenges.length - 1] || {};
  let challenge = lastChallenge.challengeId ? lastChallenge : (JSON.parse(localStorage.getItem('yogiChallenge')) || {});
  const wallet = window.walletPublicKey || localStorage.getItem('currentJourneyWallet') || '';
  document.getElementById('cert-wallet').textContent = wallet ? `(Wallet: ${wallet.slice(0,4)}...${wallet.slice(-4)})` : 'N/A';
  document.getElementById('cert-startDate').textContent = challenge.startDate || 'N/A';
  
// Prefer showing the local completion date if available; fallback to endDate
  const shownCompletionDate = challenge.completionDate || challenge.endDate || 'N/A';
  document.getElementById('cert-endDate').textContent = shownCompletionDate;
  document.getElementById('cert-totalSessions').textContent = challenge.totalSessions || 'N/A';
  document.getElementById('cert-totalMinutes').textContent = challenge.totalMinutes || 'N/A';
  document.getElementById('cert-totalTokens').textContent = 'YÃê' + challenge.totalTokens || 'N/A';
  document.getElementById('cert-issuedOn').textContent = shownCompletionDate;
  document.getElementById('cert-certId').textContent = 'TR_' + challengeData.challengeId;
}

function closeCertificatePage() {
  document.getElementById('certificate-page').classList.add('hidden');
  document.getElementById('journey-complete-section').classList.remove('hidden');
}
function printCertificatePage() {
  // Only print the certificate section
  const certPage = document.getElementById('certificate-page');
  certPage.classList.remove('hidden');
  window.print();
}

// Get local time string (e.g. "2025-08-24 10:45:02")
function getLocalTimeString() {
  const now = new Date();
  return now.getFullYear() + '-' +
    String(now.getMonth() + 1).padStart(2, '0') + '-' +
    String(now.getDate()).padStart(2, '0') + ' ' +
    String(now.getHours()).padStart(2, '0') + ':' +
    String(now.getMinutes()).padStart(2, '0') + ':' +
    String(now.getSeconds()).padStart(2, '0');
}

    function addSessionTimeInput() {
  const sessionTimesContainer = document.getElementById('session-times-inputs');
  const inputs = sessionTimesContainer.querySelectorAll('div[id^="session-time-"]').length;
  
  // Check maximum 3 sessions
  if (inputs >= 3) {
    const errorElement = document.getElementById('config-error');
    errorElement.textContent = 'Maximum 3 session times allowed.';
    errorElement.classList.remove('hidden');
    return;
  }

  // Get the last session's time and duration
  const lastSessionDiv = document.getElementById(`session-time-${inputs}`);
  const lastTimeInput = lastSessionDiv.querySelector('input[type="time"]');
  const lastDurationSelect = lastSessionDiv.querySelector('select');
  const lastTime = lastTimeInput.value;
  const lastDuration = parseInt(lastDurationSelect.value) / 60; // Convert seconds to minutes

  // Calculate new session time
  let newTime = '';
  if (lastTime) {
    const [hours, minutes] = lastTime.split(':').map(Number);
    const lastTimeInMinutes = hours * 60 + minutes;
    const gapInMinutes = 180; // 3-hour gap
    const totalMinutes = lastTimeInMinutes + lastDuration + gapInMinutes;
    const newTotalMinutes = totalMinutes % (24 * 60); // Handle midnight overflow
    const newHours = Math.floor(newTotalMinutes / 60);
    const newMinutes = newTotalMinutes % 60;
    newTime = `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
  }

  // Create new session input
  const newInput = document.createElement('div');
  newInput.className = 'session-time-block flex items-center gap-2 flex-col sm:flex-row';
  newInput.id = `session-time-${inputs + 1}`;
  newInput.innerHTML = `
    <input type="time" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg" value="${newTime}" required>
    <select id="duration-${inputs + 1}" class="w-full bg-gray-800 text-white px-4 py-2 rounded-lg">
      <option value="60">1 minute</option>
      <option value="180">3 minutes</option>
      <option value="780">13 minutes</option>
      <option value="1800" selected>30 minutes</option>
      <option value="3600">60 minutes</option>
      <option value="5400">90 minutes</option>
      <option value="10800">180 minutes</option>
    </select>
    ${inputs >= 1 ? `
      <button onclick="removeSessionTimeInput('session-time-${inputs + 1}')" class="text-red-400 hover:text-red-300 text-sm cursor-pointer">
        <i class="fas fa-minus mr-1"></i>${t('removeSessionTime')}
      </button>
    ` : ''}
  `;
  sessionTimesContainer.appendChild(newInput);
  document.getElementById('config-error').classList.add('hidden');
  attachTokenPreviewListeners();
  updateTokenPreview()
}

    function removeSessionTimeInput(id) {
      const inputs = document.querySelectorAll('#session-times-inputs input[type="time"]').length;
      if (inputs <= 1) {
        document.getElementById('config-error').textContent = 'At least one session time is required.';
        document.getElementById('config-error').classList.remove('hidden');
        return;
      }
      document.getElementById(id).remove();
      document.getElementById('config-error').classList.add('hidden');
	  attachTokenPreviewListeners();
	  updateTokenPreview();
    }

    function saveYogiConfig() {
	const journeyWallet = localStorage.getItem('currentJourneyWallet');
const walletIsConnected = !!window.walletPublicKey;
const jwtToken = localStorage.getItem('jwtToken');
const jwtValid = isJwtValid();

// 1. If the user is connected to a wallet
if (walletIsConnected) {
  // a. If journeyWallet is set and does not match, block
  if (journeyWallet && window.walletPublicKey !== journeyWallet) {
    showWalletSwitchBlockModal(journeyWallet, window.walletPublicKey);
    return;
  }
  // b. If not verified (missing or expired JWT), block
  if (!jwtValid) {
    showAuthRequiredModal();
    return;
  }
}

// 2. If journeyWallet exists and wallet is NOT connected, block
if (journeyWallet && !walletIsConnected) {
  showConnectWalletRequiredModal();
  return;
}

if (challengeData.currentDay >= 22 && !isMobile()) {
  showMobileRequiredModal();
  return;
}

  const startDate = document.getElementById('start-date').value;
  const sessionTimeInputs = document.querySelectorAll('#session-times-inputs input[type="time"]');
  const durationInputs = document.querySelectorAll('#session-times-inputs select[id^="duration-"]');
  const sessionTimes = Array.from(sessionTimeInputs).map((input, index) => ({
    time: input.value,
    duration: parseInt(durationInputs[index].value)
  })).filter(session => session.time);

  if (!startDate) {
    document.getElementById('config-error').textContent = 'Please select a start date.';
    document.getElementById('config-error').classList.remove('hidden');
    return;
  }

  const today = getLocalDateString();
  const selectedDate = new Date(startDate);
  const todayDate = new Date(today);
  if (selectedDate < todayDate) {
    document.getElementById('config-error').textContent = 'Start date cannot be in the past';
    document.getElementById('config-error').classList.remove('hidden');
    return;
  }

  if (sessionTimes.length < 1) {
    document.getElementById('config-error').textContent = 'Please select at least one session time.';
    document.getElementById('config-error').classList.remove('hidden');
    return;
  }

  const timesInMinutes = sessionTimes.map(session => {
    const [hours, minutes] = session.time.split(':').map(Number);
    return { start: hours * 60 + minutes, duration: session.duration / 60 };
  }).sort((a, b) => a.start - b.start);

  for (let i = 1; i < timesInMinutes.length; i++) {
    const prevEnd = timesInMinutes[i - 1].start + timesInMinutes[i - 1].duration;
    if (timesInMinutes[i].start - prevEnd < 180) {
      document.getElementById('config-error').textContent = 'Session times must have at least a 3-hour gap between the end of one session and the start of the next.';
      document.getElementById('config-error').classList.remove('hidden');
      return;
    }
  }

  const start = new Date(startDate); // Use the selected future date
  const end = new Date(start);
  end.setDate(start.getDate() + 40);

  // --- Calculate totalTokens correctly for the whole challenge ---
  const totalMinutes = sessionTimes.reduce((sum, s) => sum + (s.duration / 60), 0);
  const totalTokens = totalMinutes * 10;
  
  // Preserve reset count when reconfiguring
const currentResetCount = challengeData.resetCount || 0;
// Get the domain/source
const challengeSourceFull = window.location.origin;

// --- GENERATE UNIQUE CHALLENGE ID ---
  // Use startDate, endDate and timestamp for uniqueness
  const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const deviceType = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? "mobile" : "desktop";
  const userAgent = navigator.userAgent;
  const created_at_local = getLocalTimeString();
  const sessionCount = sessionTimes.length;
  const sessionDurations = sessionTimes.map(s => `${Math.round(s.duration / 60)}md`).join('_');
  const challengeConfigTimestamp = Date.now();
  const challengeId = `${start.toISOString().split('T')[0]}_${end.toISOString().split('T')[0]}_${sessionCount}s_${sessionDurations}_${challengeConfigTimestamp}`;  // Save to challengeData (and config)
userSessionTimes = sessionTimes;
challengeData = {
  startDate: start.toISOString().split('T')[0],
  endDate: end.toISOString().split('T')[0],
  currentDay: 1,
  sessionsCompleted: [],
  requiredSessions: sessionTimes.length,
  lastSessionDate: null,
  streakDays: 0,
  totalSessions: 0,
  totalMinutes: 0,
  resetCount: currentResetCount, // Preserve the reset count
  challengeStreak: 0,
  challengeId: challengeId,
  totalTokens,
  timezone: userTimezone,
  created_at_local: created_at_local,
  device_type: deviceType,
  user_agent: userAgent,
  challenge_source: challengeSourceFull
};

  localStorage.setItem('yogiConfig', JSON.stringify({
    startDate: challengeData.startDate,
    endDate: challengeData.endDate,
    sessionTimes,
    requiredSessions: challengeData.requiredSessions,
    notificationWindow: 10,
    configured: true,
	challengeId,
	timezone: userTimezone,
	created_at_local: created_at_local,
	device_type: deviceType,
    user_agent: userAgent,
	challenge_source: challengeSourceFull
  }));
  saveChallengeData(); 
  updateYogiIcon(); 
  document.getElementById('yogi-config-modal').classList.add('hidden');
  document.getElementById('app-interface').classList.remove('hidden');
  updateBackButtonVisibility();
  updateSessionTimesDisplay();
  checkSessionNotifications();
  if (window.walletPublicKey && localStorage.getItem('jwtToken') && typeof window.syncYogiConfigToSupabase === "function") {
    window.syncYogiConfigToSupabase();
  }
}

function completeExpiredSessionIfNeeded() {
  // Check if there is an active session stored in localStorage
  const activeSessionStr = localStorage.getItem('activeSession');
  if (!activeSessionStr) return;

  let sessionData;
  try {
    sessionData = JSON.parse(activeSessionStr);
  } catch (e) {
    // If corrupted, remove and exit
    localStorage.removeItem('activeSession');
    return;
  }

  // Check if the session is still flagged as active and expired
  if (sessionData.sessionActive && sessionData.endTime <= Date.now()) {
    // Prepare the completion data
    const sessionDate = new Date(sessionData.startTime);
    const today = getLocalDateString(sessionDate); // should match your main date formatting
    const sessionTime = sessionData.sessionTime;
    const duration = sessionData.targetDuration;

    // Ensure challengeData.sessionsCompleted exists
    if (!challengeData.sessionsCompleted) {
      challengeData.sessionsCompleted = [];
    }

    // Only add if not already present (no duplicates)
    const alreadyCompleted = challengeData.sessionsCompleted.some(
      s => s.date === today && s.time === sessionTime
    );

    if (!alreadyCompleted) {
      challengeData.sessionsCompleted.push({
        time: sessionTime,
        duration: duration,
        date: today
      });

      // Update other stats if needed
      challengeData.totalSessions = (challengeData.totalSessions || 0) + 1;
      challengeData.totalMinutes = (challengeData.totalMinutes || 0) + Math.round(duration / 60);
      challengeData.lastSessionDate = today;
      // Optionally handle streak logic here
      localStorage.setItem('yogiChallenge', JSON.stringify(challengeData));
    }

    // Remove the active session flag
    localStorage.removeItem('activeSession');
  }
}

async function updateSessionTimesDisplay() {
  const completeSectionVisible = !document.getElementById('complete-section').classList.contains('hidden');
  const finalSectionVisible = !document.getElementById('final-section').classList.contains('hidden');
  if (completeSectionVisible || finalSectionVisible) {
    closeMissedSessionModal();
    return;
  }

  // Await completion of any expired session before proceeding
  if (typeof completeExpiredSessionIfNeeded === 'function') {
    await completeExpiredSessionIfNeeded();
  }
  
  const list = document.getElementById('session-times-list');
  list.innerHTML = '';
  if (!challengeData.startDate || !userSessionTimes.length) return;

  const now = new Date();
  const currentHours = now.getHours();
  const currentMinutes = now.getMinutes();
  const currentTime = currentHours * 60 + currentMinutes;
  const today = getLocalDateString(now);
  const [y, m, d] = challengeData.startDate.split('-').map(Number);
  const startDate = new Date(y, m - 1, d);
  const [ey, em, ed] = challengeData.endDate.split('-').map(Number);
  const endDate = new Date(ey, em - 1, ed);

  // FIX: Check if today is after challenge end date
  const isChallengeEnded = now > endDate;

  let hasMissedSession = false;
  let todayCompleted = challengeData.sessionsCompleted.filter(s => s.date === today).length;

  // Only evaluate sessions if today is on or after startDate
  if (now < startDate) {
    userSessionTimes.forEach(session => {
      const badge = document.createElement('span');
      badge.className = 'session-time-badge px-2 py-1 rounded-full text-xs font-medium';
      badge.textContent = `${formatTime(session.time)} (${formatDuration(session.duration)})`;
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      badge.setAttribute('data-tooltip', t('journeyBegins') + ' ' + startDate.toLocaleDateString('en-US', options));
      badge.classList.add('status-tooltip', 'Journey-begins-tip');
      list.appendChild(badge);
    });
    return;
  }

  // Sort sessions by time
  const sortedSessions = [...userSessionTimes].sort((a, b) => a.time.localeCompare(b.time));

  sortedSessions.forEach(session => {
    const [hours, minutes] = session.time.split(':').map(Number);
    const sessionTime = hours * 60 + minutes;
    const isActive = Math.abs(sessionTime - currentTime) <= 10;
    const isCompleted = challengeData.sessionsCompleted.some(
      completed => completed.time === session.time && completed.date === today
    );
    
    // FIX: If challenge has ended, treat all sessions as completed
    if (isChallengeEnded) {
      const badge = document.createElement('span');
      badge.className = 'session-time-badge px-2 py-1 rounded-full text-xs font-medium completed';
      badge.textContent = `${formatTime(session.time)} (${formatDuration(session.duration)})`;
      badge.setAttribute('data-tooltip', t('challengeCompleted'));
      badge.classList.add('status-tooltip', 'completed-tip');
      list.appendChild(badge);
      return; // Skip to next session
    }
    
    // Original logic for active challenge period
    const isMissed = !isCompleted && (
      (sessionTime < currentTime - 10) ||
      isSessionMissedOnPreviousDays(session.time, today)
    );

    if (isMissed) {
      hasMissedSession = true;
    }

    const badge = document.createElement('span');
    badge.className = `session-time-badge px-2 py-1 rounded-full text-xs font-medium ${
      isMissed ? 'missed' :
      isActive && !isCompleted ? 'active' : 
      isCompleted ? 'completed' : ''
    }`;
    badge.textContent = `${formatTime(session.time)} (${formatDuration(session.duration)})`;
    if (isCompleted) {
      badge.setAttribute('data-tooltip', t('completed'));
      badge.classList.add('status-tooltip', 'completed-tip');
    } else if (isMissed) {
      badge.setAttribute('data-tooltip', t("missed"));
      badge.classList.add('status-tooltip', 'missed-tip');
    } else if (isActive) {
      badge.setAttribute('data-tooltip', t("availableNow"));
      badge.classList.add('status-tooltip', 'active-tip');
    } else {
      badge.setAttribute('data-tooltip', t("upcoming"));
      badge.classList.add('status-tooltip', 'upcoming-tip');
    }
    list.appendChild(badge);
  });

  // FIX: Don't show missed modal if challenge has ended
  if (
    !isChallengeEnded &&
    hasMissedSession &&
    currentMode === 'yogi' &&
    todayCompleted < challengeData.requiredSessions
  ) {
    showMissedSessionModal();
  }
}

function isSessionMissedOnPreviousDays(sessionTime, today) {
  const todayDate = new Date(today + 'T00:00:00');
  const startDate = new Date(challengeData.startDate + 'T00:00:00');
  
  const daysSinceStart = Math.floor((todayDate - startDate) / (1000 * 60 * 60 * 24));
  const expectedSessions = daysSinceStart * challengeData.requiredSessions;
  const actualSessions = challengeData.sessionsCompleted.length;
  
  console.log(`Days: ${daysSinceStart}, Expected: ${expectedSessions}, Actual: ${actualSessions}`);
  
  return actualSessions < expectedSessions;
}

    function formatTime(time) {
      const [hours, minutes] = time.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const adjustedHours = hours % 12 || 12;
      return `${adjustedHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds} seconds`;
      const minutes = Math.round(seconds / 60);
      return `${minutes} minute${minutes !== 1 ? 's' : ''}`;
    }

    function formatDateOrDay(date, today) {
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  
  if (date.toDateString() === today.toDateString()) return "today";
  if (date.toDateString() === tomorrow.toDateString()) return "tomorrow";
  
  // For dates more than 2 days away, show the actual date
  return `on ${date.toLocaleDateString('en-US', { 
    month: 'short', 
    day: 'numeric',
    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
  })}`;
}

    function showNextSessionTime() {
  // First check if we have session data
  if (userSessionTimes.length === 0) {
    // Try to load config if missing
    loadYogiConfig();
    
    // If still no data
    if (userSessionTimes.length === 0) {
      showNextSessionModal("Not configured", "N/A", "Please configure session times first");
      return;
    }
  }

  const now = new Date();
  const startDate = new Date(challengeData.startDate);
  
  // If before startDate, show the first session on startDate + 1 day
  if (now < startDate) {
    const nextSession = userSessionTimes[0];
    const displayDate = new Date(startDate);
    displayDate.setDate(displayDate.getDate() + 1);
    
    showNextSessionModal(
      formatTime(nextSession.time), 
      formatDuration(nextSession.duration), 
      `on ${displayDate.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric'
      })}`
    );
    return;
  }

  const currentHours = now.getHours();
  const currentMinutes = now.getMinutes();
  const currentTime = currentHours * 60 + currentMinutes;
  const today = getLocalDateString(now);

  // Find all sessions for today that haven't been completed yet
  const remainingSessions = userSessionTimes.filter(session => {
    const [hours, minutes] = session.time.split(':').map(Number);
    const sessionTime = hours * 60 + minutes;
    
    // Check if session is in the future or within the 10-minute grace period
    const isFutureOrCurrent = sessionTime > currentTime - 10;
    
    // Check if session hasn't been completed today
    const isNotCompleted = !challengeData.sessionsCompleted.some(
      completed => completed.time === session.time && completed.date === today
    );
    
    return isFutureOrCurrent && isNotCompleted;
  });

  // If no remaining sessions today, find first session tomorrow
  if (remainingSessions.length === 0) {
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    // Find first session of tomorrow (sorted by time)
    const firstSessionTomorrow = [...userSessionTimes]
      .sort((a, b) => a.time.localeCompare(b.time))[0];
    
    showNextSessionModal(
      formatTime(firstSessionTomorrow.time), 
      formatDuration(firstSessionTomorrow.duration), 
      `tomorrow`
    );
    return;
  }

  // Find the next session today (sorted by time)
  const nextSessionToday = remainingSessions
    .sort((a, b) => a.time.localeCompare(b.time))[0];
  
  showNextSessionModal(
    formatTime(nextSessionToday.time), 
    formatDuration(nextSessionToday.duration), 
    "today"
  );
}

function updateStartDateDisplay() {
  const display = document.getElementById('start-date-display');
  const label = document.getElementById('start-label');
  const value = document.getElementById('start-date-value');
  
  // Only show if in Yogi mode, not during active session, and we have a start date
  if (currentMode === 'yogi' && !sessionActive && challengeData.startDate) {
    const [y, m, d] = challengeData.startDate.split('-').map(Number);
    const startDate = new Date(y, m - 1, d);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    // Set label via translation function
    label.textContent = t('spark');
    value.textContent = startDate.toLocaleDateString('en-US', options);
    display.classList.remove('hidden');
  } else {
    display.classList.add('hidden');
  }
}

function updateEndDateDisplay() {
  const display = document.getElementById('end-date-display');
  const label = document.getElementById('end-label');
  const value = document.getElementById('end-date-value');
  
  // Only show if in Yogi mode, not during active session, and we have an end date
  if (currentMode === 'yogi' && !sessionActive && challengeData.startDate && challengeData.endDate) {
    const [y, m, d] = challengeData.endDate.split('-').map(Number);
    const endDate = new Date(y, m - 1, d);
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    // Set label via translation function
    label.textContent = t('arrival');
    value.textContent = endDate.toLocaleDateString('en-US', options);
    display.classList.remove('hidden');
  } else {
    display.classList.add('hidden');
  }
}

function updateNowDisplay() {
  const el = document.getElementById('now-date-display');
  // Show only in Yogi mode, not during active session
  if (currentMode === 'yogi' && !sessionActive) {
    el.classList.remove('hidden');
  } else {
    el.classList.add('hidden');
  }
}

    function checkSessionNotifications() {
      if (!notificationPermission || userSessionTimes.length === 0) return;

      const now = new Date();
      const currentHours = now.getHours();
      const currentMinutes = now.getMinutes();
      const currentTime = currentHours * 60 + currentMinutes;
      const today = getLocalDateString(now);

      userSessionTimes.forEach(session => {
        const [hours, minutes] = session.time.split(':').map(Number);
        const sessionTime = hours * 60 + minutes;
        const isCompleted = challengeData.sessionsCompleted.some(
          completed => completed.time === session.time && completed.date === today
        );
        if (!isCompleted && Math.abs(sessionTime - currentTime) <= notificationWindow) {
          new Notification('TrueYogi Session Reminder', {
            body: `Your ${formatTime(session.time)} (${formatDuration(session.duration)}) meditation session is starting soon!`,
            icon: 'assets/favicon.ico'
          });
        }
      });

      setTimeout(checkSessionNotifications, 60000);
    }

    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.onstatechange = () => {
          console.log('AudioContext state:', audioContext.state);
          if (audioContext.state === 'running' && backgroundAudio && sessionActive) {
            backgroundAudio.play().catch(e => console.log("State change play error:", e));
          }
        };
      }
      if (audioContext.state === 'suspended') {
        return audioContext.resume().then(() => {
          console.log('AudioContext resumed successfully');
        }).catch(e => {
          console.log("AudioContext resume error:", e);
        });
      }
      return Promise.resolve();
    }

    function ensureAudioPlaying(attempts = 3) {
  if (!backgroundAudio || !sessionActive || attempts <= 0) return;
  if (backgroundAudio.paused) {
    initAudioContext().then(() => {
      backgroundAudio.play().catch(e => {
        console.log("Ensure play error:", e);
        setTimeout(() => ensureAudioPlaying(attempts - 1), 300);
      });
    });
  }
}

function showStartMeditationModal() {
  const modal = document.getElementById('start-meditation-modal');
  const textElement = document.getElementById('meditation-confirmation-text');
  
  let message = t('universeBows');
  if (currentMode === 'yogi') {
    const duration = formatDuration(targetDuration);
    message += ` ${t('sacredSessionDuration')} ${duration}. `;
  } else {
    const durationSelect = document.getElementById('duration');
    const durationText = durationSelect.options[durationSelect.selectedIndex].text;
    message += ` ${t('flowSessionDuration')} ${durationText}. `;
  }
  message += t('meditationInstructions');
  
  textElement.textContent = message;
  modal.classList.remove('hidden');
  const firstButton = modal.querySelector('button, [tabindex="0"]');
  if (firstButton) firstButton.focus();
}

function confirmStartMeditation() {
  document.getElementById('start-meditation-modal').classList.add('hidden');
  beginMeditationSession(); // Proceed with the original meditation start
}

function cancelStartMeditation() {
  document.getElementById('start-meditation-modal').classList.add('hidden');
}

let meditationSelfHealInterval = null;

function startMeditationSelfHeal() {
  stopMeditationSelfHeal();
  meditationSelfHealInterval = setInterval(() => {
    if (backgroundAudio && sessionActive) {
      if (backgroundAudio.paused) {
        backgroundAudio.loop = true;    // Safe to re-assert
        backgroundAudio.muted = false;
        backgroundAudio.volume = 0.5;
        backgroundAudio.play().catch(()=>{});
      }
    }
  }, 2500); // every 2.5 seconds
}

function stopMeditationSelfHeal() {
  if (meditationSelfHealInterval) {
    clearInterval(meditationSelfHealInterval);
    meditationSelfHealInterval = null;
  }
}

  async function startMeditation() {
   // 1. If journey wallet exists but wallet is not connected, block session start 
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;
  if (journeyWallet && !walletIsConnected) {
    // Show modal: Please connect your wallet to continue your meditation journey.
    showConnectWalletRequiredModal();
    return;
  }
  
  // Block meditation if wallet doesn't match journey wallet
  if (window.walletPublicKey && journeyWallet && journeyWallet !== window.walletPublicKey) {
    showWalletSwitchBlockModal(journeyWallet, window.walletPublicKey);
    return;
  }
  // 2.5. Block and trigger verification if not verified (no valid JWT)
  const jwtToken = localStorage.getItem('jwtToken');
  const tokenValid = jwtToken && getJwtExpiry(jwtToken) > Date.now();
  const jwtExpiry = getJwtExpiry(jwtToken);


  if (
    currentMode === 'yogi' &&
    journeyWallet &&
    walletIsConnected &&
    !tokenValid
  ) {
    // Show verify identity modal and after user verifies, start meditation seamlessly
    window.afterIdentityVerified = function() {
      window.afterIdentityVerified = null;
    };
    showAuthRequiredModal();
    return;
  }
  
  // NEW: Token valid but less than 2 hour left
if (
  currentMode === 'yogi' &&
  journeyWallet &&
  walletIsConnected &&
  tokenValid &&
  jwtExpiry - Date.now() < 7200 * 1000
) {
  window.afterIdentityVerified = function() {
    window.afterIdentityVerified = null;
  };
  showAuthRequiredModal();
  return;
}

  // Flow check (EXACT same logic)
if (
  currentMode === 'flow' &&
  journeyWallet &&
  walletIsConnected &&
  !tokenValid
) {
  window.afterIdentityVerified = function() {
    showStartMeditationModal();
    window.afterIdentityVerified = null;
  };
  showAuthRequiredModal();
  return;
}

    // Day-21 wallet check (only in Yogi mode)
  if (
    currentMode === 'yogi' &&
    challengeData.currentDay >= 22 &&
    (!window.walletPublicKey || !localStorage.getItem('jwtToken'))
  ) {
    // Show the modal and block session start
    document.getElementById('wallet-required-modal').classList.remove('hidden');
    return;
  }
  
  // Day-21 device check (only in Yogi mode)
if (
  currentMode === 'yogi' &&
  challengeData.currentDay >= 22 &&
  !isMobile()
) {
  // Show modal and block session start
  showMobileRequiredModal();
  return;
}

  updateEndDateDisplay();
  updateStartDateDisplay();
  updateNowDisplay();
  initAudioContext();
  
 // First handle the Yogi mode validation and session selection
if (currentMode === 'yogi') {
  const now = new Date();
  const today = getLocalDateString(now);
  
  // Check if challenge has ended
  if (challengeData.endDate) {
    const endDate = new Date(challengeData.endDate + "T00:00:00");
    if (now > endDate) {
      showChallengeCompletedModal();
      return;
    }
  }

    // Block if missed session in Yogi mode
if (hasMissedSession()) {
  showMissedSessionModal();
  return;
}
  
  const currentHours = now.getHours();
  const currentMinutes = now.getMinutes();
  const currentTime = currentHours * 60 + currentMinutes;
  let selectedSession = null;

  // Check if before start date
  const startDate = new Date(challengeData.startDate);
  if (now < startDate) {
    showSessionTimeModal();
    return;
  }

  for (const session of userSessionTimes) {
    const [hours, minutes] = session.time.split(':').map(Number);
    const sessionTime = hours * 60 + minutes;
    const isCompleted = challengeData.sessionsCompleted.some(
      completed => completed.time === session.time && completed.date === today
    );
    // Only allow if in window and not already completed
    if (Math.abs(sessionTime - currentTime) <= 10 && !isCompleted) {
      selectedSession = session;
      break;
    }
  }

  if (!selectedSession) {
    const remainingSessions = userSessionTimes.filter(session => {
      return !challengeData.sessionsCompleted.some(
        completed => completed.time === session.time && completed.date === today
      );
    });
    if (remainingSessions.length === 0) {
      showCompletedSessionsModal(challengeData.requiredSessions);
    } else {
      showSessionTimeModal();
    }
    return;
  }

    targetDuration = selectedSession.duration;
    currentSessionTime = selectedSession.time;
  } else {
    // Flow - get duration from dropdown
    targetDuration = parseInt(document.getElementById('duration').value);
    currentSessionTime = null;
  }

  // Now show the confirmation modal instead of starting immediately
  showStartMeditationModal();
}

// This is the actual meditation start that gets called after confirmation
async function beginMeditationSession() {
  startMeditationBackground();
  updateHideUiBtnVisibility();
  updateHideUiButtonVisibility();
  requestWakeLock();
  if ("vibrate" in navigator) navigator.vibrate(20);
    // Device type detection
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const deviceType = isMobile ? "mobile" : "desktop";
  
  startTime = Date.now();
  endTime = startTime + (targetDuration * 1000);
  sessionActive = true;
  

	// Hide FAQ tab (add this line)
  document.getElementById('faq-tab').style.display = 'none';
  // Set up session info display
  const sessionInfoEl = document.getElementById('current-session-info');
  const badgeEl = document.getElementById('session-info-badge');
  let durationText = '';
  
  if (currentMode === 'yogi') {
    durationText = formatDuration(targetDuration);
    sessionInfoEl.textContent = `${durationText}`;
    badgeEl.classList.remove('flow-mode');
    badgeEl.classList.add('yogi-mode');
  } else {
    const durationSelect = document.getElementById('duration');
    durationText = durationSelect.options[durationSelect.selectedIndex].text;
    sessionInfoEl.textContent = `${durationText}`;
    badgeEl.classList.remove('yogi-mode');
    badgeEl.classList.add('flow-mode');
  }

  // Handle music settings
  localStorage.setItem('musicToggle', document.getElementById('music-toggle').checked);
  document.querySelectorAll('audio[id^="bg-music-"]').forEach(audio => {
    audio.pause();
    audio.currentTime = 0;
  });

if (document.getElementById('music-toggle').checked) {
  const bgMusicPlayer = document.getElementById('bg-music-player');
  bgMusicPlayer.src = 'https://assets.trueyogi.app/assets/' + selectedMusicFile;
  bgMusicPlayer.currentTime = 0;
  bgMusicPlayer.loop = true;
  bgMusicPlayer.volume = 0.5;
  try {
    await bgMusicPlayer.play();
    startMeditationSelfHeal();             
  } catch (e) {
    setTimeout(() => {
      bgMusicPlayer.play();
      startMeditationSelfHeal();          
    }, 300);
  }
  backgroundAudio = bgMusicPlayer;
}

  // Update UI
  document.getElementById('start-section').classList.add('hidden');
  document.getElementById('session-stats').classList.add('hidden');
  document.getElementById('timer-section').classList.remove('hidden');
  document.getElementById('yogi-progress').classList.add('hidden');
  document.getElementById('session-timing-display').classList.add('hidden');
  document.getElementById('start-date-display').classList.add('hidden');
  document.getElementById('now-date-display').classList.add('hidden');
  document.getElementById('end-date-display').classList.add('hidden');
  updateBackButtonVisibility();
  enableMobileAudioResume();

  // Save session state
  localStorage.setItem('activeSession', JSON.stringify({
    startTime,
    endTime,
    mode: currentMode,
    targetDuration,
    sessionActive,
    sessionTime: currentSessionTime,
	deviceType
  }));

  // Start timer
  requestAnimationFrame(updateTimer);
  document.addEventListener('visibilitychange', handleVisibilityChange);
}

    function showEndMeditationModal() {
      sessionCompletedWhileModalOpen = false;
      document.getElementById('timer-section').classList.add('hidden');
      document.getElementById('end-meditation-modal').classList.remove('hidden');
    }

    function cancelEndMeditation() {
      if (sessionCompletedWhileModalOpen) {
        document.getElementById('end-meditation-modal').classList.add('hidden');
        return;
      }

      document.getElementById('end-meditation-modal').classList.add('hidden');
      document.getElementById('timer-section').classList.remove('hidden');
      document.getElementById('yogi-progress').classList.add('hidden');
      document.getElementById('session-timing-display').classList.add('hidden');
      updateBackButtonVisibility();
      if (document.getElementById('music-toggle').checked && backgroundAudio) {
        backgroundAudio.play().catch(e => console.log("Audio play error:", e));
      }
      requestAnimationFrame(updateTimer);
    }

    function confirmEndMeditation() {
	updateEndDateDisplay();
	updateStartDateDisplay();
	updateNowDisplay();
	stopMeditationBackground();
	updateHideUiBtnVisibility();
	updateHideUiButtonVisibility();
	disableMobileAudioResume();
	if ("vibrate" in navigator) navigator.vibrate(20);
  if (sessionCompletedWhileModalOpen) {
    document.getElementById('end-meditation-modal').classList.add('hidden');
    return;
  }

  sessionActive = false;
  releaseWakeLock();
  localStorage.removeItem('activeSession');

  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;
  if (journeyWallet && walletIsConnected && journeyWallet !== window.walletPublicKey) {
   // Do NOT save session. Just return silently.
  return;
  }

  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  const today = getLocalDateString();
  sessions[today] = sessions[today] || [];
  const actualMinutes = Math.round((Date.now() - startTime) / (1000 * 60));
  sessions[today].push({ 
    minutes: actualMinutes, 
    mode: currentMode, 
    completed: false,
    sessionTime: currentSessionTime 
  });
  localStorage.setItem('meditationSessions', JSON.stringify(sessions));
  
  // Immediately sync cancelled session to Supabase
if (window.walletPublicKey && typeof window.syncSessionsToSupabase === "function") {
  window.syncSessionsToSupabase();
}

  document.getElementById('end-meditation-modal').classList.add('hidden');
  
  if (currentMode === 'yogi') {
    showMissedSessionModal();
  } else {
    document.getElementById('incomplete-section').classList.remove('hidden');
  }
  
  document.getElementById('session-stats').classList.remove('hidden');
  document.getElementById('yogi-progress').classList.toggle('hidden', currentMode !== 'yogi');
  document.getElementById('session-timing-display').classList.toggle('hidden', currentMode !== 'yogi');
  updateBackButtonVisibility();

const bgMusicPlayer = document.getElementById('bg-music-player');
if (bgMusicPlayer) {
  bgMusicPlayer.pause();
  bgMusicPlayer.currentTime = 0;
  backgroundAudio = null;
}

  document.removeEventListener('visibilitychange', handleVisibilityChange);
  currentSessionTime = null;
  updateStats();
  updateSessionTimesDisplay();
}

function updateTimer() {
  if (!sessionActive) {
    timerRunning = false; // Mark as not running
    return;
  }

  timerRunning = true; // Mark as running

  const now = Date.now();
  const remainingTime = Math.max(0, endTime - now);
  const seconds = Math.floor((remainingTime / 1000) % 60);
  const minutes = Math.floor(remainingTime / (1000 * 60));
  document.getElementById('timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

  const progress = 1 - (remainingTime / (targetDuration * 1000));
  const circumference = 282.6;
  document.getElementById('progress-ring').setAttribute('stroke-dashoffset', circumference * (1 - progress));

  if (remainingTime <= 0) {
    sessionActive = false;
    timerRunning = false;
    localStorage.removeItem('activeSession');
	updateHideUiButtonVisibility();
	updateHideUiBtnVisibility();
	releaseWakeLock();
	disableMobileAudioResume();
	stopMeditationSelfHeal();
    
    const modal = document.getElementById('end-meditation-modal');
    if (!modal.classList.contains('hidden')) {
      sessionCompletedWhileModalOpen = true;
    }
    
    const actualMinutes = Math.round(targetDuration / 60);
    updateDurationMessage(actualMinutes);
    saveSession(actualMinutes, currentSessionTime);
	localStorage.setItem('lastCompletedMode', currentMode);

    if (currentMode === 'yogi') {
      const sessionDate = new Date(startTime).toDateString();
      const sessionTimeStr = currentSessionTime; // Always the scheduled 'HH:MM'
      const sessionDay = getLocalDateString(new Date(startTime));
      // Only push if not already present
      if (!challengeData.sessionsCompleted.some(
        completed => completed.time === sessionTimeStr && completed.date === sessionDay
      )) {
        challengeData.sessionsCompleted.push({ 
          time: sessionTimeStr, 
          duration: targetDuration, 
          date: sessionDay
        });
        challengeData.totalSessions++;
        challengeData.totalMinutes += actualMinutes;
        challengeData.lastSessionDate = sessionDate;
        saveChallengeData();
        // Immediately update Yogi stats display
        document.getElementById('yogi-total-sessions').textContent = challengeData.totalSessions;
        document.getElementById('yogi-total-minutes').textContent = challengeData.totalMinutes;
        document.getElementById('current-streak').textContent = challengeData.streakDays;
      }
    }

    document.getElementById('timer-section').classList.add('hidden');
    document.getElementById('complete-section').classList.remove('hidden');
    document.getElementById('session-stats').classList.remove('hidden');
    document.getElementById('yogi-progress').classList.toggle('hidden', currentMode !== 'yogi');
    document.getElementById('session-timing-display').classList.toggle('hidden', currentMode !== 'yogi');
    
    document.querySelector('#app-interface #flow-mode-btn-app').classList.add('hidden');
    document.querySelector('#app-interface #yogi-mode-btn-app').classList.add('hidden');
    
    updateBackButtonVisibility();
    updateSessionTimesDisplay();
    stopMeditationBackground();
	showCompletionStats();

    const bell = document.getElementById('bell');
    if (bell) {
      bell.muted = false;
      bell.play().catch(e => console.log("Bell sound error:", e));
    }

const bgMusicPlayer = document.getElementById('bg-music-player');
if (bgMusicPlayer) {
  bgMusicPlayer.pause();
  bgMusicPlayer.currentTime = 0;
  backgroundAudio = null;
  stopMeditationSelfHeal();
}

    document.removeEventListener('visibilitychange', handleVisibilityChange);
    currentSessionTime = null;
  } else {
    requestAnimationFrame(updateTimer);
  }
}

function isSyncAuthBannerVisible() {
  const banner = document.getElementById('sync-auth-banner');
  return banner && banner.style.display !== 'none';
}

  function confirmCompletion() {
  if (isSyncAuthBannerVisible()) {
    // Optionally, you could flash the banner or alert, but doing nothing is fine.
    return;
  }
  // Update stats one more time before moving to final section
  stopMeditationBackground();
  updateHideUiBtnVisibility();
  updateSessionTimesDisplay();
  updateStats();

  // Check for challenge completion (last session of last day)
  let showCongrats = false;
  if (currentMode === 'yogi') {
// Get the scheduled date of the last completed session
const lastSessionDate = challengeData.sessionsCompleted.length
  ? challengeData.sessionsCompleted[challengeData.sessionsCompleted.length - 1].date
  : null;

if (
  lastSessionDate === challengeData.endDate &&
  challengeData.sessionsCompleted.filter(s => s.date === challengeData.endDate).length === challengeData.requiredSessions
) {
  showCongrats = true;
}
  }
  updateYogiIcon();
  document.getElementById('complete-section').classList.add('hidden');
  saveChallengeData();
if (window.walletPublicKey && localStorage.getItem('jwtToken')) {
  window.syncYogiChallengeToSupabase();
}

  // Wisdom reset here:
wisdomShownCount = 0;
quoteOrder = yogiQuotes.slice().sort(() => Math.random() - 0.5); // Or your wisdoms array
document.getElementById('show-wisdom').textContent = t('revealTodaysWisdom');
document.getElementById('show-wisdom').style.display = ""; // Make button visible
  
const completionDateLocal = getLocalDateString(new Date(startTime || Date.now())); // YYYY-MM-DD local
  
  if (showCongrats) {
  // --- ADD THIS BLOCK ---
  completedChallenges.push({
    challengeId: challengeData.challengeId,
    startDate: challengeData.startDate,
    endDate: challengeData.endDate,
    completionDate: completionDateLocal,
    claimed: false,
    claimTxId: null,
	totalTokens: challengeData.totalTokens,
	totalSessions: challengeData.totalSessions,
    totalMinutes: challengeData.totalMinutes,
	wallet: window.walletPublicKey || localStorage.getItem('currentJourneyWallet') || 'N/A'
  });
  localStorage.setItem('completedChallenges', JSON.stringify(completedChallenges));
  // --- END BLOCK ---
  
      // --- ADD THIS BLOCK: Save to Supabase certificates table ---
  const cert = {
    user_id: window.walletPublicKey,
    challenge_id: challengeData.challengeId,
    start_date: challengeData.startDate,
    end_date: challengeData.endDate,
    completion_date: completionDateLocal,
    total_tokens: challengeData.totalTokens,
	total_minutes: challengeData.totalMinutes,
    claimed: false,
    cert_id: `TR_${challengeData.challengeId}`
  };
  if (window.walletPublicKey && localStorage.getItem('jwtToken')) {
    fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_certificates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      },
      body: JSON.stringify({ certificate: cert })
    });
  }
  // --- END BLOCK ---
  document.getElementById('journey-complete-section').classList.remove('hidden');
  updateBackButtonVisibility();
} else {
    document.getElementById('final-section').classList.remove('hidden');
			  // Save final section state
    localStorage.setItem('finalSectionActive', 'true');
    localStorage.setItem('wisdomShownCount', wisdomShownCount);
    localStorage.setItem('quoteOrder', JSON.stringify(quoteOrder));
	
    document.getElementById('yogi-progress').classList.toggle('hidden', currentMode !== 'yogi');
    document.getElementById('session-timing-display').classList.toggle('hidden', currentMode !== 'yogi');
	document.getElementById('faq-tab').style.display = 'none';
    updateBackButtonVisibility();
    checkJourneyCompletion();
	showCompletionStats();
	if (window.walletPublicKey) {
	fixUnknownSessionIds();
	const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;
  if (journeyWallet && walletIsConnected && journeyWallet !== window.walletPublicKey) {
    // Do NOT save session. Just return silently.
    return;
  }
    window.syncSessionsToSupabase();
   }
  }
}
 
function saveSession(minutes, sessionTime) {
 // PREVENT SESSION POLLUTION: Only save if journey wallet matches
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;

  if (journeyWallet && walletIsConnected && journeyWallet !== window.walletPublicKey) {
    // Do NOT save session. Just return silently.
    return;
  }
  const today = getLocalDateString();
  
  // If in yogi mode and sessionTime is "HH:mm", convert to ISO datetime for today
  if (
    typeof sessionTime === "string" &&
    /^\d{2}:\d{2}$/.test(sessionTime)
  ) {
    // Combine today's date and sessionTime, local time
    sessionTime = new Date(`${today}T${sessionTime}:00`).toISOString();
  }

  // Fallback for missing sessionTime
  if (!sessionTime) {
    sessionTime = new Date().toISOString();
  }

  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  sessions[today] = sessions[today] || [];
  sessions[today].push({ 
    minutes, 
    mode: currentMode, 
    completed: true, 
    sessionTime 
  });
  localStorage.setItem('meditationSessions', JSON.stringify(sessions));
  updateStats();
  updateSessionTimesDisplay();
  // Automatically sync to Supabase after saving a session
  // Always sync after save
  if (window.walletPublicKey) {
    if (typeof fixUnknownSessionIds === "function") fixUnknownSessionIds();
    if (typeof window.syncSessionsToSupabase === "function") window.syncSessionsToSupabase();
  }
}

   function saveChallengeData() {
  challengeData.challenge_source = window.location.origin; 
  localStorage.setItem('yogiChallenge', JSON.stringify(challengeData));
  updateProgressDisplay();
  
  // Also update the stats display immediately
  if (currentMode === 'yogi') {
    document.getElementById('yogi-total-sessions').textContent = challengeData.totalSessions;
    document.getElementById('yogi-total-minutes').textContent = challengeData.totalMinutes;
    document.getElementById('yogi-day-streak').textContent = challengeData.streakDays;
    document.getElementById('yogi-reset-count').textContent = challengeData.resetCount || 0;
  }
  if (window.walletPublicKey && localStorage.getItem('jwtToken') && typeof window.syncYogiChallengeToSupabase === "function") {
  window.syncYogiChallengeToSupabase();
}
}

function getStreakFireColor(day) {
  if (day <= 7) return '#ef4444';      // red
  if (day <= 13) return '#f59e42';     // orange
  if (day <= 19) return '#eab308';     // yellow
  if (day <= 25) return '#22c55e';     // green
  if (day <= 31) return '#7dd3fc';     // blue 3b82f6
  if (day <= 37) return '#6366f1';     // indigo
  return '#8b5cf6';                    // violet
}

const PROGRESS_SEGMENTS = [
  { color: "#ef4444", days: 6 },   // Red
  { color: "#f59e42", days: 6 },   // Orange
  { color: "#eab308", days: 6 },   // Yellow
  { color: "#22c55e", days: 6 },   // green
  { color: "#7dd3fc", days: 6 },   // Light Blue
  { color: "#6366f1", days: 6 },   // indigo
  { color: "#8b5cf6", days: 5 },   // violet
];

function updateProgressDisplay() {
  document.getElementById('current-day-display').textContent = challengeData.currentDay;
  const today = getLocalDateString();
  const todaySessions = challengeData.sessionsCompleted.filter(s => s.date === today).length;
  document.getElementById('sessions-completed').textContent = todaySessions;
  document.getElementById('required-sessions').textContent = challengeData.requiredSessions;
  document.getElementById('streak-days').textContent = challengeData.streakDays;

  const fireIcon = document.querySelector('#yogi-progress .fa-fire');
  if (fireIcon) {
    fireIcon.style.color = getStreakFireColor(challengeData.currentDay);
  }

  // Multi-segment progress bar
  const progressBarBg = document.getElementById('progress-bar-bg');
  progressBarBg.innerHTML = ''; // Clear previous segments

  // Cap at totalDays so bar can fill 100%
  const totalDays = 41;
  let daysDone = Math.min(challengeData.currentDay, totalDays);

  let left = 0;

  PROGRESS_SEGMENTS.forEach((seg, i) => {
    const segDiv = document.createElement('div');
    // Fill this segment with remaining days only if available
    let segDays = Math.min(seg.days, daysDone);
    let widthPercent = (segDays / totalDays) * 100;
    if (segDays <= 0) widthPercent = 0;

    segDiv.style.width = `${widthPercent}%`;
    segDiv.style.background = seg.color;
    segDiv.style.height = '100%';
    segDiv.style.display = 'inline-block';

    // Left border radius for first, right border radius for last segment
    if (i === 0 && widthPercent > 0) {
      segDiv.style.borderRadius = '9999px 0 0 9999px';
    }
    // Make the final segment right edge rounded if it's the last *filled* segment
    if (i === PROGRESS_SEGMENTS.length - 1 && widthPercent > 0) {
      segDiv.style.borderRadius = '0 9999px 9999px 0';
    }

    segDiv.style.verticalAlign = 'top';
    progressBarBg.appendChild(segDiv);

    daysDone -= segDays;
    left += segDays;
    if (daysDone <= 0) return;
  });
  
    // ---- NEW: turn check green if all sessions completed ---
const checkIcon = document.getElementById('sessions-completed-check');
if (todaySessions >= challengeData.requiredSessions) {
  // All sessions completed - green
  checkIcon.style.color = "#22c55e"; // green-500
  checkIcon.classList.add('pulse-green');
} else if (todaySessions === 0) {
  // No sessions completed - red
  checkIcon.style.color = "#ef4444"; // red-500
  checkIcon.classList.remove('pulse-green');
} else if (todaySessions > 0 && todaySessions < challengeData.requiredSessions) {
  // Some sessions completed but not all - yellow
  checkIcon.style.color = "#f59e0b"; // yellow-500
  checkIcon.classList.remove('pulse-green');
} else {
  // Fallback (shouldn't normally reach here)
  checkIcon.style.color = "#9ca3af"; // gray-400
  checkIcon.classList.remove('pulse-green');
}
}

    function checkDayReset() {
  if (!challengeData.startDate) return;

  const today = getLocalMidnight(new Date());
  const todayStr = getLocalDateString(today);
  const startDate = getLocalMidnight(challengeData.startDate);
  const endDate = new Date(challengeData.endDate);

  // Only proceed if today is on or after the start date
  if (today < startDate) {
    challengeData.currentDay = 1; // Keep at day 1 until start date
    challengeData.lastSessionDate = null;
    challengeData.streakDays = 0;
    saveChallengeData();
    updateSessionTimesDisplay();
    return;
  }

  const diffTime = today - startDate;
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
  
  if (diffDays > challengeData.currentDay) {
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yesterdayStr = getLocalDateString(yesterday);
    
    const yesterdaySessions = challengeData.sessionsCompleted.filter(s => s.date === yesterdayStr).length;
    if (yesterdaySessions < challengeData.requiredSessions && today > startDate) {
      const yesterdayMissed = userSessionTimes.some(sessionTime => {
        return !challengeData.sessionsCompleted.some(
          s => s.date === yesterdayStr && s.time === sessionTime.time
        );
      });
      if (yesterdayMissed) {
        showMissedSessionModal();
      }
    }

    const lastSessionDate = challengeData.lastSessionDate ? new Date(challengeData.lastSessionDate) : startDate;
    const lastSessionDiff = Math.floor((today - lastSessionDate) / (1000 * 60 * 60 * 24));
    
    if (lastSessionDiff > 1 || (yesterdaySessions < challengeData.requiredSessions && today > startDate)) {
  challengeData.streakDays = 0;
} else if (yesterdaySessions >= challengeData.requiredSessions) {
  challengeData.streakDays++;
}

    challengeData.currentDay = Math.min(diffDays, 41); // Cap at 41 days
    challengeData.lastSessionDate = todayStr;
    saveChallengeData();
  }
  updateSessionTimesDisplay();
}

function connectWalletForDay21() {
  document.getElementById('wallet-required-modal').classList.add('hidden');
  // Trigger wallet connection flow
  document.getElementById('wallet-action-btn').click();
}

function resetChallengeForDay21() {
  document.getElementById('wallet-required-modal').classList.add('hidden');
  // Show reset confirmation
  showResetConfirmation();
}

    function checkJourneyCompletion() {
  if (!challengeData.startDate) return;

  const todayStr = getLocalDateString(new Date());
  if (
    todayStr > challengeData.endDate &&
    challengeData.currentDay >= 41 &&
    challengeData.streakDays >= 41
  ) {
    document.getElementById('app-interface').classList.add('hidden');
    document.getElementById('journey-complete-section').classList.remove('hidden');
	updateJourneyCompleteButtons();
    updateBackButtonVisibility();
	updateYogiIcon(); 
  }
}

function showClaimRequiredModal() {
  document.getElementById('claim-required-modal').classList.remove('hidden');
}

function closeClaimRequiredModal() {
  document.getElementById('claim-required-modal').classList.add('hidden');
}

function handleClaimRequiredOk() {
  document.getElementById('claim-required-modal').classList.add('hidden');
  // Check for unclaimed completed challenge
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch (e) {
    completedChallenges = [];
  }
  let unclaimed = completedChallenges.find(c => !c.claimed && c.completionDate);
  if (unclaimed) {
    // Show claim tokens screen
    showClaimTokens();
  }
  // Otherwise, just close the modal (already done above)
}


function updateJourneyCompleteButtons() {
  // Find any completed challenge that is unclaimed
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch {}
  const hasUnclaimed = completedChallenges.some(c => !c.claimed && c.completionDate);
  document.getElementById('claim-tokens-btn').style.display = hasUnclaimed ? '' : 'none';
  document.querySelector('#journey-complete-section button[onclick="resetYogiJourney()"]').style.display = hasUnclaimed ? 'none' : '';
}

    async function resetYogiJourney() {
  let completedChallenges = [];
  try {
    completedChallenges = JSON.parse(localStorage.getItem('completedChallenges') || '[]');
  } catch {}
  const hasUnclaimed = completedChallenges.some(c => !c.claimed && c.completionDate);
  if (hasUnclaimed) {
    showClaimRequiredModal();
    return;
  }
  
   // --- ADD THIS BLOCK: Clear yogi_config from DB if wallet is connected ---
  const walletKey = window.walletPublicKey;
  const jwtToken = localStorage.getItem('jwtToken');
  if (walletKey && jwtToken) {
    try {
      await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi-reset', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + jwtToken
        }
      });
      // Optionally handle response but usually silent
    } catch (err) {
      console.warn('Could not clear remote yogi_config during resetYogiJourney:', err.message);
    }
  }
  // --- END BLOCK ---
  
  localStorage.removeItem('yogiConfig');
  localStorage.removeItem('yogiChallenge');
  clearYogiSessions();
  challengeData = {
    startDate: null,
    endDate: null,
    currentDay: 1,
    sessionsCompleted: [],
    requiredSessions: 1,
    lastSessionDate: null,
    streakDays: 0,
    totalSessions: 0,
    totalMinutes: 0
  };
  updateYogiIcon();
  userSessionTimes = [];
  
  // Reset the Yogi stats display
  document.getElementById('yogi-total-sessions').textContent = '0';
  document.getElementById('yogi-total-minutes').textContent = '0';
  
    // Close the challenge completed modal
  closeChallengeCompletedModal();
  
  // Update UI
  document.getElementById('journey-complete-section').classList.add('hidden');
  document.getElementById('app-interface').classList.remove('hidden');
  showYogiConfig();
  updateBackButtonVisibility();
  updateStats(); // Refresh all stats
}

function updateStats() {
  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
    
  let flowSessions = 0;
  let flowMinutes = 0;
  let yogiSessions = challengeData.totalSessions;
  let yogiMinutes = challengeData.totalMinutes;
  let cancelledSessions = 0;

  // Convert sessions object to array of all sessions sorted by date
  const allSessions = [];
  for (const date in sessions) {
    sessions[date].forEach(session => {
      allSessions.push({
        date: new Date(date),
        ...session
      });
    });
  }

  // Sort sessions by date (oldest first)
  allSessions.sort((a, b) => a.date - b.date);

  // Calculate stats from session history
  for (const date in sessions) {
    for (const session of sessions[date]) {
      if (session.completed) {
        if (session.mode === 'flow') {
          flowSessions++;
          flowMinutes += session.minutes;
        } else if (session.mode === 'yogi') {
          if (!challengeData.startDate || new Date(date) < new Date(challengeData.startDate)) {
            yogiSessions++;
            yogiMinutes += session.minutes;
          }
        }
      } else {
        cancelledSessions++;
      }
    }
  }

  // --- Flow Streak Calculation ---
  function calculateFlowStreak(sessions) {
    let streak = 0;
    let today = new Date();
    const todayStr = getLocalDateString(today);

    // If today has a FLOW session, count streak back from today
    if (sessions[todayStr] && sessions[todayStr].some(s => s.completed && s.mode === 'flow')) {
      let streakDate = new Date();
      while (true) {
        const dateStr = getLocalDateString(streakDate);
        if (sessions[dateStr] && sessions[dateStr].some(s => s.completed && s.mode === 'flow')) {
          streak++;
          streakDate.setDate(streakDate.getDate() - 1);
        } else {
          break;
        }
      }
    } else {
      // If today has NO session, count streak back from yesterday
      let streakDate = new Date();
      streakDate.setDate(streakDate.getDate() - 1);
      while (true) {
        const dateStr = getLocalDateString(streakDate);
        if (sessions[dateStr] && sessions[dateStr].some(s => s.completed && s.mode === 'flow')) {
          streak++;
          streakDate.setDate(streakDate.getDate() - 1);
        } else {
          break;
        }
      }
    }
    return streak;
  }
  let flowStreak = calculateFlowStreak(sessions);
  let streak = (currentMode === 'yogi') ? challengeData.streakDays : flowStreak;

  // Update the display
  document.getElementById('flow-total-sessions').textContent = flowSessions;
  document.getElementById('flow-total-minutes').textContent = flowMinutes;
  document.getElementById('yogi-total-sessions').textContent = yogiSessions;
  document.getElementById('yogi-total-minutes').textContent = yogiMinutes;
  document.getElementById('yogi-day-streak').textContent = challengeData.streakDays;
  document.getElementById('yogi-reset-count').textContent = challengeData.resetCount || 0;
  document.getElementById('current-streak').textContent = streak;
  document.getElementById('cancelled-sessions').textContent = cancelledSessions;

  // If in Yogi mode, ensure progress is updated
  if (currentMode === 'yogi') {
    updateProgressDisplay();
  }
}

function showCompletionStats() {
  const mode = localStorage.getItem('lastCompletedMode') || currentMode;
  document.getElementById('flow-stats').classList.add('hidden');
  document.getElementById('yogi-stats').classList.add('hidden');
  document.getElementById('shared-stats').classList.add('hidden');
  if (mode === 'flow') {
    document.getElementById('flow-stats').classList.remove('hidden');
    document.getElementById('shared-stats').classList.remove('hidden');
  } else if (mode === 'yogi') {
    document.getElementById('yogi-stats').classList.remove('hidden');
  } 
}

function clearYogiSessions() {
  const sessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  
  for (const date in sessions) {
    sessions[date] = sessions[date].filter(session => session.mode !== 'yogi');
    if (sessions[date].length === 0) {
      delete sessions[date];
    }
  }
  
  localStorage.setItem('meditationSessions', JSON.stringify(sessions));
}

function updateMeditationGuideImage(mode) {
  const imageDiv = document.getElementById('meditation-guide-image');
  if (!imageDiv) return;
  // Remove previous image if exists
  imageDiv.innerHTML = '';
  let imgSrc = '/assets/meditate.svg';
  let altText = 'Meditating Person';

  if (mode === 'yogi') {
    imgSrc = '/assets/truemeditate.svg';
    altText = 'TrueYogi Meditation';
  } else if (mode === 'flow') {
    imgSrc = '/assets/flowmeditate.svg';
    altText = 'Flow Meditation';
  }

  const img = document.createElement('img');
  img.src = imgSrc;
  img.alt = altText;
  img.style.height = '143px';
  img.style.width = 'auto';
  img.style.display = 'block';
  
      if (mode === 'yogi') {
    img.id = 'truemeditate-img-svg'; // Set the ID ONLY here for Yogi
  }
  
  imageDiv.appendChild(img);
  
    // Only attach music to truemeditate image
  if (mode === 'yogi') {
    attachMeditationMusicHandler();
  }
}

function toggleMeditationGuide() {
  const guide = document.getElementById('meditation-guide');
  if (!guide) return;

  // was it hidden before toggling?
  const wasHidden = guide.classList.contains('hidden') || getComputedStyle(guide).display === 'none';

  // toggle visibility
  guide.classList.toggle('hidden');

  if (wasHidden) {
    // we just opened the guide ‚Äî render the image for the current mode
    updateMeditationGuideImage(currentMode);
  } else {
    // we just closed the guide ‚Äî ensure music and glow stop
    stopMeditationMusicOnClose();
  }
}

function handleVisibilityChange() {
  if (!document.hidden) {
  completeExpiredSessionIfNeeded();
      // Resume OM music if needed
    const omAudio = document.getElementById('om-sound');
    if (omAudio && omAudio.paused && window.omPresenceId) {
      omAudio.muted = false;
      omAudio.volume = 0.7;
      omAudio.play().catch(() => {});
    }
    // When user returns to tab
    if (sessionActive) {
	  requestWakeLock();
	  enableMobileAudioResume();
      const now = Date.now();
      if (endTime <= now) {
        // The session should be over ‚Äî complete it immediately!
        sessionActive = false;
        localStorage.removeItem('activeSession');
        const actualMinutes = Math.round(targetDuration / 60);
        document.getElementById('actual-minutes').textContent = actualMinutes;
        document.getElementById('minute-text').textContent = actualMinutes === 1 ? 'minute' : 'minutes';
        saveSession(actualMinutes, currentSessionTime);
		localStorage.setItem('lastCompletedMode', currentMode);
        // Show completion UI, update stats, etc.
        document.getElementById('timer-section').classList.add('hidden');
        document.getElementById('complete-section').classList.remove('hidden');
        document.getElementById('session-stats').classList.remove('hidden');
        document.getElementById('yogi-progress').classList.toggle('hidden', currentMode !== 'yogi');
        document.getElementById('session-timing-display').classList.toggle('hidden', currentMode !== 'yogi');
        document.querySelector('#app-interface #flow-mode-btn-app').classList.add('hidden');
        document.querySelector('#app-interface #yogi-mode-btn-app').classList.add('hidden');
        updateBackButtonVisibility();
        updateSessionTimesDisplay();
        stopMeditationBackground();
		showCompletionStats();
		updateHideUiBtnVisibility();
		disableMobileAudioResume();
        const bell = document.getElementById('bell');
        if (bell) {
          bell.muted = false;
          bell.play().catch(e => console.log("Bell sound error:", e));
        }
		const bgMusicPlayer = document.getElementById('bg-music-player');
		if (bgMusicPlayer) {
		bgMusicPlayer.pause();
		bgMusicPlayer.currentTime = 0;
		backgroundAudio = null;
		}
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        currentSessionTime = null;
      } else {
        // Resume timer as usual
        if (!timerRunning) {
          requestAnimationFrame(updateTimer);
        }
		const bgMusicPlayer = document.getElementById('bg-music-player');
      if (bgMusicPlayer && document.getElementById('music-toggle').checked && bgMusicPlayer.paused) {
          bgMusicPlayer.play().catch(e => console.log("Resume music error:", e));
        }
      }
    }
  }
}

    async function loadQuotes() {
  const lang = localStorage.getItem('lang') || 'en';
  let quotesFile = `/assets/quotes.${lang}.json`;
  try {
    let response = await fetch(quotesFile);
    if (!response.ok && lang !== 'en') {
      // fallback to English if translation not found
      response = await fetch('/assets/quotes.json');
    }
    yogiQuotes = await response.json();
    if (!Array.isArray(yogiQuotes)) yogiQuotes = [];
    if (yogiQuotes.length === 0) yogiQuotes = ["No quotes available. Add some wisdom to quotes.json!"];
    showRandomQuote();
  } catch (e) {
    yogiQuotes = ["The journey inward begins with a single breath."];
    showRandomQuote();
  }
}

    function showRandomQuote() {
      const quoteElement = document.getElementById('yogi-quote');
      if (yogiQuotes.length > 0) {
        const randomIndex = Math.floor(Math.random() * yogiQuotes.length);
        quoteElement.textContent = yogiQuotes[randomIndex];
      } else {
        quoteElement.textContent = "No quotes available.";
      }
    }
    
	async function authenticateWithWallet() {
	  // --- STEP 1: Block if connected wallet doesn't match journey wallet ---
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;

  if (
    walletIsConnected &&
    journeyWallet &&
    window.walletPublicKey !== journeyWallet
  ) {
    showConnectJourneyWalletRequiredModal(journeyWallet);
    return; // Block verification
  }
  // --- END STEP 1 ---
  if (window.solana && window.solana.isPhantom && window.walletPublicKey) {
    if (!window.bs58) {
      document.getElementById('wallet-status').textContent = 'bs58 not loaded!';
      return;
    }

    // STEP 1: Get nonce from backend
    let nonce;
    try {
      const nonceResp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/nonce', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ publicKey: window.walletPublicKey })
      });
      const nonceData = await nonceResp.json();
      if (!nonceData.success) throw new Error(nonceData.error || "No nonce");
      nonce = nonceData.nonce;
    } catch (err) {
      document.getElementById('wallet-status').textContent = 'Error getting nonce: ' + err.message;
      return;
    }

    // STEP 2: Ask wallet to sign nonce
    const encodedMessage = new TextEncoder().encode(nonce);
    let signature;
    try {
      const signedMessage = await window.solana.signMessage(encodedMessage, "utf8");
      signature = window.bs58.encode(signedMessage.signature);
    } catch (err) {
      document.getElementById('wallet-status').textContent = `Sign failed: ${err.message}`;
      return;
    }

    // STEP 3: Send signature to backend for verification
    try {
      const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          publicKey: window.walletPublicKey,
          signature: signature
        })
      });
      const result = await resp.json();
      if (result.success) {
		const shortAddress = `${result.address.slice(0, 4)}.....${result.address.slice(-4)}`;
		document.getElementById('wallet-status').textContent = `Authenticated: ${shortAddress}`;
		if (result.token) {
  localStorage.setItem('jwtToken', result.token);
  if (!localStorage.getItem('currentJourneyWallet')) {
  localStorage.setItem('currentJourneyWallet', window.walletPublicKey);
  }
  // await window.fetchYogiChallengeFromSupabase();
  updateWalletUI();
  hideSyncAuthBanner();
  if (window.supabase && window.supabase.auth && window.supabase.auth.setSession) {
    window.supabase.auth.setSession({ access_token: result.token, refresh_token: "" });
  }
  // Sync sessions after successful identity verification
  if (window.syncSessionsToSupabase) {
    await window.syncSessionsToSupabase();
    // Fetch sessions after 10 secs
    if (window.fetchSessionsFromSupabase) {
      setTimeout(() => {
        window.fetchSessionsFromSupabase();
      }, 10000);
    }
  }
    if (window.afterIdentityVerified) {
      window.afterIdentityVerified();
    }
}
		} else {
        document.getElementById('wallet-status').textContent = `Auth failed: ${result.error}`;
      }
    } catch (err) {
      document.getElementById('wallet-status').textContent = `Auth error: ${err.message}`;
    }
  } else {
    document.getElementById('wallet-status').textContent = 'Wallet not connected or Phantom not detected';
  }
}
	
function isMobile() {
  const ua = navigator.userAgent;
  const platform = navigator.platform;
  const isMobileUA = /Mobi|Android|iPhone|iPad|iPod/i.test(ua);
  
  // Check for Android FIRST
  if (/Android/i.test(ua)) {
    // Check for REAL Android vs DevTools emulation
    const isLikelyDevToolsEmulation = 
      // DevTools emulation clues:
      ('ontouchstart' in window && navigator.maxTouchPoints === 0) || // Touch API exists but no touch points
      (platform.includes('Win') && ua.includes('Android')) || // Windows platform + Android UA = DevTools
      (platform.includes('Mac') && ua.includes('Android')) || // Mac platform + Android UA = DevTools
      (navigator.platform === 'Win32' && /Android/.test(ua)) || // Specific DevTools signature
      (navigator.userAgent.includes('Chrome') && 
       window.chrome && 
       window.chrome.devtools); // DevTools is open
    
    if (isLikelyDevToolsEmulation) {
      //console.log('Blocking DevTools emulation');
      return false; // No wallet
    }
    
    // Only block 100% certain emulators (keep your existing code)
    const isEmulator = 
      /Android.*x86|Linux.*x86_64|SDK built for|emulator/i.test(ua) ||
      (navigator.platform === 'Linux x86_64' && /Android/.test(ua)) ||
      /BrowserStack|LambdaTest|ldplayer|ldad/i.test(ua);
    
    if (isEmulator) {
      // console.log('Blocking emulator');
      return false;
    }
    
    return true;
  }
  
  // Rest of your original desktop detection
  const isDesktopOS = /Win|Mac|Linux|X11/.test(platform) || 
                     /Windows NT|Macintosh|Linux x86_64|X11|Win64/i.test(ua);
  
  if (isDesktopOS) return false;
  if (!isMobileUA) return false;
  return true;
}

    function startWalletApp() {
      let walletConnected = false;
      let walletPublicKey = null;

      function updateWalletUI() {
    const btn = document.getElementById('wallet-action-btn');
	const btnIcon = btn.querySelector('.btn-icon i');
    const btnText = document.getElementById('wallet-btn-text');
    const authBtn = document.getElementById('auth-wallet-btn');
    // Clean up any previous timer interval
    if (window.jwtTimerInterval) clearInterval(window.jwtTimerInterval);

    if (walletConnected && walletPublicKey) {
        btnIcon.className = 'fas fa-sign-out-alt';
        btnText.style.display = 'none';
        btn.classList.add('bg-red');
        btn.classList.remove('bg-purple');
		authBtn.classList.remove('hidden');
        const shortAddress = `${walletPublicKey.slice(0, 4)}.....${walletPublicKey.slice(-4)}`;
		document.getElementById('wallet-status').innerHTML = `
  <span id="wallet-status-row" style="display:inline-flex;align-items:center;gap:10px;position:relative;cursor:pointer;">
    <span id="wallet-status-dot" style="
      display:inline-block;
      width:12px;height:12px;
      border-radius:50%;
      background:radial-gradient(circle,#34d399 60%,#059669 100%);
      box-shadow:0 0 10px #34d39999,0 0 1px #059669;
      vertical-align:middle;
      "></span>
    <span id="wallet-short-address" style="font-weight:bold; color:#fde68a; font-size:1.07em; transition:color 0.2s;">
      ${shortAddress}
    </span>
    <span id="wallet-copied" style="display:none; margin-left:8px; color:#10b981; font-size:0.96em; font-weight:500;">Copied!</span>
    <span id="jwt-timer" style="margin-left:10px;color:#fde68a;font-size:0.97em;"></span>
    <span id="wallet-connected-tooltip" style="
      display:block;
      position:absolute;
      left:0;top:140%;
      background:#222;
      color:#fffbe9;
      padding:4px 16px;
      border-radius:8px;
      font-size:1em;
      z-index:2000;
      white-space:nowrap;
      box-shadow: 0 2px 8px #0002;
      font-weight:500;
      pointer-events:none;
      min-width: 100px;
      text-align: center;
    ">Connected</span>
  </span>
`;

const row = document.getElementById('wallet-status-row');
const dot = document.getElementById('wallet-status-dot');
const addr = document.getElementById('wallet-short-address');
const tooltip = document.getElementById('wallet-connected-tooltip');
const copiedEl = document.getElementById('wallet-copied');

    // Auto-hide tooltip after 3 seconds
    setTimeout(() => {
        if (tooltip) {
            tooltip.style.display = 'none';
        }
    }, 3000);
	
if (row && tooltip) {
  // Show tooltip on hover
  row.addEventListener('mouseenter', () => {
    tooltip.style.display = 'block';
  });
  row.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
  });

  // Copy address on click (anywhere in row: dot or addr)
// Copy address on click (anywhere in row: dot or addr)
row.addEventListener('click', async () => {
    try {
        await navigator.clipboard.writeText(walletPublicKey);
        if (copiedEl && addr) {
            // Temporarily disable hover behavior
            row.style.pointerEvents = 'none';
            
            copiedEl.style.display = 'inline';
            addr.style.color = '#10b981';
            
            setTimeout(() => {
                copiedEl.style.display = 'none';
                addr.style.color = '#fde68a';
                // Re-enable hover behavior after copy animation
                setTimeout(() => {
                    row.style.pointerEvents = 'auto';
                }, 100);
            }, 1200);
        }
    } catch (e) {
        // fallback: select and copy
        const temp = document.createElement('textarea');
        temp.value = walletPublicKey;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
    }
    
    // Force hide tooltip immediately on click
    if (tooltip) {
        tooltip.style.display = 'none';
    }
});
}

        // Timer logic
        function updateJwtTimer() {
            const token = localStorage.getItem('jwtToken');
            const timerSpan = document.getElementById('jwt-timer');
            if (!token || !timerSpan) return;
            const expiry = getJwtExpiry(token);
            const now = Date.now();
            let remaining = Math.max(0, expiry - now);
            if (remaining === 0) {
                timerSpan.textContent = '';
                return;
            }
            // Format as hh:mm:ss
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining / (1000 * 60)) % 60);
            const seconds = Math.floor((remaining / 1000) % 60);
            timerSpan.textContent = `üíõ ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        updateJwtTimer();
        window.jwtTimerInterval = setInterval(updateJwtTimer, 1000);

        // Show/hide auth button as before
        if (shouldShowVerifyButton()) {
            authBtn.classList.remove('hidden');
        } else {
            authBtn.classList.add('hidden');
        }
    } else {
		btnIcon.className = 'fas fa-wallet';
        btnText.textContent = t('connectWallet');
		btnText.style.display = '';
        btn.classList.remove('bg-red');
        btn.classList.add('bg-purple');
		authBtn.classList.add('hidden');
        document.getElementById('wallet-status').innerHTML = `
            <div class="web3-status-wrapper">
                <span class="web3-status-icon">üí´</span>
                <span class="web3-status-desc">${t('portalAlwaysOpen')}</span>
            </div>
        `;
        authBtn.classList.add('hidden');
        // Clean up timer if exists
        if (window.jwtTimerInterval) clearInterval(window.jwtTimerInterval);
    }
	
	// When user confirms disconnect
document.getElementById('confirm-disconnect-wallet').onclick = async function() {
  document.getElementById('disconnect-wallet-modal').classList.add('hidden');
  if (window.solana && window.solana.isPhantom) {
    await window.solana.disconnect();
    walletConnected = false;
    walletPublicKey = null;
    window.walletPublicKey = null;
    localStorage.setItem('walletManuallyDisconnected', 'true');
    updateWalletUI();
  }
};
// When user cancels
document.getElementById('cancel-disconnect-wallet').onclick = function() {
  document.getElementById('disconnect-wallet-modal').classList.add('hidden');
};

}

      async function checkWalletConnection() {
		// Don't auto-connect if manually disconnected
		const manuallyDisconnected = localStorage.getItem('walletManuallyDisconnected') === 'true';
		if (window.solana && window.solana.isPhantom && !manuallyDisconnected) {
			try {
			const resp = await window.solana.connect({ onlyIfTrusted: true });
			walletConnected = true;
			walletPublicKey = resp.publicKey.toString();
			window.walletPublicKey = walletPublicKey;
			if (!localStorage.getItem('currentJourneyWallet')) {
		    localStorage.setItem('currentJourneyWallet', walletPublicKey);
            }
			window.dispatchEvent(new Event('wallet-connected'));
			} catch {
			walletConnected = false;
			walletPublicKey = null;
			window.walletPublicKey = null;
			}
		} else {
			walletConnected = false;
			walletPublicKey = null;
			window.walletPublicKey = null;
		}
		updateWalletUI();
	}

      document.getElementById('wallet-action-btn').addEventListener('click', async function () {
  if (window.solana && window.solana.isPhantom) {
    if (!walletConnected) {
      try {
        const resp = await window.solana.connect({ onlyIfTrusted: false });
        const toConnectPublicKey = resp.publicKey.toString();

        // --- NEW BLOCK: Intercept first wallet connect after offline config ---
        let journeyWallet = localStorage.getItem('currentJourneyWallet');
        const hasOfflineConfig = !!localStorage.getItem('yogiConfig');
        if (!journeyWallet && hasOfflineConfig) {
          // Show modal to warn about starting fresh
          showStartOnChainJourneyModal(toConnectPublicKey);
          await window.solana.disconnect(); // Prevent Phantom confusion
          return; // Do NOT assign walletConnected or walletPublicKey!
        }
        // --- END NEW BLOCK ---

        // If journeyWallet is missing, empty, or "null", auto-assign to current wallet
        if (!journeyWallet || journeyWallet === "null") {
          journeyWallet = toConnectPublicKey;
          localStorage.setItem('currentJourneyWallet', journeyWallet);
        }

        if (journeyWallet && journeyWallet !== toConnectPublicKey) {
          // Show a modal, block connection assignment, optionally disconnect attempted wallet
          showWalletSwitchBlockModal(journeyWallet, toConnectPublicKey);
          await window.solana.disconnect(); // Prevent Phantom confusion (optional)
          return; // Do NOT assign walletConnected or walletPublicKey!
        }
        // --- END BLOCK ---

        walletConnected = true;
        walletPublicKey = resp.publicKey.toString();
        window.walletPublicKey = walletPublicKey;
        window.dispatchEvent(new Event('wallet-connected'));
        // CLEAR the manual disconnect flag on manual connect
        localStorage.removeItem('walletManuallyDisconnected');
      } catch (err) {
        walletConnected = false;
        walletPublicKey = null;
        window.walletPublicKey = null;
        document.getElementById('wallet-status').textContent = `Connection failed: ${err.message}`;
      }
    } else {
      // Instead of disconnecting right away, show the modal:
      document.getElementById('disconnect-wallet-modal').classList.remove('hidden');
      // Do NOT disconnect yet!
      return; // Prevent running updateWalletUI() here
    }
    updateWalletUI();
  } else {
    // If on mobile, redirect to Phantom universal link
    if (isMobile()) {
      // Show the modal instead of redirecting immediately
      document.getElementById('mobile-wallet-modal').classList.remove('hidden');
      // Attach event listeners just once (or use event delegation)
      const modal = document.getElementById('mobile-wallet-modal');
      const continueBtn = document.getElementById('mobile-wallet-continue');
      const cancelBtn = document.getElementById('mobile-wallet-cancel');
      // Remove previous listeners if any
      continueBtn.onclick = () => {
        modal.classList.add('hidden');
        window.location.href = "https://phantom.app/ul/browse/" +
          encodeURIComponent("https://trueyogi.app") +
          "?ref=phantom";
      };
      cancelBtn.onclick = () => {
        modal.classList.add('hidden');
        // Optionally show a message or do nothing
      };
    } else {
      // On desktop with no Phantom, show error
      document.getElementById('wallet-status').textContent = 'Phantom wallet not found. Please install it from https://phantom.app/';
    }
  }
});

      document.getElementById('auth-wallet-btn').addEventListener('click', authenticateWithWallet);
      window.addEventListener('DOMContentLoaded', checkWalletConnection);
	  window.updateWalletUI = updateWalletUI;
    }

    // Wait for bs58 to load before running wallet code!
    if (window.bs58Ready) {
      startWalletApp();
    } else {
      window.addEventListener('bs58-ready', startWalletApp);
    }

async function ensureAuthenticated() {
 // --- STEP 1: Block if connected wallet doesn't match journey wallet ---
  const journeyWallet = localStorage.getItem('currentJourneyWallet');
  const walletIsConnected = !!window.walletPublicKey;

  if (
    walletIsConnected &&
    journeyWallet &&
    window.walletPublicKey !== journeyWallet
  ) {
    showConnectJourneyWalletRequiredModal(journeyWallet);
    return; // Block verification
  }
  // --- END STEP 1 ---
  const jwtToken = localStorage.getItem('jwtToken');
  if (jwtToken) return jwtToken;

  // If not authenticated, prompt the user for authentication
  const statusDiv = document.getElementById('claim-status');
  statusDiv.textContent = "Authenticating wallet before claim...";

  // STEP 1: Get nonce from backend
  let nonce;
  try {
    const nonceResp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/nonce', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ publicKey: window.walletPublicKey })
    });
    const nonceData = await nonceResp.json();
    if (!nonceData.success) throw new Error(nonceData.error || "No nonce");
    nonce = nonceData.nonce;
  } catch (err) {
    statusDiv.textContent = 'Error getting nonce: ' + err.message;
    return null;
  }

  // STEP 2: Ask wallet to sign nonce
  const encodedMessage = new TextEncoder().encode(nonce);
  let signature;
  try {
    const signedMessage = await window.solana.signMessage(encodedMessage, "utf8");
    signature = window.bs58.encode(signedMessage.signature);
  } catch (err) {
    statusDiv.textContent = `Sign failed: ${err.message}`;
    return null;
  }

  // STEP 3: Send signature to backend for verification
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        publicKey: window.walletPublicKey,
        signature: signature
      })
    });
    const result = await resp.json();
    if (result.success && result.token) {
      localStorage.setItem('jwtToken', result.token);  
	  updateWalletUI();
	  // await window.fetchYogiChallengeFromSupabase();
      return result.token;
    } else {
      statusDiv.textContent = `Auth failed: ${result.error}`;
      return null;
    }
  } catch (err) {
    statusDiv.textContent = `Auth error: ${err.message}`;
    return null;
  }
}

async function requestClaimNonce(publicKey, challengeId, jwtToken) {
  const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/claim-nonce', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + jwtToken
    },
    body: JSON.stringify({ publicKey, challengeId })
  });
  const result = await resp.json();
  if (result.success) return result.nonce;
  throw new Error(result.error || "Failed to get claim nonce");
}


async function startClaimProcess() {
  const statusDiv = document.getElementById('claim-status');
  const loader = document.getElementById('claim-loader');
  if (loader) loader.style.display = 'block';
  statusDiv.textContent = "Checking wallet connection...";

  // 1. Check wallet connection
  if (!window.walletPublicKey) {
    statusDiv.textContent = "Please connect your wallet first.";
    if (loader) loader.style.display = 'none';
    return;
  }
  if (!window.solana || !window.solana.isPhantom) {
    statusDiv.textContent = "Phantom wallet not found.";
    if (loader) loader.style.display = 'none';
    return;
  }

  // 2. Ensure authenticated and get JWT
  const jwtToken = await ensureAuthenticated();
  if (!jwtToken) {
    statusDiv.textContent = "Authentication required before claiming tokens.";
    if (loader) loader.style.display = 'none';
    return;
  }

  // 3. Find completed unclaimed challenge
  let unclaimed = completedChallenges.find(c => !c.claimed && c.completionDate);
  if (!unclaimed) {
    statusDiv.textContent = "No unclaimed challenge available to claim.";
    if (loader) loader.style.display = 'none';
    return;
  }
  const challengeId = unclaimed.challengeId;
  const totalTokens = unclaimed.totalTokens;

  // 4. Request claim nonce from backend
  statusDiv.textContent = "Requesting claim nonce...";
  let nonce;
  try {
    const nonceResp = await fetch("https://trueyogi-backend-knkq.onrender.com/api/claim-nonce", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${jwtToken}`
      },
      body: JSON.stringify({
        publicKey: window.walletPublicKey,
        challengeId
      })
    });
    const nonceData = await nonceResp.json();
    if (!nonceData.success || !nonceData.nonce) throw new Error(nonceData.error || "No nonce");
    nonce = nonceData.nonce;
  } catch (err) {
    statusDiv.textContent = 'Error getting claim nonce: ' + err.message;
    if (loader) loader.style.display = 'none';
    return;
  }

// 5. Build human-readable claim message to sign
const message = `Claim TrueYogi tokens, challenge: ${challengeId}, nonce: ${nonce}`;
const encodedMessage = new TextEncoder().encode(message);

// 6. Request wallet signature
statusDiv.textContent = "Requesting wallet signature...";
let signature;
try {
  const signed = await window.solana.signMessage(encodedMessage, "utf8");
  signature = window.bs58.encode(signed.signature);
} catch (e) {
  statusDiv.textContent = "Signature request cancelled or failed.";
  if (loader) loader.style.display = 'none';
  return;
}

  // 7. Submit claim request
  statusDiv.textContent = "Submitting claim to server...";
  try {
    const resp = await fetch("https://trueyogi-backend-knkq.onrender.com/api/claim", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${jwtToken}`
      },
      body: JSON.stringify({
        publicKey: window.walletPublicKey,
        challengeId,
        totalTokens,
        nonce,
        signature,
		message
      })
    });
    const result = await resp.json();

    if (result.success) {
		  // ...existing claim success code...
  let unclaimed = completedChallenges.find(c => !c.claimed && c.completionDate);
  if (unclaimed) {
    // Save certificate data for FAQ tab
    const certificateData = {
      wallet: window.walletPublicKey,
      challengeId: unclaimed.challengeId,
      startDate: unclaimed.startDate,
      completionDate: unclaimed.completionDate,
      totalSessions: challengeData.totalSessions,
      totalMinutes: challengeData.totalMinutes,
      totalTokens: unclaimed.totalTokens,
      certId: `TY-${window.walletPublicKey}-${unclaimed.completionDate}`
    };
    localStorage.setItem('yogiCertificate', JSON.stringify(certificateData));
  }
      const explorerUrl = `https://explorer.solana.com/tx/${result.txSignature}`;
      statusDiv.innerHTML = `
        Success! You received ${result.tokensSent} YOGI tokens.<br>
        Transaction:<a href="${explorerUrl}" target="_blank" rel="noopener" class="tx-link">View transaction</a>
      `;
      if (loader) loader.style.display = 'none';
      // Mark challenge as claimed
      if (unclaimed) {
        unclaimed.claimed = true;
        unclaimed.claimTxId = result.txSignature;
        localStorage.setItem('completedChallenges', JSON.stringify(completedChallenges));
      }
      localStorage.setItem('yogiTokensClaimed', 'true');
      updateJourneyCompleteButtons();
    } else {
      statusDiv.textContent = `Claim failed: ${result.error || "Unknown error."}`;
      if (loader) loader.style.display = 'none';
    }
  } catch (err) {
    statusDiv.textContent = "Network error while claiming tokens.";
    if (loader) loader.style.display = 'none';
  }
}

// Gracefully complete expired session if user returns after end time (fixes wrong "missed session" modal)
document.addEventListener('visibilitychange', async function() {
  if (!document.hidden) {
    const activeSession = localStorage.getItem('activeSession');
    if (activeSession) {
      try {
        const sessionData = JSON.parse(activeSession);
        if (sessionData.sessionActive && sessionData.endTime <= Date.now()) {
          // Complete the session as if timer finished
          startTime = sessionData.startTime;
          endTime = sessionData.endTime;
          currentMode = sessionData.mode;
          targetDuration = sessionData.targetDuration;
          currentSessionTime = sessionData.sessionTime;
          sessionActive = false;
          localStorage.removeItem('activeSession');
          const actualMinutes = Math.round(targetDuration / 60);
          document.getElementById('actual-minutes').textContent = actualMinutes;
          document.getElementById('minute-text').textContent = actualMinutes === 1 ? 'minute' : 'minutes';
		  updateDurationMessage(actualMinutes);
          saveSession(actualMinutes, currentSessionTime);
		  localStorage.setItem('lastCompletedMode', currentMode);

		  
          if (currentMode === 'yogi') {
            const sessionDate = new Date(startTime).toDateString();
            const sessionTimeStr = currentSessionTime || new Date(startTime).toTimeString().split(' ')[0].slice(0, 5);
            challengeData.sessionsCompleted.push({ time: sessionTimeStr, duration: targetDuration, date: getLocalDateString(new Date(startTime)) });
            challengeData.totalSessions++;
            challengeData.totalMinutes += actualMinutes;
            challengeData.lastSessionDate = sessionDate;
            saveChallengeData();
          }

          document.getElementById('mode-selection').classList.add('hidden');
          document.getElementById('app-interface').classList.remove('hidden');
          document.getElementById('timer-section').classList.add('hidden');
          document.getElementById('complete-section').classList.remove('hidden');
          document.getElementById('start-section').classList.add('hidden');
          document.getElementById('session-stats').classList.remove('hidden');
          document.getElementById('yogi-progress').classList.add('hidden');
          document.getElementById('session-timing-display').classList.add('hidden');
          document.querySelector('#app-interface #flow-mode-btn-app').classList.add('hidden');
          document.querySelector('#app-interface #yogi-mode-btn-app').classList.add('hidden');
          updateBackButtonVisibility();
		  showCompletionStats();
		  // --- FIX: STOP MUSIC ---
		const bgMusicPlayer = document.getElementById('bg-music-player');
		if (bgMusicPlayer) {
		  bgMusicPlayer.pause();
		  bgMusicPlayer.currentTime = 0;
		  backgroundAudio = null;
		}
	      // --- END FIX ---	  
          const bell = document.getElementById('bell');
          if (bell) {
            bell.muted = false;
            bell.play().catch(e => console.log("Bell sound error:", e));
          }
        }
      } catch (e) {
        localStorage.removeItem('activeSession');
      }
    }
  }
});


function t(key, opts = {}) {
  let str = LANGUAGES[key] || key;
  if (opts.count !== undefined) {
    const plural = opts.count > 1 ? (LANGUAGES[key + "_plural"] || "s") : "";
    str = str.replace("{plural}", plural);
  }
  // Interpolate all {var} in the string
  Object.keys(opts).forEach(function(k) {
    str = str.replace(new RegExp('\\{'+k+'\\}', 'g'), opts[k]);
  });
  return str;
}

async function setLanguage(lang) {
  localStorage.setItem('lang', lang);
  await loadLanguage(lang);
  updateUILanguage();
  updateWalletUI();
  await loadQuotes();
}

function updateFAQTokenAddress() {
  // Use translation for each element
  document.getElementById('faq-token-address-question').textContent = t('faqTokenAddressQuestion');
  document.getElementById('faq-token-address-answer').textContent = t('faqTokenAddressAnswer');
  document.getElementById('faq-token-mint-label').textContent = t('faqTokenMintLabel');
  document.getElementById('yogi-mint').textContent = t('faqTokenMintValue');
  document.getElementById('faq-token-copy-tip').textContent = t('faqTokenCopyTip');
  document.getElementById('faq-token-explorer-link').textContent = t('faqTokenExplorerLink');

  // Mint value click-to-copy logic
  document.getElementById('yogi-mint').onclick = function() {
    navigator.clipboard.writeText(t('faqTokenMintFull'));
    const tip = document.getElementById('faq-token-copy-tip');
    tip.style.opacity = 1;
    setTimeout(() => tip.style.opacity = 0, 1500);
  };

  // Set explorer link href
  document.getElementById('faq-token-explorer-link').href =
    "https://solscan.io/token/" + t('faqTokenMintFull');
}

function updateUILanguage() {
updateFAQTokenAddress();
  const howToMeditateEl = document.getElementById('how-to-meditate-link');
  if (howToMeditateEl) howToMeditateEl.textContent = t('howToMeditate');
  const endMeditationBtn = document.getElementById('end-meditation-btn-label');

  const continuePathBtn = document.getElementById('continue-path1');
  if (continuePathBtn) {
  continuePathBtn.innerHTML = `<i class="fas fa-dove mr-2"></i>${t('continuePath1')}`;
  }

  const textElement = document.getElementById('completed-sessions-text');
  const requiredSessions = challengeData.requiredSessions || 1;
  textElement.textContent = t('completedSessionsText', { count: requiredSessions });
  document.getElementById('completed-sessions-modal-btn').textContent = t('contiJourney');
  
  if (endMeditationBtn) endMeditationBtn.textContent = t('endMeditationButton');
  document.getElementById('start-button-label').textContent = t('startMeditation');
  document.getElementById('end-meditation-modal').querySelector('h2').textContent = t('endMeditation');
  document.getElementById('completion-message').textContent = t('sessionComplete');
  document.getElementById('final-message').textContent = t('finalSection');
  document.querySelector('#start-meditation-modal h2').textContent = t('enterSacredStillness');
  document.querySelector('#start-meditation-modal .bg-yellow-500').textContent = t('beginStillness');
  document.querySelector('#start-meditation-modal .bg-gray-600').textContent = t('notYet');
  document.querySelector('#incomplete-section .text-red-300').textContent = t('sessionIncomplete');
  document.querySelector('#incomplete-section .text-gray-300').textContent = t('IncompleteMessage');
  document.querySelector('#incomplete-section button').innerHTML = `<i class="fas fa-dove mr-2"></i>${t('continuePath2')}`;
  document.querySelector('#missed-session-modal h2').textContent = t('sessionMissed');
  document.getElementById('missed-session-modal-text').textContent = t('missedSessionText');
  document.getElementById('missed-session-modal-reconfigure').textContent = t('reconfigure');
  document.getElementById('missed-session-modal-flowmode').textContent = t('switchToFlowMode');
  document.querySelector('#session-time-modal h2').textContent = t('sessionTimeRestriction');
  document.getElementById('session-time-modal-description').textContent = t('restrictDescription');
  document.querySelector('#completed-sessions-modal h2').textContent = t('completedSessions');
  document.querySelector('#yogi-config-modal h2').textContent = t('configureJourney');
  document.querySelector('#meditation-guide h2').textContent = t('meditationGuide');
  document.querySelector('#journey-complete-section .text-yellow-300').textContent = t('journeyComplete');
  document.querySelector('#claim-required-modal h2').textContent = t('claimRequired');
  document.querySelector('#auth-required-modal h2').textContent = t('verificationNeeded');
  document.querySelector('.auth-title').innerHTML = t('space');
  document.querySelector('#end-meditation-modal h2').textContent = t('endMeditation');
  document.querySelector('#reset-confirmation-modal h2').textContent = t('resetStillness');
  document.getElementById('reset-description').textContent = t('resetDescription');
  document.querySelector('#reset-confirmation-modal .bg-red-500').textContent = t('resetConfirmation');
  document.querySelector('#reset-confirmation-modal .bg-gray-600').textContent = t('resetCancel');
  document.querySelector('#session-timing-display p.text-yellow-300').childNodes[1].textContent = t('sessionTime');
  document.querySelector('#yogi-stats .text-yellow-400').nextElementSibling.textContent = t('yogiSessions');
  document.querySelector('#yogi-stats .text-green-400').nextElementSibling.textContent = t('yogiMinutes');
  document.querySelectorAll('#yogi-stats .text-yellow-400')[1].nextElementSibling.textContent = t('yogiStreak');
  document.querySelector('#yogi-stats .text-purple-400').nextElementSibling.textContent = t('resets');
  document.querySelector('#shared-stats .text-red-400').nextElementSibling.textContent = t('cancelled');
  document.querySelector('#flow-stats .text-blue-400').nextElementSibling.textContent = t('flowSessions');
  document.querySelector('#flow-stats .text-green-400').nextElementSibling.textContent = t('flowMinutes');
  document.querySelector('#shared-stats .text-blue-400').nextElementSibling.textContent = t('flowStreak');
  document.querySelector('.calm-heading').textContent = t('awakenWithin');
  document.querySelector('.subdued-path-text').textContent = t('chooseMeditationPath');
  document.querySelector('#flow-mode-btn-select .text-base').textContent = t('flowMode');
  document.querySelector('#flow-mode-btn-select .text-sm').textContent = t('meditateFreely');
  document.querySelector('#yogi-mode-btn-select .text-base').textContent = t('trueYogi');
  document.querySelector('#yogi-mode-btn-select .text-sm').textContent = t('yogiDescription');
  document.querySelector('#complete-section button').textContent = t('carryStillnessForward');
  document.querySelector('#end-meditation-modal .bg-red-500').textContent = t('endSession');
  document.querySelector('#end-meditation-modal .bg-gray-600').textContent = t('continueMeditation');
  document.getElementById('flow-mode-btn-app').textContent = t('flowModem');
  document.getElementById('yogi-mode-btn-app').textContent = t('yogiModem');
  document.getElementById('back-to-mode').innerHTML = '<i class="fas fa-arrow-left mr-2"></i>' + t('back2Mode');
  document.getElementById('proof-of-stillness-heading').textContent = t('proofOfStillness');
  document.getElementById('proof-of-stillness-subtitle').textContent = t('proofOfStillnessSubtitle');
  document.getElementById('duration-label').innerHTML = '<i class="far fa-hourglass mr-2"></i>' + t('selectDurationLabel');
  document.getElementById('background-music').textContent = t('backgroundMusic'); 
  document.getElementById('meditating').textContent = t('meditating'); 
  document.getElementById('youaresecret').textContent = t('youaresecret');
  document.getElementById('sacred').textContent = t('sacred');
  document.getElementById('day-label').textContent = t('day');
  document.getElementById('reset-challenge-btn').textContent = t('reset');
  document.getElementById('day-streak').textContent = t('streakDays');
  document.getElementById('today').textContent = t('today');
  document.getElementById('next-session').textContent = t('nextSession');
  document.getElementById('start-label').textContent = t('spark');
  document.getElementById('end-label').textContent = t('arrival');
  document.getElementById('now-date-display').textContent = t('now');
  document.getElementById('phantom-wallet-heading').textContent = t('openPhantomWallet');
  document.getElementById('phantom-wallet-redirect').textContent = t('phantomRedirectNotice');
  document.getElementById('phantom-wallet-confirm').textContent = t('phantomRedirectConfirm');
  document.getElementById('disconnect-wallet-title').textContent = t('disconnectWalletTitle');
  document.getElementById('disconnect-wallet-line1').textContent = t('disconnectWalletStatsLine1');
  document.getElementById('disconnect-wallet-line2').textContent = t('disconnectWalletStatsLine2');
  document.getElementById('disconnect-wallet-line3').textContent = t('disconnectWalletStatsLine3');
  document.getElementById('disconnect-wallet-message').textContent = t('disconnectWalletMessage');
  document.getElementById('confirm-disconnect-wallet').textContent = t('disconnectWalletConfirmButton');
  document.getElementById('cancel-disconnect-wallet').textContent = t('disconnectWalletCancelButton');
  document.getElementById('yogi-config-modalstart').textContent = t('configstart');
  document.getElementById('yogi-config-modalTimes').textContent = t('configTimes');
  document.getElementById('yogi-config-modalduration').textContent = t('configduration');
  document.getElementById('yogi-config-modalwindow').textContent = t('configwindow');
  document.getElementById('yogi-config-modalstreak').textContent = t('configstreak');
  document.getElementById('yogi-config-modal-41').textContent = t('configtag');
  document.getElementById('yogi-config-selectstart').textContent = t('selectstart');
  document.getElementById('yogi-config-selecttimes').textContent = t('selecttimes');
  document.getElementById('yogi-config-addsessions').innerHTML = '<i class="fas fa-plus mr-1"></i>' + t('addsessions'); 
  document.getElementById('begin-journey').textContent = t('beginJourney');
  document.getElementById('verify-identity-btn').textContent = t('verifyIdentity');
  document.getElementById('end-meditation-description').textContent = t('endDescription'); 
  document.getElementById('next-session-modal-heading').textContent = t('nextSessionHeading');
  document.getElementById('next-session-text').textContent = t('nextSessionText'); // If you want a default/fallback
  document.getElementById('auth-required-modal-verify').textContent = t('clickVerify');
  document.getElementById('auth-required-modal-line1').textContent = t('authLine1');
  document.getElementById('auth-required-modal-line2').textContent = t('authLine2');
  document.getElementById('connect-wallet-modal').textContent = t('connectWallet');
  document.getElementById('connect-wallet-line1').textContent = t('connectWalletL1'); 
  document.getElementById('connect-wallet-line2').textContent = t('connectWalletL2');
  document.querySelector('#sync-auth-required-modal h2').textContent = t('syncAuthRequiredHeading');
  document.querySelector('#sync-auth-required-modal .text-gray-200').innerHTML = `
  ${t('syncAuthRequiredLine1')}<br>
  ${t('syncAuthRequiredLine2')}<br>
  <span class="block mt-2 text-yellow-400">${t('syncAuthRequiredVerify')}</span>
`;
  document.querySelector('#wallet-required-modal h2').textContent = t('walletRequiredHeading');
  document.querySelector('#wallet-required-modal .text-gray-200').innerHTML = `
  ${t('walletRequiredDescriptionLine1')}<br>
  ${t('walletRequiredDescriptionLine2')}
`;
  document.querySelector('#wallet-required-modal .bg-yellow-500').innerHTML = `<i class="fas fa-wallet mr-2"></i> ${t('walletRequiredButtonConnect')}`;
  document.querySelector('#wallet-required-modal .bg-gray-700').innerHTML = `<i class="fas fa-redo mr-2"></i> ${t('walletRequiredButtonReset')}`;
  document.querySelector('#claim-required-modal h2').textContent = t('claimRequiredHeading');
  document.querySelector('#claim-required-modal .text-gray-200').innerHTML = t('claimRequiredDescription');
  document.querySelector('#journey-complete-section .text-yellow-300').textContent = t('journeyCompleteHeading');
  document.querySelector('#journey-complete-section .text-gray-300').textContent = t('journeyCompleteDescription');
  document.querySelector('#journey-complete-section button[onclick="resetYogiJourney()"]').innerHTML =
  `<i class="fas fa-om mr-2"></i>${t('journeyCompleteButtonNewJourney')}`;  
  document.getElementById('claim-tokens-btn').innerHTML =
  `<i class="fas fa-coins mr-2"></i>${t('journeyCompleteButtonClaimTokens')}`;
  document.getElementById('view-certificate-btn').innerHTML =
  `<i class="fas fa-certificate mr-2"></i>${t('journeyCompleteButtonViewCertificate')}`;
  document.querySelector('#claim-tokens-section .text-green-300').textContent = t('claimTokensHeading');
  document.querySelector('#claim-tokens-section .text-gray-300').textContent = t('claimTokensDescription');
  document.getElementById('start-claim-btn').innerHTML =
  `<i class="fas fa-wallet mr-2"></i>${t('claimTokensButtonClaimNow')}`;
  document.querySelector('#claim-loader div:last-child').textContent = t('claimTokensProcessing');
  document.querySelector('#start-onchain-journey-modal h2').textContent = t('startOnChainJourneyHeading');
  document.querySelector('#start-onchain-journey-modal .text-gray-200').innerHTML =
  `${t('startOnChainJourneyDescriptionLine1')}<br>
   ${t('startOnChainJourneyDescriptionLine2')}<br>
   <span class="text-yellow-400 font-bold">${t('startOnChainJourneyWarning')}</span><br>
   ${t('startOnChainJourneyDescriptionLine3')}`;
  document.querySelector('#start-onchain-journey-modal .bg-yellow-500').textContent = t('startOnChainJourneyButtonStartFresh');
  document.querySelector('#start-onchain-journey-modal .bg-gray-600').textContent = t('startOnChainJourneyButtonCancel');
  document.querySelector('#wallet-switch-block-modal h2').textContent = t('walletSwitchBlockHeading');
  document.querySelector('#wallet-switch-block-modal .text-gray-200').innerHTML =
  `${t('walletSwitchBlockDescriptionLine1')} <span id="modal-old-wallet" class="font-bold text-yellow-400"></span>.<br>
   ${t('walletSwitchBlockDescriptionLine2')} <span id="modal-new-wallet" class="font-bold text-blue-400"></span>.<br>
   <span class="block mt-2 text-yellow-400">${t('walletSwitchBlockWarning')}</span>`;
  document.querySelector('#wallet-switch-block-modal .bg-yellow-500').textContent = t('walletSwitchBlockButtonReset');
  document.querySelector('#wallet-switch-block-modal .bg-gray-600').textContent = t('walletSwitchBlockButtonBack');
  document.getElementById('faq-heading').textContent = t('faqHeading');
  document.getElementById('choose-background-music-text').textContent = t('chooseBackgroundMusic');
  
  // Meditation steps translation
  const stepsList = document.getElementById('meditation-steps-list');
  if (stepsList) {
    const steps = [
      t('meditationStep1'),
      t('meditationStep2'),
      t('meditationStep3'),
      t('meditationStep4')
    ];
    stepsList.innerHTML = steps.map(step => `<li>${step}</li>`).join('');
  }
  
  for (let i = 1; i <= 5; i++) {
  const qEl = document.getElementById(`faq-q${i}`);
  const aEl = document.getElementById(`faq-a${i}`);
  if (qEl) qEl.textContent = t(`faq_q${i}`);
  if (aEl) aEl.textContent = t(`faq_a${i}`);
}

for (let i = 1; i <= 5; i++) {
  const qEl = document.getElementById(`app-faq-q${i}`);
  const aEl = document.getElementById(`app-faq-a${i}`);
  if (qEl) qEl.textContent = t(`app_faq_q${i}`);
  if (aEl) aEl.textContent = t(`app_faq_a${i}`);
}

for (let i = 1; i <= 5; i++) {
  const qEl = document.getElementById(`dapp-faq-q${i}`);
  const aEl = document.getElementById(`dapp-faq-a${i}`);
  if (qEl) qEl.textContent = t(`dapp_faq_q${i}`);
  if (aEl) aEl.textContent = t(`dapp_faq_a${i}`);
}

const rfKeys = [
  'heading', 'intro', 'table-session', 'table-tokens', 'table-41max', 'table-yearly',
  'note1', 'note2', 'note3', 'cta'
];
rfKeys.forEach(k => {
  const el = document.getElementById(`rewards-faq-${k}`);
  if (el) el.textContent = t(`rewards_faq_${k.replace(/-/g, '_')}`);
});

document.getElementById('reset-faq-heading').textContent = t('reset_faq_heading');
document.getElementById('reset-faq-description').textContent = t('reset_faq_description');
document.getElementById('reset-faq-button').textContent = t('reset_faq_button');

document.getElementById('reset-confirm-title').textContent = t('reset_confirm_title');
document.getElementById('reset-confirm-description').textContent = t('reset_confirm_description');
document.getElementById('reset-confirm-list1').textContent = t('reset_confirm_list1');
document.getElementById('reset-confirm-list2').textContent = t('reset_confirm_list2');
document.getElementById('reset-confirm-list3').textContent = t('reset_confirm_list3');
document.getElementById('reset-confirm-list4').textContent = t('reset_confirm_list4');
document.getElementById('reset-confirm-warning').textContent = t('reset_confirm_warning');
document.getElementById('reset-confirm-button').textContent = t('reset_confirm_button');
document.getElementById('reset-confirm-cancel').textContent = t('reset_confirm_cancel');

document.getElementById('faq-wallet-question').innerHTML = `<span class="mr-2 text-yellow-400">üïäÔ∏è</span> ${t('faq_wallet_question')}`;
document.getElementById('faq-wallet-21days-label').textContent = t('faq_wallet_21days_label');
document.getElementById('faq-wallet-21days-text').textContent = t('faq_wallet_21days_text');
document.getElementById('faq-wallet-beyond-label').textContent = t('faq_wallet_beyond_label');
document.getElementById('faq-wallet-beyond-text').textContent = t('faq_wallet_beyond_text');
document.getElementById('faq-wallet-anew-title').textContent = t('faq_wallet_anew_title');
document.getElementById('faq-wallet-anew-desc').textContent = t('faq_wallet_anew_desc');
document.getElementById('faq-wallet-anew-note').textContent = t('faq_wallet_anew_note');
document.getElementById('faq-wallet-ending-quote').textContent = t('faq_wallet_ending_quote');
document.getElementById('meditation-faq-tab').textContent = t('faq_tab_meditation');
document.getElementById('app-faq-tab').textContent = t('faq_tab_app');
document.getElementById('dapp-faq-tab').textContent = t('faq_tab_web3');
document.getElementById('rewards-faq-tab').textContent = t('faq_tab_rewards');
document.getElementById('wisdom-section-heading').textContent = t('wisdomSectionHeading');
const sw = document.getElementById('show-wisdom');
if (sw && sw.querySelector('span')) {
  sw.querySelector('span').textContent = t('revealTodaysWisdom');
}	

document.getElementById('mobile-reminder-heading').textContent = t('mobileReminder_heading');
document.getElementById('mobile-reminder-paragraph').innerHTML = t('mobileReminder_paragraph');
document.getElementById('mobile-reminder-peaceflow').textContent = t('mobileReminder_peaceflow');
document.getElementById('desktop-yogi-modal-heading').textContent = t('desktopYogi_heading');
document.getElementById('desktop-yogi-modal-paragraph').innerHTML = t('desktopYogi_paragraph');
document.getElementById('desktop-yogi-modal-button').textContent = t('desktopYogi_button');
document.getElementById('mobile-required-heading').textContent = t('mobileRequired_heading');
document.getElementById('mobile-required-paragraph').innerHTML = t('mobileRequired_paragraph');
document.getElementById('mobile-required-button').textContent = t('mobileRequired_button');

document.getElementById('info-toggle-btn-text').textContent = t('infoToggleButton');
document.getElementById('info-section-title').textContent = t('infoSectionTitle');
document.getElementById('info-section-line1').textContent = t('infoSectionLine1');
document.getElementById('info-section-line2').textContent = t('infoSectionLine2');
document.getElementById('info-section-line3').textContent = t('infoSectionLine3');
document.getElementById('info-section-line4').textContent = t('infoSectionLine4');

document.querySelector('#faq-reset-yogi-config h3').textContent = t('resetYogiConfigHeading');
document.querySelector('#faq-reset-yogi-config p').textContent = t('resetYogiConfigDescription');
document.querySelector('#faq-reset-yogi-config button').innerHTML = `<i class="fas fa-redo mr-2"></i> ${t('resetYogiConfigButton')}`;

document.getElementById('mobile-yogi-modal-heading').textContent = t('mobileYogi_heading');
document.getElementById('mobile-yogi-modal-paragraph').innerHTML = t('mobileYogi_paragraph');
document.getElementById('mobile-yogi-modal-button').textContent = t('mobileYogi_button');

document.getElementById('wisdom-wallet-modal').textContent = t('wisdomWallet');
document.getElementById('wisdom-wallet-line1').textContent = t('wisdomWalletL1'); 
document.getElementById('wisdom-wallet-line2').textContent = t('wisdomWalletL2');

document.getElementById('clear-cache-heading').textContent = t('clearCacheModalHeading');
document.getElementById('clear-cache-description').innerHTML = t('clearCacheModalDescription');
document.getElementById('clear-cache-confirm-btn').innerHTML = `<i class="fas fa-broom mr-1"></i> ${t('clearCacheModalButtonConfirm')}`;
document.getElementById('clear-cache-cancel-btn').textContent = t('clearCacheModalButtonCancel');

document.getElementById('faq-clear-cache-heading').textContent = t('faqClearCacheHeading');
document.getElementById('faq-clear-cache-description').textContent = t('faqClearCacheDescription');
document.getElementById('faq-clear-cache-btn').innerHTML = `<i class="fas fa-broom mr-2"></i> ${t('faqClearCacheButton')}`;

document.getElementById('unseen-faq-q1').textContent = t('unseen_faq_q1');
document.getElementById('unseen-faq-a1').textContent = t('unseen_faq_a1');
document.getElementById('unseen-faq-q2').textContent = t('unseen_faq_q2');
document.getElementById('unseen-faq-a2').textContent = t('unseen_faq_a2');
document.getElementById('unseen-faq-q3').textContent = t('unseen_faq_q3');
document.getElementById('unseen-faq-a3').textContent = t('unseen_faq_a3');
document.getElementById('unseen-faq-q4').textContent = t('unseen_faq_q4');
document.getElementById('unseen-faq-a4').textContent = t('unseen_faq_a4');
document.getElementById('unseen-faq-q5').textContent = t('unseen_faq_q5');
document.getElementById('unseen-faq-a5').textContent = t('unseen_faq_a5');
document.getElementById('unseen-faq-q6').textContent = t('unseen_faq_q6');
document.getElementById('unseen-faq-a6').textContent = t('unseen_faq_a6');
document.getElementById('unseen-faq-q7').textContent = t('unseen_faq_q7');
document.getElementById('unseen-faq-a7').textContent = t('unseen_faq_a7');

  // Fix for challenge completed modal
  const heading = document.querySelector('#challenge-complete-section .text-white');
  const description = document.querySelector('#challenge-complete-section .text-gray-300');
  const newJourneyBtn = document.querySelector('#challenge-complete-section button[onclick="resetYogiJourney()"]');
  const closeBtn = document.querySelector('#challenge-complete-section button[onclick="closeChallengeCompletedModal()"]');
  
  if (heading) {
    heading.textContent = t('challengeCompleteHeading');
  }
  
  if (description) {
    const descText = t('challengeCompleteDescription')
      .replace('${startDate}', challengeData.startDate)
      .replace('${endDate}', challengeData.endDate);
    description.textContent = descText;
  }
  
  if (newJourneyBtn) {
    newJourneyBtn.innerHTML = `<i class="fas fa-om mr-2"></i>${t('challengeCompleteButtonNewJourney')}`;
  }
  
  if (closeBtn) {
    closeBtn.innerHTML = `<i class="fas fa-times mr-2"></i>${t('close')}`;
  }
  
}

document.addEventListener('DOMContentLoaded', updateUILanguage);
document.addEventListener('visibilitychange', handleVisibilityChange);
// ADD THIS ONE LINE FOR PWA SUPPORT
document.addEventListener('visibilitychange', requestWakeLock);

// Add to Homescreen functionality

// NEW: Detect platform and show correct instructions
function detectPlatformAndShowInstructions() {
  const userAgent = navigator.userAgent || navigator.vendor || window.opera;
  const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
  const isSamsungBrowser = /SamsungBrowser/i.test(userAgent);
  
  // Hide all instruction sets first
  document.getElementById('ios-steps').style.display = 'none';
  document.getElementById('android-chrome-steps').style.display = 'none';
  document.getElementById('samsung-steps').style.display = 'none';
  
  // Show relevant instructions
  if (isIOS) {
    document.getElementById('ios-steps').style.display = 'block';
  } else if (isSamsungBrowser) {
    document.getElementById('samsung-steps').style.display = 'block';
  } else {
    // Default to Android Chrome (most common)
    document.getElementById('android-chrome-steps').style.display = 'block';
  }
}

function showHomescreenPrompt() {
  // Check if we should show the prompt
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const promptDismissed = localStorage.getItem('homescreenPromptDismissed');
  
  // Only show on mobile devices, when not already in standalone mode, and if not previously dismissed
  if (isMobile && !isStandalone && !promptDismissed) {
    // NEW: Detect platform before showing
    detectPlatformAndShowInstructions();
    
    const prompt = document.getElementById('add-to-homescreen');
    prompt.style.display = 'block';
  }
}

function dismissHomescreenPrompt(permanent = false) {
  const prompt = document.getElementById('add-to-homescreen');
  prompt.style.display = 'none';
  
  if (permanent) {
    localStorage.setItem('homescreenPromptDismissed', 'true');
  }
}

// Wait a bit before showing the prompt for better UX
setTimeout(showHomescreenPrompt, 20000);

// Listen for app installed event
window.addEventListener('appinstalled', () => {
  // The app was successfully installed
  dismissHomescreenPrompt(true);
});

// NEW: Optional - Also detect on page load in case of slow connection
window.addEventListener('load', function() {
  // Re-check after load to ensure detection is accurate
  if (document.getElementById('add-to-homescreen').style.display === 'block') {
    detectPlatformAndShowInstructions();
  }
});
	
	
// --- Meditation Hide UI Toggle Button ---
let uiHiddenForMeditation = false;

const hideBtn = document.getElementById('hide-ui-btn');
const appInterface = document.getElementById('app-interface');
const modeSelection = document.getElementById('mode-selection');
const meditationCanvas = document.getElementById('meditation-canvas');

// Toggle UI when button clicked
hideBtn.addEventListener('click', () => {
  if (!sessionActive) return; // Only work during meditation
  uiHiddenForMeditation = !uiHiddenForMeditation;
  if (uiHiddenForMeditation) {
    // Hide all UI except the canvas
    appInterface.classList.add('hidden');
    modeSelection.classList.add('hidden');
    meditationCanvas.classList.remove('hidden');
    hideBtn.textContent = 'üåú'; // Show "restore" icon
    hideBtn.title = '';
  } else {
    // Restore all UI
    appInterface.classList.remove('hidden');
    meditationCanvas.classList.remove('hidden');
    hideBtn.textContent = 'üåû'; // Show "hide" icon
    hideBtn.title = '';
  }
});

// Show/hide button only during active session
function updateHideUiButtonVisibility() {
  if (sessionActive) {
    hideBtn.style.display = 'block';
    hideBtn.textContent = uiHiddenForMeditation ? 'üåû' : 'üåû';
  } else {
    hideBtn.style.display = 'none';
    uiHiddenForMeditation = false;
    appInterface.classList.remove('hidden');
    meditationCanvas.classList.remove('hidden');
  }
}

// Call on session start and end
// Patch into your beginMeditationSession and session end logic
const origBeginMeditationSession = window.beginMeditationSession;
window.beginMeditationSession = async function(...args) {
  await origBeginMeditationSession.apply(this, args);
  updateHideUiButtonVisibility();
};

function cleanupAfterSessionEnd() {
  updateHideUiButtonVisibility();
  // ...rest of your session cleanup logic...
}

// Call cleanupAfterSessionEnd() in your updateTimer() at session completion and in confirmEndMeditation()

// Also, call updateHideUiButtonVisibility() on page load
document.addEventListener('DOMContentLoaded', updateHideUiButtonVisibility);
	
function updateHideUiBtnVisibility() {
  document.getElementById('hide-ui-btn').style.display = sessionActive ? 'block' : 'none';
}	

let wisdoms = [];
let wisdomShownCount = 0;
let quoteOrder = [];

async function loadWisdoms() {
  const lang = localStorage.getItem('lang') || 'en';
  let wisdomFile = '/assets/wisdom.en.json';
  if (lang !== 'en') wisdomFile = `/assets/wisdom.${lang}.json`;
  try {
    const resp = await fetch(wisdomFile);
    wisdoms = await resp.json();
    if (!Array.isArray(wisdoms)) wisdoms = [];
  } catch {
    wisdoms = [];
  }
}

function showNextWisdom() {
  // üü¢ Always hide the like button at start
  document.getElementById('wisdom-like-container').style.display = 'none';

  const wisdomSection = document.getElementById('wisdom-section');
  const wisdomTextEl = document.getElementById('wisdom-text');
  const wisdomBtn = document.getElementById('show-wisdom');
  
  if (!wisdoms.length) {
    wisdomTextEl.textContent = t('wisdomNone');
    wisdomSection.classList.remove('hidden');
    return;
  }

  if (wisdomShownCount === 0) {
    // Get wisdom statistics from localStorage
    const wisdomStats = JSON.parse(localStorage.getItem('wisdomStats') || '{}');
    
    // Create array with wisdom text and its show count
    const wisdomsWithStats = wisdoms.map((wisdom, index) => ({
      text: wisdom,
      index: index,
      showCount: wisdomStats[index] || 0
    }));

    // Separate wisdoms into two groups:
    // - Never shown (showCount === 0)
    // - Already shown (showCount >= 1)
    const neverShown = wisdomsWithStats.filter(w => w.showCount === 0);
    const alreadyShown = wisdomsWithStats.filter(w => w.showCount >= 1);

    let selectedWisdoms = [];

    // 1. Add 11 never-shown wisdoms (or all if less than 11 available)
    if (neverShown.length > 0) {
      const newOnes = neverShown
        .sort(() => Math.random() - 0.5)
        .slice(0, 11);
      selectedWisdoms.push(...newOnes);
    }

    // 2. Add 2 random already-shown wisdoms (repeats)
    if (alreadyShown.length > 0) {
      const repeats = alreadyShown
        .sort(() => Math.random() - 0.5)
        .slice(0, 2);
      selectedWisdoms.push(...repeats);
    }

    // 3. If we don't have enough wisdoms (less than 13 total), fill with random
    if (selectedWisdoms.length < 13) {
      const needed = 13 - selectedWisdoms.length;
      const remaining = wisdomsWithStats
        .filter(w => !selectedWisdoms.includes(w))
        .sort(() => Math.random() - 0.5)
        .slice(0, needed);
      selectedWisdoms.push(...remaining);
    }

    // Final shuffle to mix new and repeated wisdoms
    wisdomOrder = selectedWisdoms
      .sort(() => Math.random() - 0.5)
      .map(item => item.text);
  }

  if (wisdomShownCount < Math.min(13, wisdomOrder.length)) {
    const wisdomText = wisdomOrder[wisdomShownCount];
    wisdomTextEl.textContent = wisdomText;
    wisdomSection.classList.remove('hidden');

    // üü¢ Show the like button now, since a wisdom is actually displayed:
    document.getElementById('wisdom-like-container').style.display = '';

    // Find its index in the original array and store as currentWisdomId
    currentWisdomId = wisdoms.indexOf(wisdomText);

    // üü° --- ADD THIS BLOCK TO RESET LIKE UI ---
    const icon = document.getElementById('wisdom-like-icon');
    const count = document.getElementById('wisdom-like-count');
    if (icon) {
      icon.classList.remove('fa-solid', 'text-pink-500');
      icon.classList.add('fa-regular');
    }
    if (count) {
      count.textContent = '0';
    }
    // üü° --- END BLOCK ---

    // üü° Fetch and render the actual like state for the new wisdom
    updateWisdomLikeUI(currentWisdomId);

    // Update wisdom statistics
    const wisdomStats = JSON.parse(localStorage.getItem('wisdomStats') || '{}');
    wisdomStats[currentWisdomId] = (wisdomStats[currentWisdomId] || 0) + 1;
    wisdomStats[`lastSeen_${currentWisdomId}`] = Date.now();
    localStorage.setItem('wisdomStats', JSON.stringify(wisdomStats));

    wisdomShownCount++;
    wisdomBtn.textContent = wisdomShownCount < Math.min(13, wisdomOrder.length)
      ? t('revealAnotherWisdom')
      : t('meditateToUnlockWisdom');
  } else {
    wisdomTextEl.textContent = t('wisdomJourneyContinues');
    wisdomBtn.style.display = "none";
    // üü¢ Optionally hide like button if journey is over:
    document.getElementById('wisdom-like-container').style.display = 'none';
  }
}

function getCurrentWisdomId() {
  return currentWisdomId;
}

document.addEventListener('DOMContentLoaded', async () => {
  await loadWisdoms();
  document.getElementById('show-wisdom').onclick = showNextWisdom;
  document.getElementById('lang-switch').addEventListener('change', async function() {
    await loadWisdoms();
    wisdomShownCount = 0;
  document.getElementById('show-wisdom').textContent = t('revealTodaysWisdom');
  document.getElementById('wisdom-section-heading').textContent = t('wisdomSectionHeading');
  document.getElementById('wisdom-section').classList.add('hidden');
  });
});

document.addEventListener('DOMContentLoaded', function() {
  const infoBtn = document.getElementById('info-toggle-btn');
  const infoSection = document.getElementById('info-section');
  if (infoBtn && infoSection) {
    infoBtn.addEventListener('click', function() {
      infoSection.style.display = infoSection.style.display === 'none' ? 'block' : 'none';
    });
  }
});

// Listen for visibility changes (tab or screen unlock)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && sessionActive) {
    requestWakeLock();
  }
});
window.addEventListener('focus', () => {
  if (sessionActive) requestWakeLock();
});

document.addEventListener('DOMContentLoaded', function() {
  const counterEl = document.getElementById('om-counter');
  const logo = document.getElementById('logo-sacred');
  const om = document.getElementById('om-sound');
  let isPlaying = false;

  function handleLogoTap(e) {
    e.preventDefault();
    e.stopPropagation();

    const rect = logo.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const clickX = e.touches ? e.touches[0].clientX : e.clientX;
    const clickY = e.touches ? e.touches[0].clientY : e.clientY;
    const dist = Math.sqrt(Math.pow(centerX - clickX, 2) + Math.pow(centerY - clickY, 2));

    if (dist < 33) {
      // Resume audio context if needed (usually for iOS)
      if (!window.audioContextResumed && window.webkitAudioContext) {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        context.resume();
        window.audioContextResumed = true;
      }

      if (!isPlaying) {
        try {
          om.loop = true;         // <<<<<< THIS is where it goes!
          om.muted = false;
          om.currentTime = 0;
          om.volume = 0.7;
          om.play();
          isPlaying = true;
          safeAddCount();
          startOmSelfHeal();
          startAudioHealthCheck();
        } catch (error) {
          console.log('Audio play failed:', error);
          isPlaying = false;
        }
      } else {
        om.pause();
        om.currentTime = 0;
        isPlaying = false;
        safeRemoveCount();
        stopOmSelfHeal();
        stopAudioHealthCheck();
      }
    }
  }

  if (logo && om) {
    om.loop = true; // Make sure; also can set here on DOM ready
    logo.addEventListener('click', handleLogoTap, { passive: false });
    logo.addEventListener('touchstart', handleLogoTap, { passive: false });
  }
});

window.addEventListener('pagehide', function() {
  const om = document.getElementById('om-sound');
  if (om) {
    om.pause();
    om.currentTime = 0;
  }
});

// --- OM play/stop rate limit logic ---
let omActionTimestamps = []; // Array of Date.now()
let omLockUntil = 0; // timestamp when lock ends

const OM_RATE_LIMIT = 10; // max allowed in window
const OM_RATE_WINDOW = 60 * 1000; // 1 min window in ms
const OM_LOCK_TIME = 30 * 60 * 1000; // 30 min lock in ms

function canPerformOmAction() {
  const now = Date.now();
  // If locked, return false if still locked
  if (omLockUntil && now < omLockUntil) return false;

  // Remove timestamps older than 1 min
  omActionTimestamps = omActionTimestamps.filter(ts => now - ts < OM_RATE_WINDOW);

  // Allow if under limit
  if (omActionTimestamps.length < OM_RATE_LIMIT) return true;

  // Otherwise, lock out for 30 min
  omLockUntil = now + OM_LOCK_TIME;
  // Optionally, store in localStorage to persist across reloads:
  localStorage.setItem('omLockUntil', omLockUntil.toString());
  return false;
}

// Call this in safeAddCount and safeRemoveCount
function recordOmAction() {
  const now = Date.now();
  omActionTimestamps.push(now);
  // Optionally, can store in localStorage for persistence
}

// On page load, restore lock from storage if needed:
document.addEventListener('DOMContentLoaded', () => {
  const savedLock = localStorage.getItem('omLockUntil');
  if (savedLock) omLockUntil = parseInt(savedLock, 10) || 0;
});

let lastOmAction = 0;

function safeAddCount() {
  const now = Date.now();
  if (now - lastOmAction < 500) return;
  if (!canPerformOmAction()) {
    //showOmLockNotice(); // Optional: show a message
    return;
  }
  lastOmAction = now;
  recordOmAction();
  addCount();
}

function safeRemoveCount() {
  const now = Date.now();
  if (now - lastOmAction < 500) return;
  if (!canPerformOmAction()) {
    //showOmLockNotice(); // Optional: show a message
    return;
  }
  lastOmAction = now;
  recordOmAction();
  removeCount();
}

// --- Audio Health Check System ---
let audioHealthCheckInterval = null;

function startAudioHealthCheck() {
  stopAudioHealthCheck();
  audioHealthCheckInterval = setInterval(() => {
    const om = document.getElementById('om-sound');
    if (om && !om.paused && om.currentTime > 0) {
      // Audio is healthy - do nothing
      return;
    }
    
    // Audio might be stuck - try to restart
    if (om && window.isPlaying) {
      console.log('Audio health check: restarting stuck audio');
      om.currentTime = 0;
      om.play().catch(error => {
        console.log('Audio health restart failed:', error);
        window.isPlaying = false;
        stopAudioHealthCheck();
      });
    }
  }, 5000); // Check every 5 seconds
}
function stopAudioHealthCheck() {
  if (audioHealthCheckInterval) {
    clearInterval(audioHealthCheckInterval);
    audioHealthCheckInterval = null;
  }
}

// --- OM self-heal sound interval ---
let omSelfHealInterval = null;

function stopOmSelfHeal() {
  if (omSelfHealInterval) {
    clearInterval(omSelfHealInterval);
    omSelfHealInterval = null;
  }
}
function startOmSelfHeal() {
  stopOmSelfHeal();
  if (!window.om || !window.counterEl) return;
  
  omSelfHealInterval = setInterval(() => {
    if (window.omPresenceId && window.counterEl.classList.contains('active')) {
      const om = document.getElementById('om-sound');
      if (om && om.paused && window.isPlaying) {
        console.log('Self-heal: restarting paused audio');
        om.currentTime = 0;
        om.play().catch(error => {
          console.log('Self-heal restart failed:', error);
          window.isPlaying = false;
        });
      }
    }
  }, 3000); // Reduced from 2500 to 3000 for better performance
}

// === create the small counter display ===
const counterEl = document.getElementById('om-counter');
// === helper functions for live Om counter ===
let omPresenceId = localStorage.getItem('omPresenceId');

async function addCount() {
  let id = localStorage.getItem('omPresenceId');
  if (id) {
    // Validate it with backend
    const res = await fetch('https://trueyogi-backend-knkq.onrender.com/check-om', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await res.json();
    if (!data.exists) {
      localStorage.removeItem('omPresenceId');
      id = null;
    }
  }
  if (!id) {
    // Now, add presence
    try {
	const localTimeString = new Date().toLocaleString();
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  
      const res = await fetch('https://trueyogi-backend-knkq.onrender.com/join-om', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
		    body: JSON.stringify({
      timezone,
	  user_id: omUserId,
      local_joined_at: localTimeString // Or use localTimeString if you want human readable
    })
  });
      const data = await res.json();
      localStorage.setItem('omPresenceId', data.id);
      omPresenceId = data.id;

      // --- Pulse, then restore glow ---
      counterEl.classList.remove('active');
      counterEl.classList.remove('om-counter-pulse');
      void counterEl.offsetWidth;
      counterEl.classList.add('om-counter-pulse');
      setTimeout(() => {
        counterEl.classList.remove('om-counter-pulse');
        counterEl.classList.add('active');
      }, 700);
      // ---

      updateCount();
      startHeartbeat();
    } catch (err) { console.error(err); }
  }
}

async function removeCount() {
  if (!omPresenceId) return;
  try {
    await fetch('https://trueyogi-backend-knkq.onrender.com/leave-om', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: omPresenceId })
    });
	localStorage.removeItem('omPresenceId');
    omPresenceId = null;
    updateCount();
	stopHeartbeat();
	    // ‚û§ Remove active glow
    const counterEl = document.getElementById('om-counter');
    if (counterEl) counterEl.classList.remove('active');
  } catch (err) { console.error(err); }
}

let lastCount = null; // Place this at the top (outside the function)

async function updateCount() {
  try {
    // Get the up-to-date count directly from Supabase
    const { count, error } = await supabase
      .from('om_presence')
      .select('*', { count: 'exact', head: true });
    if (error) throw error;

    const newCount = (typeof count === "number") ? count : 0;

    if (newCount > 0) {
      counterEl.innerHTML = `<span class="om-number">${newCount}</span>`;
      counterEl.classList.remove('hidden');
      counterEl.style.opacity = 1;

      // Animate if the count changed
      if (lastCount !== null && newCount !== lastCount) {
        counterEl.classList.add('om-counter-pulse');
        setTimeout(() => counterEl.classList.remove('om-counter-pulse'), 700);
        showMeditatorFloat();
      }
      lastCount = newCount;

        // --------- KEEP THIS BLOCK ---------
      const omNumber = counterEl.querySelector('.om-number');
      if (omNumber) {
        omNumber.onclick = function(e) {
          showEarthGrid();
          e.stopPropagation();
        };
      }
      // --------- END BLOCK ---------
    } else {
      // Hide completely if count is zero
      counterEl.classList.add('hidden');
      counterEl.innerHTML = '';
      lastCount = 0;
    }
  } catch (err) {
    counterEl.classList.add('hidden');
    counterEl.innerHTML = '';
    lastCount = 0;
    console.error(err);
  }
    // Always sync OM counter glow ("active") with local omPresenceId
  if (counterEl) {
    let omPresenceId = localStorage.getItem('omPresenceId');
    if (omPresenceId) {
      counterEl.classList.add('active');
    } else {
      counterEl.classList.remove('active');
    }
  }
}

document.addEventListener('visibilitychange', () => {
  if (!document.hidden) updateCount();
});

setInterval(updateCount, 9000); // every 9 seconds

// clear user when closing page
//window.addEventListener('beforeunload', () => {
//  removeCount();//  stopHeartbeat();//});
//window.addEventListener('pagehide', () => {
//  removeCount();//  stopHeartbeat();//});
 

let heartbeatInterval = null;

async function sendHeartbeat() {
  if (!omPresenceId) return;
  try {
    await fetch('https://trueyogi-backend-knkq.onrender.com/om-heartbeat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: omPresenceId })
    });
  } catch (err) { /* Optional: handle error */ }
}

function startHeartbeat() {
  sendHeartbeat(); // send once immediately
  heartbeatInterval = setInterval(sendHeartbeat, 30 * 60 * 1000); // every 30 minutes
}

function stopHeartbeat() {
  if (heartbeatInterval) clearInterval(heartbeatInterval);
  heartbeatInterval = null;
}

// Validate OM presence against the backend
async function validateOmPresence() {
  let omPresenceId = localStorage.getItem('omPresenceId');
  if (!omPresenceId) return;

  const res = await fetch('https://trueyogi-backend-knkq.onrender.com/check-om', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: omPresenceId })
  });
  const data = await res.json();
  if (!data.exists) {
    localStorage.removeItem('omPresenceId');
    omPresenceId = null;
    // Now safe to call addCount() again when user plays
  }
}

let meditateSVGContent = null;

async function showMeditatorFloat() {
  // 1. Fetch SVG if not already loaded
  if (!meditateSVGContent) {
    const resp = await fetch('/assets/ommeditate.svg');
    meditateSVGContent = await resp.text();
  }

  // 2. Get aura color
  const auraClass = Array.from(counterEl.classList).find(c => auraColors.includes(c)) || "yellow";
  const auraColorMap = {
    red: "#FF1A1A", orange: "#FF8800", yellow: "#FFD600", green: "#29D884",
    blue: "#3B82F6", indigo: "#4338CA", violet: "#C026D3", gold: "#FFD700",
    silver: "#BFC9CA", sapphire: "#1a4fcc", "dark-silver": "#606060EE", white: "#FFFFFF"
  };
  const color = auraColorMap[auraClass] || "#FFD600";

  // 3. Replace color in SVG (adjust regex if needed)
  let svgColored = meditateSVGContent.replace(/fill="[^"]*"/g, `fill="${color}"`);

  // 4. Position: get OM counter center
  const rect = counterEl.getBoundingClientRect();
  const svgSize = 0.1; // px, adjust if needed
  const centerX = rect.left + rect.width / 2 - svgSize / 2;
  const centerY = rect.top + rect.height / 2 - svgSize / 2;

  // 5. Create floating div for SVG
  const float = document.createElement("div");
  float.innerHTML = svgColored;
  float.style.position = "fixed";
  float.style.left = `${centerX}px`;
  float.style.top = `${centerY}px`;
  float.style.width = `${svgSize}px`;
  float.style.height = `${svgSize}px`;
  float.style.pointerEvents = "none";
  float.style.zIndex = 9999;
  float.style.transition = "opacity 0.8s, transform 0.8s";
  float.style.opacity = "1";
  float.style.transform = "translateY(0)";
  float.style.filter = `drop-shadow(0 0 12px ${color}88)`;

  document.body.appendChild(float);

  setTimeout(() => {
    float.style.opacity = "0";
    float.style.transform = "translateY(-36px) scale(1.15)";
  }, 50);
  setTimeout(() => float.remove(), 950);
}

document.addEventListener('DOMContentLoaded', () => {
  const omPresenceId = localStorage.getItem('omPresenceId');
  const counterEl = document.getElementById('om-counter');
  if (omPresenceId && counterEl) {
    counterEl.classList.add('active'); // Show OM glow immediately
  } else if (counterEl) {
    counterEl.classList.remove('active'); // Remove glow if not present
  }
});


function isModeSelectionVisible() {
  const modeSelection = document.getElementById('mode-selection');
  const faqModal = document.getElementById('faq-modal');
  const welcomeModal = document.getElementById('welcome-message');
  
  // Return true ONLY if mode selection is visible AND both modals are hidden
  return modeSelection && 
         faqModal && 
         welcomeModal &&
         !modeSelection.classList.contains('hidden') && 
         faqModal.classList.contains('hidden') &&
         welcomeModal.classList.contains('hidden');
}

let startY = 0;
let currentY = 0;
let isDragging = false;
const spinner = document.getElementById('pull-refresh-spinner');
const lungsImg = spinner.querySelector('.breathing-lungs');

const expansionPx = 350;
const minShowPx = 96;
const refreshThresholdPx = minShowPx + 1.8 * (expansionPx - minShowPx); // matches violet

// Breathing phase thresholds - UPDATED FOR BOTH DIRECTIONS
const BREATHING_PHASES = {
  RED:      { scale: 1.0, message: "" },
  ORANGE:   { scale: 1.42, message: "breath_in_slow" },
  YELLOW:   { scale: 1.83, message: "keep_breathing_in" },
  GREEN:    { scale: 2.25, message: "almost_full" },
  LIGHTBLUE:{ scale: 2.67, message: "get_ready_hold" },
  INDIGO:   { scale: 3.08, message: "deep_breath_in" },
  VIOLET:   { scale: 3.5, message: "hold" }
};

const EXHALE_PHASES = {
  VIOLET:    { scale: 3.5, message: "hold_breath" },
  INDIGO:    { scale: 3.08, message: "breath_out_slow" },
  LIGHTBLUE: { scale: 2.67, message: "keep_breathing_out" },
  GREEN:     { scale: 2.25, message: "releasing_slowly" },
  YELLOW:    { scale: 1.83, message: "almost_empty" },
  ORANGE:    { scale: 1.42, message: "final_exhale" },
  RED:       { scale: 1.0, message: "hold_breath" }
};

// Rainbow color thresholds with your exact colors
const colorStops = [
  { scale: 1.0, color: 'lungs-red' },
  { scale: 1.3, color: 'lungs-orange' },
  { scale: 1.6, color: 'lungs-yellow' },
  { scale: 1.9, color: 'lungs-green' },
  { scale: 2.2, color: 'lungs-lightblue' },
  { scale: 2.5, color: 'lungs-indigo' },
  { scale: 2.8, color: 'lungs-violet' }
];

let countdownCompleted = false;
let breathingCycleLocked = false; 
let currentPhase = 'RED';
let countdownInterval = null;
let isExhaling = false;
let previousScale = 1.0;

// Remove all color classes
function removeColorClasses() {
  colorStops.forEach(stop => {
    lungsImg.classList.remove(stop.color);
  });
}

// Update color based on current scale
function updateLungsColor(scale) {
  removeColorClasses();
  
  // Detect if we're exhaling (scaling down) - BUT NOT during countdown
  if (scale < previousScale && previousScale >= colorStops[1].scale && !countdownInterval) {
    isExhaling = true;
  } else if (scale > previousScale) {
    isExhaling = false;
  }
  
  previousScale = scale;
  
  // Find the appropriate color for current scale
  for (let i = colorStops.length - 1; i >= 0; i--) {
    if (scale >= colorStops[i].scale) {
      lungsImg.classList.add(colorStops[i].color);
      
      // Update breathing phase and message based on direction
      const phaseName = Object.keys(BREATHING_PHASES)[i];
      updateBreathingMessage(scale, phaseName, isExhaling);
      break;
    }
  }
  
  // Default to red if no color matched
  if (scale < colorStops[0].scale) {
    lungsImg.classList.add('lungs-red');
    updateBreathingMessage(scale, 'RED', isExhaling);
  }
}

// Update breathing guidance message based on direction
function updateBreathingMessage(scale, phaseName, isExhaling) {
  let message = "";
  
  // ONCE COUNTDOWN COMPLETES, LOCK TO EXHALE ONLY
  if (breathingCycleLocked) {
    // Force exhale messages regardless of direction
    const key = EXHALE_PHASES[phaseName]?.message || "";
		message = key ? t(key) : "";
  }
  else if (isExhaling) {
    // ONLY show exhale messages if we're not in hold phase
    if (countdownInterval === null || phaseName !== 'VIOLET') {
      const key = EXHALE_PHASES[phaseName]?.message || "";
		message = key ? t(key) : "";
    } else {
      // Still counting down - show hold message instead of exhale
      message = "Hold your breath...";
    }
  } else {
    // Use inhale messages when scaling up - BUT NOT if cycle is locked
    if (!breathingCycleLocked) {
      const key = BREATHING_PHASES[phaseName]?.message || "";
		message = key ? t(key) : "";
      
      // Start countdown only when reaching VIOLET
      if (phaseName === 'VIOLET' && !countdownInterval) {
        startCountdown();
      }
    } else {
      // If cycle locked and user tries to inhale again, show exhale message
      message = "Continue breathing out...";
    }
  }
  
  // Only update if phase changed
  if (phaseName !== currentPhase) {
    currentPhase = phaseName;
    showBreathingMessage(message);
  }
}

// Show breathing message on screen
function showBreathingMessage(message) {
  let messageEl = document.getElementById('breathing-message');
  
  if (!messageEl) {
    messageEl = document.createElement('div');
    messageEl.id = 'breathing-message';
    messageEl.style.cssText = `
      position: fixed;
      top: 20%; /* Position at top of screen instead of center */
      left: 50%;
      transform: translateX(-50%); /* Only center horizontally */
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 18px;
      font-weight: bold;
      z-index: 10001;
      text-align: center;
      transition: opacity 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
    `;
    document.body.appendChild(messageEl);
  }
  
  // FIX: Only show message when lungs are actually visible (scale > 1.0 and spinner is shown)
  const shouldShowMessage = message && previousScale > 1.0 && spinner.classList.contains('show');
  
  if (shouldShowMessage) {
    messageEl.textContent = message;
    messageEl.style.opacity = '1';
  } else {
    messageEl.style.opacity = '0';
  }
}

// Countdown for breath holding
function startCountdown() {
  let countdown = 21;
  const messageEl = document.getElementById('breathing-message');
  breathingCycleLocked = false; // Reset lock
  
  countdownInterval = setInterval(() => {
    if (countdown > 0) {
      messageEl.textContent = t('hold_breath_countdown', { countdown });
      countdown--;
    } else {
      stopCountdown();
      breathingCycleLocked = true; // LOCK THE CYCLE - no more inhaling
      // Switch to exhale message after countdown
      isExhaling = true;
      messageEl.textContent = t('breath_out_slow');
    }
  }, 1000);
}

function stopCountdown() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
}

// Clean up breathing message
function cleanupBreathingMessage() {
  stopCountdown();
  const messageEl = document.getElementById('breathing-message');
  if (messageEl) {
    messageEl.style.opacity = '0';
    setTimeout(() => {
      if (messageEl.parentNode) messageEl.parentNode.removeChild(messageEl);
    }, 300);
  }
  currentPhase = 'RED';
  isExhaling = false;
  previousScale = 1.0;
  breathingCycleLocked = false; // RESET THE LOCK
}

document.addEventListener('touchstart', function(e) {
  if (!isModeSelectionVisible()) return;
  if (window.scrollY === 0) {
    startY = e.touches[0].pageY;
    isDragging = true;
    spinner.style.opacity = '0';
    spinner.classList.remove('show');
    lungsImg.style.transform = 'scale(1)';
    lungsImg.style.transition = 'none';
    removeColorClasses();
    lungsImg.classList.add('lungs-red'); // Start with red
    cleanupBreathingMessage(); // Reset breathing guidance
    
    // Don't show message immediately - wait for lungs to appear
    const messageEl = document.getElementById('breathing-message');
    if (messageEl) {
      messageEl.style.opacity = '0';
    }
  }
}, { passive: false });

document.addEventListener('touchmove', function(e) {
  if (!isDragging || !isModeSelectionVisible()) return;
  currentY = e.touches[0].pageY;
  const pullDistance = currentY - startY;
  const maxScale = 3.5;
  const minScale = 0.3;

  if (pullDistance > minShowPx) {
    spinner.classList.add('show');
    spinner.style.opacity = 1;
    const scale = 1 + Math.min((pullDistance - minShowPx) / (expansionPx - minShowPx), maxScale - 1);
    lungsImg.style.transform = `scale(${scale})`;
    
    // Update color based on scale
    updateLungsColor(scale);

  } else {
    const shrinkDistance = Math.max(pullDistance, 0);
    const scale = Math.max(1 + shrinkDistance / minShowPx, minScale);
    lungsImg.style.transform = `scale(${scale})`;
    updateLungsColor(scale); // Update color even when shrinking
    spinner.classList.remove('show');
    spinner.style.opacity = '0';
  }
}, { passive: false });

document.addEventListener('touchend', function(e) {
  if (!isDragging || !isModeSelectionVisible()) return;
  const pullDistance = currentY - startY;
  lungsImg.style.transition = 'transform 0.45s cubic-bezier(.22,1,.36,1)';

  if (pullDistance > refreshThresholdPx) {
    // Refresh logic
    spinner.classList.add('refreshing');
    lungsImg.style.transform = 'scale(1) rotate(0deg)';
    lungsImg.style.opacity = '0';
    showBreathingMessage("‚ú®");
    
    setTimeout(() => {
      spinner.style.opacity = '1';
      lungsImg.style.transform = 'scale(1)';
      lungsImg.style.transition = 'transform 0.25s cubic-bezier(.22,1,.36,1)';
      cleanupBreathingMessage();
      window.location.reload(true);
    }, 500);
  } else {
    // Breathing exercise logic - SIMPLIFIED
    spinner.classList.remove('show', 'refreshing');
    lungsImg.style.transform = 'scale(1)';
    
    // JUST CLEAN UP - NO COMPLETION MESSAGE
    cleanupBreathingMessage();
    
    setTimeout(() => { spinner.style.opacity = '0'; }, 400);
  }
  
  isDragging = false;
  startY = 0;
  currentY = 0;
}, { passive: false });

// === ADD THIS NEW CODE AT THE BOTTOM OF YOUR FILE ===

// Audio Manager for better sound management
class AudioManager {
  constructor() {
    this.audioElements = new Map();
    this.maxSimultaneous = 9;
  }

  playSound(src, volume = 1.0, loop = false) {
    this.cleanup();
    
    const audio = new Audio();
    audio.src = src;
    audio.volume = volume;
    audio.loop = loop;
    audio.preload = 'auto';
    
    const audioId = Date.now() + Math.random();
    this.audioElements.set(audioId, audio);
    
    audio.play().catch(e => {
      console.log('Audio play failed:', e);
    });
    
    if (!loop) {
      audio.onended = () => {
        this.audioElements.delete(audioId);
      };
    }
    
    if (this.audioElements.size > this.maxSimultaneous) {
      this.removeOldestNonLooping();
    }
    
    return audioId;
  }

  cleanup() {
    for (const [id, audio] of this.audioElements) {
      if (!audio.loop && (audio.ended || audio.paused)) {
        audio.src = '';
        this.audioElements.delete(id);
      }
    }
  }

  removeOldestNonLooping() {
    for (const [id, audio] of this.audioElements) {
      if (!audio.loop) {
        audio.pause();
        audio.src = '';
        this.audioElements.delete(id);
        break;
      }
    }
  }
}

// Create the audio manager
const audioManager = new AudioManager();

// Double-tap music with 4 screen zones
let lastTap = 0;

// Define 4 different sounds (add these audio elements to your HTML)
const zoneSounds = {
  'top-left': 'https://assets.trueyogi.app/assets/bell.m4a',      
  'top-right': 'https://assets.trueyogi.app/assets/harmony-bell.m4a',
  'bottom-left': 'https://assets.trueyogi.app/assets/tamtam-gong.m4a',  
  'bottom-right': 'https://assets.trueyogi.app/assets/tao-chi-gong.m4a'
};

const zoneIcons = {
  'top-left': 'üîî',      // Bell
  'top-right': 'üîî',     // Music notes
  'bottom-left': 'üé∂',   // Drum
  'bottom-right': 'üé∂'   // Multiple notes
};

document.addEventListener('touchend', function(e) {
  // Your existing filters (keep these)
  const avatarEl = document.querySelector('.avatar-container');
  if (avatarEl && avatarEl.contains(e.target)) return;

  const logoEl = document.getElementById('logo-sacred');
  if (logoEl && logoEl.contains(e.target)) return;
  
    const truemeditateImg = document.getElementById('truemeditate-img-svg');
if (truemeditateImg && (e.target === truemeditateImg || truemeditateImg.contains(e.target))) {
  return; // Skip zone/bell/double-tap sounds here!
}
  
  const modeSelectionEl = document.getElementById('mode-selection');
  const appInterfaceEl  = document.getElementById('app-interface');
  const onModeSelection = modeSelectionEl && !modeSelectionEl.classList.contains('hidden');
  const onAppInterface  = appInterfaceEl && !appInterfaceEl.classList.contains('hidden');
  if (!(onModeSelection || onAppInterface)) return;
  if (typeof sessionActive !== "undefined" && sessionActive) return;

  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastTap;

  if (tapLength < 200 && tapLength > 0) {
    e.preventDefault();
    
    // Determine which zone was tapped
    const zone = getTapZone(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    
    // Play zone-specific sound
    playZoneSound(zone);
    
    // Show zone-specific icon
    showZoneIcon(e.changedTouches[0].clientX, e.changedTouches[0].clientY, zone);
  }
  lastTap = currentTime;
});

// Determine which zone was tapped
function getTapZone(x, y) {
  const screenWidth = window.innerWidth;
  const screenHeight = window.innerHeight;
  const isTop = y < screenHeight / 2;
  const isLeft = x < screenWidth / 2;
  
  if (isTop && isLeft) return 'top-left';
  if (isTop && !isLeft) return 'top-right';
  if (!isTop && isLeft) return 'bottom-left';
  return 'bottom-right'; // !isTop && !isLeft
}

// Play zone-specific sound
// Play zone-specific sound - UPDATED VERSION
function playZoneSound(zone) {
  const soundFiles = {
    'top-left': 'https://assets.trueyogi.app/assets/bell.m4a',
    'top-right': 'https://assets.trueyogi.app/assets/harmony-bell.m4a', 
    'bottom-left': 'https://assets.trueyogi.app/assets/tamtam-gong.m4a',
    'bottom-right': 'https://assets.trueyogi.app/assets/tao-chi-gong.m4a'
  };
  
  const volumes = {
    'top-left': 0.7,
    'top-right': 0.6,
    'bottom-left': 0.8,
    'bottom-right': 0.5
  };
  
  const soundFile = soundFiles[zone];
  const volume = volumes[zone];
  
  if (soundFile) {
    // Use the AudioManager for better performance
    audioManager.playSound(soundFile, volume);
  }
}

// Show zone-specific icon with different colors
function showZoneIcon(x, y, zone) {
  const iconDiv = document.createElement('div');
  const icon = zoneIcons[zone];
  const colors = {
    'top-left': { bg: '#fff', color: '#eab308', border: '#fde68a' },      // Yellow (original)
    'top-right': { bg: '#fff', color: '#3b82f6', border: '#93c5fd' },     // Blue
    'bottom-left': { bg: '#fff', color: '#ef4444', border: '#fca5a5' },   // Red
    'bottom-right': { bg: '#fff', color: '#10b981', border: '#6ee7b7' }   // Green
  };
  
  const zoneColor = colors[zone];
  
  iconDiv.textContent = icon;
  iconDiv.style.cssText = `
    position: fixed;
    left: ${x}px;
    top: ${y-40}px;
    transform: translate(-50%, 0);
    font-size: 1.2em;
    background: ${zoneColor.bg};
    color: ${zoneColor.color};
    border-radius: 24px;
    padding: 4px 20px;
    z-index: 9999;
    box-shadow: 0 0 24px #fff, 0 0 9px ${zoneColor.color}88;
    text-shadow: 0 0 14px #fff, 0 0 4px ${zoneColor.color};
    border: 2px solid ${zoneColor.border};
    pointer-events: none;
    opacity: 0;
    animation: dtMusicFloat 1s forwards;
  `;
  
  document.body.appendChild(iconDiv);
  setTimeout(() => {
    if (iconDiv.parentNode) iconDiv.parentNode.removeChild(iconDiv);
  }, 1000);
}

// Keep your existing animation
const dtStyle = document.createElement('style');
dtStyle.textContent = `
@keyframes dtMusicFloat {
  0% {opacity:0;transform:translate(-50%,10px) scale(0.85);}
  40% {opacity:1;transform:translate(-50%,0) scale(1);}
  100% {opacity:0;transform:translate(-50%,-30px) scale(0.8);}
}`;
document.head.appendChild(dtStyle);

// Minimal avatar music with basic health guard and single-init protection
document.addEventListener('DOMContentLoaded', function() {
  // Guard: init only once
  if (window.__avatarAudioInitialized) return;
  window.__avatarAudioInitialized = true;

  const avatar = document.querySelector('.avatar-container');
  const avatarSound = document.getElementById('avatar-sound'); // audio element
  let avatarPlaying = false;
  let avatarHealthInterval = null;

  function startAvatarHealthCheck() {
    stopAvatarHealthCheck();
    avatarHealthInterval = setInterval(() => {
      try {
        if (avatarPlaying && avatarSound && avatarSound.paused) {
          console.log('Avatar health: audio paused unexpectedly ‚Äî restarting');
          avatarSound.currentTime = 0;
          avatarSound.play().catch(err => {
            console.log('Avatar health restart failed:', err);
            avatarPlaying = false;
            stopAvatarHealthCheck();
          });
        }
      } catch (e) { console.error(e); }
    }, 5000);
  }
  function stopAvatarHealthCheck() {
    if (avatarHealthInterval) {
      clearInterval(avatarHealthInterval);
      avatarHealthInterval = null;
    }
  }

  // Only try to auto-restart if the pause happened because tab was hidden
  if (avatarSound) {
    avatarSound.addEventListener('pause', () => {
      if (avatarPlaying && document.hidden) {
        setTimeout(() => {
          if (avatarPlaying && avatarSound.paused) {
            avatarSound.play().catch(err => {
              console.log('Avatar visibility restart failed:', err);
              avatarPlaying = false;
              stopAvatarHealthCheck();
            });
          }
        }, 100);
      }
    });
  }

  if (avatar && avatarSound) {
    avatarSound.loop = true;
    avatar.addEventListener('click', function(e) {
      const rect = avatar.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const clickX = e.clientX;
      const clickY = e.clientY;
      const dist = Math.hypot(centerX - clickX, centerY - clickY);
      const avatarRadius = Math.min(rect.width, rect.height) / 22;

      if (dist < avatarRadius) {
        if (!avatarPlaying) {
          // Start
          try {
            stopAvatarHealthCheck(); // ensure no stray interval
            avatarSound.muted = false;
            avatarSound.currentTime = 0;
            avatarSound.volume = 0.3;
            avatarSound.play().catch(()=>{});
            avatarPlaying = true;
            startAvatarHealthCheck();
            // optional visual feedback: showAvatarFeedback(centerX, centerY);
          } catch (err) {
            console.log('Avatar play failed:', err);
            avatarPlaying = false;
            stopAvatarHealthCheck();
          }
        } else {
          // Stop: stop health-check first to avoid immediate restart
          stopAvatarHealthCheck();
          try {
            avatarSound.pause();
            avatarSound.currentTime = 0;
          } catch (err) { console.warn(err); }
          avatarPlaying = false;
        }
      }
    });
  }
});


// Aura 12 Colors - Rotated by 2 hours forward
const auraColors = [
  "red",         // 1 (6:30‚Äì8:30)  
  "orange",      // 2 (8:30‚Äì10:30) 
  "yellow",      // 3 (10:30‚Äì12:30)  
  "green",       // 4 (12:30‚Äì2:30)  
  "blue",        // 5 (2:30‚Äì4:30)  
  "indigo",      // 6 (4:30‚Äì6:30)  
  "violet",      // 7 (6:30‚Äì8:30) 
  "gold",        // 8 (8:30‚Äì10:30) 
  "silver",      // 9 (10:30‚Äì12:30) 
  "sapphire",    // 10 (12:30‚Äì2:30) 
  "dark-silver", // 11 (2:30‚Äì4:30) 
  "white"        // 12 (4:30‚Äì6:30) 
];

const auraGradientHex = {
  red:      "#FF1A1A",
  orange:   "#FF8800",
  yellow:   "#FFD600",
  green:    "#29D884",
  blue:     "#3B82F6",
  indigo:   "#4338CA",
  violet:   "#C026D3",
  gold:     "#FFD700",
  silver:   "#BFC9CA",
  sapphire: "#1a4fcc",
  "dark-silver": "#606060EE",
  white:    "#fff"
};

// Returns 0‚Äì11 for slot based on new timing (6:30 start instead of 4:30)
function getAuraIndex() {
  const now = new Date();
  const localHour = now.getHours();
  const localMin = now.getMinutes();
  
  // Start from 6:30 instead of 4:30
  let minutesSinceStart = (localHour * 60 + localMin) - (6 * 60 + 30);
  if (minutesSinceStart < 0) minutesSinceStart += 24 * 60;
  
  const slot = Math.floor(minutesSinceStart / 120);
  return slot % 12;
}

function setAuraColor() {
  const auraClass = auraColors[getAuraIndex()];

  // Elements to update
  const card = document.querySelector('.card-aura');
  const omCounter = document.getElementById('om-counter');
  const resonanceMsg = document.getElementById('resonanceMsg');
  const userIdDisplay = document.getElementById('userIdDisplay'); // <-- Add this line

  // Remove old aura classes from all
  auraColors.forEach(c => {
    if (card) card.classList.remove(c);
    if (omCounter) omCounter.classList.remove(c);
    if (resonanceMsg) resonanceMsg.classList.remove(c);
    if (userIdDisplay) userIdDisplay.classList.remove(c); // <-- Add this
  });

  // Add new aura class
  if (card) card.classList.add(auraClass);
  if (omCounter) omCounter.classList.add(auraClass);
  if (resonanceMsg) resonanceMsg.classList.add(auraClass);
  if (userIdDisplay) userIdDisplay.classList.add(auraClass); // <-- Add this
  
    // --- CONNECTION STATUS LOGIC ---
  if (userIdDisplay) {
    // Get user connection status
    const userId = localStorage.getItem('omUserId');
    // livePresenceRows must be global and updated!
    const isConnected = Array.isArray(livePresenceRows) && livePresenceRows.some(row => row.user_id === userId);

    // Use aura gradient color hex
    const hex = auraGradientHex[auraClass] || "#FFD700";
    const alpha = isConnected ? "66" : "11"; // Connected = more opaque

    // Override gradient background inline
    userIdDisplay.style.background = `linear-gradient(90deg,#232526 0%, ${hex}${alpha} 100%)`;

	    // Simple connection indicators
    userIdDisplay.style.border = isConnected ? `2px solid ${hex}` : "1px solid #444";
    userIdDisplay.style.boxShadow = isConnected ? `0 0 15px ${hex}88` : "none";
  }
}

// Run once and then every minute (or every second for animation)
setAuraColor();
setInterval(setAuraColor, 1000);


// Enhanced offline detection
function updateOnlineStatus() {
  const status = document.getElementById('online-status');
  
  // Check both browser online status AND actual network connectivity
  if (!navigator.onLine || !isActuallyOnline()) {
    status.style.display = 'block';
    console.log('Offline mode activated');
  } else {
    status.style.display = 'none';
  }
}

// Check real network connectivity
function isActuallyOnline() {
  // If browser says we're offline, trust it
  if (!navigator.onLine) return false;
  
  // For desktop, we'll assume online unless proven otherwise
  // You could add a fetch test here for more accuracy
  return true;
}

// Create status element
const statusElement = document.createElement('div');
statusElement.id = 'online-status';
statusElement.innerHTML = `
  <img src="/assets/spaceship.svg" width="16" height="16" />
    <div class="thruster-flame left"></div>
    <div class="thruster-flame right"></div>
`;
statusElement.style.cssText = `
  position: fixed;
  top: 23px;
  left: 6px;
  border-radius: 50%;
  z-index: 10000;
  display: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  cursor: help;
  width: 24px;
  height: 30px;
  background: transparent;
`;
statusElement.title = 'Offline Mode - App working locally';
document.body.appendChild(statusElement);


// Listen for online/offline events
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Also check periodically (for desktop)
setInterval(updateOnlineStatus, 10000); // Check every 10 seconds

// Initial check
updateOnlineStatus();


// Service Worker Status Indicator
class SWStatusIndicator {
  constructor() {
    this.indicator = this.createIndicator();
    this.showInstalling = true;
    this.init();
  }

  createIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'sw-status-indicator';
    indicator.innerHTML = `
      <style>
        #sw-status-indicator {
          position: fixed;
          top: 10px;
          right: 10px;
          width: 12px;
          height: 12px;
          background: #ffeb3b;
          border-radius: 50%;
          box-shadow: 0 0 10px #ffeb3b;
          z-index: 10000;
          animation: blink 1s infinite;
          display: none;
        }
        @keyframes blink {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.3; }
        }
      </style>
    `;
    document.body.appendChild(indicator);
    return indicator;
  }

  show() {
    if (this.showInstalling) {
      this.indicator.style.display = 'block';
    }
  }

  hide() {
    this.indicator.style.display = 'none';
  }

  init() {
    if ('serviceWorker' in navigator) {
      // Show when installing/updating
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SW_INSTALLING') {
          this.show();
        }
        if (event.data && event.data.type === 'SW_READY') {
          setTimeout(() => this.hide(), 1000); // Hide after 1 sec
        }
      });

      // Also show when page loads if SW is installing
      navigator.serviceWorker.ready.then(() => {
        setTimeout(() => this.hide(), 500);
      });
    }
  }
}

// Initialize the indicator
const swIndicator = new SWStatusIndicator();

// Show indicator immediately when page loads (optional)
swIndicator.show();
setTimeout(() => swIndicator.hide(), 22000); // Hide after 22 seconds if no SW activity


// 7 Chakra sound files and icons (bottom to top)
const chakraSounds = [
  { sound: '/assets/root_lam_396hz.mp3',   icon: 'üî¥', name: '' },
  { sound: '/assets/sacral_vam_417hz.mp3', icon: 'üü†', name: '' },
  { sound: '/assets/solar_ram_528hz.mp3',  icon: 'üü°', name: '' },
  { sound: '/assets/heart_yam_639hz.mp3',  icon: 'üü¢', name: '' },
  { sound: '/assets/throat_ham_741hz.mp3', icon: 'üîµ', name: '' },
  { sound: '/assets/thirdeye_om_852hz.mp3',  icon: 'üü£', name: '' },
  { sound: '/assets/crown_aum_963hz.mp3',  icon: '‚ö™', name: '' }
];

let lastSessionTap = 0;

document.addEventListener('touchend', function(e) {
  // Only run this if sessionActive is true and timer-section is visible
  if (!(typeof sessionActive !== "undefined" && sessionActive)) return;
  const timerSection = document.getElementById('timer-section');
  if (!timerSection || timerSection.classList.contains('hidden')) return;

  // Ignore if tap is on avatar, logo, or UI buttons
  const avatarEl = document.querySelector('.avatar-container');
  if (avatarEl && avatarEl.contains(e.target)) return;
  const logoEl = document.getElementById('logo-sacred');
  if (logoEl && logoEl.contains(e.target)) return;

  // Double-tap logic
  const currentTime = new Date().getTime();
  const tapLength = currentTime - lastSessionTap;

  if (tapLength < 250 && tapLength > 0) {
    e.preventDefault();

// Determine which vertical zone was tapped (7 zones, bottom to top)
const y = e.changedTouches[0].clientY;
const screenHeight = window.innerHeight;
const zoneHeight = screenHeight / 7;
const zone = 6 - Math.floor(y / zoneHeight); // Now 0 is bottom, 6 is top

    // Play chakra sound
    playChakraSound(zone);

    // Show chakra icon and name
    showChakraIcon(e.changedTouches[0].clientX, y, zone);
  }
  lastSessionTap = currentTime;
});

// Play the appropriate chakra sound
function playChakraSound(zone) {
  if (chakraSounds[zone]) {
    audioManager.playSound(chakraSounds[zone].sound, 0.9);
  }
}

// Show chakra icon and name
function showChakraIcon(x, y, zone) {
  if (!chakraSounds[zone]) return;
  const iconDiv = document.createElement('div');
  iconDiv.textContent = chakraSounds[zone].icon + ' ' + chakraSounds[zone].name;
  iconDiv.style.cssText = `
    position: fixed;
    left: ${x}px;
    top: ${y-40}px;
    transform: translate(-50%, 0);
    font-size: 1.1em;
    background: #222;
    color: #fde68a;
    border-radius: 24px;
    padding: 6px 18px;
    z-index: 9999;
    box-shadow: 0 0 24px #fde68a55;
    text-shadow: 0 0 14px #fde68a;
    border: 2px solid #fde68a;
    pointer-events: none;
    opacity: 0;
    animation: dtMusicFloat 1s forwards;
    font-weight: 600;
  `;
  document.body.appendChild(iconDiv);
  setTimeout(() => {
    if (iconDiv.parentNode) iconDiv.parentNode.removeChild(iconDiv);
  }, 1000);
}


// Called when the wisdom is revealed
async function renderWisdom(wisdomId) {
  // ...existing wisdom display logic...
  await updateWisdomLikeUI(wisdomId);
}

// Fetch like count and status for this wisdom
async function updateWisdomLikeUI(wisdomId) {
  // Fetch from backend: {count, liked (true/false)}
  const resp = await fetch(`https://trueyogi-backend-knkq.onrender.com/api/wisdom-likes?wisdomId=${wisdomId}&wallet=${window.walletPublicKey || ''}`);
  const {count, liked} = await resp.json();

  document.getElementById('wisdom-like-count').textContent = count;
  const icon = document.getElementById('wisdom-like-icon');
  if (liked) {
    icon.classList.remove('fa-regular');
    icon.classList.add('fa-solid', 'text-pink-500');
  } else {
    icon.classList.remove('fa-solid', 'text-pink-500');
    icon.classList.add('fa-regular');
  }
}

// Called when user clicks the heart
async function toggleWisdomLike() {
  if (!window.walletPublicKey) {
    showWisdomWalletRequiredModal();
    return;
  }

  const wisdomId = getCurrentWisdomId();
  const icon = document.getElementById('wisdom-like-icon');
  const liked = icon.classList.contains('fa-solid');
  const method = liked ? 'DELETE' : 'POST';

  // ADD THIS: Vibration
  if (navigator.vibrate) navigator.vibrate(50);
  
  // ADD THIS: Heart animation
  icon.style.transform = 'scale(1.3)';
  setTimeout(() => { icon.style.transform = 'scale(1)'; }, 200);

  await fetch('https://trueyogi-backend-knkq.onrender.com/api/wisdom-likes', {
    method,
    headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')},
    body: JSON.stringify({wisdomId})
  });
  await updateWisdomLikeUI(wisdomId);
}

document.addEventListener('DOMContentLoaded', () => {
  const omMuteToggle = document.getElementById('om-mute-toggle');
  const omAudio = document.getElementById('om-sound');
  let omIsMuted = localStorage.getItem('omIsMuted') === 'true';

  // Set initial mute state
  if (omAudio) omAudio.muted = omIsMuted;

  if (omMuteToggle) {
    omMuteToggle.addEventListener('click', (e) => {
      // Only allow if user is present in OM (i.e. has omPresenceId)
      const omPresenceId = localStorage.getItem('omPresenceId');
      if (!omPresenceId) return;

      omIsMuted = !omIsMuted;
      if (omAudio) omAudio.muted = omIsMuted;
      localStorage.setItem('omIsMuted', omIsMuted);
      // No icon or visual update needed
    });
  }
});


	// Select all loader backgrounds (videos or images)
const loaderMedia = document.querySelectorAll('.cosmic-bg');
const HOUR_IN_MS = 3600000; // 1 hour

function switchLoaderMedia() {
    loaderMedia.forEach((el) => {
        el.classList.remove('active');
        if (el.tagName === 'VIDEO') {
            el.pause();
            el.currentTime = 0;
            el.preload = "none";
        }
    });

    // Pick a random media element
    const randomIndex = Math.floor(Math.random() * loaderMedia.length);
    const selected = loaderMedia[randomIndex];
    selected.classList.add('active');

    if (selected.tagName === 'VIDEO') {
        selected.preload = "auto";
        selected.play().catch(() => {});
    }

    localStorage.setItem('lastImageSwitch', Date.now());
    localStorage.setItem('currentImageIndex', randomIndex);
}

function initializeLoaderMedia() {
    const lastSwitch = localStorage.getItem('lastImageSwitch');
    const savedIndex = localStorage.getItem('currentImageIndex');
    const now = Date.now();

    if (!lastSwitch || (now - lastSwitch) >= HOUR_IN_MS) {
        switchLoaderMedia();
    } else {
        loaderMedia.forEach((el) => {
            el.classList.remove('active');
            if (el.tagName === 'VIDEO') {
                el.pause();
                el.currentTime = 0;
                el.preload = "none";
            }
        });
let index = savedIndex ? parseInt(savedIndex, 10) : 0;
if (isNaN(index) || index < 0 || index >= loaderMedia.length) index = 0;
const selected = loaderMedia[index];
if (selected) {
    selected.classList.add('active');
    if (selected.tagName === 'VIDEO') {
        selected.preload = "auto";
        selected.play().catch(() => {});
    }
}
    }
}

// Initialize on page load
initializeLoaderMedia();

// Check every minute if it's time to switch
setInterval(initializeLoaderMedia, 60000);


// Moon icon music functionality
document.addEventListener('DOMContentLoaded', function() {
  const moonIcon = document.querySelector('.moon-icon');
  const moonSound = document.getElementById('moon-sound'); // Add this audio element to your HTML
  let moonPlaying = false;

  if (moonIcon && moonSound) {
    // Play only once
    moonSound.loop = false;

    // Reset state when sound ends naturally
    moonSound.addEventListener('ended', () => {
      moonPlaying = false;
      moonIcon.style.textShadow = 'none';
      moonSound.currentTime = 0;
    });

    moonIcon.addEventListener('click', function(e) {
      // Get moon icon position and click coordinates
      const rect = moonIcon.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const clickX = e.clientX;
      const clickY = e.clientY;
      const dist = Math.sqrt(Math.pow(centerX - clickX, 2) + Math.pow(centerY - clickY, 2));
      
      // Set moon radius - adjust this value as needed
      const moonRadius = Math.min(rect.width, rect.height) / 1.5;
      
      // Only toggle sound if click is within the moon radius
      if (dist < moonRadius) {
        if (!moonPlaying) {
          // Start playing moon sound once
          moonSound.muted = false;
          moonSound.currentTime = 0;
          moonSound.volume = 0.4;
          moonSound.play().catch(()=>{});
          moonPlaying = true;
          moonIcon.style.textShadow = "0 0 15px rgba(255, 255, 100, 0.8)";
        } else {
          // Stop playing early (if user taps to stop)
          moonSound.pause();
          moonSound.currentTime = 0;
          moonPlaying = false;
          moonIcon.style.textShadow = "none";
        }
      }
    });
  }
});


function canShowSwipeEffect(e) {
  if (!(typeof sessionActive !== "undefined" && sessionActive)) return false;
  const timerSection = document.getElementById('timer-section');
  if (!timerSection || timerSection.classList.contains('hidden')) return false;

  // Ignore if tap is on avatar, logo, or UI buttons
  const avatarEl = document.querySelector('.avatar-container');
  if (avatarEl && e && avatarEl.contains(e.target)) return false;
  const logoEl = document.getElementById('logo-sacred');
  if (logoEl && e && logoEl.contains(e.target)) return false;

  return true;
}

class ElementalSwipe {
  constructor() {
    this.effectsContainer = document.getElementById('swipe-effects');
    this.elements = ['water', 'fire', 'air', 'earth', 'lightning'];
    this.currentElement = 0;
    this.isTouching = false;
    this.startX = 0;
    this.startY = 0;
    this.minSwipeDistance = 190; // Minimum pixels to move before activating
    this.hasActivated = false;
    
    this.init();
  }

  init() {
    // Touch events
document.addEventListener('touchstart', (e) => {
  if (!canShowSwipeEffect(e)) return;
  this.handleStart(e);
}, { passive: false });

document.addEventListener('touchmove', (e) => {
  if (!this.isTouching || !canShowSwipeEffect(e)) return;
  this.handleMove(e);
}, { passive: false });

document.addEventListener('touchend', (e) => {
  if (!this.isTouching || !canShowSwipeEffect(e)) return;
  this.handleEnd(e);
}, { passive: false });
    
    //  Cycle through elements every 20 seconds
    setInterval(() => {
      this.currentElement = (this.currentElement + 1) % this.elements.length;
    }, 20000);
  }

  handleStart(e) {
    this.isTouching = true;
    this.hasActivated = false;
    const point = this.getPoint(e);
    this.startX = point.x;
    this.startY = point.y;
    
    // Don't create effect immediately - wait for movement
  }

  handleMove(e) {
    if (!this.isTouching) return;
    
    const point = this.getPoint(e);
    const deltaX = point.x - this.startX;
    const deltaY = point.y - this.startY;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    // Only activate after minimum swipe distance
    if (!this.hasActivated && distance >= this.minSwipeDistance) {
      this.hasActivated = true;
      // Create the first/main effect at current position
      this.createSwipeEffect(point.x, point.y, true);
    }
    
    // Continue creating trail effects if activated
    if (this.hasActivated) {
      e.preventDefault();
      this.createSwipeEffect(point.x, point.y, false);
    }
  }

  handleEnd() {
    this.isTouching = false;
    this.hasActivated = false;
  }

  getPoint(e) {
    if (e.touches) {
      return {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY
      };
    } else {
      return {
        x: e.clientX,
        y: e.clientY
      };
    }
  }

  createSwipeEffect(x, y, isMain) {
    const elementType = this.elements[this.currentElement];
    const effect = document.createElement('div');
    
    effect.className = `element-swipe swipe-${elementType} ${isMain ? '' : 'swipe-trail'}`;
    effect.style.left = x + 'px';
    effect.style.top = y + 'px';
    
    // Randomize size slightly for natural look
    if (!isMain) {
      const size = 18 + Math.random() * 18;
      effect.style.width = size + 'px';
      effect.style.height = size + 'px';
    }
    
    this.effectsContainer.appendChild(effect);
    
    // Remove element after animation
    setTimeout(() => {
      if (effect.parentNode) {
        effect.parentNode.removeChild(effect);
      }
    }, 2000);
  }
}

// Initialize the swipe effects
new ElementalSwipe();


// ========== üåç ENHANCED WORLD GRID WITH LOCATION TAPS ==========
let earthGridOpen = false;
let gridChannel = null;
let livePresenceRows = [];

// Example: Fetch country stats on Earth Grid open
async function fetchCountryStats() {
  let { data, error } = await supabase
    .from('om_sessions')
    .select('country, countryCode, user_id, duration_seconds')
    .not('ended_at', 'is', null);

  if (error) {
    console.error(error);
    return [];
  }
  // Group by countryCode
  const countryTotals = {};
  for (const s of data) {
    if (!s.countryCode) continue;
    if (!countryTotals[s.countryCode]) {
      countryTotals[s.countryCode] = {
        country: s.country,
        users: new Set(),
        totalSeconds: 0
      };
    }
    // Add user_id to set for counting souls
    if (s.user_id) countryTotals[s.countryCode].users.add(s.user_id);
    countryTotals[s.countryCode].totalSeconds += (s.duration_seconds || 0);
  }
  // Build the array with souls and total_seconds fields
  return Object.entries(countryTotals)
    .map(([countryCode, val]) => ({
      countryCode,
      country: val.country,
      souls: val.users.size,
      total_seconds: val.totalSeconds
    }))
    .sort((a, b) => b.total_seconds - a.total_seconds);
}

function formatDuration(seconds) {
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  if (hrs > 0) return `${hrs} hr${hrs > 1 ? 's' : ''} ${mins} min${mins !== 1 ? 's' : ''}`;
  return `${mins} min${mins !== 1 ? 's' : ''}`;
}

function formatDurationGrid(seconds) {
  const days = Math.floor(seconds / 86400);
  const hrs  = Math.floor((seconds % 86400) / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;

  if (days > 0) return `${days}d ${hrs}hr ${mins}min ${secs}s`;
  if (hrs > 0) return `${hrs}hr ${mins}min ${secs}s`;
  if (mins > 0) return `${mins}min ${secs}s`;
  return `${secs}s`;
}

async function showCountryStatsOnEarthGrid() {
  const stats = await fetchCountryStats();
  const statsLabel = document.getElementById('gridStatsLabel');
  if (!statsLabel) return;
  if (stats.length === 0) {
    statsLabel.innerHTML = "No Power Node hours recorded yet.";
    return;
  }

  const content = stats.map(stat => {
    const code = stat.countryCode ? stat.countryCode.toLowerCase() : "un";
    return `
      <span class="scroll-flag" data-country="${stat.country}" style="display:inline-flex;align-items:center;margin:0 15px;">
       <img src="https://flagcdn.com/w40/${code}.png"
           style="width:34px;height:24px;border-radius:3px;box-shadow:0 0 2px #000;">
        <span style="font-weight:bold;font-size:0.9em;padding-left:6px;">
          ${stat.souls} ${stat.souls === 1 ? 'Soul' : 'Souls'} ¬∑ ${formatDurationGrid(stat.total_seconds)}
        </span>
      </span>
    `;
  }).join('');

  statsLabel.innerHTML = `<div style="display:inline-block;animation: scrollTicker 30s linear infinite;">${content}</div>`;

  // Attach popup handlers for desktop and mobile **AFTER** innerHTML set
statsLabel.querySelectorAll('.scroll-flag').forEach(el => {
  el.onclick = function(e) {
    showFlagPopup(el.getAttribute('data-country'), e, true);
  };
  el.ontouchstart = function(e) {
    showFlagPopup(el.getAttribute('data-country'), e, true);
  };
});

  // Add CSS for scrolling animation (only once)
  if (!document.getElementById('country-scroll-ticker-style')) {
    const style = document.createElement('style');
    style.id = 'country-scroll-ticker-style';
    style.textContent = `
      @keyframes scrollTicker {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
    `;
    document.head.appendChild(style);
  }
}

// Always fetch latest data when grid opens
async function fetchPresenceRowsAndRender() {
  // Adjust field names based on your om_presence schema!
  const { data, error } = await supabase.from('om_presence').select('*');
  if (!error) {
    livePresenceRows = data;
    if (earthGridOpen) renderEarthGrid();
  }
}

function showEarthGrid() {
  earthGridOpen = true;
  fetchPresenceRowsAndRender(); // Always get fresh data

  // If already subscribed, don't re-subscribe
  if (!gridChannel) {
    gridChannel = supabase
      .channel('earthgrid-realtime')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'om_presence' },
        payload => {
          // On any change, refresh data and re-render if open
          fetchPresenceRowsAndRender();
        }
      )
      .subscribe();
  }
}

async function fetchUserCountryStats() {
  const userId = localStorage.getItem('omUserId');
  if (!userId) return [];
  let { data, error } = await supabase
    .from('om_sessions')
    .select('country, countryCode, duration_seconds')
    .eq('user_id', userId)
    .not('ended_at', 'is', null);

  if (error) {
    console.error(error);
    return [];
  }
  // Group by countryCode
  const countryTotals = {};
  for (const s of data) {
    if (!s.countryCode) continue;
    if (!countryTotals[s.countryCode]) {
      countryTotals[s.countryCode] = {
        country: s.country,
        totalSeconds: 0
      };
    }
    countryTotals[s.countryCode].totalSeconds += (s.duration_seconds || 0);
  }
  return Object.entries(countryTotals)
    .map(([countryCode, val]) => ({
      countryCode,
      country: val.country,
      total_seconds: val.totalSeconds
    }))
    .sort((a, b) => b.total_seconds - a.total_seconds);
}

async function getUserCountryInfo() {
  try {
    // Fast, free, no API key needed
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    return {
      country: data.country_name,
      countryCode: data.country_code
    };
  } catch {
    return { country: "Unknown", countryCode: "un" };
  }
}

async function showUserTravelBar() {
  const stats = await fetchUserCountryStats();
  let bar = document.getElementById('userTravelBar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id = 'userTravelBar';
    bar.style.cssText = `
      position: absolute;
      bottom: 16%;
      left: 50%;
      transform: translateX(-50%);
      min-width: 120px;
      max-width: 95vw;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      color: #ffe;
      border-radius: 18px;
      text-shadow: 0 0 6px #ffd70099;
      z-index: 10001;
      white-space: nowrap;
      overflow: hidden;
      display: block;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
    `;
    document.getElementById('earthGridContainer').appendChild(bar);
  }

if (stats.length === 0) {
  // Get user's country info
  const userInfo = await getUserCountryInfo();
  const code = userInfo.countryCode ? userInfo.countryCode.toLowerCase() : "un";
  bar.innerHTML = `
    <span class="user-scroll-flag" data-country="${userInfo.country}" style="display:inline-flex;align-items:center;margin:0 14px;">
      <img src="https://flagcdn.com/w40/${code}.png"
           style="width:34px;height:24px;border-radius:3px;box-shadow:0 0 2px #000;">
      <span style="font-weight:bold;font-size:1em;padding-left:7px;">
        0 min
      </span>
    </span>
  `;

  // Optional: attach popup for country name (if you want)
bar.querySelectorAll('.user-scroll-flag').forEach(el => {
  el.onclick = function(e) {
    showFlagPopup(el.getAttribute('data-country'), e, false);
  };
  el.ontouchstart = function(e) {
    showFlagPopup(el.getAttribute('data-country'), e, false);
  };
});

  return;
}

  // Add keyframes for scrolling animation (only once)
  if (!document.getElementById('user-scroll-ticker-style')) {
    const style = document.createElement('style');
    style.id = 'user-scroll-ticker-style';
    style.textContent = `
      @keyframes userScrollTicker {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
      }
    `;
    document.head.appendChild(style);
  }

  let content = stats.map(stat => {
    const code = stat.countryCode ? stat.countryCode.toLowerCase() : "un";
    return `
      <span class="user-scroll-flag" data-country="${stat.country}" style="display:inline-flex;align-items:center;margin:0 14px;">
        <img src="https://flagcdn.com/w40/${code}.png"
             style="width:34px;height:24px;border-radius:3px;box-shadow:0 0 2px #000;">
        <span style="font-weight:bold;font-size:1em;padding-left:7px;">
          ${formatDurationGrid(stat.total_seconds)}
        </span>
      </span>
    `;
  }).join('');

  bar.innerHTML = `
    <div id="userTravelScroll" style="display:inline-block;animation: userScrollTicker 50s linear infinite;">
      ${content}
    </div>
  `;

  // Attach popup handlers for desktop and mobile
  const scrollDiv = bar.querySelector('#userTravelScroll');
  if (scrollDiv) {
    scrollDiv.querySelectorAll('.user-scroll-flag').forEach(el => {
      el.onclick = function(e) {
        showFlagPopup(el.getAttribute('data-country'), e);
      };
      el.ontouchstart = function(e) {
        showFlagPopup(el.getAttribute('data-country'), e);
      };
    });
  }
}

function showFlagPopup(country, event, allowUserList = false) {
  // Remove any existing popup
  const old = document.getElementById('flag-popup');
  if (old) old.remove();

  // Get event position
  let x = window.innerWidth / 2, y = 80;
  if (event && event.touches && event.touches.length > 0) {
    x = event.touches[0].clientX;
    y = event.touches[0].clientY;
  } else if (event && event.clientX !== undefined) {
    x = event.clientX;
    y = event.clientY;
  }

  // Create popup
  const popup = document.createElement('div');
  popup.id = 'flag-popup';
  popup.textContent = country;
  popup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y - 36}px;
    transform: translate(-50%, -100%);
    background: rgba(0,0,0,0.85);
    color: #fde68a;
    font-size: 0.95rem;
    font-family: 'Poppins', sans-serif;
    padding: 8px 22px;
    border-radius: 18px;
    z-index: 10003;
    box-shadow: 0 0 12px #fde68acc;
    pointer-events: auto; // Make sure it's clickable
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.16s;
  `;
  document.body.appendChild(popup);
  setTimeout(() => popup.style.opacity = 1, 10);

popup.style.pointerEvents = 'auto'; // Make sure popup can be clicked


  // --- ADD: Tap/click handler to show user list popup ---
  if (allowUserList) {
    popup.onclick = function(ev) {
      showCountryUserListPopup(country, x, y);
    };
    popup.ontouchstart = function(ev) {
      showCountryUserListPopup(country, x, y);
    };
  }

  // Remove after 6s (instead of 1.7s)
  setTimeout(() => {
    popup.style.opacity = 0;
    setTimeout(() => popup.remove(), 350);
  }, 6000);
}

async function showCountryUserListPopup(country, x, y) {
  // Remove any old user list popup
  const oldList = document.getElementById('country-user-list-popup');
  if (oldList) oldList.remove();

  // Fetch all sessions for the country
  let { data, error } = await supabase
    .from('om_sessions')
    .select('user_id, country, duration_seconds')
    .eq('country', country);

  if (error || !data) {
    // fallback: show error
    const listPopup = document.createElement('div');
    listPopup.id = 'country-user-list-popup';
    listPopup.innerHTML = "<i>Could not load user data.</i>";
    document.body.appendChild(listPopup);
    setTimeout(() => { listPopup.remove(); }, 9000);
    return;
  }

  // Group and sum durations by user
  const userDurations = {};
  data.forEach(row => {
    if (!row.user_id) return;
    userDurations[row.user_id] = (userDurations[row.user_id] || 0) + (row.duration_seconds || 0);
  });

  // Prepare popup
  const listPopup = document.createElement('div');
  listPopup.id = 'country-user-list-popup';
  listPopup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y + 32}px;
    transform: translate(-50%, 0);
    background: rgba(0,0,0,0.97);
    color: #fde68a;
    font-size: 0.96rem;
    padding: 9px 18px;
    border-radius: 10px;
    box-shadow: 0 0 14px #fde68a66;
    z-index: 10004;
    min-width: 160px;
    max-height: 320px;
    overflow-y: auto;
    text-align: left;
	  /* Scrollbar styling */
  scrollbar-width: thin;
  scrollbar-color: #fde68a #000000;
  `;
  
const userIds = Object.keys(userDurations).sort((a, b) => userDurations[b] - userDurations[a]);
const currentUserId = localStorage.getItem('omUserId');

if (userIds.length === 0) {
  listPopup.innerHTML = "<i>No users found for this country.</i>";
} else {
  const liveIds = new Set(livePresenceRows.map(row => row.user_id));
  const liveSvg = `<svg width="16" height="16" style="vertical-align:middle;">
    <circle cx="8" cy="8" r="6" fill="#29D884" stroke="#fff" stroke-width="1"/>
  </svg>`;
  const blankSvg = `<svg width="16" height="16" style="vertical-align:middle;">
    <circle cx="8" cy="8" r="6" fill="transparent" stroke="transparent" stroke-width="1"/>
  </svg>`;

  listPopup.innerHTML = `
    <div style="border-bottom:1px solid #fde68a;padding-bottom:6px;margin-bottom:6px;text-align:center;">
      <strong>${country.replace(/_/g, ' ')}</strong>
    </div>
    ${userIds.map((id, index) => {
      const isCurrentUser = id === currentUserId;
      const isLive = liveIds.has(id);
      return `
        <div style="border-bottom:1px solid #333;padding:4px 0;display:flex;align-items:center;gap:0;${isCurrentUser ? 'background:#ffd70022;font-weight:bold;' : ''}">
          <span style="color:#888;font-size:0.8rem;min-width:18px;">${index + 1}</span>
          <span style="margin:0 2px;display:inline-block;vertical-align:middle;">
            ${isLive ? liveSvg : blankSvg}
          </span>
          <span style="font-family:monospace; color:${isCurrentUser ? '#fff' : '#ffd700'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 8px #fff;' : ''}">
            ${getShortUserId(id)}
          </span>
          <img src="assets/clock.svg" style="width:16px; height:16px; vertical-align:middle; margin:0 2px;">
          <span style="color:${isCurrentUser ? '#fff' : '#ffd700'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 6px #fff;' : ''}">
            ${formatDurationGrid(userDurations[id])}
          </span>
        </div>
      `;
    }).join('')}
  `;
}

  document.body.appendChild(listPopup);
  setTimeout(() => { listPopup.remove(); }, 12000);
}

function getShortUserId(id) {
  if (!id || id.length < 6) return id || '';
  return id.slice(0,3) + '...' + id.slice(-3);
}

function formatFlameDuration(seconds) {
  const days = Math.floor(seconds / 86400);
  const hrs  = Math.floor((seconds % 86400) / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  if (days > 0) return `${days}d ${hrs}hr ${mins}min ${secs}s`;
  if (hrs > 0) return `${hrs}hr ${mins}min ${secs}s`;
  if (mins > 0) return `${mins}min ${secs}s`;
  return `${secs}s`;
}

let flameTimerInterval = null;
let heartbeatOn = false; // outside, top scope
let lastStarterUserId = null;
let lastFlameStarted = null;

async function startFlameTimer() {
  const timerEl = document.getElementById('om-flame-timer');
  if (flameTimerInterval) clearInterval(flameTimerInterval);

  try {
    const res = await fetch('https://trueyogi-backend-knkq.onrender.com/om-flame');
    const data = await res.json();
    if (data.burning && data.started_at) {
      let started = new Date(data.started_at);
	  lastStarterUserId = data.starter_user_id || '';
	  lastFlameStarted = new Date(data.started_at);
      function updateFlame() {
        const flameTimeEl = document.getElementById('om-flame-time');
        const now = new Date();
        const elapsed = Math.floor((now - started) / 1000);
        flameTimeEl.textContent = formatFlameDuration(elapsed);

        heartbeatOn = !heartbeatOn;
        flameTimeEl.style.opacity = heartbeatOn ? "1" : "0.5";
      }
      // Initial run and then interval
      updateFlame();
      flameTimerInterval = setInterval(updateFlame, 1000);
    } else {
      timerEl.textContent = "The OM Flame awaits its next keeper...";
    }
  } catch (err) {
    timerEl.textContent = "Unable to connect to OM Flame.";
  }
}

let canStartCall = false;

async function fetchCallPermission() {
  const response = await fetch('https://trueyogi-backend-knkq.onrender.com/api/permissions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ userId: localStorage.getItem('omUserId') })
  });
  const data = await response.json();
  canStartCall = data.canStartCall;
}

async function fetchUserWithHighestDuration() {
  let { data, error } = await supabase
    .from('om_sessions')
    .select('user_id, duration_seconds')
    .not('ended_at', 'is', null);

  if (error) {
    console.error(error);
    return null;
  }

  // Aggregate total duration for each user
  const userTotals = {};
  for (const s of data) {
    if (!s.user_id) continue;
    userTotals[s.user_id] = (userTotals[s.user_id] || 0) + (s.duration_seconds || 0);
  }

  // Find the user with max total duration
  let maxId = null, maxTotal = 0;
  for (const [id, total] of Object.entries(userTotals)) {
    if (total > maxTotal) {
      maxTotal = total;
      maxId = id;
    }
  }
  return maxId; // This user should be allowed the call icon
}

// --- Main renderer (called whenever data changes or grid opens) ---
function renderEarthGrid() {
  // --- Setup container, canvas, and label ---
  let container = document.getElementById('earthGridContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'earthGridContainer';
    container.style.cssText = `
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      transition: opacity 1s ease;
    `;
    document.body.appendChild(container);
  } else {
    container.style.display = 'flex';
  }

let closeBtn = document.getElementById('gridCloseBtn');
if (!closeBtn) {
  closeBtn = document.createElement('button');
  closeBtn.id = 'gridCloseBtn';
  closeBtn.innerHTML = `<img src="/assets/gridclose1.svg" alt="Close" style="width:18px;height:18px;display:block;">`;
  closeBtn.style.cssText = `
  position: absolute;
  bottom: 3%;
  right: 50%;
  width: 22px;
  height: 22px;
  font-size: 1rem;
  color: #fde68a;
  background: rgba(0,0,0,0.54);
  border-radius: 50%;
  border: 1.5px solid #fde68a33;
  box-shadow: 0 0 6px #fde68a99;
  cursor: pointer;
  z-index: 10002;
  display: flex;
  align-items: center;
  justify-content: center;
  outline: none;
  transition: background 0.2s;
`;
  closeBtn.onmouseenter = () => closeBtn.style.background = 'rgba(0,0,0,0.8)';
  closeBtn.onmouseleave = () => closeBtn.style.background = 'rgba(0,0,0,0.54)';
  closeBtn.onclick = () => closeEarthGrid();
  container.appendChild(closeBtn);
}

  let canvas = document.getElementById('earthGrid');
  if (!canvas) {
    canvas = document.createElement('canvas');
    canvas.id = 'earthGrid';
    canvas.width = 320;
    canvas.height = 320;
    canvas.style.cssText = `
      border-radius: 50%;
      background: radial-gradient(circle at center, #001a33, #000);
      box-shadow: 0 0 35px rgba(255,255,255,0.3);
      cursor: pointer;
    `;
    container.appendChild(canvas);
  }

  let label = document.getElementById('gridLabel');
  if (!label) {
    label = document.createElement('div');
    label.id = 'gridLabel';
label.style.cssText = `
  position: absolute;
  bottom: 9%;
  font-family: 'Poppins', sans-serif;
  font-size: 0.9rem;
  letter-spacing: 1px;
  color: #fde68a;
  opacity: 0.9;
  text-shadow: 0 0 8px #fde68a;
  background: radial-gradient(circle at 60% 40%, #fde68a44 0%, #23252688 80%, #000 100%);
  padding: 8px 16px;
  border-radius: 20px;
  backdrop-filter: blur(8px);
  box-shadow: 0 0 24px 4px #fde68a33, 0 0 60px 8px #fff2;
  border: 1px solid #fde68a33;
`;
    container.appendChild(label);
  }

// Create or get the top stats label
let statsLabel = document.getElementById('gridStatsLabel');
if (!statsLabel) {
  statsLabel = document.createElement('div');
  statsLabel.id = 'gridStatsLabel';
statsLabel.style.cssText = `
  position: absolute;
  top: 22%;
  left: 5%;                    // Changed from 20% to 5%
  transform: none;             // REMOVED translateX(-50%)
  font-family: 'Poppins', sans-serif;
  font-size: 1rem;
  color: #fde68a;
  /* background: rgba(0,0,0,0.35);  */
  padding: 4px 12px;
  border-radius: 18px;
  text-shadow: 0 0 4px #111;
  z-index: 10001;
  /* pointer-events: none; */
  white-space: nowrap;
  overflow: hidden;
  width: 80%;
`;
  container.appendChild(statsLabel);
}

// Create NEW heading for Global Resonance Field at top center
let globalHeading = document.getElementById('globalHeading');
if (!globalHeading) {
  globalHeading = document.createElement('div');
  globalHeading.id = 'globalHeading';
  globalHeading.style.cssText = `
    position: absolute;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Poppins', sans-serif;
    font-size: 1.1rem;
    letter-spacing: 1.5px;
    color: #fde68a;
    opacity: 0.9;
    text-shadow: 0 0 8px #fde68a;
    background: linear-gradient(90deg,#232526 0%, #fde68a44 100%);
    box-shadow: 0 0 10px 2px #fde68a22, 0 0 20px 3px #fff1;
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #fde68a33;
    backdrop-filter: blur(5px);
    white-space: nowrap;
    z-index: 10001;
    width: max-content;
    box-sizing: border-box;
    min-width: 0;
    margin-left: 8px;
    margin-right: 8px;
    max-width: calc(100vw - 16px); /* prevents overflow on tiny screens */
    overflow: hidden;
  `;
  globalHeading.innerHTML = `
    <span style="vertical-align:middle;display:inline-block;margin-right:7px;">
      <img src="assets/global.svg" style="width:24px;height:24px;vertical-align:middle;">
    </span>
    Global Resonance Field
  `;
  container.appendChild(globalHeading);
}

// --- OM Flame Timer below Global Heading / with fire SVG ---
let flameTimer = document.getElementById('om-flame-timer');
if (!flameTimer) {
  flameTimer = document.createElement('div');
  flameTimer.id = 'om-flame-timer';
  flameTimer.style.cssText = `
  position: absolute;
  bottom: 33%;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.32rem;
  font-weight: bold;
  z-index: 10001;
  padding: 3px 0;
  background: rgba(0,0,0,0.13);  /* transparent dark for glow */
  backdrop-filter: blur(2px);    /* smooth out ‚Äúpatchy‚Äù glow */
  pointer-events: auto;
  text-align: center;
  white-space: nowrap;
  cursor: pointer;
  border-radius: 10px;           /* optional: rounds timer bar edges */
  box-sizing: border-box;        /* ensures no overflow on zoom */
`;
  flameTimer.innerHTML = `<span id="om-flame-time" class="om-flame-fire">--</span>`;
  container.appendChild(flameTimer);
}

flameTimer.onclick = async function(e) {
  const oldTooltip = document.getElementById('flame-tooltip');
  if (oldTooltip) oldTooltip.remove();

  const flameTimeEl = document.getElementById('om-flame-time');
  const rect = flameTimeEl.getBoundingClientRect();
  let starterUserShortId = lastStarterUserId ? `${getShortUserId(lastStarterUserId)}` : 'Unknown';

  // 1. Fetch the longest completed flame
  let longestFlame = null;
  let maxDuration = 0; // in ms
  try {
    const { data: flames, error } = await supabase
      .from("om_flame")
      .select("starter_user_id, started_at, ended_at")
      .eq("active", false)
      .not("ended_at", "is", null);

    if (flames && flames.length) {
      flames.forEach(f => {
        if (f.started_at && f.ended_at) {
          const dur = new Date(f.ended_at) - new Date(f.started_at);
          if (dur > maxDuration) {
            maxDuration = dur;
            longestFlame = f;
          }
        }
      });
    }
  } catch (err) {
    // ignore, just don't show Longest Flame if error
  }

  // 2. Get current session duration (in ms)
  // You can get this in various ways, here we use the formatted time in the counter if that's all you have:
  // It's safer to use a direct duration if you have started_at/live
  let currentFlameDuration = 0;
  try {
    // If you track lastFlameStarted:
    if (lastFlameStarted) {
      currentFlameDuration = Date.now() - new Date(lastFlameStarted);
    }
  } catch {}

  // 3. Only show "Longest Flame" if the current one is NOT beating the record.
  let showLongestLine = true;
  if (currentFlameDuration > maxDuration && maxDuration > 0) showLongestLine = false;

  // 4. Generate Longest Flame HTML only if needed
const longestFlameHTML =
  longestFlame && showLongestLine
  ? `
<div style="margin:6px 0 3px 0;font-size:0.95em;">
  <span style="color:#FFD700;text-shadow:0 0 6px #FFD700CC;font-weight:600;letter-spacing:0.4px;padding:2px 8px;">LONGEST FLAME:</span>
  <a href="#" id="longest-flame-keepers-link" style="
    color:#29D884;
    font-weight:700;
    text-decoration:underline;
    margin-left:8px;
    cursor:pointer;
    font-size:1.02em;
    text-shadow:0 0 10px #29D884AA;
    background:linear-gradient(45deg, #29D88422, #29D88411);
    padding:2px 8px;
    border-radius:4px;
    border:1px solid #29D88433;
    transition:all 0.3s ease;
  " onmouseover="this.style.textShadow='0 0 15px #29D884CC';this.style.background='linear-gradient(45deg, #29D88433, #29D88422)';"
     onmouseout="this.style.textShadow='0 0 10px #29D884AA';this.style.background='linear-gradient(45deg, #29D88422, #29D88411)';">
    ${formatFlameDuration(Math.floor(maxDuration / 1000))}
  </a>
</div>
  `
  : '';

  const tooltip = document.createElement('div');
  tooltip.id = 'flame-tooltip';
  tooltip.innerHTML = `
    <div style="font-size:1.01rem;">
      <div class="om-flame-heading-container" style="text-align:center;">
        <img src="/assets/flame1.svg"
             alt="Flame"
             style="height:1.6em; margin-bottom:-6px; filter:drop-shadow(0 0 9px #FF8800); display:block; margin-left:auto; margin-right:auto; cursor:pointer;">
        <b class="om-flame-heading-gradient">OM Flame</b>
      </div>
      <span style="color:#ffd700;">
        This flame was first lit by 
        <b style="color:#fff; text-shadow:0 0 8px #fff8;">${starterUserShortId}</b><br>
        <span>
          <span class="chakra-glow">Unified</span> for 
          <span style="color:#29D884; font-weight:600; text-shadow:0 0 8px #29D88477;">${flameTimeEl.textContent}</span>
        </span><br>  
        <a href="#" id="flame-keepers-link" style="color:#FF8800;font-size:0.97rem;font-weight:bold;display:inline-block;text-decoration:underline;margin-top:6px;cursor:pointer;">Show all keepers</a>
        ${longestFlameHTML}
	  </span>
    </div>
  `;
  tooltip.style.cssText = `
    position: fixed;
    left: ${rect.left + rect.width/2}px; 
    top: ${rect.top - 32}px;
    transform: translate(-50%, -100%);
    background: rgba(0,0,0,0.94);
    color: #ffd700;
    font-family: 'Poppins', sans-serif;
    font-size: 1.01rem;
    padding: 7px 19px;
    border-radius: 11px;
    box-shadow: 0 0 12px #ffd700bb;
    white-space: nowrap;
    z-index: 10040;
    opacity: 0;
    transition: opacity 0.16s;
    pointer-events:auto;
    text-align:center;
  `;

  document.body.appendChild(tooltip);
  setTimeout(() => tooltip.style.opacity = 1, 10);

  // Add handler for keepers link
  tooltip.querySelector('#flame-keepers-link').onclick = function(ev) {
    ev.preventDefault();
    showAllFlameKeepers(rect.left + rect.width/2, rect.top); // Show at same position
  };

// Only add handler for longestFlame link if present:
const longestFlameLink = tooltip.querySelector('#longest-flame-keepers-link');
if (longestFlameLink) {
  longestFlameLink.onclick = function(ev) {
    ev.preventDefault();
    showAllFlameKeepersForPeriod(
      longestFlame.started_at,
      longestFlame.ended_at,
      longestFlame.starter_user_id,
      rect.left + rect.width/2,
      rect.top
    );
  };
}

  setTimeout(() => {
    tooltip.style.opacity = 0;
    setTimeout(() => tooltip.remove(), 400);
  }, 30000);
};

// Add click handler for the flame SVG in the tooltip
document.addEventListener('click', function(e) {
  // Check if the clicked element is the flame SVG inside the tooltip
  if (e.target.closest('#flame-tooltip img[src*="flame1.svg"]')) {
    e.preventDefault();
    e.stopPropagation();
    
    // Remove any existing awareness tooltip
    const oldAwarenessTooltip = document.getElementById('awareness-tooltip');
    if (oldAwarenessTooltip) oldAwarenessTooltip.remove();
    
    // Get position from the clicked flame
    const flameRect = e.target.getBoundingClientRect();
    
    // Create the awareness tooltip
    const awarenessTooltip = document.createElement('div');
    awarenessTooltip.id = 'awareness-tooltip';
    awarenessTooltip.innerHTML = `
<div style="text-align: center; max-width: 220px;">
  <div style="font-size: 1.2rem; font-weight: 700; color: #FFD700; margin-bottom: 10px; text-shadow: 0 0 12px #FFD700, 0 0 20px #FFA50088; letter-spacing: 0.5px;">
    Living Fire of Awareness
  </div>
  <div style="font-size: 0.95rem; color: #ffffff; text-shadow: 0 0 10px #FFD700cc, 0 0 3px #ffffff; line-height: 1.5; font-weight: 400;">
    When at least one holds, the flame endures.
  </div>
</div>
    `;
    
    awarenessTooltip.style.cssText = `
      position: fixed;
      left: ${flameRect.left + flameRect.width/2}px;
      top: ${flameRect.top - 10}px;
      transform: translate(-50%, -100%);
      background: rgba(0, 0, 0, 0.95);
      color: white;
      font-family: 'Poppins', sans-serif;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      z-index: 10050;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: auto;
    `;
    
    document.body.appendChild(awarenessTooltip);
    
	awarenessTooltip.addEventListener('click', function(e) {
  const awAudio = document.getElementById('awareness-sound');
  if (awAudio) {
    if (awAudio.paused) {
      // If paused, play
      awAudio.currentTime = 0;
      awAudio.muted = false;
      awAudio.volume = 0.75;
      awAudio.play().catch(err => {
        console.log('Audio play failed:', err);
      });
    } else {
      // If playing, pause
      awAudio.pause();
      awAudio.currentTime = 0;
    }
  } else {
    console.log('Audio element not found!');
  }
});

    // Fade in
    setTimeout(() => awarenessTooltip.style.opacity = 1, 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      awarenessTooltip.style.opacity = 0;
      setTimeout(() => awarenessTooltip.remove(), 300);
    }, 9000);
  }
});

async function showAllFlameKeepers(x, y) {
await fetchCallPermission();
  // Remove if already open
  const oldList = document.getElementById('flame-keeper-list');
  if (oldList) oldList.remove();

  // Fetch sessions during this flame period 
  let { data, error } = await supabase
    .from('om_sessions')
    .select('user_id, country, countryCode, duration_seconds, started_at, ended_at')
    .gte('started_at', lastFlameStarted.toISOString());

  if (error || !data) {
    // fallback UI
    // ... same fallback as before ...
    return;
  }

  // Group and sum durations by user
  const userDurations = {}; // user_id => total seconds
  const userRows = {};      // user_id => store country/countryCode from any row

  data.forEach(row => {
    if (!row.user_id) return;
    let duration = 0;

    if (row.ended_at) {
      // Session ended, use provided duration or calculate
      duration = row.duration_seconds || (
        Math.floor((new Date(row.ended_at) - new Date(row.started_at)) / 1000)
      );
    } else {
      // Live session, use elapsed time from started_at to now
      duration = Math.floor((Date.now() - new Date(row.started_at)) / 1000);
    }

    userDurations[row.user_id] = (userDurations[row.user_id] || 0) + duration;

    // Store row for country/countryCode
    if (!userRows[row.user_id]) userRows[row.user_id] = row;
  });

  // Display list of users with flag, shortUserId, SUMMED duration
  const listPopup = document.createElement('div');
  listPopup.id = 'flame-keeper-list';
  listPopup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y + 32}px;
    transform: translate(-50%, 0);
    background: rgba(0,0,0,0.96);
    color: #ffd700;
    font-size: 0.98rem;
    padding: 9px 18px;
    border-radius: 11px;
    box-shadow: 0 0 14px #ffd70066;
    z-index: 10050;
    min-width: 0;
    max-width: 320px;
    width: 100%;
    max-height: 240px;
    box-sizing: border-box;
    overflow-y: auto;
    overflow-x: hidden;
    text-align: left;
    /* Scrollbar styling */
    scrollbar-width: thin;
    scrollbar-color: #fde68a #000000;
  `;

  // Add this to prevent scroll propagation
  listPopup.addEventListener('wheel', (e) => {
    e.stopPropagation();
  });

  // Add touch event prevention for mobile
  listPopup.addEventListener('touchmove', (e) => {
    e.stopPropagation();
  });

  // Sort user IDs: longest duration first
const userIds = Object.keys(userDurations).sort((a, b) => userDurations[b] - userDurations[a]);
const currentUserId = localStorage.getItem('omUserId');
const liveIds = new Set(livePresenceRows.map(row => row.user_id));
const liveSvg = `<svg width="16" height="16" style="vertical-align:middle;">
  <circle cx="8" cy="8" r="6" fill="#29D884" stroke="#fff" stroke-width="1"/>
</svg>`;
const blankSvg = `<svg width="16" height="16" style="vertical-align:middle;">
  <circle cx="8" cy="8" r="6" fill="transparent" stroke="transparent" stroke-width="1"/>
</svg>`;

// const longestDurationUserId = userIds[0]; // top flame keeper
//const longestDurationUserId = await fetchUserWithHighestDuration();

if (userIds.length === 0) {
  listPopup.innerHTML = "<i>No Flame Keepers found.</i>";
} else {
  listPopup.innerHTML = `
  <div style="border-bottom:1px solid #ffd700;padding-bottom:6px;margin-bottom:6px;text-align:center;">
    <strong>Flame Keepers</strong>
  </div>
  ${userIds.map((id, index) => {
    const isCurrentUser = id === currentUserId;
    const isLive = liveIds.has(id);
    const row = userRows[id];
    const code = row && row.countryCode ? row.countryCode.toLowerCase() : "un";

    // Only top duration keeper sees call icon for other live users
    let callIcon = '';
    if (
      canStartCall &&
      !isCurrentUser &&
      isLive
    ) {
      callIcon = `<span class="call-icon" data-userid="${id}" style="margin-left:10px;cursor:pointer;" title="Start call">‚òéÔ∏è</span>`;
    }

    return `
      <div style="border-bottom:1px solid #222;padding:5px 0;display:flex;align-items:center;gap:0;${isCurrentUser ? 'background:#ffd70022;font-weight:bold;' : ''}">
        <span style="color:#888;font-size:0.95em;min-width:18px;">${index + 1}</span>
        <span style="margin:0 1.5px;display:inline-block;vertical-align:middle;">
          ${isLive ? liveSvg : blankSvg}
        </span>
        <img src="https://flagcdn.com/w20/${code}.png" style="width:19px;height:14px;border-radius:2px;box-shadow:0 0 2px #000;">
        <span style="font-family:monospace; font-size:1em; color:${isCurrentUser ? '#fff' : '#FFD700'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 8px #fff;' : ''}">
          ${getShortUserId(id)}
        </span>
        <img src="assets/clock.svg" style="width:16px; height:16px; vertical-align:middle; margin:0 2px;">
        <span style="color:${isCurrentUser ? '#fff' : '#bbea6a'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 6px #fff;' : ''}">
          ${formatDurationGrid(userDurations[id])}
        </span>
        ${callIcon}
      </div>
    `;
  }).join('')}
  `;
}

// ADD THIS DIRECTLY AFTER listPopup.innerHTML IS ASSIGNED
Array.from(listPopup.querySelectorAll('.call-icon')).forEach(el => {
  el.onclick = function(e) {
    e.stopPropagation();
    const currentUserId = localStorage.getItem('omUserId'); // Top keeper (host)
    const targetUserId = this.getAttribute('data-userid');  // Invited user
    const targetUserName = this.getAttribute('data-username'); // optional, if you have from HTML
	const shortId = getShortUserId(targetUserId);

    // Show custom confirmation dialog
    showCallConfirm(shortId, targetUserName, async (result) => {
      if (!result) return; // Cancelled

      // Request a new Whereby room from your backend server
      let resp;
      try {
        resp = await fetch('https://trueyogi-backend-knkq.onrender.com/create-whereby-room', {
          method: 'POST', credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            hostUserId: currentUserId,
            targetUserId: targetUserId
          })
        });
      } catch (err) {
        alert('Network error or backend is down.');
        return;
      }

      if (!resp.ok) {
        // Show error to user, log for debug
        const text = await resp.text();
        alert('Failed to create call: ' + text);
        return;
      }

      let data;
      try {
        data = await resp.json();
      } catch (err) {
        alert('Backend did not return valid JSON.');
        return;
      }

      if (!data.hostUrl) {
        alert('Backend did not provide host link.');
        return;
      }
      showWherebyHostDialog(data.hostUrl, data.callId);
    });
  };
});

  document.body.appendChild(listPopup);
  setTimeout(() => listPopup.remove(), 12000);
}

async function showAllFlameKeepersForPeriod(flameStartedAt, flameEndedAt, starterUserId, x, y) {
  // Remove any previous keeper popup
  const oldList = document.getElementById('flame-keeper-list');
  if (oldList) oldList.remove();

  // Query sessions for all users in completed flame's duration
  let { data, error } = await supabase
    .from('om_sessions')
    .select('user_id, country, countryCode, duration_seconds, started_at, ended_at')
    .gte('started_at', new Date(flameStartedAt).toISOString())
    .lte('ended_at', new Date(flameEndedAt).toISOString());

  // Fallback UI
  if (error || !data || data.length === 0) {
    const fallbackPopup = document.createElement('div');
    fallbackPopup.id = 'flame-keeper-list';
    fallbackPopup.style.cssText = `
      position: fixed;
      left: ${x}px; top: ${y + 32}px;
      transform: translate(-50%, 0);
      background: rgba(0,0,0,0.95);
      color: #ffd700;
      font-size: 1.01rem;
      padding: 11px 20px;
      border-radius: 10px;
      box-shadow: 0 0 12px #FFD70088;
      z-index: 10051;
      min-width: 160px;
      max-width: 340px;
      width: 100%;
      text-align: center;
    `;
    fallbackPopup.innerHTML = `<i>No Flame Keepers found for this flame.</i>`;
    document.body.appendChild(fallbackPopup);
    setTimeout(() => fallbackPopup.remove(), 9000);
    return;
  }

  // Durations per user & starter
  const userDurations = {};
  const userRows = {};

  data.forEach(row => {
    if (!row.user_id) return;
    let duration = row.ended_at
      ? row.duration_seconds || Math.floor((new Date(row.ended_at) - new Date(row.started_at)) / 1000)
      : Math.floor((Date.now() - new Date(row.started_at)) / 1000);
    userDurations[row.user_id] = (userDurations[row.user_id] || 0) + duration;
    if (!userRows[row.user_id]) userRows[row.user_id] = row;
  });

  // Sort all userIds by duration (excluding the starter from normal list)
  const keeperUserIds = Object
    .keys(userDurations)
    .filter(id => id !== starterUserId)
    .sort((a, b) => userDurations[b] - userDurations[a]);

  const currentUserId = localStorage.getItem('omUserId');

  // Build popup HTML
  const listPopup = document.createElement('div');
  listPopup.id = 'flame-keeper-list';
  listPopup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y + 32}px;
    transform: translate(-50%, 0);
    background: rgba(0,0,0,0.96);
    color: #ffd700;
    font-size: 0.98rem;
    padding: 9px 18px;
    border-radius: 11px;
    box-shadow: 0 0 14px #ffd700aa;
    z-index: 10050;
    min-width: 0;
    max-width: 320px;
    width: 100%;
    max-height: 240px;
    box-sizing: border-box;
    overflow-y: auto;
    overflow-x: hidden;
    text-align: left;
    scrollbar-width: thin;
    scrollbar-color: #fde68a #000000;
  `;
  listPopup.addEventListener('wheel', (e) => { e.stopPropagation(); });
  listPopup.addEventListener('touchmove', (e) => { e.stopPropagation(); });

  let keeperHtml = `
    <div style="border-bottom:1px solid #ffd700;padding-bottom:6px;margin-bottom:6px;text-align:center;">
      <strong>Flame Keepers</strong>
      <div style="font-size:0.89em;color:#bbb;margin-top:2px;">
        (${keeperUserIds.length + 1} Soul${keeperUserIds.length ? 's' : ''} Unified)
      </div>
    </div>
  `;

  // Show starter as the first keeper ‚òÖ
  if (starterUserId && userRows[starterUserId]) {
    const starterRow = userRows[starterUserId];
    const starterCode = starterRow.countryCode ? starterRow.countryCode.toLowerCase() : "un";
    const starterDuration = formatDurationGrid(userDurations[starterUserId] || 0);
    keeperHtml += `
      <div style="padding:7px 0 5px 0;display:flex;align-items:center;gap:0;background:#22222233;font-weight:bold;">
        <img src="https://flagcdn.com/w20/${starterCode}.png" style="width:20px;height:15px;border-radius:2px;box-shadow:0 0 2px #000;">
        <span style="font-family:monospace; font-size:1.1em; color:#FFD700;font-weight:bold;text-shadow:0 0 8px #fff;">
          ${getShortUserId(starterUserId)}
        </span>
        <img src="assets/clock.svg" style="width:17px; height:17px; vertical-align:middle; margin:0 3px;">
        <span style="color:#FFD700;font-weight:bold;text-shadow:0 0 8px #fff;">
          ${starterDuration} ‚Ä¢ Kindler
        </span>
      </div>
      <div style="border-bottom:1px solid #444;margin:2px 0 6px 0;"></div>
    `;
  }

  // Show all other keepers ranked by duration
  keeperHtml += keeperUserIds.map((id, index) => {
    const row = userRows[id];
    const code = row && row.countryCode ? row.countryCode.toLowerCase() : "un";
    const isCurrentUser = id === currentUserId;
    return `
      <div style="border-bottom:1px solid #222;padding:5px 0;display:flex;align-items:center;gap:0;${isCurrentUser ? 'background:#ffd70022;font-weight:bold;' : ''}">
        <img src="https://flagcdn.com/w20/${code}.png" style="width:19px;height:14px;border-radius:2px;box-shadow:0 0 2px #000;">
        <span style="font-family:monospace; font-size:1em; color:${isCurrentUser ? '#fff' : '#FFD700'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 8px #fff;' : ''}">
          ${getShortUserId(id)}
        </span>
        <img src="assets/clock.svg" style="width:16px; height:16px; vertical-align:middle; margin:0 2px;">
        <span style="color:${isCurrentUser ? '#fff' : '#bbea6a'};${isCurrentUser ? 'font-weight:bold;text-shadow:0 0 6px #fff;' : ''}">
          ${formatDurationGrid(userDurations[id])}
        </span>
      </div>
    `;
  }).join('');

  listPopup.innerHTML = keeperHtml;
  document.body.appendChild(listPopup);
  setTimeout(() => listPopup.remove(), 12000);
}

// --- Motivational scroll/message below // --- // --- Motivational scroll/message below Global Resonance Field ---
let resonanceMsg = document.getElementById('resonanceMsg');
if (!resonanceMsg) {
  resonanceMsg = document.createElement('div');
  resonanceMsg.id = 'resonanceMsg';
  resonanceMsg.style.cssText = `
    position: absolute;
    top: 10%;
    left: 0;
    right: 0;
    font-family: 'Poppins', sans-serif;
    font-size: clamp(1.8rem, 6vw, 2.8rem);  // Increased size
    font-weight: 800;  // Bolder
    opacity: 0.98;
    padding: 25px 0;   // More padding
    white-space: nowrap;
    z-index: 10001;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    animation: scrollMsg 25s linear infinite;
    text-shadow: 0 0 4px #fde68a, 0 0 2px #fde68a;
    
  `;
  container.appendChild(resonanceMsg);

  // Scrolling animation
  if (!document.getElementById('scrollMsgStyle')) {
    const style = document.createElement('style');
    style.id = 'scrollMsgStyle';
    style.textContent = `
      @keyframes scrollMsg {
        0% { 
          transform: translateX(100%);
        }
        100% { 
          transform: translateX(-100%);
        }
      }
    `;
    document.head.appendChild(style);
  }
  setAuraColor(); 
}

// Set the text with connection status
const userrId = localStorage.getItem('omUserId');
const isConnected = livePresenceRows.some(row => row.user_id === userrId);
const soulCount = livePresenceRows.length;

if (isConnected) {
  if (soulCount === 1) {
    resonanceMsg.textContent = "Breathe ‚Ä¢ Let Go ‚Ä¢ Be Still";
  } else {
    const othersCount = soulCount - 1;
    resonanceMsg.textContent = "Breathe ‚Ä¢ Let Go ‚Ä¢ Be Still";
  }
} else {
  resonanceMsg.textContent = "Breathe ‚Ä¢ Let Go ‚Ä¢ Be Still";
}
resonanceMsg.style.display = "";

// --- Grid ID display ---
let userIdDisplay = document.getElementById('userIdDisplay');
if (!userIdDisplay) {
  userIdDisplay = document.createElement('div');
  userIdDisplay.id = 'userIdDisplay';
  userIdDisplay.style.cssText = `
    position: absolute;
    bottom: 23%;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Poppins', sans-serif;
    font-size: 0.98rem;
    letter-spacing: 2px;
    opacity: 0.93;
    border-radius: 16px;
    padding: 4px 16px;
    z-index: 10001;
    font-weight: 600;
    margin-top: 4px;
    box-shadow: 0 0 6px #ffd70033;
    width: max-content;
    max-width: calc(100vw - 32px);
  `;
  container.appendChild(userIdDisplay);
}

// --- Set the text ---
const userId = localStorage.getItem('omUserId');
userIdDisplay.innerHTML = `Grid ID: <span style="font-family:monospace;font-size:1.05em;">${getShortUserId(userId)}</span>`;

userIdDisplay.style.cursor = 'pointer'; // Show it's clickable

userIdDisplay.onclick = function(e) {
  const userId = localStorage.getItem('omUserId');
  const userRow = livePresenceRows.find(row => row.user_id === userId);
  if (!userRow) return;

  // Calculate duration for current user
  let duration = "";
  if (userRow.joined_at) {
    const secs = Math.floor((Date.now() - new Date(userRow.joined_at)) / 1000);
    duration = formatDurationGrid(secs);
  }

  // --- HEARTBEAT WARNING LOGIC ---
  let heartbeatStyle = "color:#ffd700"; // normal gold
  let lastHeartbeatStr = "";
  let nextHeartbeatStr = "";
  let missedHeartbeat = false;
  let nextCountdownText = "";
  let nextHeartbeatDate = null;
  if (userRow.last_heartbeat) {
    const lastHeartbeatDate = new Date(userRow.last_heartbeat);
    lastHeartbeatStr = lastHeartbeatDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    // 30min + custom grace (change graceMins for your threshold)
    const graceMins = 30;
    const now = Date.now();
    const lastMs = lastHeartbeatDate.getTime();
    missedHeartbeat = (now - lastMs) > (graceMins * 60 * 1000);

    if (missedHeartbeat) {
      heartbeatStyle = "color:#ffa366;font-weight:bold;text-shadow:0 0 8px #ff9944"; // warning orange
    }
    nextHeartbeatDate = new Date(lastMs + 30 * 60 * 1000);
    nextHeartbeatStr = nextHeartbeatDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    // -- Countdown until next heartbeat
    const timeLeftMs = nextHeartbeatDate - now;
    if (timeLeftMs < 0) {
      nextCountdownText = "Due now!";
    } else {
      const minsLeft = Math.floor(timeLeftMs / 60000);
      const secsLeft = Math.floor((timeLeftMs % 60000) / 1000);
      nextCountdownText = `${minsLeft} min${minsLeft !== 1 ? 's' : ''} ${secsLeft}s left`;
    }
  }

  // Get position (show near the Grid ID bar)
  const rect = userIdDisplay.getBoundingClientRect();
  const x = rect.left + rect.width / 2;
  const y = rect.top - 10;

  // Remove any existing popup
  const oldPopup = document.getElementById('current-user-mins-popup');
  if (oldPopup) oldPopup.remove();

  // Build your popup with heartbeat warning color and countdown
  const popup = document.createElement('div');
  popup.id = 'current-user-mins-popup';
popup.innerHTML = `
  <div style="font-size:1.2em;font-weight:800;color:#ffd700;margin-bottom:5px;letter-spacing:1px;text-align:center;">
    ${duration} <span style="font-size:0.7em;font-weight:normal;opacity:0.9;">connected</span>
  </div>
  <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;">
    <span style="width:26px;height:26px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at 50% 50%, ${missedHeartbeat?'#f72b29':'#29D884'} 0%, #2a2525 90%);
      box-shadow: 0 0 12px ${missedHeartbeat?'#f72b29':'#29D884'}, inset 0 1px 1px rgba(255,255,255,0.2);">
      <svg viewBox="0 0 20 20" fill="none" style="width:16px;height:16px;filter:drop-shadow(0 1px 1px rgba(0,0,0,0.3));">
        <path d="M4 11 L7 7 L10 13 L13 10 L16 13" stroke="#fff" stroke-width="2" fill="none" stroke-linecap="round"/>
      </svg>
    </span>
    <span style="font-size:1.05em;color:#ffe066;">
      <span style="font-size:0.95em;color:${missedHeartbeat?'#ff9944':'#29D884'};font-weight:600;">
        ${missedHeartbeat?'Resonance interrupted!':'Resonance active'}
      </span>
    </span>
  </div>
  <hr style="border:none;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(255,215,0,0.3) 50%,transparent 100%);margin:12px 0;">
  <div style="display:flex;align-items:center;justify-content:center;gap:8px;text-align:center;">
<span style="font-size:1em;color:#ffe066;line-height:1.4;text-align:center;">
  <div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:4px;">
    <span style="font-weight:600;opacity:0.9;color:#ffeb99;">Next pulse:</span>
    <b style="color:#ffd700;text-shadow:0 0 6px rgba(255,215,0,0.4);">${nextHeartbeatStr || 'Unknown'}</b>
  </div>
  <div id="hb-countdown" style="font-size:0.95em;color:#ffd700;font-weight:700;letter-spacing:0.5px;
                background:rgba(255,215,0,0.1);padding:4px 8px;border-radius:4px;border:1px solid rgba(255,215,0,0.2);">
    ${nextCountdownText}
  </div>
</span>
  </div>
${missedHeartbeat 
  ? `<div style="margin-top:14px;padding:8px 12px;background:rgba(255,68,68,0.1);border-radius:6px;font-size:1.02em;color:#ff6b6b;font-weight:bold;text-align:center;border:1px solid rgba(255,68,68,0.3);">
        Pulse missed! 
        <span style="color:#ffd700;font-weight:bold;text-shadow:0 0 8px #ffd700;animation:om-glow 2s infinite alternate;">OM</span> again.
     </div>`
  : ''
}
`;
  popup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y}px;
    transform: translate(-50%, -100%);
    background: rgba(0,0,0,0.94);
    color: #ffd700;
    font-family: 'Poppins', sans-serif;
    font-size: 1.02rem;
    padding: 11px 18px;
    border-radius: 12px;
    box-shadow: 0 0 10px #ffd70066;
    z-index: 10020;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.18s;
    text-align: center;
  `;
  document.body.appendChild(popup);
  setTimeout(() => popup.style.opacity = 1, 10);

// --- Live countdown update for heartbeat ---
if (nextHeartbeatDate) {
  function updateCountdown() {
    const countdownEl = document.getElementById("hb-countdown");
    if (!countdownEl) return;
    const timeLeftMs = nextHeartbeatDate - Date.now();
    
    // Check if heartbeat was received while popup is open
    const currentUserId = localStorage.getItem('omUserId');
    const currentUserRow = livePresenceRows.find(row => row.user_id === currentUserId);
    
    if (currentUserRow && currentUserRow.last_heartbeat) {
      const lastHeartbeatMs = new Date(currentUserRow.last_heartbeat).getTime();
      // If we have a newer heartbeat than when we opened the popup
      if (lastHeartbeatMs > new Date(userRow.last_heartbeat).getTime()) {
        countdownEl.textContent = "Pulse received!";
        countdownEl.style.cssText = `
          font-size: 0.95em;
          color: #29D884;
          font-weight: 700;
          letter-spacing: 0.5px;
          background: rgba(41, 216, 132, 0.1);
          padding: 4px 8px;
          border-radius: 4px;
          border: 1px solid rgba(41, 216, 132, 0.2);
          animation: pulse-flash 6s infinite;
        `;
        return;
      }
    }
    
if (timeLeftMs < 0) {
  countdownEl.innerHTML = `
    <button id="sendPulseBtn"
      style="
        background:#222413;
        border:1px solid #ffd700;
        color:#ffd700;
        font-weight:700;
        border-radius:7px;
        padding:7px 28px;
        font-size:1.07em;
        box-shadow:0 0 7px #ffd70055;
        cursor:pointer;
        margin-top:2px;
        margin-bottom:2px;
        outline:none;">
      OM now!
    </button>
  `;
  // Attach handler RIGHT after rendering
  const btn = document.getElementById("sendPulseBtn");
  if (btn) {
btn.onclick = async function() {
  this.disabled = true;
  this.textContent = "Sending...";
  await sendHeartbeat();
  startHeartbeat();

  // Activate OM sound as well
  const om = document.getElementById('om-sound');
  if (om) {
    om.muted = false;
    om.currentTime = 0;
    om.volume = 0.7;
    om.play().catch(()=>{});
    isPlaying = true;
  }

  countdownEl.innerHTML = `<span style="color:#29D884;font-weight:700;">Pulse received!</span>`;
  clearInterval(intervalId);
  setTimeout(() => {
    if (popup) {
      popup.style.opacity = 0;
      setTimeout(() => popup.remove(), 400);
    }
  }, 1100);
};
  }
  return;
}
    const minsLeft = Math.floor(timeLeftMs / 60000);
    const secsLeft = Math.floor((timeLeftMs % 60000) / 1000);
    countdownEl.textContent = `${minsLeft} min${minsLeft!==1?'s':''} ${secsLeft}s left`;
  }
  
  const intervalId = setInterval(updateCountdown, 1000);
  updateCountdown();
  setTimeout(() => clearInterval(intervalId), 12000);
}

setTimeout(() => {
  popup.style.opacity = 0;
  setTimeout(() => popup.remove(), 400);
}, 12000);
};

showCountryStatsOnEarthGrid(); 
showUserTravelBar();
startFlameTimer();
setAuraColor();

  const ctx = canvas.getContext('2d');
  setTimeout(() => container.style.opacity = 1, 10);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // --- Layered starfield (unchanged) ---
  const starLayers = [
    { count: 60, minR: 0.2, maxR: 1.1, minA: 0.35, maxA: 0.75 },
    { count: 26, minR: 1.0, maxR: 2.4, minA: 0.10, maxA: 0.26 },
    { count: 8,  minR: 2.8, maxR: 5.0, minA: 0.05, maxA: 0.12 }
  ];
  for (const layer of starLayers) {
    for (let i = 0; i < layer.count; i++) {
      const starX = Math.random() * canvas.width;
      const starY = Math.random() * canvas.height;
      const size = layer.minR + Math.random() * (layer.maxR - layer.minR);
      const alpha = layer.minA + Math.random() * (layer.maxA - layer.minA);
      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      ctx.fillStyle = '#ffffff';
      ctx.arc(starX, starY, size, 0, Math.PI * 2);
      ctx.fill();
      if (size > 1.2) {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,240,200,${Math.min(0.08, alpha * 0.18)})`;
        ctx.arc(starX, starY, size * 3.5, 0, Math.PI * 2);
        ctx.fill();
      }
      if (size > 0.9 && size <= 2.5) {
        ctx.shadowColor = 'rgba(255, 220, 170, 0.08)';
        ctx.shadowBlur = size * 4;
        ctx.beginPath();
        ctx.fillStyle = '#ffffff';
        ctx.arc(starX, starY, 0.6, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }
      ctx.restore();
    }
  }

// ---- LIVE ZONE/COUNTRY CALCULATION ----
const countryCounts = {};
let omPresenceId = localStorage.getItem('omPresenceId');
livePresenceRows.forEach(row => {
  const zone = row.country || row.zone || row.region;
  if (!zone) return;
  countryCounts[zone] = (countryCounts[zone] || 0) + 1;
});
const zones = Object.keys(countryCounts).map(zone => ({
  zone,
  count: countryCounts[zone]
}));

// --- Draw flags and dots for each active zone/country ---
const baseX = canvas.width / 2;
const baseY = canvas.height / 2;
const radius = 120;
const dots = [];
fetch('https://restcountries.com/v3.1/all?fields=name,cca2,cca3,latlng')
  .then(res => res.json())
  .then(allCountries => {
    const flagPromises = [];
    zones.forEach((z, i) => {
            let zoneName = typeof z === 'object' ? z.zone : z;
	  // Normalize any USA variant to "United States"
	  if (zoneName && zoneName.toLowerCase().includes('united states')) {
	   zoneName = 'United States';
	  } 
      let coords;
      const country = allCountries.find(c => 
        c.name.common.toUpperCase() === zoneName.toUpperCase().replace(/_/g, ' ') ||
        c.name.official.toUpperCase() === zoneName.toUpperCase().replace(/_/g, ' ') ||
        c.cca2 === zoneName ||
        c.cca3 === zoneName
      );
      if (country && country.latlng) {
        coords = { lat: country.latlng[0], lon: country.latlng[1] };
      } else {
        const angle = (i / zones.length) * 2 * Math.PI;
        coords = { lat: Math.sin(angle) * 60, lon: (angle / Math.PI) * 180 };
      }
      const x = baseX + (coords.lon / 180) * radius * 0.9;
      const y = baseY - (coords.lat / 90) * radius * 0.45;
      const color = `hsl(${(i * 33) % 360}, 80%, 60%)`;
      let countryCode = 'un';
      if (country && country.cca2) countryCode = country.cca2.toLowerCase();
      const codeMap = {
        'USA': 'us', 'US': 'us', 'United_States': 'us',
		'United States of America': 'us',
		'United States of America (the)': 'us',
        'India': 'in', 'IN': 'in',
        'China': 'cn', 'CN': 'cn',
        'UK': 'gb', 'GB': 'gb', 'United_Kingdom': 'gb',
        'Australia': 'au', 'AU': 'au',
        'Brazil': 'br', 'BR': 'br',
        'Russia': 'ru', 'RU': 'ru',
        'Japan': 'jp', 'JP': 'jp',
        'Canada': 'ca', 'CA': 'ca',
        'Mexico': 'mx', 'MX': 'mx',
        'South_Africa': 'za', 'ZA': 'za',
        'Egypt': 'eg', 'EG': 'eg',
        'Indonesia': 'id', 'ID': 'id',
        'Argentina': 'ar', 'AR': 'ar'
      };
      countryCode = codeMap[zoneName] || countryCode;

      // Only do the presenceRow lookup ONCE
      const presenceRow = livePresenceRows.find(row => row.country === zoneName);
      const id = presenceRow ? presenceRow.id : null;

      const flagImg = new Image();
      flagImg.crossOrigin = "anonymous";
      const flagPromise = new Promise((resolve) => {
        flagImg.onload = () => resolve({ img: flagImg, x, y, zone: z, color, id });
        flagImg.onerror = () => resolve({ img: null, x, y, zone: z, color, id });
        flagImg.src = `https://flagcdn.com/w20/${countryCode}.png`;
      });
      flagPromises.push(flagPromise);

      dots.push({ x, y, zone: z, color, id });
    });

    Promise.all(flagPromises).then(flags => {
      flags.forEach(({ img, x, y, zone, color, id }) => {
        // Compare this dot's id to your saved omPresenceId
        if (id && omPresenceId && id.toString() === omPresenceId.toString()) {
          // Draw shine/glow under your flag
          ctx.save();
          ctx.beginPath();
          ctx.ellipse(x, y + 1, 9, 5, 0, 0, 1 * Math.PI);
          ctx.fillStyle = '#fffde0';
          ctx.globalAlpha = 0.38;
          ctx.shadowColor = '#ffd700';
          ctx.shadowBlur = 28;
          ctx.fill();
          ctx.restore();
        }

        // Draw the flag as usual
        if (img) {
          ctx.drawImage(img, x - 6, y - 4, 12, 9);
        } else {
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fillStyle = color;
          ctx.shadowColor = color;
          ctx.globalAlpha = 0.18;
          ctx.shadowBlur = 15;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, Math.PI * 2);
          ctx.strokeStyle = color + '40';
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      });
    });
// zonepopup 
getUserCountryInfo().then(userCountryInfo => {
  const omPresenceId = localStorage.getItem('omPresenceId');
  const isUserActive = !!omPresenceId;

  // Try to find user's country among active nodes/dots
  const userZoneDot = dots.find(dot => {
    let zoneName = typeof dot.zone === 'object' ? dot.zone.zone : dot.zone;
    return zoneName === userCountryInfo.country;
  });

  const canvasRect = canvas.getBoundingClientRect();

  if (userZoneDot) {
    // Show normal popup (with count)
    showZonePopup(
      typeof userZoneDot.zone === 'object' ? userZoneDot.zone : { zone: userZoneDot.zone, count: userZoneDot.count },
      userZoneDot.x + canvasRect.left,
      userZoneDot.y + canvasRect.top
    );
  } else {
    // Show minimal popup at default flag location (center or calculated)
    // Option 1: Center of canvas
    const centerX = canvasRect.left + canvas.width / 2;
    const centerY = canvasRect.top + canvas.height / 2;

    // Option 2: Calculate flag position using restcountries lat/lng
    // (if you want, but center is simplest fallback)

    // Create a minimal zone object
    const minimalZone = { zone: userCountryInfo.country, count: null };

    showZonePopup(minimalZone, centerX, centerY);
  }
});
  });

  let glowActive = false;

// --- Power Node Label ---
label.innerHTML = zones.length > 0 
  ? `‚ö° ${zones.length} ${zones.length === 1 ? 'Power Node' : 'Power Nodes'} Active`
  : 'No active resonance detected';

// Make it clickable to highlight all flags
label.style.cursor = 'pointer';
label.onclick = function(e) {
  e.stopPropagation();
  togglePowerNodesGlow();
};

function togglePowerNodesGlow() {
  const ctx = canvas.getContext('2d');

  if (glowActive) {
    // Turn off glow - just redraw the grid normally
    renderEarthGrid();
  } else {
    // Turn on glow - add gold effects
    dots.forEach(dot => {
      ctx.save();
      ctx.beginPath();
      ctx.arc(dot.x, dot.y, 10, 0, Math.PI * 2);
      ctx.fillStyle = '#ffd70033';
      ctx.shadowColor = '#ffd700';
      ctx.shadowBlur = 20;
      ctx.fill();

      ctx.strokeStyle = '#ffd700';
      ctx.lineWidth = 1.5;
      ctx.strokeRect(dot.x - 7, dot.y - 5, 14, 10);
      ctx.restore();

      // ---- NEW: Show zone popup for this flag/zone ----
      const canvasRect = canvas.getBoundingClientRect();
      // Prepare zone object for showZonePopup
      const zoneObj = typeof dot.zone === 'object' ? dot.zone : { zone: dot.zone, count: dot.count };
      showZonePopup(
        zoneObj,
        dot.x + canvasRect.left,
        dot.y + canvasRect.top
      );
    });
  }

  glowActive = !glowActive;
}

  // --- Canvas events and popups (unchanged) ---
  let popupTimer = null;
  let lastZone = null;
  canvas.onpointermove = function(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    let found = null;
    for (const d of dots) {
      const dist = Math.sqrt((x - d.x) ** 2 + (y - d.y) ** 2);
      if (dist < 10) { found = d; break; }
    }
    if (found && (lastZone !== found.zone)) {
      showZonePopup(found.zone, e.clientX, e.clientY, found.count);
      lastZone = found.zone;
      if (popupTimer) clearTimeout(popupTimer);
      popupTimer = setTimeout(() => { lastZone = null; }, 1000); // prevents popup spam
    }
  };
  canvas.onpointerleave = function() { lastZone = null; };
  canvas.ondblclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    let found = null;
    for (const d of dots) {
      const dist = Math.sqrt((x - d.x) ** 2 + (y - d.y) ** 2);
      if (dist < 10) { found = d; break; }
    }
    if (!found) { closeEarthGrid(); }
  };

  // --- Fade out after 30 min (unchanged) ---
  setTimeout(() => closeEarthGrid(), 3000000);
}

let participantCallChannel = null;

function showWherebyParticipantDialog(participantUrl, callId) {
  // Clean up any previous dialog
  const oldDlg = document.getElementById('participant-call-dialog');
  if (oldDlg) oldDlg.remove();

// Get current user's name/ID for display
const currentUserId = localStorage.getItem('omUserId') || 'User';
const shortId = getShortUserId(currentUserId);
const enhancedUrl = `${participantUrl}${participantUrl.includes('?') ? '&' : '?'}displayName=${encodeURIComponent(shortId)}&skipMediaPermissionPrompt=true&skipJoinDialog=true`;

  const dlg = document.createElement('div');
  dlg.id = 'participant-call-dialog';
  dlg.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10050;background:#232626;display:flex;flex-direction:column;align-items:center;justify-content:center;";
  dlg.innerHTML = `<iframe src="${enhancedUrl}" allow="camera; microphone; fullscreen; speaker" style="border-radius:12px;border:none;width:96vw;height:90vh;max-width:700px;max-height:500px;background:#232626;"></iframe>
    <button style="margin-top:12px;padding:.5em 1.4em;background:#fde68a;color:#232626;border:none;border-radius:7px;font-weight:bold;box-shadow:0 2px 10px #eab30822;cursor:pointer;" onclick="closeCallDialog(this)">Close</button>`;
  document.body.appendChild(dlg);

  // --- SUBSCRIBE FOR CLOSE SIGNAL FROM HOST ---
  if (participantCallChannel) {
    participantCallChannel.unsubscribe();
    participantCallChannel = null;
  }
  if (callId) {
    participantCallChannel = supabase
      .channel('participant-call-sub-' + callId)
      .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'om_calls',
        filter: `id=eq.${callId}`
      }, (payload) => {
        if (payload.new.status === 'finish') {
          closeParticipantCallDialog();
        }
      })
      .subscribe();
  }
}

function closeParticipantCallDialog() {
  const dlg = document.getElementById('participant-call-dialog');
  if (dlg) {
    const iframe = dlg.querySelector('iframe');
    if (iframe) iframe.src = 'about:blank';
    setTimeout(() => {
      dlg.remove();
      restoreAudioAfterCall();
    }, 100); // Small delay if you want it, otherwise just remove() immediately
  }
  if (participantCallChannel) {
    participantCallChannel.unsubscribe();
    participantCallChannel = null;
  }
}
function closeCallDialog(button) {
  closeParticipantCallDialog();
}

function showWherebyHostDialog(hostUrl, callId) {
  // Get host user info and enhance the URL
  const currentUserId = localStorage.getItem('omUserId') || 'Host';
  const shortId = getShortUserId(currentUserId);
    // Add auto-join parameters to host URL
  const enhancedUrl = `${hostUrl}${hostUrl.includes('?') ? '&' : '?'}displayName=${encodeURIComponent(shortId)}&skipMediaPermissionPrompt=true&skipJoinDialog=true`;
  
  const dlg = document.createElement('div');
  dlg.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:10050;background:#232626;display:flex;flex-direction:column;align-items:center;justify-content:center;";
  dlg.innerHTML = `<iframe src="${enhancedUrl}" allow="camera; microphone; fullscreen; speaker" style="border-radius:12px;border:none;width:96vw;height:90vh;max-width:700px;max-height:500px;background:#232626;"></iframe>
    <button id="close-host-btn" style="margin-top:12px;padding:.5em 1.4em;background:#fde68a;color:#232626;border:none;border-radius:7px;font-weight:bold;box-shadow:0 2px 10px #eab30822;cursor:pointer;">Close</button>`;
  document.body.appendChild(dlg);

  document.getElementById('close-host-btn').onclick = async function() {
    // üëá Force camera release
    const iframe = dlg.querySelector('iframe');
    if (iframe) iframe.src = 'about:blank';

    setTimeout(async () => {
      dlg.remove();
      restoreAudioAfterCall();
      if (callId) {
        await supabase.from('om_calls').update({ status: 'finish' }).eq('id', callId);
      }
    }, 100); // 100ms delay
  }
}

function showCallConfirm(userId, userName, onConfirm) {
  const modal = document.getElementById('call-confirm-modal');
  const msgElem = modal.querySelector('.modal-message');
  const okBtn = document.getElementById('call-confirm-ok');
  const cancelBtn = document.getElementById('call-confirm-cancel');

  // Customize the message as you like
  msgElem.textContent = userName
    ? `Are you sure you want to call ${userName}?`
    : `Are you sure you want to call user ${userId}?`;

  modal.classList.remove('hidden');

  function cleanup() {
    modal.classList.add('hidden');
    okBtn.removeEventListener('click', okHandler);
    cancelBtn.removeEventListener('click', cancelHandler);
  }
  function okHandler() {
    cleanup();
    onConfirm(true);
	stopAllAudio();
  }
  function cancelHandler() {
    cleanup();
    onConfirm(false);
  }
  okBtn.addEventListener('click', okHandler);
  cancelBtn.addEventListener('click', cancelHandler);
}

// üîá ADD THIS FUNCTION TO STOP ALL AUDIO
function stopAllAudio() {
  // Stop OM sound
  const omSound = document.getElementById('om-sound');
  if (omSound) {
    omSound.pause();
    omSound.currentTime = 0;
    window.isPlaying = false; // Update global state
    stopOmSelfHeal(); // Stop health check
    stopAudioHealthCheck(); // Stop health check
  }
}

// üîá SIMPLE RESTORE AUDIO (OM only)
function restoreAudioAfterCall() {
  const om = document.getElementById('om-sound');
  if (om) {
    om.muted = false;
    om.currentTime = 0;
    om.volume = 0.7;
    om.play().catch(()=>{});
    window.isPlaying = true;
	startOmSelfHeal();
    startAudioHealthCheck();
  }
}

function formatTotalDuration(seconds) {
  if (!seconds) return '0 mins';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  if (hrs > 0) return `${hrs} hr${hrs > 1 ? 's' : ''} ${mins} min${mins !== 1 ? 's' : ''}`;
  return `${mins} min${mins !== 1 ? 's' : ''}`;
}

function getDisplayCountryName(zoneName) {
  if (!zoneName) return '';
  const name = zoneName.toLowerCase();
  if (name.includes('united states')) return 'United States';
  // Add more custom aliases here if needed (e.g., UK, UAE)
  return zoneName.replace(/_/g, ' ');
}

async function showZonePopup(zone, x, y) {
  const omPresenceId = localStorage.getItem('omPresenceId');
  const isUserActive = !!omPresenceId;

  // Get user's country info
  const userCountryInfo = await getUserCountryInfo();
  const isUsersCountry = (zone.zone === userCountryInfo.country);

  // Set svgClass FIRST!
  let svgClass = '';
  if (isUserActive) {
    svgClass = 'rainbow';
  }

  // NOW create svgImg using the class
  const svgImg = `
  <span style="min-width:33px;min-height:33px;display:inline-flex;align-items:center;justify-content:center;">
    <img id="omusers-svg" class="${svgClass}" src="assets/omusers.svg"
      style="width:33px;height:33px;vertical-align:middle;display:inline-block;">
  </span>
`;

  // Find all users in this zone
  let usersInZone = livePresenceRows.filter(row => row.country === zone.zone);

  // Calculate total duration for all users in this zone
let totalSeconds = usersInZone.reduce((sum, u) => {
  if (u.joined_at) {
    const start = new Date(u.joined_at);
    const end = Date.now(); // current time in ms
    if (!isNaN(start.getTime())) {
      return sum + ((end - start.getTime()) / 1000);
    }
  }
  return sum;
}, 0);
  const totalDurationText = formatTotalDuration(totalSeconds);

  // Always show total count
  let countText = `${zone.count}`;

  // Popup HTML
const popup = document.createElement('div');
popup.classList.add('earthzone-popup'); 
let showCount = zone.count !== null && zone.count !== undefined && zone.count > 0;
popup.innerHTML = `
<div style="
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
  max-width: 98vw;
  overflow: auto;
  font-size: 0.91em;
">
  ${showCount ? `<span>${countText}</span>` : ''}
  <span style="min-width:33px;min-height:33px;display:inline-flex;align-items:center;justify-content:center;">
    ${svgImg}
  </span>
  <span>${getDisplayCountryName(zone.zone)}</span>
  ${
    showCount && totalDurationText
      ? `<span style="font-weight:600;color:#ffe066;display: flex; align-items: center;max-width:80vw;overflow:hidden;text-overflow:ellipsis;">
            <img src="/assets/clockchakra.svg" class="chakra-rotate" style="width:18px; height:18px; margin-right:5px;">
            ${totalDurationText.replace(/[()]/g, '')}
         </span>`
      : ''
  }
</div>
`;
  popup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y}px;
    transform: translate(-50%, -120%);
    background: rgba(0,0,0,0.75);
    color: #fde68a;
    font-size: 0.85rem;
    padding: 6px 10px;
    border-radius: 6px;
    box-shadow: 0 0 8px #fde68a66;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 10000;
    white-space: nowrap;
  `;
  document.body.appendChild(popup);
  
  // Attach event to SVG icon in popup
const svgIcon = popup.querySelector('#omusers-svg');
if (svgIcon) {
  svgIcon.style.cursor = "pointer";
  svgIcon.onpointerenter = function(e) {
    showUserListPopup(usersInZone, popup, x, y);
  };
  svgIcon.onclick = function(e) {
    showUserListPopup(usersInZone, popup, x, y);
  };
}

  setTimeout(() => popup.style.opacity = 1, 10);
  setTimeout(() => {
    popup.style.opacity = 0;
    setTimeout(() => popup.remove(), 900);
  }, 9000);
}

function showUserListPopup(users, parentPopup, x, y) {
  // Remove any old user list popup
  const oldList = document.getElementById('user-list-popup');
  if (oldList) oldList.remove();

  // Get current user's ID
  const currentUserId = localStorage.getItem('omUserId');

  // SORT USERS BY DURATION (highest first)
  const sortedUsers = users.sort((a, b) => {
    const durationA = a.joined_at ? (Date.now() - new Date(a.joined_at)) / 1000 : 0;
    const durationB = b.joined_at ? (Date.now() - new Date(b.joined_at)) / 1000 : 0;
    return durationB - durationA; // Highest first
  });

  // Create new popup
  const listPopup = document.createElement('div');
  listPopup.id = 'user-list-popup';
  listPopup.style.cssText = `
    position: fixed;
    left: ${x}px; top: ${y+32}px;
    transform: translate(-50%, 0);
    background: rgba(0,0,0,0.97);
    color: #fde68a;
    font-size: 0.96rem;
    padding: 9px 18px;
    border-radius: 10px;
    box-shadow: 0 0 14px #fde68a66;
    z-index: 10001;
    min-width: 160px;
    max-height: 320px;
    overflow-y: auto;
    text-align: left;
	  /* Scrollbar styling */
  scrollbar-width: thin;
  scrollbar-color: #fde68a #000000;
  `;

  if (users.length === 0) {
    listPopup.innerHTML = "<i>No users found.</i>";
  } else {
    // Get country name from first user (assuming all users in this popup are from same country)
    const countryName = users[0]?.country || "Active Users";
    
    listPopup.innerHTML = `
      <div style="border-bottom:1px solid #fde68a;padding-bottom:6px;margin-bottom:6px;text-align:center;">
        <strong>${countryName.replace(/_/g, ' ')}</strong>
      </div>
      ${users.map(u => {
        let duration = "";
        if (u.joined_at) {
          const secs = Math.floor((Date.now() - new Date(u.joined_at)) / 1000);
          duration = formatDuration(secs);
        }
        // Bold and highlight current user
        const isCurrentUser = u.user_id === currentUserId;
        return `
          <div style="border-bottom:1px solid #333;padding:4px 0;display:flex;align-items:center;gap:14px;${isCurrentUser ? 'background:#ffd70022;font-weight:bold;' : ''}">
            <b>ID:</b>
            <span style="font-family:monospace; color:#ffd700;${isCurrentUser ? 'font-weight:bold;' : ''}">${getShortUserId(u.user_id)}</span>
            <img src="assets/clock.svg" style="width:18px; height:18px; vertical-align:middle;">
            <span style="color:#ffd700;${isCurrentUser ? 'font-weight:bold;' : ''}">${duration}</span>
          </div>
        `;
      }).join('')}
    `;
  }
  
  document.body.appendChild(listPopup);
  
  // Optional: Remove on mouse leave
  //listPopup.onmouseleave = () => listPopup.remove();
  // Or remove after a timeout
  setTimeout(() => { listPopup.remove(); }, 12000);
}

// Track which call id you've already popped up for in this session
function startCallPolling() {
  if (typeof supabase === "undefined") {
    // Wait and try again in 500ms, up to N tries
    setTimeout(startCallPolling, 500);
    return;
  }

  let lastCallId = null;
  setInterval(async () => {
    const currentUserId = localStorage.getItem('omUserId');
    if (!currentUserId) return;
    const { data, error } = await supabase
      .from('om_calls')
      .select('*')
      .eq('participant_user_id', currentUserId)
      .in('status', ['pending'])
      .order('created_at', { ascending: false })
      .limit(1);

    if (data && data.length) {
      const call = data[0];
      if (lastCallId === call.id) return;

      const callTime = new Date(call.created_at).getTime();
      const now = Date.now();
      if ((now - callTime) > 3 * 60 * 1000) {
        await supabase.from('om_calls').update({ status: 'expired' }).eq('id', call.id);
        return;
      }

      lastCallId = call.id;
	  
	  stopAllAudio();
      showWherebyParticipantDialog(call.whereby_participant_url, call.id);

      const { error: updateError } = await supabase
        .from('om_calls')
        .update({ status: 'active' })
        .eq('id', call.id);

      if (updateError) {
        console.error('Call status update failed:', updateError);
      }
    }
  }, 3000);
}

function closeEarthGrid() {
  earthGridOpen = false;

  // Remove ALL zone popups + other tooltips
  document.querySelectorAll('.earthzone-popup').forEach(el => el.remove());

  [
    'flag-popup',
    'country-user-list-popup',
    'flame-keeper-list',
    'user-list-popup',
    'flame-tooltip',
    'current-user-mins-popup',
	'awareness-tooltip', 
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });

  const container = document.getElementById('earthGridContainer');
  if (container) {
    container.style.opacity = 0;
    setTimeout(() => container.style.display = 'none', 1000);
  }
  gridChannel?.unsubscribe();
  gridChannel = null;
}

// Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const langSwitch = document.getElementById('lang-switch');
  
  // Store original options with full names
  const languageMap = {
    'en': 'English',
    'te': 'Telugu', 
    'hi': 'Hindi',
    'es': 'Spanish',
    'fr': 'French',
    'de': 'German',
    'zh': 'Chinese',
    'ru': 'Russian',
    'it': 'Italian'		
  };
  
  // Show full names when dropdown opens
  langSwitch.addEventListener('mousedown', function() {
    Array.from(this.options).forEach(option => {
      option.textContent = languageMap[option.value];
    });
  });
  
  // Revert to codes when selection is made or dropdown closes
  langSwitch.addEventListener('change', function() {
    Array.from(this.options).forEach(option => {
      option.textContent = option.value.toUpperCase();
    });
  });
  
  // Also revert if user clicks away without selecting
  langSwitch.addEventListener('blur', function() {
    Array.from(this.options).forEach(option => {
      option.textContent = option.value.toUpperCase();
    });
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const muteBtn = document.getElementById('mute-audio-btn');
  const muteIcon = document.getElementById('mute-audio-icon');
  
  // Find the meditation background audio element
  function getMeditationAudio() {
    return window.backgroundAudio || document.querySelector('audio[id^="bg-music-"]:not([paused])');
  }

  let isMuted = false;

  muteBtn.addEventListener('click', () => {
    // FIRST: Try to resume audio context if suspended
    if (audioContext && audioContext.state === 'suspended') {
      audioContext.resume().then(() => {
        console.log('Audio context resumed via mute button');
      });
    }

    // THEN: Handle mute/unmute as normal
    const audio = getMeditationAudio();
    if (!audio) return;
    
    isMuted = !isMuted;
    audio.muted = isMuted;
    muteIcon.className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
    muteBtn.textContent = isMuted ? '' : '';
    muteBtn.prepend(muteIcon); // Keep icon at front
  });
});

// Attach music play handler to truemeditate.svg only
const languageMusicMap = {
  en: 'https://assets.trueyogi.app/assets/music/music-en.mp3',
  te: 'https://assets.trueyogi.app/assets/music/music-te.mp3',
  hi: 'https://assets.trueyogi.app/assets/music/music-hi.mp3',
  es: 'https://assets.trueyogi.app/assets/music/music-es.mp3',
  fr: 'https://assets.trueyogi.app/assets/music/music-fr.mp3',
  de: 'https://assets.trueyogi.app/assets/music/music-de.mp3',
  zh: 'https://assets.trueyogi.app/assets/music/music-zh.mp3',
  ru: 'https://assets.trueyogi.app/assets/music/music-ru.mp3',
  it: 'https://assets.trueyogi.app/assets/music/music-it.mp3'  
};

function setMeditationMusicForLang(langCode) {
  const audio = document.getElementById('meditate-music-audio');
  const src = languageMusicMap[langCode] || languageMusicMap['en'];
  if (audio.src !== src) {
    audio.src = src;
    audio.currentTime = 0;
    audio.pause();
  }
}

// On page load and dropdown change:
document.addEventListener('DOMContentLoaded', function() {
  const langSwitch = document.getElementById('lang-switch');
  setMeditationMusicForLang(langSwitch.value);

  langSwitch.addEventListener('change', function() {
    setMeditationMusicForLang(this.value);
  });
});

function attachMeditationMusicHandler() {
  const truemeditateImg = document.querySelector('#meditation-guide-image img[alt="TrueYogi Meditation"]');
  const musicAudio = document.getElementById('meditate-music-audio');
  if (!truemeditateImg || !musicAudio) return;

  truemeditateImg.onclick = null;
  let playing = false;
  let audioContextResumed = false;

  // Audio health check for meditation music
  let musicHealthCheckInterval = null;

  function startMusicHealthCheck() {
    stopMusicHealthCheck();
    musicHealthCheckInterval = setInterval(() => {
      if (playing && musicAudio && musicAudio.paused) {
        console.log('Music health check: restarting stopped audio');
        musicAudio.currentTime = 0;
        musicAudio.play().catch(error => {
          console.log('Music health restart failed:', error);
          playing = false;
          truemeditateImg.style.filter = '';
          stopMusicHealthCheck();
        });
      }
    }, 5000);
  }

  function stopMusicHealthCheck() {
    if (musicHealthCheckInterval) {
      clearInterval(musicHealthCheckInterval);
      musicHealthCheckInterval = null;
    }
  }

  // PREVENT browser from pausing audio on visibility change
  musicAudio.addEventListener('pause', function() {
    if (playing && document.hidden) {
      // Browser tried to pause because tab went to background - RESTART IT
      console.log('Browser tried to pause audio due to visibility change - RESTARTING');
      setTimeout(() => {
        if (playing) {
          musicAudio.play().catch(error => {
            console.log('Visibility restart failed:', error);
          });
        }
      }, 100);
    }
  });

let lastTap = 0;
let tapTimeout = null;

truemeditateImg.addEventListener('click', async function(e) {
  const rect = truemeditateImg.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  const clickX = e.clientX;
  const clickY = e.clientY;
  const dist = Math.sqrt((centerX - clickX) ** 2 + (centerY - clickY) ** 2);

  const tapRadius = Math.min(rect.width, rect.height) / 3;
  if (dist >= tapRadius) return;

  const now = Date.now();
  if (now - lastTap < 333) {
    // DOUBLE TAP
    clearTimeout(tapTimeout);
    lastTap = 0;
    // Set loop mode for double tap
    musicAudio.loop = true;
    if (!playing) {
      try {
        musicAudio.muted = false;
        musicAudio.currentTime = 0;
        musicAudio.volume = 0.7;
        await musicAudio.play();
        playing = true;
        truemeditateImg.style.filter = 'drop-shadow(0 0 22px #FFD700AA)';
        startMusicHealthCheck();
      } catch (error) {
        playing = false;
        truemeditateImg.style.filter = '';
      }
    }
    // Optionally: show short visual feedback for loop mode
    truemeditateImg.classList.add("looping");
    setTimeout(() => truemeditateImg.classList.remove("looping"), 500);
    return;
  }

  // SINGLE TAP delay logic
  lastTap = now;
  clearTimeout(tapTimeout);
  tapTimeout = setTimeout(async () => {
    // SINGLE TAP (no loop)
    musicAudio.loop = false;
    if (!playing) {
      try {
        musicAudio.muted = false;
        musicAudio.currentTime = 0;
        musicAudio.volume = 0.7;
        await musicAudio.play();
        playing = true;
        truemeditateImg.style.filter = 'drop-shadow(0 0 22px #FFD700AA)';
        startMusicHealthCheck();
      } catch (error) {
        playing = false;
        truemeditateImg.style.filter = '';
      }
    } else {
      musicAudio.pause();
      musicAudio.currentTime = 0;
      playing = false;
      truemeditateImg.style.filter = '';
      stopMusicHealthCheck();
    }
  }, 340);
});

  musicAudio.addEventListener('ended', () => {
    playing = false;
    truemeditateImg.style.filter = '';
    stopMusicHealthCheck();
  });
}

function stopMeditationMusicOnClose() {
  const musicAudio = document.getElementById('meditate-music-audio');
  const truemeditateImg = document.querySelector('#meditation-guide-image img[alt="TrueYogi Meditation"]');

  if (musicAudio) {
    try { musicAudio.pause(); } catch (e) {}
    try { musicAudio.currentTime = 0; } catch (e) {}
    // trigger any existing ended handlers so they can clear local flags/UI
    try { musicAudio.dispatchEvent(new Event('ended')); } catch (e) {}
  }

  if (truemeditateImg) {
    truemeditateImg.style.filter = '';
  }
}

  </script>
	
 <script>
// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('Service Worker registered: ', registration);
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('Service Worker update found!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New content is available, show update notification
              console.log('New content is available; please refresh.');
              // You can show an update notification to the user here
            }
          });
        });
      })
      .catch((registrationError) => {
        console.log('Service Worker registration failed: ', registrationError);
      });
  });

  // Listen for controller changes (when SW takes control)
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    console.log('Service Worker controller changed');
  });
}
</script>  
	
<script>
// run when DOM is ready
window.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('particles-canvas')
  const ctx = canvas.getContext('2d')
  const resize = () => {
    canvas.width = window.innerWidth
    canvas.height = window.innerHeight
  }
  window.addEventListener('resize', resize)
  resize()

  const particles = Array.from({ length: 60 }).map(() => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 2 + 1,
    dx: (Math.random() - 0.5) * 0.3,
    dy: (Math.random() - 0.5) * 0.3
  }))

  // Load planet images
  const neptune = new Image()
  const pluto = new Image()
  const galaxy = new Image()
  const saturn = new Image()
  const portal = new Image()
  const bgalaxy = new Image()

  // üß† Use relative paths correctly
  neptune.src = 'assets/neptune.png'
  pluto.src = 'assets/pluto.png'
  galaxy.src = 'assets/galaxy.png'
  saturn.src = 'assets/saturn.png'
  portal.src = 'assets/portal.png'
  bgalaxy.src = 'assets/bgalaxy.png'

  const planets = [
    { img: neptune, orbit: 100, size: 40, angle: Math.random(), speed: 0.0001, get cx() { return canvas.width * 0.2 }, get cy() { return canvas.height * 0.3 } },
    { img: galaxy, orbit: 220, size: 36, angle: Math.random(), speed: 0.0001, get cx() { return canvas.width * 0.3 }, get cy() { return canvas.height * 0.6 } },
    { img: saturn, orbit: 220, size: 36, angle: Math.random(), speed: 0.00003, get cx() { return canvas.width * 0.9 }, get cy() { return canvas.height * 0.4 } },
    { img: portal, orbit: 220, size: 19, angle: Math.random(), speed: 0.0001, get cx() { return canvas.width * 0.7 }, get cy() { return canvas.height * 0.5 } },
    { img: bgalaxy, orbit: 100, size: 22, angle: Math.random(), speed: 0.0002, get cx() { return canvas.width * 0.8 }, get cy() { return canvas.height * 0.15 } },
  ];
  
  // Spaceship class - BEAUTIFUL look!
  class Spaceship {
    constructor() {
      this.size = Math.random() * 12 + 12; // Slightly larger for visibility
      this.direction = Math.random() < 0.5 ? 1 : -1;
      this.x = this.direction > 0 ? -this.size : canvas.width + this.size;
      this.y = Math.random() * (canvas.height - 60) + 30;
      this.speed = Math.random() * 2.5 + 1.2;
      this.color = `hsl(${Math.random() * 360}, 78%, 58%)`;
      this.wingAngle = 0;
      this.wingDirection = 0.05;
      this.engineParticles = [];
      this.type = Math.random() < 0.7 ? 'normal' : 'warp';
      this.warpCooldown = 0;
      this.visible = true;
    }
    
    update() {
	    if (this.pauseUntil > Date.now()) {
      // Do nothing (pause)
      return;
    }
	
      if (this.type === 'warp') {
        const progress = this.direction > 0 
          ? this.x / canvas.width
          : 1 - (this.x / canvas.width);

        if (this.visible && progress > 0.3 && progress < 0.4) {
          this.visible = false;
          this.warpCooldown = 30;
        }

        if (!this.visible) {
          this.warpCooldown--;
          if (this.warpCooldown <= 0) {
            this.visible = true;
            if (this.direction > 0) {
              this.x = canvas.width * (0.6 + Math.random() * 0.1);
            } else {
              this.x = canvas.width * (0.3 - Math.random() * 0.1);
            }
          }
          return;
        }
      }

      this.x += this.speed * this.direction;
      this.wingAngle += this.wingDirection;

      if (this.wingAngle > 0.5 || this.wingAngle < -0.5) {
        this.wingDirection *= -1;
      }

// Add engine particles occasionally
    // Add engine particles at the BACK
    if (Math.random() < 0.3) {
      this.engineParticles.push({
        offsetX: -this.size/2, // always the rear
        offsetY: 0,
        size: Math.random() * 2 + 1,
        life: 20
      });
    }
    for (let i = this.engineParticles.length - 1; i >= 0; i--) {
      this.engineParticles[i].offsetX -= this.speed * 0.8; // always go further back (independent of direction/scale)
      this.engineParticles[i].life--;
      if (this.engineParticles[i].life <= 0) {
        this.engineParticles.splice(i, 1);
      }
    }

      // Reset if off screen
      if (
        ((this.direction > 0 && this.x > canvas.width + this.size) || 
         (this.direction < 0 && this.x < -this.size))
      ) {
        this.x = this.direction > 0 ? -this.size : canvas.width + this.size;
        this.y = Math.random() * (canvas.height - 60) + 30;
		this.pauseUntil = Date.now() + 10000; // Mothership pause for 10 seconds
      }
    }
    
    draw(ctx) {
      if (this.type === 'warp' && !this.visible) return;

      ctx.save();
      ctx.translate(this.x, this.y);
      if (this.direction < 0) ctx.scale(-1, 1);

      // --- BEAUTIFUL SHAPE SECTION ---
	  
	  // Draw engine particles
    // Draw engine particles at the rear
    for (const particle of this.engineParticles) {
      ctx.save();
      ctx.globalAlpha = particle.life / 20;
      ctx.beginPath();
      ctx.arc(particle.offsetX, particle.offsetY, particle.size, 0, Math.PI * 2);
      ctx.fillStyle = this.type === 'warp'
        ? '#7df9ff'
        : (this.type === 'fast' ? '#ff5555' : '#fde68a');
      ctx.shadowColor = ctx.fillStyle;
      ctx.shadowBlur = 8;
      ctx.fill();
      ctx.restore();
    }

      // Soft aura glow for warp ships
      if (this.type === 'warp') {
        ctx.globalAlpha = 0.5;
        const auraGrad = ctx.createRadialGradient(0, 0, this.size*0.4, 0, 0, this.size*1.1);
        auraGrad.addColorStop(0, '#7df9ffcc');
        auraGrad.addColorStop(0.5, '#7df9ff44');
        auraGrad.addColorStop(1, 'rgba(125,249,255,0)');
        ctx.beginPath();
        ctx.arc(0, 0, this.size*1.1, 0, Math.PI*2);
        ctx.fillStyle = auraGrad;
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      // Draw engine glow (universal)
      ctx.save();
      ctx.globalAlpha = 0.36;
      ctx.beginPath();
      ctx.arc(-this.size/2, 0, this.size/3.5, 0, Math.PI * 2);
      ctx.fillStyle = this.type === 'warp' ? '#7df9ff' : '#ff5555';
      ctx.shadowColor = this.type === 'warp' ? '#7df9ff' : '#ff5555';
      ctx.shadowBlur = 14;
      ctx.fill();
      ctx.restore();

      // Ship body: metallic gradient
      let bodyGrad = ctx.createLinearGradient(-this.size/2, 0, this.size/2, 0);
      bodyGrad.addColorStop(0, '#101010');
      bodyGrad.addColorStop(0.3, this.type === 'warp' ? '#7df9ff' : this.color);
      bodyGrad.addColorStop(0.8, '#fff');
      ctx.fillStyle = bodyGrad;
      ctx.beginPath();
      ctx.ellipse(0, 0, this.size/2, this.size/3, 0, 0, Math.PI * 2);
      ctx.shadowColor = this.type === 'warp' ? '#7df9ff' : this.color;
      ctx.shadowBlur = 5;
      ctx.fill();

      // Cockpit: glass dome
      ctx.save();
      ctx.beginPath();
      ctx.ellipse(this.size/6, 0, this.size/5, this.size/7, 0, 0, Math.PI*2);
      let cockpitGrad = ctx.createRadialGradient(this.size/6, 0, this.size/20, this.size/6, 0, this.size/5);
      cockpitGrad.addColorStop(0, '#fff');
      cockpitGrad.addColorStop(1, this.type === 'warp' ? '#7df9ff' : '#7df9ff66');
      ctx.fillStyle = cockpitGrad;
      ctx.globalAlpha = 0.8;
      ctx.fill();
      ctx.restore();

      // Windows/lights
      ctx.save();
      ctx.globalAlpha = 0.7;
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(this.size/8, -this.size/8, this.size/14, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();

      // --- Wings: Beautiful shapes ---
      if (this.type === 'warp') {
        // Curved glowing "energy" wings
        ctx.save();
        ctx.shadowColor = '#7df9ff';
        ctx.shadowBlur = 18;
        ctx.strokeStyle = '#7df9ff';
        ctx.lineWidth = 3.2;
        ctx.beginPath();
        ctx.moveTo(-this.size/4, 0);
        ctx.quadraticCurveTo(-this.size/2, -this.size/2 * Math.sin(this.wingAngle), 0, -this.size/2);
        ctx.moveTo(-this.size/4, 0);
        ctx.quadraticCurveTo(-this.size/2, this.size/2 * Math.sin(this.wingAngle), 0, this.size/2);
        ctx.stroke();
        ctx.restore();
      } else {
        // Sleek swept wings with metallic gradient
        let wingGrad = ctx.createLinearGradient(-this.size/2, 0, 0, 0);
        wingGrad.addColorStop(0, '#888');
        wingGrad.addColorStop(1, '#fff');
        ctx.fillStyle = wingGrad;
        ctx.beginPath();
        ctx.moveTo(-this.size/4, 0);
        ctx.lineTo(-this.size/2, -this.size/2 * Math.sin(this.wingAngle));
        ctx.lineTo(-this.size/2, this.size/2 * Math.sin(this.wingAngle));
        ctx.closePath();
        ctx.fill();
      }

      // Fins: small triangles
      ctx.save();
      ctx.fillStyle = '#444444';
      ctx.beginPath();
      ctx.moveTo(-this.size/2, -this.size/7);
      ctx.lineTo(-this.size/2 - 8, 0);
      ctx.lineTo(-this.size/2, this.size/7);
      ctx.closePath();
      ctx.globalAlpha = 0.7;
      ctx.fill();
      ctx.restore();

      ctx.restore();
    }
  }
  
  class Mothership extends Spaceship {
  constructor() {
    super();
    this.size = 50;
    this.speed = 0.2 + Math.random() * 0.2; // Slow speed
    this.color = "#fde68a";
    this.type = "mothership";
    this.x = Math.random() < 0.5 ? -this.size : window.innerWidth + this.size;
    this.y = window.innerHeight * 0.55;
    this.direction = Math.random() < 0.5 ? 1 : -1;
    this.engineParticles = [];
    this.wingAngle = 0;
    this.wingDirection = 0.03;
	this.pauseUntil = 0;
  }
  draw(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    if (this.direction < 0) ctx.scale(-1, 1);

    // Glowing aura
    ctx.globalAlpha = 0.55;
    let auraGrad = ctx.createRadialGradient(0, 0, this.size * 0.6, 0, 0, this.size * 1.4);
    auraGrad.addColorStop(0, "#fde68a");
    auraGrad.addColorStop(0.7, "#fde68a22");
    auraGrad.addColorStop(1, "rgba(253, 230, 138, 0)");
    ctx.beginPath();
    ctx.arc(0, 0, this.size * 1.4, 0, Math.PI * 2);
    ctx.fillStyle = auraGrad;
    ctx.fill();

    ctx.globalAlpha = 1;

    // Main body (ellipse, gold gradient)
    let bodyGrad = ctx.createLinearGradient(-this.size/2, 0, this.size/2, 0);
    bodyGrad.addColorStop(0, "#f59e0b");
    bodyGrad.addColorStop(0.6, "#fde68a");
    bodyGrad.addColorStop(1, "#fffbe6");
    ctx.beginPath();
    ctx.ellipse(0, 0, this.size/1.1, this.size/2.2, 0, 0, Math.PI * 2);
    ctx.fillStyle = bodyGrad;
    ctx.shadowColor = "#fde68a";
    ctx.shadowBlur = 18;
    ctx.fill();

    // Dome (lotus or OM symbol in gold)
    ctx.save();
    ctx.globalAlpha = 0.85;
    ctx.beginPath();
    ctx.ellipse(this.size/5, -this.size/4, this.size/4, this.size/8, 0, 0, Math.PI*2);
    ctx.fillStyle = "#fffbe6";
    ctx.shadowColor = "#fde68a";
    ctx.shadowBlur = 12;
    ctx.fill();
    ctx.restore();

// Multi-color inner halo (ellipse)
ctx.save();
ctx.globalAlpha = 0.33;
const haloGrad = ctx.createRadialGradient(
  this.size/5, -this.size/8, this.size/6,
  this.size/5, -this.size/8, this.size/2
);
haloGrad.addColorStop(0, "#fffbe6");
haloGrad.addColorStop(0.4, "#fde68a");
haloGrad.addColorStop(0.7, "#60a5fa"); // blue
haloGrad.addColorStop(0.9, "#f472b6"); // pink
haloGrad.addColorStop(1, "#fde68a00");
ctx.beginPath();
ctx.ellipse(this.size/5, -this.size/8, this.size/2, this.size/5, 0, 0, Math.PI*2);
ctx.strokeStyle = haloGrad;
ctx.lineWidth = 7;
ctx.shadowColor = "#fde68a";
ctx.shadowBlur = 14;
ctx.stroke();
ctx.restore();

// Inside Mothership.draw(ctx) after main body:
ctx.save();
// Inner cockpit glow (ellipse)
ctx.globalAlpha = 0.85;
ctx.beginPath();
ctx.ellipse(this.size/5, -this.size/8, this.size/5, this.size/9, 0, 0, Math.PI*2);
let cockpitGrad = ctx.createRadialGradient(
  this.size/5, -this.size/8, this.size/16,
  this.size/5, -this.size/8, this.size/5
);
cockpitGrad.addColorStop(0, "#fffbe6");
cockpitGrad.addColorStop(0.8, "#fde68a");
cockpitGrad.addColorStop(1, "rgba(253,230,138,0.3)");
ctx.fillStyle = cockpitGrad;
ctx.shadowColor = "#fde68a";
ctx.shadowBlur = 15;
ctx.fill();
ctx.restore();

// Optional: Soft halo ring inside
ctx.save();
ctx.globalAlpha = 0.19;
ctx.beginPath();
ctx.ellipse(this.size/5, -this.size/8, this.size/3.1, this.size/7, 0, 0, Math.PI*2);
ctx.strokeStyle = "#fde68a";
ctx.lineWidth = 2.7;
ctx.shadowColor = "#fde68a";
ctx.shadowBlur = 6;
ctx.stroke();
ctx.restore();

// 2. Animated ‚ÄúLeader Beacons‚Äù Orbiting Dots
const time = Date.now() * 0.001;
for (let i = 0; i < 3; i++) {
  const angle = time + i * (Math.PI * 2 / 3);
  const rx = this.size * 0.7 * Math.cos(angle);
  const ry = this.size * 0.33 * Math.sin(angle);
  const dotRadius = Math.max(2, this.size * 0.05);
  ctx.save();
  ctx.globalAlpha = 0.75;
  ctx.beginPath();
  ctx.arc(rx, ry, dotRadius, 0, Math.PI * 2);
  ctx.fillStyle = ["#fbbf24", "#60a5fa", "#f472b6"][i];
  ctx.shadowColor = ctx.fillStyle;
  ctx.shadowBlur = 12;
  ctx.fill();
  ctx.restore();
}

// 3. Pulsing Core
const pulse = 0.7 + 0.3 * Math.sin(Date.now() * 0.003);
ctx.save();
ctx.globalAlpha = 0.18 + 0.16 * pulse;
ctx.beginPath();
ctx.arc(this.size/5, -this.size/8, this.size/8 * pulse, 0, Math.PI*2);
ctx.fillStyle = "#fbbf24";
ctx.shadowColor = "#fde68a";
ctx.shadowBlur = 10;
ctx.fill();
ctx.restore();

// 4. Starburst Rays
ctx.save();
ctx.globalAlpha = 0.13;
const timee = Date.now() * 0.0003; // Slow rotation
const rayCount = 12;              // More rays!
const rayLength = this.size * 1.5;  // Longer rays
for (let i = 0; i < rayCount; i++) {
  const angle = i * (Math.PI * 2 / rayCount) + timee;
  ctx.beginPath();
  ctx.moveTo(this.size/5, -this.size/8);
  ctx.lineTo(
    this.size/5 + Math.cos(angle) * rayLength,
    -this.size/8 + Math.sin(angle) * rayLength
  );
  ctx.strokeStyle = "#fde68a";
  ctx.lineWidth = 3;
  ctx.shadowBlur = 8;
  ctx.shadowColor = "#fde68a";
  ctx.stroke();
}
ctx.restore();

    // Engine glow (bigger and gold)
    ctx.save();
    ctx.globalAlpha = 0.47;
    ctx.beginPath();
    ctx.arc(-this.size/2, 0, this.size/3.1, 0, Math.PI * 2);
    ctx.fillStyle = "#fbbf24";
    ctx.shadowColor = "#fde68a";
    ctx.shadowBlur = 18;
    ctx.fill();
    ctx.restore();

    // Wings - double arched, glowing
    ctx.save();
    ctx.shadowColor = "#fde68a";
    ctx.shadowBlur = 18;
    ctx.strokeStyle = "#fde68a";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(-this.size/4, 0);
    ctx.quadraticCurveTo(-this.size/1.2, -this.size/2 * Math.sin(this.wingAngle), 0, -this.size/1.3);
    ctx.moveTo(-this.size/4, 0);
    ctx.quadraticCurveTo(-this.size/1.2, this.size/2 * Math.sin(this.wingAngle), 0, this.size/1.3);
    ctx.stroke();
    ctx.restore();

    // Fins: big triangles
    ctx.save();
    ctx.fillStyle = "#fbbf24";
    ctx.globalAlpha = 0.7;
    ctx.beginPath();
    ctx.moveTo(-this.size/2, -this.size/6);
    ctx.lineTo(-this.size/2 - 14, 0);
    ctx.lineTo(-this.size/2, this.size/6);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    ctx.restore();
  }
}

  // Spaceships - 3 regular (first is fast, red), 2 warp
  const spaceships = [];
  for (let i = 0; i < 3; i++) {
    const ship = new Spaceship();
    if (i === 0) {
      ship.speed = Math.random() * 4 + 3;
      ship.type = 'fast';
      ship.color = '#ff5555';
    } else {
      ship.type = 'normal';
    }
    spaceships.push(ship);
  }

  for (let i = 0; i < 2; i++) {
    const ship = new Spaceship();
    ship.type = 'warp';
    spaceships.push(ship);
  }
  
    // --- Add the Mothership ---
const mothership = new Mothership();
spaceships.push(mothership);

  // Wait for all images to load before starting animation
  const images = [neptune, pluto, galaxy, saturn, portal, bgalaxy];
  let imagesLoaded = 0;
  function checkAllImagesLoaded() {
    imagesLoaded++;
    if (imagesLoaded === images.length) {
      animate();
    }
  }
  images.forEach(img => {
    if (img.complete) {
      checkAllImagesLoaded();
    } else {
      img.onload = checkAllImagesLoaded;
      img.onerror = checkAllImagesLoaded;
    }
  });

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ‚ú® Update and draw particles
    ctx.fillStyle = '#fde68a';
    for (const p of particles) {
      p.x += p.dx;
      p.y += p.dy;
      if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fill();
    }

    // ü™ê Draw orbiting planets
    for (const planet of planets) {
      planet.angle += planet.speed;
      const px = planet.cx + planet.orbit * Math.cos(planet.angle);
      const py = planet.cy + planet.orbit * Math.sin(planet.angle);
      if (planet.img && planet.img.complete && planet.img.naturalWidth > 0) {
        ctx.drawImage(
          planet.img,
          px - planet.size / 2,
          py - planet.size / 2,
          planet.size,
          planet.size
        );
      }
    }
    
    // üöÄ Update and draw spaceships
    for (const ship of spaceships) {
      ship.update();
      ship.draw(ctx);
    }

    requestAnimationFrame(animate);
  }
  // Animation will start after all images are loaded
})
</script>

<script>
let idleTimeout;
let screensaverActive = false;

const canvasEl = document.getElementById("particles-canvas");

// Listen to any user activity
["mousemove", "keydown", "touchstart"].forEach(evt => {
  document.addEventListener(evt, resetIdleTimer, true);
});

function resetIdleTimer() {
  if (screensaverActive) {
    hideScreensaver();
  }
  clearTimeout(idleTimeout);
  idleTimeout = setTimeout(() => {
    if (isHomeScreen()) {
      showScreensaver();
    }
  }, 30000); // 1 minute = 60000ms
}

function isHomeScreen() {
  const homeScreen = document.getElementById("mode-selection");
  return homeScreen && !homeScreen.classList.contains("hidden");
}

function showScreensaver() {
  canvasEl.classList.remove("hidden");
  screensaverActive = true;
}

function hideScreensaver() {
  canvasEl.classList.add("hidden");
  screensaverActive = false;
}

// Start timer initially
resetIdleTimer();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('meditation-canvas');
  const ctx = canvas.getContext('2d');
  // const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // DNA helix parameters
  const dnaNodes = 30;
  const dnaSegments = 20;
  const dnaRadius = 120;
  const nodeRadius = 4;
  let dnaRotation = 0;
  let showDNA = true;
  let transitionProgress = 0;
  const transitionDuration = 648000; // frames for DNA to stay visible

  // Gentle drifting stars
  const stars = Array.from({ length: isMobile() ? 18 : 33 }).map(() => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    r: Math.random() * 1.5 + 0.5,
    speed: (Math.random() * 0.05) + 0.02
  }));

  // Aurora-like waves data
  let t = 0;
  let frameCount = 0;

  // NEW: Neurons and biophotons data
  const neurons = Array.from({ length: isMobile() ? 7 : 13 }).map(() => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    connections: [],
    lastFired: Math.random() * 1000, // Stagger initial firing
    firing: 0,
    radius: Math.random() * 3 + 2
  }));

  // Create connections between neurons
  neurons.forEach((neuron, i) => {
    // Connect to 2-4 other neurons
    const numConnections = Math.floor(Math.random() * 3) + 2;
    for (let j = 0; j < numConnections; j++) {
      const targetIndex = Math.floor(Math.random() * neurons.length);
      if (targetIndex !== i) {
        neuron.connections.push(targetIndex);
      }
    }
  });

  // Biophotons (subtle light particles)
  const biophotons = Array.from({ length: isMobile() ? 12 : 25 }).map(() => ({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    size: Math.random() * 1.5 + 0.5,
    speed: Math.random() * 0.8 + 0.3,
    angle: Math.random() * Math.PI * 2,
    life: Math.random() * 100,
    maxLife: 300 + Math.random() * 200
  }));

function getUnlockedChakraIndex(currentDay) {
  if (currentDay >= 41) return 6; // Crown
  if (currentDay >= 36) return 5; // Third Eye
  if (currentDay >= 29) return 4; // Throat
  if (currentDay >= 22) return 3; // Heart
  if (currentDay >= 15) return 2; // Solar Plexus
  if (currentDay >= 8)  return 1; // Sacral
  return 0; // Root
}

// Draw 7 chakra petals from bottom to top
const chakraColors = [
    {hue: 360, name: "Root"},      // Red (bottom)
    {hue: 30, name: "Sacral"},     // Orange
    {hue: 60, name: "Solar"},      // Yellow
    {hue: 120, name: "Heart"},     // Green
    {hue: 210, name: "Throat"},    // Blue
    {hue: 270, name: "Third Eye"}, // Indigo
    {hue: 300, name: "Crown"}      // Violet (top)
];

// Get user's current challenge day (from your app logic)
const currentDay = challengeData.currentDay || 1;
const unlockedChakra = getUnlockedChakraIndex(currentDay);
const chakraPetalCounts = [4, 6, 10, 12, 16, 2, 32]; // Petal counts for chakras

  // NEW: Draw neurons and connections
function drawNeurons() {
  // Draw connections first (behind neurons)
  neurons.forEach(neuron => {
    if (neuron.firing > 0) {
      neuron.connections.forEach(connIndex => {
        const target = neurons[connIndex];
        // Only draw connection when firing
        const alpha = Math.min(neuron.firing, target.firing) * 0.15;
        if (alpha > 0.01) {
          ctx.beginPath();
          ctx.moveTo(neuron.x, neuron.y);
          ctx.lineTo(target.x, target.y);
          ctx.strokeStyle = `hsla(300, 70%, 80%, ${alpha})`;
          ctx.lineWidth = 1;
          ctx.stroke();

          // Add a subtle glow to active connections
          ctx.beginPath();
          ctx.moveTo(neuron.x, neuron.y);
          ctx.lineTo(target.x, target.y);
          ctx.strokeStyle = `hsla(180, 50%, 90%, ${alpha * 0.3})`;
          ctx.lineWidth = 3;
          ctx.stroke();
        }
      });
    }
  });

  // Draw neurons (with realistic appearance)
  neurons.forEach(neuron => {
    // --- Soma: Irregular oval instead of perfect circle ---
    ctx.save();
    ctx.translate(neuron.x, neuron.y);
    ctx.rotate(Math.random() * Math.PI); // Random rotation for organic feel
    ctx.beginPath();
    ctx.ellipse(
      0, 0,
      neuron.radius * (1.1 + Math.random() * 0.3),
      neuron.radius * (0.7 + Math.random() * 0.25),
      0, 0, Math.PI * 2
    );
    ctx.fillStyle = neuron.firing > 0
      ? `hsla(300, 80%, 90%, ${0.5 + neuron.firing * 0.5})`
      : `hsla(300, 30%, 70%, 0.3)`;
    ctx.shadowColor = neuron.firing > 0 ? '#eab308' : '#fffbe6';
    ctx.shadowBlur = neuron.firing > 0 ? 16 * neuron.firing : 5;
    ctx.fill();
    ctx.restore();

    // --- Dendrites/Axons: Branches radiating out ---
    const branchCount = 3 + Math.floor(Math.random() * 3); // 3‚Äì5 branches
    for (let i = 0; i < branchCount; i++) {
      const angle = (i / branchCount) * Math.PI * 2 + Math.random() * 0.4;
      const length = neuron.radius * (2.5 + Math.random());
      ctx.beginPath();
      ctx.moveTo(neuron.x, neuron.y);
      ctx.lineTo(
        neuron.x + Math.cos(angle) * length,
        neuron.y + Math.sin(angle) * length
      );
      ctx.strokeStyle = neuron.firing > 0
        ? `hsla(300, 70%, 80%, ${0.23 + neuron.firing * 0.27})`
        : `hsla(300, 20%, 60%, 0.23)`;
      ctx.lineWidth = neuron.firing > 0 ? 1.5 : 1;
      ctx.shadowColor = neuron.firing > 0 ? '#eab308' : '#fffbe6';
      ctx.shadowBlur = neuron.firing > 0 ? 10 * neuron.firing : 2;
      ctx.stroke();
    }

    // --- Optionally: Draw a small core nucleus for the soma ---
    ctx.beginPath();
    ctx.arc(neuron.x, neuron.y, neuron.radius * 0.35, 0, Math.PI * 2);
    ctx.fillStyle = neuron.firing > 0
      ? `hsla(300, 90%, 98%, ${0.8 * neuron.firing})`
      : `hsla(300, 60%, 90%, 0.23)`;
    ctx.shadowBlur = neuron.firing > 0 ? 12 * neuron.firing : 0;
    ctx.fill();
  });
}

  // NEW: Update neurons - make them fire occasionally
  function updateNeurons() {
    neurons.forEach(neuron => {
      neuron.lastFired++;
      
      // Random firing with slightly increased chance during DNA visibility
      const fireChance = showDNA ? 0.002 : 0.0008;
      
      if (neuron.firing > 0) {
        neuron.firing -= 0.05;
        if (neuron.firing < 0) neuron.firing = 0;
      } else if (Math.random() < fireChance) {
        neuron.firing = 1;
        neuron.lastFired = 0;
        
        // Trigger connected neurons with decreasing probability
        neuron.connections.forEach(connIndex => {
          if (Math.random() < 0.6) {
            neurons[connIndex].firing = 0.8;
          }
        });
      }
    });
  }

  // NEW: Draw biophotons (subtle light particles)
  function drawBiophotons() {
    biophotons.forEach(photon => {
      photon.life++;
      
      // Reset photon when it expires
      if (photon.life > photon.maxLife) {
        photon.x = Math.random() * canvas.width;
        photon.y = Math.random() * canvas.height;
        photon.life = 0;
        photon.maxLife = 100 + Math.random() * 200;
        photon.angle = Math.random() * Math.PI * 2;
      }
      
      // Move photon
      photon.x += Math.cos(photon.angle) * photon.speed;
      photon.y += Math.sin(photon.angle) * photon.speed;
      
      // Wrap around edges
      if (photon.x < 0) photon.x = canvas.width;
      if (photon.x > canvas.width) photon.x = 0;
      if (photon.y < 0) photon.y = canvas.height;
      if (photon.y > canvas.height) photon.y = 0;
      
      // Occasionally change direction
      if (Math.random() < 0.01) {
        photon.angle += (Math.random() - 0.5) * 0.5;
      }
      
      // Draw with pulsating effect
      const pulse = 0.5 + 0.5 * Math.sin(photon.life * 0.05);
      const alpha = 0.1 + 0.1 * (photon.life / photon.maxLife) * pulse;
      
      ctx.beginPath();
      ctx.arc(photon.x, photon.y, photon.size * pulse, 0, Math.PI * 2);
      ctx.fillStyle = `hsla(180, 70%, 90%, ${alpha * 0.4})`;
      ctx.fill();
      
      // Add a subtle glow
      ctx.beginPath();
      ctx.arc(photon.x, photon.y, photon.size * pulse * 4, 0, Math.PI * 2);
      ctx.fillStyle = `hsla(180, 50%, 95%, ${alpha * 0.2})`;
      ctx.fill();
    });
  }

  // Draw DNA helix
  function drawDNA() {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const showChakraPetals = true;
 
    if (showChakraPetals && typeof currentMode !== "undefined" && currentMode === "yogi") {
      const bottomOffset = 80; // Space for button
      const topOffset = 80;     // Space for top padding
      const availableHeight = canvas.height - bottomOffset - topOffset;

      for (let chakra = 0; chakra <= unlockedChakra; chakra++) {
        // Space chakras evenly between topOffset and bottomOffset
        const chakraY = canvas.height - bottomOffset - (availableHeight * (chakra / 6));
        const chakraSize = 25 + chakra * 4;
        
        // Draw petal shapes instead of circles
        const petalCount = chakraPetalCounts[chakra];
        for (let i = 0; i < petalCount; i++) {
          const angle = (i / petalCount) * Math.PI * 2 + dnaRotation;
          const petalLength = chakraSize * 1.3;
          
          ctx.beginPath();
          ctx.moveTo(canvas.width/2, chakraY);
          
          // Create petal shape with Bezier curves
          const cp1x = canvas.width/2 + Math.cos(angle) * petalLength;
          const cp1y = chakraY + Math.sin(angle) * petalLength;
          const cp2x = canvas.width/2 + Math.cos(angle + Math.PI/8) * petalLength * 0.7;
          const cp2y = chakraY + Math.sin(angle + Math.PI/8) * petalLength * 0.7;
          
          ctx.bezierCurveTo(
            cp1x, cp1y,
            cp2x, cp2y,
            canvas.width/2, chakraY
          );
          
          // Chakra colors from bottom to top
          ctx.fillStyle = `hsla(${chakraColors[chakra].hue}, 80%, 60%, 0.4)`;
          ctx.strokeStyle = `hsla(${chakraColors[chakra].hue}, 90%, 70%, 0.8)`;
          ctx.lineWidth = 1.5;
          ctx.fill();
          ctx.stroke();
        }
        
// Enhanced Third Eye (Ajna) chakra glow
if (chakra === 5) {
  ctx.save();
  
  // Create pulsing effect for the glow
  const pulseIntensity = 0.5 + 0.3 * Math.sin(Date.now() * 0.002);
  const glowSize = 55 + 12 * pulseIntensity; // Increased base size
  
  // Inner intense glow - more vibrant
  ctx.globalAlpha = 0.7 * pulseIntensity;
  let glowGradient = ctx.createRadialGradient(
    canvas.width/2, chakraY, 0,
    canvas.width/2, chakraY, glowSize
  );
  glowGradient.addColorStop(0, `hsla(${chakraColors[5].hue}, 98%, 80%, 1)`);
  glowGradient.addColorStop(0.5, `hsla(${chakraColors[5].hue}, 90%, 65%, 0.6)`);
  glowGradient.addColorStop(0.8, `hsla(${chakraColors[5].hue}, 85%, 55%, 0.3)`);
  glowGradient.addColorStop(1, `hsla(${chakraColors[5].hue}, 80%, 50%, 0)`);
  
  ctx.beginPath();
  ctx.ellipse(canvas.width/2, chakraY, glowSize, glowSize/1.8, 0, 0, Math.PI * 2);
  ctx.fillStyle = glowGradient;
  ctx.fill();
  
  // Outer subtle glow - expanded
  ctx.globalAlpha = 0.3;
  glowGradient = ctx.createRadialGradient(
    canvas.width/2, chakraY, 0,
    canvas.width/2, chakraY, glowSize * 2.2
  );
  glowGradient.addColorStop(0, `hsla(${chakraColors[5].hue}, 95%, 70%, 0.4)`);
  glowGradient.addColorStop(1, `hsla(${chakraColors[5].hue}, 90%, 60%, 0)`);
  
  ctx.beginPath();
  ctx.ellipse(canvas.width/2, chakraY, glowSize * 2.2, glowSize * 1.1, 0, 0, Math.PI * 2);
  ctx.fillStyle = glowGradient;
  ctx.fill();
  
  // Enhanced glowing particles with varying sizes
          // Add glowing particles around Third Eye
          ctx.globalAlpha = 0.7;
          for (let i = 0; i < 8; i++) {
            const angle = (i / 8) * Math.PI * 2 + dnaRotation;
            const distance = glowSize + 15;
            const particleSize = 2 + pulseIntensity * 1.5;
            
            ctx.beginPath();
            ctx.arc(
              canvas.width/2 + Math.cos(angle) * distance,
              chakraY + Math.sin(angle) * distance,
              particleSize, 0, Math.PI * 2
            );
            ctx.fillStyle = `hsla(${chakraColors[5].hue + i * 10}, 90%, 70%, ${0.8 - i * 0.1})`;
            ctx.fill();
          }
    
  // ADDITION: Central core with brighter glow
  ctx.globalAlpha = 0.9;
  const coreGradient = ctx.createRadialGradient(
    canvas.width/2, chakraY, 0,
    canvas.width/2, chakraY, glowSize * 0.4
  );
  coreGradient.addColorStop(0, `hsla(${chakraColors[5].hue}, 100%, 90%, 1)`);
  coreGradient.addColorStop(1, `hsla(${chakraColors[5].hue}, 95%, 70%, 0)`);
  
  ctx.beginPath();
  ctx.arc(canvas.width/2, chakraY, glowSize * 0.4, 0, Math.PI * 2);
  ctx.fillStyle = coreGradient;
  ctx.fill();
  
  ctx.restore();
}
        
        // After drawing petals for Crown
        if (chakra === 6) {
          ctx.save();
          // Crown's radiant glow: big, soft, violet-white halo
          ctx.globalAlpha = 0.18;
          const glowColor = `hsla(${chakraColors[6].hue}, 90%, 90%, 1)`; // Violet-white
          ctx.beginPath();
          ctx.arc(canvas.width/2, chakraY, chakraSize * 1.5, 0, Math.PI * 2);
          ctx.fillStyle = glowColor;
          ctx.shadowColor = glowColor;
          ctx.shadowBlur = 32;
          ctx.fill();
          ctx.restore();

          // Optional: Layered petals for extra "lotus" effect
          ctx.save();
          ctx.globalAlpha = 0.11;
          ctx.beginPath();
          ctx.arc(canvas.width/2, chakraY, chakraSize * 1.8, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(${chakraColors[6].hue}, 90%, 80%, 1)`;
          ctx.shadowColor = `hsla(${chakraColors[6].hue}, 90%, 80%, 1)`;
          ctx.shadowBlur = 18;
          ctx.fill();
          ctx.restore();

          // Central point - bright violet/white
          ctx.beginPath();
          ctx.arc(canvas.width/2, chakraY, 8, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(${chakraColors[6].hue}, 100%, 95%, 1)`;
          ctx.shadowColor = `#fff`;
          ctx.shadowBlur = 1;
          ctx.fill();
        }

        // Add a central point for each chakra
        ctx.beginPath();
        ctx.arc(canvas.width/2, chakraY, 5, 0, Math.PI * 2);
        ctx.fillStyle = `hsla(${chakraColors[chakra].hue}, 100%, 70%, 0.9)`;
        ctx.fill();
      }
    }		
    
    // Draw nodes for both strands
    for (let i = 0; i < dnaNodes; i++) {
      const progress = i / dnaNodes;
      const angle = progress * Math.PI * 4 + dnaRotation;
      
      // --- Chakra color mapping ---
      // Map node index from 0 (bottom) to dnaNodes-1 (top) to chakras 0-6
      const chakraPos = (dnaNodes - 1 - i) / (dnaNodes - 1) * (chakraColors.length - 1);
      const lowerIdx = Math.floor(chakraPos);
      const upperIdx = Math.min(lowerIdx + 1, chakraColors.length - 1);
      const frac = chakraPos - lowerIdx;
      const lowerHue = chakraColors[lowerIdx].hue;
      const upperHue = chakraColors[upperIdx].hue;
      const hue = lowerHue + (upperHue - lowerHue) * frac;
      
    // Calculate positions for both strands
    const x1 = centerX + Math.cos(angle) * dnaRadius;
    const y1 = centerY - canvas.height/2 + i * (canvas.height / dnaNodes);
    
    const x2 = centerX + Math.cos(angle + Math.PI) * dnaRadius;
    const y2 = centerY - canvas.height/2 + i * (canvas.height / dnaNodes);
    
    // Draw enhanced connecting lines between the two strands
    if (i % 2 === 0) {
      // Calculate line properties
      const lineLength = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
      const lineAngle = Math.atan2(y2 - y1, x2 - x1);
      
      // Create pulsing effect
      const pulseIntensity = 0.7 + 0.3 * Math.sin(Date.now() * 0.005 + i * 0.3);
      
      // Draw main connecting line with gradient
      ctx.save();
      ctx.translate(x1, y1);
      ctx.rotate(lineAngle);
      
      // Main line with gradient
      const gradient = ctx.createLinearGradient(0, 0, lineLength, 0);
      gradient.addColorStop(0, `hsla(${hue}, 100%, 70%, ${0.8 * pulseIntensity})`);
      gradient.addColorStop(0.3, `hsla(${hue}, 100%, 85%, ${0.9 * pulseIntensity})`);
      gradient.addColorStop(0.5, `hsla(${hue + 20}, 100%, 90%, ${1 * pulseIntensity})`);
      gradient.addColorStop(0.7, `hsla(${hue}, 100%, 85%, ${0.9 * pulseIntensity})`);
      gradient.addColorStop(1, `hsla(${hue}, 100%, 70%, ${0.8 * pulseIntensity})`);
      
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(lineLength, 0);
      ctx.strokeStyle = gradient;
      ctx.lineWidth = 2 * pulseIntensity;
      ctx.shadowBlur = 10;
      ctx.shadowColor = `hsla(${hue}, 100%, 70%, 0.7)`;
      ctx.stroke();
      
      // Add glow effect underneath
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(lineLength, 0);
      ctx.strokeStyle = `hsla(${hue}, 100%, 80%, 0.3)`;
      ctx.lineWidth = 6 * pulseIntensity;
      ctx.stroke();
      
      ctx.restore();
      
      // Add energy particles along the line (randomly)
      if (Math.random() < 0.3) {
        const particlePos = Math.random();
        const px = x1 + (x2 - x1) * particlePos;
        const py = y1 + (y2 - y1) * particlePos;
        
        ctx.beginPath();
        ctx.arc(px, py, 1.2 * pulseIntensity, 0, Math.PI * 2);
        ctx.fillStyle = `hsla(${hue + 30}, 100%, 95%, ${0.9 * pulseIntensity})`;
        ctx.shadowBlur = 8;
        ctx.shadowColor = `hsla(${hue}, 100%, 70%, 0.8)`;
        ctx.fill();
      }
    }
	
      // First strand nodes
      drawNode(
        centerX + Math.cos(angle) * dnaRadius,
        centerY - canvas.height/2 + i * (canvas.height / dnaNodes),
        angle,
        hue
      );
      
      // Second strand nodes (opposite side)
      drawNode(
        centerX + Math.cos(angle + Math.PI) * dnaRadius,
        centerY - canvas.height/2 + i * (canvas.height / dnaNodes),
        angle + Math.PI,
        hue
      );
    }
  }
  
  // Draw a single node of the DNA
  function drawNode(x, y, angle, hue) {
    // Create gradient based on chakra hue
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, nodeRadius * 2);
    gradient.addColorStop(0, `hsla(${hue}, 100%, 70%, 1)`);
    gradient.addColorStop(1, `hsla(${hue}, 100%, 50%, 0.3)`);
    
    ctx.beginPath();
    ctx.arc(x, y, nodeRadius, 0, Math.PI * 2);
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Add glow effect
    ctx.beginPath();
    ctx.arc(x, y, nodeRadius * 3, 0, Math.PI * 2);
    const glowGradient = ctx.createRadialGradient(x, y, nodeRadius, x, y, nodeRadius * 3);
    glowGradient.addColorStop(0, `hsla(${hue}, 100%, 70%, 0.5)`);
    glowGradient.addColorStop(1, `hsla(${hue}, 100%, 50%, 0)`);
    ctx.fillStyle = glowGradient;
    ctx.fill();
  }


// Draw Cosmic energy as flowing particles moving upward
function drawCosmicEnergy() {
  const centerX = canvas.width / 2;
  const waveWidth = 35; // Width of the energy flow
  const particleCount = isMobile() ? 150 : 333; // Number of particles
  const riseSpeed = 1.8; // Speed of upward movement
  
  ctx.save();
  
  // Create and update particles
  if (!window.cosmicParticles) {
    // Initialize particles if they don't exist
    window.cosmicParticles = [];
    for (let i = 0; i < particleCount; i++) {
      window.cosmicParticles.push({
        x: centerX + (Math.random() - 0.5) * waveWidth,
        y: Math.random() * canvas.height * 0.2,
        size: Math.random() * 2 + 1,
        speed: Math.random() * riseSpeed + riseSpeed * 0.5,
        hue: Math.random() * 60 + 50, // Golden to yellow
        life: Math.random() * 100,
        oscillation: Math.random() * Math.PI * 2
      });
    }
  }
  
  // Update and draw particles
  window.cosmicParticles.forEach(particle => {
    // Move particle upward
    particle.y += particle.speed;
    particle.life += 0.1;
    particle.oscillation -= 0.05;
    
    // Reset particle if it goes off the top
    if (particle.y > canvas.height + 10) {
      particle.y = -10;
      particle.x = centerX + (Math.random() - 0.5) * waveWidth;
      particle.hue = 50 + Math.random() * 20; // Reset to golden color
      particle.size = Math.random() * 2 + 1;
    }
    
    // Oscillate slightly side to side
    particle.x = centerX + Math.sin(particle.oscillation) * waveWidth/2;
    
    // Color transition as particle rises (golden ‚Üí violet ‚Üí light blue)
    const heightRatio = particle.y / canvas.height;
	const hueRange = 360 - 280;
if (heightRatio < 0.15) {
    particle.hue = 280; // Violet - Crown (top)
} else if (heightRatio < 0.25) {
    particle.hue = 270; // Indigo - Third Eye
} else if (heightRatio < 0.35) {
    particle.hue = 210; // Blue - Throat
} else if (heightRatio < 0.5) {
    particle.hue = 120; // Green - Heart
} else if (heightRatio < 0.65) {
    particle.hue = 60;  // Yellow - Solar Plexus
} else if (heightRatio < 0.8) {
    particle.hue = 30;  // Orange - Sacral
} else {
    particle.hue = 0;   // Red - Root (bottom)
}
    
    // Draw the particle
    const pulse = 0.7 + 0.3 * Math.sin(particle.life * 0.1);
    const alpha = 0.7 + 0.3 * Math.sin(particle.life * 0.05);
    
    ctx.beginPath();
    ctx.arc(particle.x, particle.y, particle.size * pulse, 0, Math.PI * 2);
    
    // Create gradient fill for each particle
    const gradient = ctx.createRadialGradient(
      particle.x, particle.y, 0,
      particle.x, particle.y, particle.size * 2
    );
    gradient.addColorStop(0, `hsla(${particle.hue}, 100%, 80%, ${alpha})`);
    gradient.addColorStop(1, `hsla(${particle.hue}, 100%, 60%, 0)`);
    
    ctx.fillStyle = gradient;
    ctx.shadowBlur = 10;
    ctx.shadowColor = `hsla(${particle.hue}, 100%, 70%, 0.7)`;
    ctx.fill();
    
    // Add a tiny sparkle trail
    if (Math.random() < 0.3) {
      ctx.beginPath();
      ctx.arc(
        particle.x + (Math.random() - 0.5) * 3,
        particle.y + (Math.random() - 0.5) * 3,
        particle.size * 0.5,
        0, Math.PI * 2
      );
      ctx.fillStyle = `hsla(${particle.hue + 20}, 100%, 90%, 0.4)`;
      ctx.fill();
    }
  });
  
  ctx.restore();
}

// Draw shining silver fluid energy rising from root chakra
function drawSilverEnergy() {
  const centerX = canvas.width / 2;
  const waveWidth = 25;
  // Dynamically set particle count based on unlocked chakra
  const baseCount = isMobile() ? 13 : 20;
  const particleCount = baseCount * (unlockedChakra + 1);

  // Get the current unlocked chakra Y position
  const bottomOffset = 80;
  const topOffset = 80;
  const availableHeight = canvas.height - bottomOffset - topOffset;
  const targetChakraY = canvas.height - bottomOffset - (availableHeight * (unlockedChakra / 6));

  ctx.save();

  // Dynamically add or remove particles
  if (!window.silverParticles) {
    window.silverParticles = [];
  }
  // Add particles if needed
  while (window.silverParticles.length < particleCount) {
    window.silverParticles.push({
      x: centerX + (Math.random() - 0.5) * waveWidth,
      y: canvas.height - Math.random() * 100,
      size: Math.random() * 1.5 + 1.2,
      speed: Math.random() * 1.2 + 0.9,
      life: Math.random() * 100,
      oscillation: Math.random() * Math.PI * 2,
      amplitude: Math.random() * waveWidth / 2.2
    });
  }
  // Remove particles if needed
  while (window.silverParticles.length > particleCount) {
    window.silverParticles.pop();
  }

  window.silverParticles.forEach(particle => {
    // Move particle upward
    particle.y -= particle.speed;
    particle.life += 0.13;
    particle.oscillation += 0.04;

    // If particle reaches the current chakra Y, reset to bottom
    if (particle.y < targetChakraY) {
      particle.y = canvas.height + 12;
      particle.x = centerX + (Math.random() - 0.5) * waveWidth;
      particle.size = Math.random() * 1.7 + 1.2;
    }

    // Sway side to side
    particle.x = centerX + Math.sin(particle.oscillation) * particle.amplitude;

    const pulse = 0.8 + 0.4 * Math.sin(particle.life * 0.08);
    const alpha = 0.85 + 0.15 * Math.sin(particle.life * 0.07);

    ctx.beginPath();
    ctx.arc(particle.x, particle.y, particle.size * pulse, 0, Math.PI * 2);

    const grad = ctx.createRadialGradient(
      particle.x, particle.y, 0,
      particle.x, particle.y, particle.size * pulse * 2
    );
    grad.addColorStop(0, `hsla(0, 0%, 100%, 0.97)`);
    grad.addColorStop(0.45, `hsla(200, 15%, 92%, 0.85)`);
    grad.addColorStop(1, `hsla(200, 17%, 80%, 0.0)`);

    ctx.fillStyle = grad;
    ctx.shadowBlur = 22;
    ctx.shadowColor = `hsla(0, 0%, 95%, 0.9)`;
    ctx.globalAlpha = alpha;
    ctx.fill();

    if (Math.random() < 0.3) {
      ctx.beginPath();
      ctx.arc(
        particle.x + (Math.random() - 0.5) * 2.5,
        particle.y + (Math.random() - 0.5) * 2.5,
        particle.size * 0.65,
        0, Math.PI * 2
      );
      ctx.fillStyle = `hsla(0, 0%, 100%, 0.93)`;
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 7;
      ctx.shadowColor = "#fff";
      ctx.fill();
      ctx.globalAlpha = alpha;
    }
  });

  ctx.globalAlpha = 1;
  ctx.restore();
}

// Add to your DNA drawing function near the crown chakra section
function drawLotusFlower() {
  const centerX = canvas.width / 2;
  const crownY = canvas.height - 80 - ((canvas.height - 160) * (6 / 6));
  
  ctx.save();
  
  // Lotus petals (two layers)
  for (let layer = 0; layer < 2; layer++) {
    const petals = layer === 0 ? 8 : 16;
    const size = layer === 0 ? 40 : 30;
    
    for (let i = 0; i < petals; i++) {
      const angle = (i / petals) * Math.PI * 2 + dnaRotation * 0.5;
      const petalLength = size * (1.2 + 0.3 * Math.sin(dnaRotation));
      
      ctx.beginPath();
      ctx.ellipse(
        centerX + Math.cos(angle) * (size * 0.7),
        crownY + Math.sin(angle) * (size * 0.7),
        petalLength,
        size * 0.5,
        angle,
        0,
        Math.PI * 2
      );
      
      const gradient = ctx.createLinearGradient(
        centerX + Math.cos(angle) * (size * 0.7 - petalLength),
        crownY + Math.sin(angle) * (size * 0.7),
        centerX + Math.cos(angle) * (size * 0.7 + petalLength),
        crownY + Math.sin(angle) * (size * 0.7)
      );
      
      gradient.addColorStop(0, `hsla(300, 40%, 90%, 0.7)`);
      gradient.addColorStop(1, `hsla(300, 60%, 80%, 0.3)`);
      
      ctx.fillStyle = gradient;
      ctx.fill();
    }
  }
  
  // Lotus center
  ctx.beginPath();
  ctx.arc(centerX, crownY, 15, 0, Math.PI * 2);
  ctx.fillStyle = 'hsla(60, 80%, 70%, 0.8)';
  ctx.fill();
  
  ctx.restore();
}

function drawTwelveStrandDNA(ctx, centerX, centerY, dnaRadius, dnaNodes, rotation, currentDay) {
  // Chakra hues from violet (top) to red (bottom)
  const chakraColors = [
    {hue: 300}, // Violet - Crown
    {hue: 270}, // Indigo - Third Eye
    {hue: 210}, // Blue - Throat
    {hue: 120}, // Green - Heart
    {hue: 60},  // Yellow - Solar
    {hue: 30},  // Orange - Sacral
    {hue: 360}, // Red - Root
  ];
  // Map day to unlocked strands (up to 10)
let unlockedStrands = 0;
if (challengeData.currentDay >= 40) unlockedStrands = 10;
else if (challengeData.currentDay >= 31) unlockedStrands = 8;
else if (challengeData.currentDay >= 23) unlockedStrands = 6;
else if (challengeData.currentDay >= 15) unlockedStrands = 4;
else if (challengeData.currentDay >= 8) unlockedStrands = 2;

  const totalStrands = unlockedStrands; // Do not count the main big 2-strands

  if (totalStrands === 0) return; // Nothing to draw if not unlocked

  // For color mapping, spread chakra hues over the unlocked strands
  for (let i = 0; i < dnaNodes; i++) {
    // --- Calculate vertical chakra color ---
    const chakraFrac = i / (dnaNodes - 1);
    const colorIdx = Math.floor(chakraFrac * (chakraColors.length - 1));
    const nextIdx = Math.min(colorIdx + 1, chakraColors.length - 1);
    const frac = chakraFrac * (chakraColors.length - 1) - colorIdx;
    const hue = chakraColors[colorIdx].hue + (chakraColors[nextIdx].hue - chakraColors[colorIdx].hue) * frac;

    const baseAngle = (i / dnaNodes) * Math.PI * 4 + rotation;

    for (let s = 0; s < unlockedStrands; s++) {
      const strandAngle = baseAngle + (s * Math.PI * 2 / unlockedStrands);
      const x = centerX + Math.cos(strandAngle) * dnaRadius;
      const y = centerY - ctx.canvas.height/2 + i * (ctx.canvas.height / dnaNodes);

      // Draw node with the **vertical chakra color**
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI * 2); // Adjust node size as needed
      ctx.fillStyle = `hsla(${hue}, 90%, 70%, 0.8)`;
      ctx.shadowColor = `hsla(${hue}, 90%, 70%, 0.5)`;
      ctx.shadowBlur = 8;
      ctx.fill();

      // Connect to next strand for "base pair" look
      if (s < unlockedStrands - 1) {
        const nextAngle = baseAngle + ((s + 1) * Math.PI * 2 / unlockedStrands);
        const x2 = centerX + Math.cos(nextAngle) * dnaRadius;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x2, y);
        ctx.strokeStyle = `hsla(${hue}, 90%, 70%, 0.22)`;
        ctx.lineWidth = 1.1;
        ctx.shadowBlur = 4;
        ctx.shadowColor = `hsla(${hue}, 90%, 70%, 0.2)`;
        ctx.stroke();
        ctx.restore();
      }
    }
  }
}

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Always increment rotation ONCE per frame
    dnaRotation += 0.015;
    
    // Draw DNA at the beginning of the session
    if (showDNA) {
      drawDNA();
      frameCount++;
      
      // Keep DNA visible for transitionDuration frames
      if (frameCount > transitionDuration) {
        showDNA = false;
      }
    }

  // ADD THIS LINE - Draw kundalini energy
    if (typeof currentMode !== "undefined" && currentMode === "yogi") {
	drawCosmicEnergy();
	drawSilverEnergy();
	drawTwelveStrandDNA(ctx, canvas.width/2, canvas.height/2, 90, 30, dnaRotation, challengeData.currentDay);
    // drawLotusFlower();
	}
  
    // NEW: Update and draw neurons and biophotons
    updateNeurons();
    drawNeurons();
    drawBiophotons();

    // üåå Draw aurora waves
for (let i = 0; i < 3; i++) {
  ctx.save();
  ctx.shadowColor = `hsla(${180 + i * 40}, 80%, 80%, 0.55)`;
  ctx.shadowBlur = 28;

  ctx.beginPath();
  ctx.moveTo(0, canvas.height / 2);

  for (let x = 0; x < canvas.width; x++) {
    const y = Math.sin(x * 0.005 + t + i) * 20 + 
              Math.sin(x * 0.002 + t * 0.5) * 15 +
              canvas.height / 2;
    ctx.lineTo(x, y);
  }

  const gradient = ctx.createLinearGradient(0, canvas.height / 2 - 50, 0, canvas.height / 2 + 50);
  gradient.addColorStop(0, `hsla(${180 + i * 40}, 80%, 60%, 0.19)`);
  gradient.addColorStop(1, `hsla(${200 + i * 40}, 80%, 70%, 0.19)`);
  ctx.strokeStyle = gradient;
  ctx.lineWidth = 1;
  ctx.stroke();
  ctx.restore();
}

    // ‚ú® Draw gentle drifting stars
    ctx.fillStyle = '#fff';
    for (const s of stars) {
      s.x -= s.speed;
      if (s.x < 0) s.x = canvas.width;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fill();
    }

    t += 0.002;
    requestAnimationFrame(animate);
  }

  // Function to start session background
  window.startMeditationBackground = function() {
    canvas.classList.remove('hidden');
    // Reset DNA animation for new session
    showDNA = true;
    frameCount = 0;
    animate();
  };

  // Function to hide session background
  window.stopMeditationBackground = function() {
    canvas.classList.add('hidden');
  };
});
</script>

 <!-- Place this at the END of your index.html, after ALL other scripts -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
  
  // --- Supabase credentials ---
  const supabaseUrl = 'https://jroelnuiafmamlzrpcfj.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impyb2VsbnVpYWZtYW1senJwY2ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NTE2NTEsImV4cCI6MjA2OTEyNzY1MX0.mQcImn6VhYCpYEQ5mFVZnSp4QoIIEk6iYXKIm6CB4Ko';
  const supabase = createClient(supabaseUrl, supabaseKey);
  
  const channel = supabase
  .channel('om-presence')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'om_presence' },
    payload => {
      // console.log('Realtime event:', payload);  
      updateCount();
    }
  )
  .subscribe(status => {
    // console.log('Channel status:', status);
  });
  
const jwtToken = localStorage.getItem('jwtToken');
if (jwtToken && supabase && supabase.auth && supabase.auth.setSession) {
  await supabase.auth.setSession({ access_token: jwtToken, refresh_token: "" });
}
// console.log('Supabase current session:', await supabase.auth.getSession());

  // Utility: Generate unique session_id for each session
  function generateSessionId(walletPublicKey, date, time, mode) {
    return `${walletPublicKey}_${date}_${time || 'flow'}_${mode}`;
  }

  // 1Ô∏è‚É£ Sync local sessions to Supabase (Local ‚Üí Cloud)
window.syncSessionsToSupabase = async function() {
  cleanUpLocalSessions();

  if (!window.walletPublicKey) {
    alert('Connect wallet first!');
    return;
  }

  const meditationSessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');
  let latestDate = null;
  // Find the latest date
  Object.keys(meditationSessions).forEach(date => {
    if (!latestDate || date > latestDate) latestDate = date;
  });
  if (!latestDate) {
    //alert('No sessions to sync!');
    return;
  }
  const sessionsForLatestDate = meditationSessions[latestDate];
  if (!sessionsForLatestDate || sessionsForLatestDate.length === 0) {
    alert('No session to sync!');
    return;
  }
  // Find the latest session in that date
  const latestSession = sessionsForLatestDate[sessionsForLatestDate.length - 1];

  // Build sessionRow as before
  const index = sessionsForLatestDate.length - 1;
  const session_id = `${window.walletPublicKey}_${latestDate}_${latestSession.mode}_${index}`;
  let timestamp;
  if (
    typeof latestSession.sessionTime === "string" &&
    /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/.test(latestSession.sessionTime)
  ) {
    timestamp = latestSession.sessionTime;
  } else if (
    typeof latestSession.sessionTime === "string" &&
    /^\d{2}:\d{2}$/.test(latestSession.sessionTime)
  ) {
    timestamp = new Date(latestDate + "T" + latestSession.sessionTime + ":00").toISOString();
  } else if (latestSession.sessionTime && !isNaN(Date.parse(latestSession.sessionTime))) {
    timestamp = new Date(latestSession.sessionTime).toISOString();
  } else {
    timestamp = new Date(latestDate + "T00:00:00").toISOString();
  }
  const now = new Date();
  const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const localTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});

  const sessionRow = {
    user_id: window.walletPublicKey,
    mode: latestSession.mode,
    duration: latestSession.minutes,
    date: latestDate,
    time: latestSession.sessionTime || null,
    completed: !!latestSession.completed,
    cancelled: !latestSession.completed,
    sync_status: 'synced',
    session_id,
    local_updated_at: new Date().toISOString(),
    streak_day: null,
    cancel_count: latestSession.completed ? 0 : 1,
    timestamp: timestamp,
    local_time: localTime,
    timezone: userTimezone,
	device_type: getDeviceType()
  };

  // Send only the latest session to backend
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/sessions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      },
      body: JSON.stringify({ sessions: [sessionRow] }),
    });
    const result = await resp.json();
    if (!result.success && result.error && result.error.toLowerCase().includes('token')) {
      showSyncAuthRequiredModal();
      return;
    }
    if (!result.success) {
      alert('Backend sync error: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    // alert('Network error syncing sessions: ' + err.message);
  }

  document.getElementById('sync-indicator').style.display = 'block';
  setTimeout(() => {
    document.getElementById('sync-indicator').style.display = 'none';
  }, 1111);
};

  // 2Ô∏è‚É£ Fetch all Supabase sessions for this wallet and merge to local (Cloud ‚Üí Local)
window.fetchSessionsFromSupabase = async function() {
  cleanUpLocalSessions();
  if (!window.walletPublicKey) {
    alert('Connect wallet first!');
    return;
  }
  try {
    // Fetch sessions from your backend, NOT directly from Supabase
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/sessions', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      }
    });
    const result = await resp.json();
	if (!result.success && result.error && result.error.toLowerCase().includes('token')) {
      showAuthRequiredModal();
      return;
    }
    if (!result.success) {
      alert('Backend fetch error: ' + (result.error || 'Unknown error'));
      return;
    }
    const data = result.sessions;

    // 1. Load existing local sessions
    const localSessions = JSON.parse(localStorage.getItem('meditationSessions') || '{}');

    // 2. For each session from backend, add if not already present locally
    data.forEach(sess => {
      if (!localSessions[sess.date]) localSessions[sess.date] = [];
      const exists = localSessions[sess.date].some(
        localSess => localSess.session_id === sess.session_id
      );
      if (!exists) {
        localSessions[sess.date].push({
          minutes: Math.round(sess.duration),
          mode: sess.mode,
          completed: !!sess.completed,
          sessionTime: sess.time || null,
          session_id: sess.session_id
        });
      }
    });

    // 3. Save merged sessions back to localStorage
    localStorage.setItem('meditationSessions', JSON.stringify(localSessions));

	// Immediately update stats!
	if (typeof updateStats === "function") updateStats();
	
    document.getElementById('fetch-indicator').style.display = 'block';
    setTimeout(() => {
      document.getElementById('fetch-indicator').style.display = 'none';
    }, 1111);
  } catch (err) {
    // alert('Network error fetching sessions: ' + err.message);
  }
};

// Add after sessions sync/fetch logic

// 1Ô∏è‚É£ Sync local yogi_config to Supabase (Local ‚Üí Cloud)
window.syncYogiConfigToSupabase = async function() {
  if (!window.walletPublicKey) {
    alert('Connect wallet first!');
    return;
  }
  const yogiConfig = JSON.parse(localStorage.getItem('yogiConfig') || '{}');
  if (!yogiConfig || !yogiConfig.startDate) {
    alert('No yogi config to sync!');
    return;
  }
  // Compose backend row
  const configRow = {
    ...yogiConfig,
    user_id: window.walletPublicKey,
    sync_status: 'synced',
    local_updated_at: new Date().toISOString()
  };
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      },
      body: JSON.stringify({ yogi_config: configRow }),
    });
    const result = await resp.json();
    if (!result.success) {
      // --- Only alert if it's a real error, NOT if no config is found ---
      if (result.error && !/no rows returned|not found/i.test(result.error)) {
        alert('Backend yogi_config fetch error: ' + (result.error || 'Unknown error'));
      }
    }
  } catch (err) {
   // alert('Network error syncing yogi config: ' + err.message);
  }
  // Optionally show UI sync indicator
};

// 2Ô∏è‚É£ Fetch yogi_config from Supabase (Cloud ‚Üí Local)
window.fetchYogiConfigFromSupabase = async function() {
  if (!window.walletPublicKey) {
    alert('Connect wallet first!');
    return;
  }
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_config', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      }
    });
    const result = await resp.json();
     if (!result.success) {
      // Ignore error if it's "No yogi_config found for user" or similar
      if (
        result.error &&
        (
          /no yogi[_ ]config.*not found/i.test(result.error) ||
          /no yogi[_ ]config found for user/i.test(result.error) ||
          /no rows returned/i.test(result.error) ||
          /not found/i.test(result.error)
        )
      ) {
        // Do nothing, this is expected for new users
        return;
      }
      if (!result.success) {
  if (
    result.error &&
    /invalid|expired token|token/i.test(result.error)
  ) {
    showSyncAuthBanner(); // Show banner, not alert
    return;
  }
  alert('Backend yogi_config fetch error: ' + (result.error || 'Unknown error'));
  return;
}
    }
    const data = result.yogi_config;
    if (data) {
      localStorage.setItem('yogiConfig', JSON.stringify(data));
      // Optionally update UI/config in app
    }
  } catch (err) {
   // alert('Network error fetching yogi config: ' + err.message);
  }
  // Optionally show UI fetch indicator
};



// --- Yogi Challenge Sync & Fetch ---
// 1Ô∏è‚É£ Sync local yogiChallenge to Supabase (Local ‚Üí Cloud)
window.syncYogiChallengeToSupabase = async function() {
  if (!window.walletPublicKey) {
    // Optionally alert: alert('Connect wallet first!');
    return;
  }
  const yogiChallenge = JSON.parse(localStorage.getItem('yogiChallenge') || '{}');
  if (!yogiChallenge || !yogiChallenge.startDate) {
    // Optionally alert: alert('No yogi challenge to sync!');
    return;
  }
  // Compose backend row
  const challengeRow = {
    ...yogiChallenge,
    user_id: window.walletPublicKey,
    challengeId: yogiChallenge.challengeId || 'default_challenge',
    sync_status: 'synced',
    local_updated_at: new Date().toISOString()
  };
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_challenge', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      },
      body: JSON.stringify({ yogi_challenge: challengeRow }),
    });
    const result = await resp.json();
    if (!result.success && result.error && result.error.toLowerCase().includes('token')) {
  showSyncAuthBanner(); // <-- Show persistent banner if JWT is expired/invalid
  return;
}
if (!result.success) {
  if (result.error && !/no rows returned|not found/i.test(result.error)) {
    alert('Backend yogi_challenge sync error: ' + (result.error || 'Unknown error'));
  }
}
  } catch (err) {
  //  alert('Network error syncing yogi challenge: ' + err.message);
  }
  // Optional: show UI sync indicator here if you wish
};

// 2Ô∏è‚É£ Fetch yogiChallenge from Supabase (Cloud ‚Üí Local)
window.fetchYogiChallengeFromSupabase = async function() {
  if (!window.walletPublicKey) {
    // Optionally alert: alert('Connect wallet first!');
    return;
  }
  try {
    const resp = await fetch('https://trueyogi-backend-knkq.onrender.com/api/yogi_challenge', {
      headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
      }
    });
    const result = await resp.json();
    if (!result.success) {
  // Ignore error if it's "No yogi_challenge found for user" or similar
  if (
    result.error &&
    (
      /no yogi[_ ]challenge.*not found/i.test(result.error) ||
      /no yogi[_ ]challenge found for user/i.test(result.error) ||
      /no rows returned/i.test(result.error) ||
      /not found/i.test(result.error)
    )
  ) {
    // Do nothing, this is expected for new users
    return;
  }
  if (!result.success) {
  if (
    result.error &&
    /invalid|expired token|token/i.test(result.error)
  ) {
    showSyncAuthBanner();
    return;
  }
  alert('Backend yogi_challenge fetch error: ' + (result.error || 'Unknown error'));
  return;
}
}
    const data = result.yogi_challenge;
    if (data) {
      localStorage.setItem('yogiChallenge', JSON.stringify(data));
      // Optionally update UI/progress in app here
    }
  } catch (err) {
   // alert('Network error fetching yogi challenge: ' + err.message);
  }
  // Optional: show fetch indicator
};


  // 3Ô∏è‚É£ Optional: Sync and fetch on wallet connect
  window.addEventListener('wallet-connected', async function() {
	 fixUnknownSessionIds();
	  await window.fetchSessionsFromSupabase();
	 if (window.walletPublicKey && localStorage.getItem('jwtToken') && typeof window.syncYogiChallengeToSupabase === "function") {
	  //await window.fetchYogiConfigFromSupabase();
      //await window.fetchYogiChallengeFromSupabase();
      await window.syncYogiChallengeToSupabase();
  }
  });

// 4Ô∏è‚É£ Sync when coming online (add this!)
window.addEventListener('online', () => {
  if (window.walletPublicKey && !isJwtValid()) {
    showSyncAuthBanner();
    return;
  }
  if (window.walletPublicKey) {
    fixUnknownSessionIds();
    window.syncSessionsToSupabase();
    // Challenge sync if on complete-section:
    const completeSection = document.getElementById('complete-section');
    if (
      completeSection && 
      !completeSection.classList.contains('hidden') &&
      typeof window.syncYogiChallengeToSupabase === "function"
    ) {
      confirmCompletion();
    }
  }
});

  // 4Ô∏è‚É£ Manual triggers for testing (browser console)
  // window.syncSessionsToSupabase();
  // window.fetchSessionsFromSupabase();

  // 5Ô∏è‚É£ Example: Expose utility function for direct use
 // window.supabaseSync = {
   // upload: window.syncSessionsToSupabase,
   // download: window.fetchSessionsFromSupabase
  // };

  // 6Ô∏è‚É£ Usage:
  // Call window.syncSessionsToSupabase() to upload local ‚Üí Supabase
  // Call window.fetchSessionsFromSupabase() to download Supabase ‚Üí local
  // You can hook these to UI events if needed!
	
  window.supabase = supabase;
  window.authenticateWithWallet = authenticateWithWallet;
  window.promptVerifyAndSync = promptVerifyAndSync;
  window.updateWalletUI = updateWalletUI;
  startCallPolling();
  
</script>

 <div id="start-date-display" class="end-date-display hidden">
  <span id="start-label">Spark</span>: <span id="start-date-value"></span>
</div>
 <div id="now-date-display" class="end-date-display hidden">NOW</div>
 <div id="end-date-display" class="end-date-display hidden">
  <span id="end-label">Arrival</span>: <span id="end-date-value"></span>
</div>
 
<!-- Sync (Upload) Indicator - Bottom Left, Green -->
<div id="sync-indicator" style="
  position: fixed;
  bottom: 18px;
  left: 18px;
  z-index: 9999;
  display: none;
  pointer-events: auto;
">
  <div id="sync-dot" style="
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: linear-gradient(135deg, #38ef7d, #11998e); 
    box-shadow: 0 0 10px #38ef7d88;
    border: 2px solid #1e293b;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: Default;
    position: relative;
  "></div>
  <div id="sync-tooltip" style="
    display: none;
    position: absolute;
    left: 24px;
    top: 0;
    background: #1e293b;
    color: #38ef7d;
    font-size: 0.95rem;
    padding: 4px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #38ef7d33;
    font-family: 'Lexend', sans-serif;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    transition: opacity 0.2s;
    opacity: 0;
  ">üßò</div>
</div>

<!-- Fetch Indicator - Bottom Right, Purple -->
<div id="fetch-indicator" style="
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 9999;
  display: none;
  pointer-events: auto;
">
  <div id="fetch-dot" style="
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: linear-gradient(135deg, #a78bfa, #6d28d9); /* purple gradient */
    box-shadow: 0 0 10px #a78bfa88;
    border: 2px solid #1e293b;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: Default;
    position: relative;
  "></div>
  <div id="fetch-tooltip" style="
    display: none;
    position: absolute;
    left: 24px;
    top: 0;
    background: #1e293b;
    color: #a78bfa;
    font-size: 0.95rem;
    padding: 4px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px #a78bfa33;
    font-family: 'Lexend', sans-serif;
    font-weight: 500;
    white-space: nowrap;
    pointer-events: none;
    transition: opacity 0.2s;
    opacity: 0;
  ">üßò</div>
</div>

<!-- Reset Indicator - Bottom Center, White -->
<div id="reset-indicator" style="
  position: fixed;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: none;
  pointer-events: none;
">
  <div id="reset-dot" style="
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: radial-gradient(circle, #fff 60%, #e5e7eb 100%);
    box-shadow: 0 0 18px #fff, 0 0 1px #e5e7eb;
    border: 2px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: resetPulse 1.8s infinite;
  "></div>
</div>

<!-- Reconfigure Indicator - Bottom Center, Yellow -->
<div id="yellow-indicator" style="
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: none;
  pointer-events: none;
">
  <div id="yellow-dot" style="
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: radial-gradient(circle, #fde047 60%, #facc15 100%);
    box-shadow: 0 0 24px #fde047, 0 0 1px #facc15;
    border: 2px solid #fde047;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: resetPulse 1.8s infinite;
  "></div>
</div>

</body>
</html>

